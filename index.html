<script type="module">
    import { createConstellationBackground } from './assets/scripts/constellation.js';

    // --- LÓGICA DE ESTADÍSTICAS (CONECTADO A SUPABASE) ---
    
    // Función para actualizar el DOM
    const renderStats = (total, available, states, rating) => {
      const set = (id, value) => {
        const el = document.getElementById(id);
        // Animación simple de conteo
        if (el) {
            el.textContent = value;
            el.classList.add('animate-pulse');
            setTimeout(() => el.classList.remove('animate-pulse'), 500);
        }
      };
      
      set('tech-count', total);
      set('available-count', available);
      set('states-count', states);
      set('avg-rating', rating);
    };

    const fetchServiceStats = async () => {
      // Obtener cliente de Supabase (asegúrate de que window.supabaseClient esté inicializado en tus otros scripts)
      const client = window.supabase || window.supabaseClient;

      if (!client) {
        console.error("Supabase client not found.");
        return;
      }

      try {
        // Consultamos solo las columnas necesarias para ser eficientes
        const { data, error, count } = await client
          .from('services')
          .select('state, status, availability', { count: 'exact' });

        if (error) throw error;

        // 1. Total Partners (Total de filas)
        const totalCount = count || 0;

        // 2. Available Now (Lógica basada en tu imagen)
        // Buscamos si la columna 'availability' dice "24/7" O si el 'status' es 'Available'
        const availableCount = data.filter(row => {
            const availText = (row.availability || '').toLowerCase();
            const statusText = (row.status || '').toLowerCase();
            return availText.includes('24/7') || statusText === 'available' || statusText === 'active';
        }).length;

        // 3. States Active (Estados únicos)
        // Normalizamos el texto (trim y mayúsculas) para evitar duplicados como "TX" y "tx "
        const uniqueStates = new Set(
            data
            .map(row => row.state ? row.state.trim().toUpperCase() : null)
            .filter(Boolean) // Eliminar nulos
        ).size;

        // 4. SLA Rating
        // Como la imagen no muestra una columna numérica de rating, lo mantenemos estático o aleatorio alto por ahora
        // Si agregas una columna 'rating' numérica, puedes hacer un promedio aquí.
        const avgRating = 4.8; 

        // Actualizar la interfaz
        renderStats(totalCount, availableCount, uniqueStates, avgRating);

      } catch (err) {
        console.warn('Error loading stats from Supabase:', err);
        // Fallback visual en caso de error de conexión
        renderStats('-', '-', '-', '-');
      }
    };

    // --- LOG IN / LOG OUT LOGIC (Mantenida igual) ---
    const handleAuthUI = async () => {
        const loginBtn = document.getElementById('nav-login');
        const logoutBtn = document.getElementById('nav-logout');
        const client = window.supabase || window.supabaseClient;

        if (!client) return;

        const updateButtonState = (session) => {
            if (session) {
                if (loginBtn) loginBtn.classList.add('hidden');
                if (logoutBtn) {
                    logoutBtn.classList.remove('hidden');
                    logoutBtn.onclick = async () => {
                        logoutBtn.textContent = '...';
                        const { error } = await client.auth.signOut();
                        if (!error) window.location.reload(); 
                    };
                }
            } else {
                if (loginBtn) loginBtn.classList.remove('hidden');
                if (logoutBtn) logoutBtn.classList.add('hidden');
            }
        };

        const { data: { session } } = await client.auth.getSession();
        updateButtonState(session);

        client.auth.onAuthStateChange((event, session) => {
            updateButtonState(session);
        });
    };

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      createConstellationBackground();
      
      // Ejecutar lógica de Auth
      handleAuthUI();
      
      // Cargar estadísticas reales
      fetchServiceStats();
    });
  </script>
