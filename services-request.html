<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Service Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/scripts/authManager.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>

  <style>
    /* Para que el "1 inch" sea literal en desktop; en mobile usamos padding normal con tailwind */
    @media (min-width: 768px) {
      .px-inch { padding-left: 96px; padding-right: 96px; }
    }
  </style>

  <link rel="stylesheet" href="assets/visuals/theme.css" />
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">
  <div class="pointer-events-none fixed inset-0 z-0 opacity-80 mix-blend-screen" aria-hidden="true">
    <canvas id="constellation-canvas" class="h-full w-full"></canvas>
  </div>

  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
    <!-- ✅ ancho completo + padding ~1" en desktop -->
    <div class="mx-auto flex w-full max-w-none items-center justify-between px-6 px-inch py-4">
      <a href="index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Network</p>
          <h1 class="text-base font-black leading-tight text-white">Service Control</h1>
        </div>
      </a>

      <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
        <a id="nav-home" href="index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
        <a id="nav-control-view" href="vehicles.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800 md:inline-flex">Control View</a>
        <a id="nav-services" href="services-request.html" class="rounded-full px-3 py-1 bg-blue-600 text-white shadow shadow-blue-500/20">Service Requests</a>
        <a
          id="nav-dashboard"
          href="Admin/index.html"
          data-dashboard-link
          aria-hidden="true"
          tabindex="-1"
          class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800 md:inline-flex"
        >
          Dashboard
        </a>
        <a id="nav-about" href="about.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">About</a>
        <a id="nav-contact" href="contact.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Contact</a>
      </nav>

      <div class="flex items-center gap-3" data-admin-actions>
        <a id="nav-login" href="login.html" class="rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
        <button id="nav-logout" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
      </div>
    </div>
  </header>

  <!-- ✅ main ancho completo + padding ~1" en desktop -->
  <main class="relative z-10 mx-auto flex w-full max-w-none flex-col gap-8 px-6 px-inch py-10">

    <!-- Header / Controls -->
    <section class="rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-xl shadow-blue-900/30">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Board</p>
          <h2 class="text-2xl font-black text-white">Service Requests</h2>
          <p class="text-sm text-slate-300">Track any service requested for any vehicle — table, kanban, and saved filters.</p>
        </div>

        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <div class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-2">
            <i data-lucide="search" class="h-4 w-4 text-slate-400"></i>
            <input id="searchInput" type="text" placeholder="Search (VIN, unit, request, vendor...)" class="w-72 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none" />
          </div>

          <div class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/40 p-1">
            <button data-view="table" class="viewBtn rounded-2xl px-3 py-2 text-xs font-bold text-white bg-blue-600">Table</button>
            <button data-view="kanban" class="viewBtn rounded-2xl px-3 py-2 text-xs font-bold text-slate-300 hover:text-white">Kanban</button>
            <button data-view="calendar" class="viewBtn rounded-2xl px-3 py-2 text-xs font-bold text-slate-300 hover:text-white">Calendar</button>
          </div>

          <button id="newRequestBtn" class="inline-flex items-center gap-2 rounded-2xl bg-blue-600 px-4 py-2 text-sm font-black text-white shadow shadow-blue-500/20 transition hover:bg-blue-500">
            <i data-lucide="plus" class="h-4 w-4"></i>
            New request
          </button>
        </div>
      </div>

      <!-- Quick filters (status) -->
      <div class="mt-5 flex flex-wrap items-center gap-2 text-xs">
        <button data-filter="Open" class="filterChip rounded-full border border-slate-800 bg-slate-950/30 px-3 py-1 font-semibold text-slate-200 hover:bg-slate-800/60">Open</button>
        <button data-filter="In Progress" class="filterChip rounded-full border border-slate-800 bg-slate-950/30 px-3 py-1 font-semibold text-slate-200 hover:bg-slate-800/60">In progress</button>
        <button data-filter="Waiting" class="filterChip rounded-full border border-slate-800 bg-slate-950/30 px-3 py-1 font-semibold text-slate-200 hover:bg-slate-800/60">Waiting</button>
        <button data-filter="Closed" class="filterChip rounded-full border border-slate-800 bg-slate-950/30 px-3 py-1 font-semibold text-slate-200 hover:bg-slate-800/60">Closed</button>
        <button id="clearFiltersBtn" class="ml-2 rounded-full border border-slate-800 bg-slate-950/30 px-3 py-1 font-semibold text-slate-200 hover:bg-slate-800/60">Clear filters</button>
      </div>
    </section>

    <!-- TABLE VIEW -->
    <section id="tableView" class="rounded-3xl border border-slate-900 bg-slate-900/70 p-0 shadow-xl shadow-blue-900/30 overflow-hidden">
      <div class="flex items-center justify-between border-b border-slate-800 px-6 py-4">
        <p class="text-sm font-bold text-white">All requests</p>
        <p id="resultsMeta" class="text-xs text-slate-400">0 items</p>
      </div>

      <div class="overflow-auto px-4 pb-4">
        <!-- ✅ más ancha en general -->
        <table class="min-w-[1600px] w-full text-left text-sm">
          <thead class="sticky top-0 bg-slate-950/80 backdrop-blur z-10">
            <!-- Header row (sort buttons injected) -->
            <tr id="tableHeaderRow" class="text-xs uppercase tracking-[0.14em] text-slate-300"></tr>
            <!-- Filter row (inputs injected) -->
            <tr id="tableFilterRow" class="text-[11px] text-slate-300"></tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between px-6 py-4 border-t border-slate-800">
        <button id="prevPage" class="rounded-xl border border-slate-700 px-4 py-2 text-sm disabled:opacity-40">Previous</button>
        <p id="pageMeta" class="text-sm text-slate-400"></p>
        <button id="nextPage" class="rounded-xl border border-slate-700 px-4 py-2 text-sm disabled:opacity-40">Next</button>
      </div>

      <div id="emptyState" class="hidden px-6 py-10">
        <div class="rounded-3xl border border-slate-800 bg-slate-950/40 p-6">
          <p id="emptyTitle" class="text-sm font-bold text-white">No service requests found</p>
          <p id="emptyMsg" class="mt-1 text-sm text-slate-300">Create the first request, or adjust filters/search.</p>
        </div>
      </div>
    </section>

    <!-- KANBAN VIEW -->
    <section id="kanbanView" class="hidden rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-xl shadow-blue-900/30">
      <div class="mb-4 flex items-center justify-between">
        <p class="text-sm font-bold text-white">Kanban</p>
        <p class="text-xs text-slate-400">Drag & drop can be added next (Phase 2).</p>
      </div>
      <div class="grid gap-4 md:grid-cols-4" id="kanbanColumns"></div>
    </section>

    <!-- CALENDAR VIEW (stub) -->
    <section id="calendarView" class="hidden rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-xl shadow-blue-900/30">
      <div class="space-y-2">
        <p class="text-sm font-bold text-white">Calendar</p>
        <p class="text-sm text-slate-300">We’ll wire this to the <span class="font-semibold">Due</span> date and show month/week views in Phase 3.</p>
        <div class="rounded-3xl border border-slate-800 bg-slate-950/40 p-6 text-slate-400">Calendar placeholder</div>
      </div>
    </section>

  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4">
    <div class="w-full max-w-2xl rounded-3xl border border-slate-800 bg-slate-950 shadow-2xl">
      <div class="flex items-center justify-between border-b border-slate-800 px-6 py-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Service request</p>
          <h3 id="modalTitle" class="text-lg font-black text-white">New request</h3>
        </div>
        <button id="modalClose" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-2 text-slate-200 hover:bg-slate-800">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>

      <form id="requestForm" class="space-y-5 px-6 py-6">
        <input type="hidden" id="requestId" />
        <!-- KEEP YOUR FORM INPUTS EXACTLY AS YOU ALREADY HAVE THEM -->
        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:justify-between">
          <p id="formError" class="text-sm text-red-300"></p>
          <div class="flex items-center gap-2">
            <button type="button" id="deleteBtn" class="hidden rounded-2xl border border-red-800 bg-red-950/40 px-4 py-2 text-sm font-black text-red-200 hover:bg-red-950/70">Delete</button>
            <button type="submit" class="rounded-2xl bg-blue-600 px-5 py-2 text-sm font-black text-white hover:bg-blue-500">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createConstellationBackground } from './assets/scripts/constellation.js';

    const SUPABASE_URL = "https://ewgtclzscwbokxmzxbcu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto";
    const TABLE_NAME = "services_request";
    const PAGE_SIZE = 20;

    function getClient() {
      if (!window.supabase?.createClient) return null;
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ✅ Teléfonos en una sola columna
    const TABLE_COLUMNS = [
      { key: 'company_name', label: 'Company Name', type: 'text' },
      { key: 'phones', label: 'Phones', type: 'text' },
      { key: 'doc', label: 'Doc', type: 'text' },
      { key: 'unittype', label: 'Unit Type', type: 'text' },
      { key: 'brand', label: 'Brand', type: 'text' },
      { key: 'model', label: 'Model', type: 'text' },
      { key: 'model year', label: 'Model Year', type: 'text' },
      { key: 'shortvin', label: 'Short VIN', type: 'text' },
      { key: 'status', label: 'Status', type: 'status' },
      { key: 'request date', label: 'Request Date', type: 'date' },
      { key: 'workdate', label: 'Work Date', type: 'date' },
      { key: 'shipping date', label: 'Shipping Date', type: 'date' },
      { key: 'quote', label: 'Quote', type: 'text' },
      { key: 'poc name', label: 'POC Name', type: 'text' },
      { key: 'confirmed', label: 'Confirmed', type: 'text' },
      { key: 'state', label: 'State', type: 'text' },
      { key: 'city', label: 'City', type: 'text' },
      { key: 'zip', label: 'ZIP', type: 'text' },
      { key: 'address', label: 'Address', type: 'text' },
    ];

    const state = {
      view: 'table',
      filterStatusChip: null,      // chips Open/In Progress/Waiting/Closed
      globalSearch: '',
      columnFilters: {},           // per-column filter text
      sortKey: null,
      sortDir: 'asc',              // 'asc' | 'desc'
      loading: false,
      client: null,
      lastError: null,

      allItems: [],                // ✅ cargamos TODO (107) una vez
      page: 1,
    };

    // DOM
    const tableView = document.getElementById('tableView');
    const kanbanView = document.getElementById('kanbanView');
    const calendarView = document.getElementById('calendarView');
    const tableBody = document.getElementById('tableBody');
    const headerRow = document.getElementById('tableHeaderRow');
    const filterRow = document.getElementById('tableFilterRow');
    const emptyState = document.getElementById('emptyState');
    const emptyTitle = document.getElementById('emptyTitle');
    const emptyMsg = document.getElementById('emptyMsg');
    const resultsMeta = document.getElementById('resultsMeta');
    const searchInput = document.getElementById('searchInput');

    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageMeta = document.getElementById('pageMeta');

    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    // Modal refs (left as-is)
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const newRequestBtn = document.getElementById('newRequestBtn');
    const requestForm = document.getElementById('requestForm');
    const requestId = document.getElementById('requestId');
    const formError = document.getElementById('formError');
    const modalTitle = document.getElementById('modalTitle');
    const deleteBtn = document.getElementById('deleteBtn');

    // helpers
    const statusPill = (status) => {
      const map = {
        'Open': 'bg-slate-800 text-slate-100 border-slate-700',
        'In Progress': 'bg-blue-600/20 text-blue-200 border-blue-700/40',
        'Waiting': 'bg-amber-600/20 text-amber-200 border-amber-700/40',
        'Closed': 'bg-emerald-600/20 text-emerald-200 border-emerald-700/40',
        'Done': 'bg-emerald-600/20 text-emerald-200 border-emerald-700/40',
        'Cancelled': 'bg-slate-800 text-slate-200 border-slate-700',
      };
      const cls = map[status] || 'bg-slate-800 text-slate-100 border-slate-700';
      return `<span class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-bold ${cls}">${status || '—'}</span>`;
    };

    // ✅ mm/dd/yy (no inventa columnas)
    function fmtDate(v) {
      if (!v) return '—';
      const d = new Date(v);
      if (isNaN(d)) return '—';
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${mm}/${dd}/${yy}`;
    }

    function normalizeRow(raw) {
      const companyPhone = raw?.['company phone'] ?? raw?.company_phone ?? null;
      const pocPhone = raw?.['poc phone'] ?? raw?.poc_phone ?? null;

      return {
        ...raw,
        'company phone': companyPhone,
        unittype: raw?.unittype ?? raw?.unit_type ?? null,
        'model year': raw?.['model year'] ?? raw?.model_year ?? null,
        shortvin: raw?.shortvin ?? raw?.short_vin ?? null,
        'request date': raw?.['request date'] ?? raw?.request_date ?? null,
        workdate: raw?.workdate ?? raw?.work_date ?? null,
        'shipping date': raw?.['shipping date'] ?? raw?.shipping_date ?? null,
        'poc name': raw?.['poc name'] ?? raw?.poc_name ?? null,
        'poc phone': pocPhone,

        // ✅ Phones single-line cell
        phones: [companyPhone, pocPhone].filter(Boolean).join(' / ') || null,
      };
    }

    function setView(view) {
      state.view = view;
      tableView.classList.toggle('hidden', view !== 'table');
      kanbanView.classList.toggle('hidden', view !== 'kanban');
      calendarView.classList.toggle('hidden', view !== 'calendar');

      document.querySelectorAll('.viewBtn').forEach(btn => {
        const active = btn.dataset.view === view;
        btn.classList.toggle('bg-blue-600', active);
        btn.classList.toggle('text-white', active);
        btn.classList.toggle('text-slate-300', !active);
      });

      render();
    }

    function getComparableValue(row, key) {
      const v = row?.[key];
      if (key === 'request date' || key === 'workdate' || key === 'shipping date') {
        const d = new Date(v);
        return isNaN(d) ? 0 : d.getTime();
      }
      return (v ?? '').toString().toLowerCase();
    }

    function applyAllFiltersAndSort(all) {
      let out = [...all];

      // chip status filter
      if (state.filterStatusChip) {
        const target = state.filterStatusChip.toLowerCase();
        out = out.filter(r => (r.status || '').toLowerCase() === target);
      }

      // global search
      if (state.globalSearch) {
        const q = state.globalSearch.toLowerCase();
        out = out.filter(r => {
          const fields = [
            r.company_name, r.phones, r.doc, r.unittype, r.brand, r.model,
            r['model year'], r.shortvin, r.status, r.quote,
            r['poc name'], r.confirmed, r.state, r.city, r.zip, r.address,
            fmtDate(r['request date']), fmtDate(r.workdate), fmtDate(r['shipping date']),
          ];
          return fields.filter(Boolean).some(v => String(v).toLowerCase().includes(q));
        });
      }

      // per-column filters
      for (const col of TABLE_COLUMNS) {
        const f = (state.columnFilters[col.key] || '').trim().toLowerCase();
        if (!f) continue;

        out = out.filter(r => {
          if (col.type === 'date') {
            return fmtDate(r[col.key]).toLowerCase().includes(f);
          }
          if (col.key === 'status') {
            return String(r.status || '').toLowerCase().includes(f);
          }
          return String(r[col.key] ?? '').toLowerCase().includes(f);
        });
      }

      // sort
      if (state.sortKey) {
        const k = state.sortKey;
        const dir = state.sortDir === 'asc' ? 1 : -1;
        out.sort((a, b) => {
          const av = getComparableValue(a, k);
          const bv = getComparableValue(b, k);
          if (av < bv) return -1 * dir;
          if (av > bv) return 1 * dir;
          return 0;
        });
      }

      return out;
    }

    function getPaged(items) {
      const total = items.length;
      const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (state.page > maxPage) state.page = maxPage;

      const start = (state.page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;

      return { pageItems: items.slice(start, end), total, maxPage };
    }

    function renderHeaderAndFilters() {
      // Sort headers
      headerRow.innerHTML = TABLE_COLUMNS.map(col => {
        const active = state.sortKey === col.key;
        const arrow = active ? (state.sortDir === 'asc' ? '▲' : '▼') : '';
        return `
          <th class="px-6 py-3 whitespace-nowrap">
            <button
              type="button"
              class="inline-flex items-center gap-2 text-slate-300 hover:text-white font-bold"
              data-sortkey="${col.key}"
              title="Sort"
            >
              <span>${col.label}</span>
              <span class="text-[10px] opacity-80">${arrow}</span>
            </button>
          </th>
        `;
      }).join('') + `<th class="px-6 py-3 text-right whitespace-nowrap">Actions</th>`;

      // Filter row
      filterRow.innerHTML = TABLE_COLUMNS.map(col => {
        const v = state.columnFilters[col.key] || '';

        if (col.key === 'status') {
          return `
            <th class="px-6 pb-3">
              <input
                data-filterkey="${col.key}"
                value="${escapeHtml(v)}"
                placeholder="filter..."
                class="w-full min-w-[120px] rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[11px] text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-600"
              />
            </th>
          `;
        }

        if (col.type === 'date') {
          return `
            <th class="px-6 pb-3">
              <input
                data-filterkey="${col.key}"
                value="${escapeHtml(v)}"
                placeholder="mm/dd/yy"
                class="w-full min-w-[110px] rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[11px] text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-600"
              />
            </th>
          `;
        }

        // Wider address filter input
        const extra = col.key === 'address' ? 'min-w-[260px]' : 'min-w-[120px]';

        return `
          <th class="px-6 pb-3">
            <input
              data-filterkey="${col.key}"
              value="${escapeHtml(v)}"
              placeholder="filter..."
              class="w-full ${extra} rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[11px] text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-600"
            />
          </th>
        `;
      }).join('') + `<th class="px-6 pb-3"></th>`;

      // bind sort buttons
      headerRow.querySelectorAll('button[data-sortkey]').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.sortkey;
          if (state.sortKey === key) {
            state.sortDir = (state.sortDir === 'asc') ? 'desc' : 'asc';
          } else {
            state.sortKey = key;
            state.sortDir = 'asc';
          }
          state.page = 1;
          render();
        });
      });

      // bind filter inputs
      filterRow.querySelectorAll('input[data-filterkey]').forEach(inp => {
        inp.addEventListener('input', () => {
          const key = inp.dataset.filterkey;
          state.columnFilters[key] = inp.value;
          state.page = 1;
          render();
        });
      });
    }

    function renderTable(items) {
      tableBody.innerHTML = '';

      if (!items.length) {
        emptyState.classList.remove('hidden');
        if (state.lastError) {
          emptyTitle.textContent = 'Could not load service requests';
          emptyMsg.textContent = state.lastError;
        } else {
          emptyTitle.textContent = 'No service requests found';
          emptyMsg.textContent = 'Try clearing filters/search.';
        }
        return;
      }

      emptyState.classList.add('hidden');

      for (const r of items) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-950/30';

        const cells = TABLE_COLUMNS.map(col => {
          const value = r[col.key];

          if (col.key === 'status') return `<td class="px-6 py-3 whitespace-nowrap">${statusPill(value)}</td>`;
          if (col.key === 'phones') return `<td class="px-6 py-3 text-slate-200 whitespace-nowrap">${value || '—'}</td>`;

          if (col.type === 'date') {
            return `<td class="px-6 py-3 text-slate-300 whitespace-nowrap">${fmtDate(value)}</td>`;
          }

          if (col.key === 'address') {
            return `<td class="px-6 py-3 text-slate-200 min-w-[360px] max-w-[520px] whitespace-normal">${value ?? '—'}</td>`;
          }

          if (col.key === 'company_name' || col.key === 'brand' || col.key === 'model') {
            return `<td class="px-6 py-3 font-bold text-white">${value || '—'}</td>`;
          }

          return `<td class="px-6 py-3 text-slate-200">${value ?? '—'}</td>`;
        }).join('');

        tr.innerHTML = `
          ${cells}
          <td class="px-6 py-3 text-right whitespace-nowrap">
            <button class="editBtn inline-flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800" data-id="${r.id}">
              <i data-lucide="pencil" class="h-4 w-4"></i>
              Edit
            </button>
          </td>
        `;
        tableBody.appendChild(tr);
      }

      tableBody.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const item = state.allItems.find(x => String(x.id) === String(id));
          if (item) openModal(item);
        });
      });

      lucide.createIcons();
    }

    function render() {
      renderHeaderAndFilters();

      const filteredSorted = applyAllFiltersAndSort(state.allItems);
      const { pageItems, total, maxPage } = getPaged(filteredSorted);

      // meta
      if (state.loading) resultsMeta.textContent = 'Loading...';
      else if (state.lastError) resultsMeta.textContent = `Error: ${state.lastError}`;
      else resultsMeta.textContent = `${pageItems.length} shown • ${total} total`;

      pageMeta.textContent = `Page ${state.page} of ${maxPage}`;
      prevPageBtn.disabled = state.page === 1 || state.loading;
      nextPageBtn.disabled = state.page === maxPage || state.loading;

      if (state.view === 'table') renderTable(pageItems);
      // kanban/calendar untouched in this request
    }

    async function loadAllRequests() {
      state.client = state.client || getClient();
      state.lastError = null;

      if (!state.client) {
        state.lastError = 'Supabase client not found. Check the supabase-js CDN script.';
        render();
        return;
      }

      state.loading = true;
      render();

      const { data, error } = await state.client
        .from(TABLE_NAME)
        .select('*');

      if (error) {
        console.error(error);
        state.lastError = error.message || String(error);
        state.allItems = [];
      } else {
        state.allItems = (data || []).map(normalizeRow);
      }

      state.loading = false;
      render();
    }

    // Minimal modal stubs (keep your original)
    function openModal(item = null) {
      formError.textContent = '';
      modalTitle.textContent = item ? 'Edit request' : 'New request';
      deleteBtn.classList.toggle('hidden', !item);
      requestId.value = item?.id || '';
      modalOverlay.classList.remove('hidden');
      modalOverlay.classList.add('flex');
      lucide.createIcons();
    }

    function closeModal() {
      modalOverlay.classList.add('hidden');
      modalOverlay.classList.remove('flex');
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Events
    document.querySelectorAll('.viewBtn').forEach(btn => {
      btn.addEventListener('click', () => setView(btn.dataset.view));
    });

    document.querySelectorAll('.filterChip').forEach(btn => {
      btn.addEventListener('click', () => {
        const f = btn.dataset.filter;
        state.filterStatusChip = (state.filterStatusChip === f) ? null : f;

        document.querySelectorAll('.filterChip')
          .forEach(x => x.classList.remove('bg-blue-600','text-white','border-blue-600'));

        if (state.filterStatusChip === f) btn.classList.add('bg-blue-600','text-white','border-blue-600');

        state.page = 1;
        render();
      });
    });

    clearFiltersBtn.addEventListener('click', () => {
      state.filterStatusChip = null;
      state.globalSearch = '';
      state.columnFilters = {};
      state.sortKey = null;
      state.sortDir = 'asc';
      state.page = 1;

      searchInput.value = '';
      document.querySelectorAll('.filterChip')
        .forEach(x => x.classList.remove('bg-blue-600','text-white','border-blue-600'));

      render();
    });

    searchInput.addEventListener('input', (e) => {
      state.globalSearch = e.target.value.trim();
      state.page = 1;
      render();
    });

    prevPageBtn.addEventListener('click', () => {
      if (state.page > 1) {
        state.page--;
        render();
      }
    });

    nextPageBtn.addEventListener('click', () => {
      const total = applyAllFiltersAndSort(state.allItems).length;
      const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (state.page < maxPage) {
        state.page++;
        render();
      }
    });

    newRequestBtn.addEventListener('click', () => openModal(null));
    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      createConstellationBackground();
      lucide.createIcons();
      state.client = getClient();
      await loadAllRequests();
    });
  </script>
</body>
</html>
