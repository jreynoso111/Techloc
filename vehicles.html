<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Control View</title>

  <!-- Styles & Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/scripts/supabaseClient.js"></script>
  <script src="assets/scripts/authManager.js"></script>
  <script src="assets/scripts/datasets.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { slate: { 850: '#1a2233', 950: '#020617' } }
        },
      },
    };
  </script>

  <style>
    :root {
      --left-sidebar-width: 360px;
      --right-sidebar-width: 360px;
      --towing-sidebar-width: 320px;
      --reseller-sidebar-width: 320px;
      --repair-sidebar-width: 320px;
      --locksmith-sidebar-width: 320px;
      --dispatcher-sidebar-width: 320px;
      --tire-sidebar-width: 320px;
      --inspector-sidebar-width: 320px;
      --custom-sidebar-width: 320px;
    }

    @media (max-width: 1280px) {
      :root {
        --left-sidebar-width: 320px;
        --right-sidebar-width: 320px;
        --towing-sidebar-width: 280px;
        --reseller-sidebar-width: 280px;
        --repair-sidebar-width: 280px;
        --locksmith-sidebar-width: 280px;
        --dispatcher-sidebar-width: 280px;
        --tire-sidebar-width: 280px;
        --inspector-sidebar-width: 280px;
        --custom-sidebar-width: 280px;
      }
    }

    @media (max-width: 1024px) {
      :root {
        --left-sidebar-width: 260px;
        --right-sidebar-width: 260px;
        --towing-sidebar-width: 240px;
        --reseller-sidebar-width: 240px;
        --repair-sidebar-width: 240px;
        --locksmith-sidebar-width: 240px;
        --dispatcher-sidebar-width: 240px;
        --tire-sidebar-width: 240px;
        --inspector-sidebar-width: 240px;
        --custom-sidebar-width: 240px;
      }

      header .max-w-7xl { row-gap: 1rem; }
    }

    /* Map */
    #tech-map { height: 100%; width: 100%; background-color: #0b1220; z-index: 1; position: absolute; inset: 0; }
    .leaflet-control-container .leaflet-top, .leaflet-control-container .leaflet-bottom { z-index: 500; }

    .resizable-sidebar {
      position: absolute;
      top: 0;
      bottom: 0;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.9);
      transition: transform 0.3s ease;
    }

    .collapsed-left { transform: translateX(calc(-1 * var(--left-sidebar-width))); }
    .collapsed-right { transform: translateX(var(--right-sidebar-width)); }
    .collapsed-towing { transform: translateX(calc(-1 * var(--towing-sidebar-width))); }
    .collapsed-reseller { transform: translateX(calc(-1 * var(--reseller-sidebar-width))); }
    .collapsed-repair { transform: translateX(calc(-1 * var(--repair-sidebar-width))); }
    .collapsed-locksmith { transform: translateX(calc(-1 * var(--locksmith-sidebar-width))); }
    .collapsed-dispatcher { transform: translateX(calc(-1 * var(--dispatcher-sidebar-width))); }
    .collapsed-tire { transform: translateX(calc(-1 * var(--tire-sidebar-width))); }
    .collapsed-inspector { transform: translateX(calc(-1 * var(--inspector-sidebar-width))); }
    .collapsed-custom { transform: translateX(calc(-1 * var(--custom-sidebar-width))); }

    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 10px;
      cursor: col-resize;
      z-index: 60;
      background: linear-gradient(90deg, transparent 30%, rgba(148, 163, 184, 0.12), transparent 70%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .resizable-sidebar:hover .resize-handle { opacity: 1; }
    .resize-handle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 28px;
      background: rgba(226, 232, 240, 0.35);
      border-radius: 9999px;
      transform: translate(-50%, -50%);
    }

    /* Legend */
    .legend-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 800;
      color: #cbd5e1;
    }

    .legend-heading::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 1px;
      border-radius: 9999px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0.6));
    }

    .legend-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      color: #e2e8f0;
      font-weight: 600;
      font-size: 11px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      border: 1px solid rgba(226, 232, 240, 0.65);
    }

    .legend-hotspot {
      position: relative;
      display: inline-flex;
      height: 14px;
      width: 14px;
      align-items: center;
      justify-content: center;
    }

    .legend-hotspot::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 9999px;
      border: 1px solid rgba(52, 211, 153, 0.7);
      background: rgba(16, 185, 129, 0.2);
    }

    .legend-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: rgba(248, 113, 113, 0.12);
      color: #fda4af;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid rgba(248, 113, 113, 0.4);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    /* Vehicle popup styling */
    .vehicle-popup .leaflet-popup-content-wrapper {
      background: #0b1120ee;
      color: #e2e8f0;
      border: 1px solid #1f2937;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
      overflow: hidden;
      width: min(260px, calc(100vw - 80px));
      max-width: min(260px, calc(100vw - 80px));
    }
    .vehicle-popup .leaflet-popup-content { margin: 0; width: 100%; }
    .vehicle-popup .leaflet-popup-tip { background: #0b1120; border: 1px solid #1f2937; }

    .service-mini-popup .leaflet-popup-content-wrapper {
      background: #0b1120f0;
      color: #e2e8f0;
      border: 1px solid #1f2937;
      border-radius: 10px;
      box-shadow: 0 18px 34px rgba(0,0,0,0.4);
      padding: 4px 6px;
      width: min(220px, calc(100vw - 80px));
      max-width: min(220px, calc(100vw - 80px));
    }

    .service-mini-popup .leaflet-popup-content { margin: 2px 4px; width: 100%; }
    .service-mini-popup .leaflet-popup-tip { background: #0b1120; border: 1px solid #1f2937; }

    .service-mini-card { font-family: 'Inter', sans-serif; min-width: 0; }
    .service-mini-title { margin: 0; font-size: 13px; font-weight: 800; color: #fff; line-height: 1.2; }
    .service-mini-location { margin: 2px 0 0; font-size: 11px; color: #cbd5e1; line-height: 1.3; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    .vehicle-cross-badge {
      color: #facc15;
      font-size: 12px;
      font-weight: 900;
      text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35);
      line-height: 1;
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      animation: vehicle-cross-shift 2.6s ease-in-out infinite alternate;
    }

    @keyframes vehicle-cross-shift {
      0% { color: #f59e0b; text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35); }
      100% { color: #fef3c7; text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35); }
    }

    .hotspot-pin {
      display: inline-flex;
      width: 16px;
      height: 16px;
      border-radius: 9999px;
      background: #ef4444;
      border: 2px solid #fff;
      box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.2), 0 14px 24px rgba(0, 0, 0, 0.45);
    }

    .vehicle-dot {
      filter: drop-shadow(0 8px 14px rgba(0, 0, 0, 0.45));
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .blacklist-marker {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ef4444;
      font-size: 18px;
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
      animation: blacklist-pulse 1.2s ease-in-out infinite alternate;
      transform: translateY(-2px);
    }

    @keyframes blacklist-pulse {
      0% { color: #ef4444; text-shadow: 0 6px 16px rgba(239, 68, 68, 0.35); }
      100% { color: #facc15; text-shadow: 0 6px 16px rgba(250, 204, 21, 0.35); }
    }

    .service-icon-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .service-cross {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ef4444;
      font-size: 11px;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(15, 23, 42, 0.45);
      pointer-events: none;
    }

    .distance-label-wrapper { pointer-events: none; }

    .distance-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--line-color, #e2e8f0);
      background: rgba(10, 14, 26, 0.95);
      border: 1px solid color-mix(in srgb, var(--line-color, #e2e8f0) 70%, transparent);
      border-radius: 9999px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }

    .sidebar-toggle-btn {
      position: relative;
      z-index: 500;
      padding: 0.5rem 0.75rem;
      font-size: 12px;
      font-weight: 700;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      transition: all 0.2s ease;
    }

    .sidebar-toggle-btn:hover { border-color: rgba(251, 191, 36, 0.7); color: #fef9c3; }

    .sidebar-toggle-btn.active {
      border-color: rgba(59, 130, 246, 0.8);
      color: #e0f2fe;
      background: linear-gradient(120deg, rgba(59, 130, 246, 0.25), rgba(14, 165, 233, 0.25));
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35);
    }

    .sidebar-toggle-group {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 500;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      pointer-events: none;
      align-items: flex-start;
    }

    .sidebar-toggle-group.items-end { align-items: flex-end; }

    .sidebar-toggle-group .sidebar-toggle-btn { position: relative; pointer-events: auto; align-self: flex-start; width: auto; }
    .sidebar-toggle-group.items-end .sidebar-toggle-btn { align-self: flex-end; }

    .sidebar-toggle-pill { padding: 0.4rem 0.85rem; font-size: 11px; }
  </style>
  <link rel="stylesheet" href="assets/visuals/theme.css" />
</head>
<body class="h-screen bg-slate-950 font-sans text-slate-50 overflow-hidden flex flex-col">
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-80 mix-blend-screen" aria-hidden="true">
    <canvas id="constellation-canvas" class="h-full w-full"></canvas>
  </div>
  <div data-auth-loading class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
    <div class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900 px-5 py-3 shadow-xl shadow-slate-900/60">
      <span class="h-3 w-3 animate-pulse rounded-full bg-blue-400"></span>
      <p class="text-sm font-semibold text-slate-200">Validating secure session…</p>
    </div>
  </div>

  <div data-auth-protected class="hidden h-full flex flex-col">

  <!-- App Header -->
  <header class="flex-none border-b border-slate-800 bg-slate-950/90 backdrop-blur z-50">
    <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-4 px-6 py-4 lg:flex-nowrap lg:gap-6">
      <a href="index.html" class="flex items-center gap-3">
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-sm font-black uppercase tracking-[0.2em] text-white">TL</span>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.18em] text-blue-200">TechLoc Network</p>
          <h1 class="text-lg font-black leading-tight text-white">Control View</h1>
        </div>
      </a>
      <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
        <a id="nav-home" href="index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
        <a id="nav-control-view" href="vehicles.html" class="hidden rounded-full px-3 py-1 bg-blue-600 text-white shadow shadow-blue-500/20">Control View</a>
        <a id="nav-services" href="services-request.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Service Requests</a>
        <a id="nav-dashboard" href="Admin/index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
        <a id="nav-about" href="about.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">About</a>
        <a id="nav-contact" href="contact.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Contact</a>
      </nav>
      <div class="flex items-center gap-3">
        <a id="nav-login" href="login.html" class="hidden rounded-full border border-blue-500 px-3 py-1 text-sm font-semibold text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
        <button id="nav-logout" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-sm font-semibold text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
        <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex" data-admin-actions>
          <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span> Live coverage
        </div>
      </div>
    </div>
  </header>

  <main id="map-layout" class="relative flex-1 overflow-hidden bg-slate-950">

    <div class="absolute inset-0">
      <div id="tech-map"></div>
    </div>

    <div id="selection-banner" class="pointer-events-auto absolute bottom-4 right-4 z-[450] hidden rounded-full border border-amber-400/60 bg-amber-500/15 px-4 py-2 text-xs font-semibold text-amber-100 shadow-lg shadow-amber-500/20 backdrop-blur">
      <span id="selection-text">Filtered by selection</span>
      <button id="clear-selection" class="ml-3 rounded-full bg-amber-400/20 px-3 py-1 text-[11px] font-bold text-amber-50 hover:bg-amber-400/30 border border-amber-300/70">Clear</button>
    </div>

    <div class="sidebar-toggle-group left-3">
      <button id="open-left-sidebar" class="sidebar-toggle-btn">GPS Technicians</button>
      <button id="open-towing-sidebar" class="sidebar-toggle-btn">Towing Companies</button>
      <button id="open-reseller-sidebar" class="sidebar-toggle-btn">Resellers</button>
      <button id="open-repair-sidebar" class="sidebar-toggle-btn">Repair Shops</button>
      <button id="open-locksmith-sidebar" class="sidebar-toggle-btn">Locksmiths</button>
      <button id="open-dispatcher-sidebar" class="sidebar-toggle-btn">Dispatchers</button>
      <button id="open-tire-sidebar" class="sidebar-toggle-btn">Tire Services</button>
      <button id="open-inspector-sidebar" class="sidebar-toggle-btn">Inspectors</button>
      <div id="custom-toggle-slot" class="flex flex-col gap-2 items-start self-start">
        <div id="custom-category-toggles" class="flex flex-col gap-2 items-start self-start"></div>
      </div>
    </div>
    <div id="map-visibility-group" class="pointer-events-none absolute top-4 left-1/2 z-[500] -translate-x-1/2 transform flex flex-wrap justify-center gap-2">
      <button id="toggle-hotspots" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active" aria-pressed="true">Hide Hotspot Areas</button>
      <button id="toggle-blacklist" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active" aria-pressed="true">Hide Blacklist Marks</button>
      <button id="toggle-vehicle-markers" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active" aria-pressed="true">Hide Vehicles Marks</button>
    </div>
    <div id="right-toggle-group" class="sidebar-toggle-group right-3 items-end">
      <button id="open-right-sidebar" class="sidebar-toggle-btn text-[11px]">Show Vehicles</button>
    </div>

    <!-- Floating Legend -->
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[400] w-[min(95vw,1100px)] rounded-2xl border border-slate-800 bg-slate-950/85 px-4 py-3 text-[11px] text-slate-200 shadow-xl backdrop-blur">
        <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between md:gap-8">
          <div class="flex-1 space-y-2">
            <p class="legend-heading">Services</p>
            <div class="flex flex-wrap items-center gap-2">
              <div class="legend-pill" data-legend="tech">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#3b82f6" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Tech
              </div>
              <div class="legend-pill" data-legend="towing">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#c084fc" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Towing
              </div>
              <div class="legend-pill" data-legend="reseller">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#34d399" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Reseller
              </div>
              <div class="legend-pill" data-legend="repair">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#fb923c" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Repair
              </div>
              <div class="legend-pill" data-legend="locksmith">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#facc15" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Locksmith
              </div>
              <div class="legend-pill" data-legend="dispatcher">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#38bdf8" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Dispatcher
              </div>
              <div class="legend-pill" data-legend="tire">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#a3e635" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Tire svc.
              </div>
              <div class="legend-pill" data-legend="inspector">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="#818cf8" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
                Inspectors
              </div>
              <div id="custom-legend-slot" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="flex-1 space-y-2 md:text-right">
            <p class="legend-heading md:justify-end">Vehicles</p>
            <div class="flex flex-wrap items-center gap-2 md:justify-end">
              <div class="legend-pill">
                <span class="legend-dot bg-red-500"></span>
                GPS Fix: All
              </div>
              <div class="legend-pill">
                <span class="legend-dot bg-emerald-400"></span>
                Fully Working
              </div>
              <div class="legend-pill">
                <span class="legend-dot bg-amber-500"></span>
                Other states
              </div>
              <div class="legend-pill">
                <span class="vehicle-cross-badge">✕</span>
                Not moving
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-2 md:justify-end">
              <div class="legend-pill">
                <span class="legend-dot bg-red-500 border-white/90"></span>
                Client location
              </div>
              <div class="legend-pill">
                <span class="legend-hotspot"></span>
                Hotspot Area
              </div>
              <div class="legend-pill">
                <span class="legend-badge">!</span>
                Blacklist
              </div>
            </div>
          </div>
        </div>
      </div>
    <!-- Sidebar: Control Panel -->
    <aside id="left-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-30 shadow-2xl" style="width: var(--left-sidebar-width)">
      <div class="resize-handle right-0"></div>

      <!-- Search -->
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-slate-400 mb-1">Client starting point</p>
            <h2 class="text-xl font-black text-white leading-tight">Find the nearest installer</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Installers</p>
              <p id="total-count" class="text-2xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-left" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize sidebar">-</button>
          </div>
        </div>
        <form id="search-form" class="relative">
          <input
            id="address-input"
            type="text"
            class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Ex: 33101, Phoenix, AZ..."
            autocomplete="off"
          >
          <button type="submit" id="search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
            CALCULATE
          </button>
        </form>

        <div class="flex justify-between items-end">
          <div id="search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          <div id="file-error" class="hidden text-xs text-red-300">Unable to read installer partner data.</div>
        </div>
      </div>

      <!-- Technicians List -->
      <div id="tech-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Waiting for installer data...</div>
      </div>
    </aside>

    <!-- Towing Sidebar -->
    <aside id="towing-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--towing-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-blue-300 mb-1">Towing partners</p>
            <h2 class="text-xl font-black text-white leading-tight">Towing companies nearby</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="towing-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-towing" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize towing sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="towing-search-form" class="relative">
            <input
              id="towing-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="towing-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="towing-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="towing-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter towing partners by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="towing-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Towing companies will appear here.</div>
      </div>
    </aside>

    <!-- Reseller Sidebar -->
    <aside id="reseller-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--reseller-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-emerald-300 mb-1">Reseller network</p>
            <h2 class="text-xl font-black text-white leading-tight">Nearby resellers</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="reseller-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-reseller" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize reseller sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="reseller-search-form" class="relative">
            <input
              id="reseller-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="reseller-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="reseller-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="reseller-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter resellers by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="reseller-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Resellers will appear here.</div>
      </div>
    </aside>

    <!-- Repair Shops Sidebar -->
    <aside id="repair-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--repair-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-orange-200 mb-1">Repair network</p>
            <h2 class="text-xl font-black text-white leading-tight">Repair shops nearby</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="repair-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-repair" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize repair sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="repair-search-form" class="relative">
            <input
              id="repair-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="repair-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="repair-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="repair-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter repair shops by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="repair-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Repair shops will appear here.</div>
      </div>
    </aside>

    <!-- Locksmith Sidebar -->
    <aside id="locksmith-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--locksmith-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-yellow-200 mb-1">Locksmith network</p>
            <h2 class="text-xl font-black text-white leading-tight">Locksmith coverage</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="locksmith-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-locksmith" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize locksmith sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="locksmith-search-form" class="relative">
            <input
              id="locksmith-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="locksmith-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="locksmith-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="locksmith-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter locksmiths by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="locksmith-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Locksmiths will appear here.</div>
      </div>
    </aside>

    <!-- Dispatcher Sidebar -->
    <aside id="dispatcher-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--dispatcher-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-sky-200 mb-1">Dispatch desks</p>
            <h2 class="text-xl font-black text-white leading-tight">Dispatcher partners</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="dispatcher-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-dispatcher" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize dispatcher sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="dispatcher-search-form" class="relative">
            <input
              id="dispatcher-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="dispatcher-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="dispatcher-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="dispatcher-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter dispatchers by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="dispatcher-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Dispatchers will appear here.</div>
      </div>
    </aside>

    <!-- Tire Services Sidebar -->
    <aside id="tire-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--tire-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-lime-200 mb-1">Tire services</p>
            <h2 class="text-xl font-black text-white leading-tight">Commercial tire partners</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="tire-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-tire" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize tire sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="tire-search-form" class="relative">
            <input
              id="tire-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="tire-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="tire-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="tire-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter tire services by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="tire-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Tire partners will appear here.</div>
      </div>
    </aside>

    <!-- Inspectors Sidebar -->
    <aside id="inspector-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--inspector-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-indigo-200 mb-1">Quality inspections</p>
            <h2 class="text-xl font-black text-white leading-tight">Field inspectors</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="inspector-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-inspector" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize inspector sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
          <form id="inspector-search-form" class="relative">
            <input
              id="inspector-address-input"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..."
              autocomplete="off"
            >
            <button type="submit" id="inspector-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>
          <div class="flex justify-between items-end">
            <div id="inspector-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          </div>
          <input
            id="inspector-filter"
            type="text"
            class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Filter inspectors by name, city, or state"
            autocomplete="off"
          >
        </div>
      </div>
      <div id="inspector-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Inspectors will appear here.</div>
      </div>
    </aside>

    <!-- Custom Services Sidebar -->
    <aside id="custom-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl hidden collapsed-custom" style="width: var(--custom-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-indigo-200 mb-1">Dynamic services</p>
            <h2 class="text-xl font-black text-white leading-tight">New categories</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="custom-count" class="text-xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-custom" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize custom services sidebar">-</button>
          </div>
        </div>
        <p class="mt-2 text-[12px] text-slate-400">Showing every new category detected in Supabase.</p>
      </div>
      <div id="custom-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">New categories will appear here.</div>
      </div>
    </aside>

    <!-- Vehicles Sidebar -->
    <aside id="right-sidebar" class="resizable-sidebar right-0 border-l border-slate-800 flex flex-col z-30 shadow-2xl" style="width: var(--right-sidebar-width)">
      <div class="resize-handle left-0"></div>
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-amber-300 mb-1">Control View</p>
            <h2 class="text-xl font-black text-white leading-tight">GPS issues around the network</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="vehicles-count" class="text-2xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-right" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize vehicles sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 relative">
          <input id="vehicle-search" type="text" placeholder="Search by VIN, model, city..." class="w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-10 py-2.5 text-sm text-white placeholder-slate-500 focus:border-amber-400 focus:ring-1 focus:ring-amber-400 outline-none transition-all">
          <i data-lucide="search" class="h-4 w-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2"></i>
        </div>
        <div class="mt-2 space-y-2 rounded-xl border border-slate-800 bg-slate-900/70 p-2.5">
          <div class="flex items-center justify-between text-[11px] font-semibold text-slate-300">
            <span>Vehicle filters</span>
            <button id="vehicle-filters-reset" class="text-amber-300 hover:text-amber-200 text-[10px] font-bold">Reset</button>
          </div>
          <div class="grid grid-cols-2 gap-1.5 text-[10px]">
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">Inv. Prep. Stat</span>
              <select id="filter-invprep" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                <option value="all">All</option>
              </select>
            </label>
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">GPS Fix</span>
              <select id="filter-gps" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                <option value="all">All</option>
              </select>
            </label>
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">Moving</span>
              <select id="filter-moving" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                <option value="all">All</option>
                <option value="moving">Moving</option>
                <option value="stopped">Not moving</option>
              </select>
            </label>
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">Deal status</span>
              <select id="filter-deal-status" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                <option value="all">All</option>
              </select>
            </label>
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">PT Status</span>
              <select id="filter-pt" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                <option value="all">All</option>
              </select>
            </label>
            <label class="space-y-0.5">
              <span class="block text-slate-400 font-semibold">Deal completion %</span>
              <div class="flex items-center gap-1.5 text-[10px] text-slate-300">
                <input id="filter-deal-min" type="number" min="0" max="100" step="1" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white focus:border-amber-400 focus:ring-1 focus:ring-amber-400" placeholder="0">
                <span class="text-slate-500">to</span>
                <input id="filter-deal-max" type="number" min="0" max="100" step="1" class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white focus:border-amber-400 focus:ring-1 focus:ring-amber-400" placeholder="100">
              </div>
            </label>
          </div>
        </div>
      </div>
      <div id="vehicle-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Waiting for vehicle data...</div>
      </div>
    </aside>
  </main>

  <!-- Vehicle detail modal -->
  <div id="vehicle-modal" class="fixed inset-0 z-[500] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-slate-800 bg-slate-950 shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between border-b border-slate-800 bg-slate-900/70 px-4 py-3">
        <div>
          <p class="text-[10px] font-black uppercase tracking-[0.18em] text-amber-300">Vehicle details</p>
          <h3 id="vehicle-modal-title" class="text-lg font-bold text-white"></h3>
        </div>
        <button id="vehicle-modal-close" class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:border-amber-400 hover:text-amber-200 transition-colors">Close</button>
      </div>
      <div class="max-h-[70vh] overflow-y-auto p-4" id="vehicle-modal-body"></div>
    </div>
  </div>

  <!-- Vehicle edit modal (admin only) -->
  <div id="vehicle-edit-modal" class="fixed inset-0 z-[600] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-4xl rounded-2xl border border-amber-600/40 bg-slate-950 shadow-2xl shadow-amber-500/20 overflow-hidden">
      <div class="flex items-center justify-between border-b border-amber-900/40 bg-amber-500/10 px-4 py-3">
        <div>
          <p class="text-[10px] font-black uppercase tracking-[0.18em] text-amber-300">Editar vehículo</p>
          <h3 id="vehicle-edit-title" class="text-lg font-bold text-white"></h3>
        </div>
        <button id="vehicle-edit-close" class="rounded-lg border border-amber-700/60 bg-amber-600/15 px-3 py-1.5 text-xs font-semibold text-amber-100 hover:bg-amber-500/25 transition-colors">Cerrar</button>
      </div>
      <form id="vehicle-edit-form" class="max-h-[70vh] overflow-y-auto p-4 space-y-4">
        <div id="vehicle-edit-status" class="hidden rounded-lg border px-3 py-2 text-xs font-semibold"></div>
        <div class="grid grid-cols-1 gap-3 md:grid-cols-2" id="vehicle-edit-fields"></div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="vehicle-edit-cancel" class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-amber-400 hover:text-amber-200 transition-colors">Cancelar</button>
          <button type="submit" id="vehicle-edit-save" class="inline-flex items-center gap-2 rounded-lg border border-amber-500/60 bg-amber-500/20 px-4 py-2 text-xs font-bold text-amber-100 hover:bg-amber-500/30 transition-colors">
            <i data-lucide="save" class="h-4 w-4"></i>
            Guardar cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Service edit modal (admin only) -->
  <div id="service-edit-modal" class="fixed inset-0 z-[600] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-emerald-500/30 bg-slate-950 shadow-2xl shadow-emerald-900/30 overflow-hidden">
      <div class="flex items-center justify-between border-b border-emerald-900/40 bg-emerald-500/10 px-4 py-3">
        <div>
          <p class="text-[10px] font-black uppercase tracking-[0.18em] text-emerald-300">Editar servicio</p>
          <h3 id="service-edit-title" class="text-lg font-bold text-white"></h3>
        </div>
        <button id="service-edit-close" class="rounded-lg border border-emerald-700/60 bg-emerald-600/15 px-3 py-1.5 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/25 transition-colors">Cerrar</button>
      </div>
      <form id="service-edit-form" class="max-h-[70vh] overflow-y-auto p-4 space-y-4">
        <div id="service-edit-status" class="hidden rounded-lg border px-3 py-2 text-xs font-semibold"></div>
        <div class="grid grid-cols-1 gap-3 md:grid-cols-2" id="service-edit-fields"></div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="service-edit-cancel" class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-emerald-400 hover:text-emerald-200 transition-colors">Cancelar</button>
          <button type="submit" id="service-edit-save" class="inline-flex items-center gap-2 rounded-lg border border-emerald-500/60 bg-emerald-500/20 px-4 py-2 text-xs font-bold text-emerald-100 hover:bg-emerald-500/30 transition-colors">
            <i data-lucide="save" class="h-4 w-4"></i>
            Guardar servicio
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- Base Config ---
    const STATE_CENTERS = {
      'AL': [32.8067, -86.7911], 'AK': [61.3707, -152.4044], 'AZ': [33.7298, -111.4312], 'AR': [34.9697, -92.3731],
      'CA': [36.1162, -119.6816], 'CO': [39.0598, -105.3111], 'CT': [41.5978, -72.7554], 'DE': [39.3185, -75.5071],
      'FL': [27.7663, -81.6868], 'GA': [33.0406, -83.6431], 'HI': [21.0943, -157.4983], 'ID': [44.2405, -114.4788],
      'IL': [40.3495, -88.9861], 'IN': [39.8494, -86.2583], 'IA': [42.0115, -93.2105], 'KS': [38.5266, -96.7265],
      'KY': [37.6681, -84.6701], 'LA': [31.1695, -91.8678], 'ME': [44.6939, -69.3819], 'MD': [39.0639, -76.8021],
      'MA': [42.2302, -71.5301], 'MI': [43.3266, -84.5361], 'MN': [45.6945, -93.9002], 'MS': [32.7416, -89.6787],
      'MO': [38.4561, -92.2884], 'MT': [46.9219, -110.4544], 'NE': [41.1254, -98.2681], 'NV': [38.3135, -117.0554],
      'NH': [43.4525, -71.5639], 'NJ': [40.2989, -74.5210], 'NM': [34.8405, -106.2485], 'NY': [42.1657, -74.9481],
      'NC': [35.6301, -79.8064], 'ND': [47.5289, -99.7840], 'OH': [40.3888, -82.7649], 'OK': [35.5653, -96.9289],
      'OR': [43.9336, -120.5583], 'PA': [40.5908, -77.2098], 'RI': [41.6809, -71.5118], 'SC': [33.8569, -80.9450],
      'SD': [44.2998, -99.4388], 'TN': [35.7478, -86.6923], 'TX': [31.0545, -97.5635], 'UT': [40.1500, -111.8624],
      'VT': [44.0459, -72.7107], 'VA': [37.7693, -78.1699], 'WA': [47.4009, -121.4905], 'WV': [38.4912, -80.9545],
      'WI': [44.2685, -89.6165], 'WY': [42.7559, -107.3025], 'DC': [38.9072, -77.0369]
    };

    let map, techLayer, targetLayer, connectionLayer, serviceLayer, serviceConnectionLayer, vehicleLayer, highlightLayer, towingLayer, resellerLayer, repairLayer, locksmithLayer, dispatcherLayer, tireLayer, inspectorLayer, customServiceLayer, hotspotLayer, blacklistLayer;
    let technicians = [];
    let blacklistSites = [];
    let hotspots = [];
    let towingCompanies = [];
    let resellers = [];
    let repairShops = [];
    let locksmiths = [];
    let dispatchers = [];
    let tirePartners = [];
    let inspectors = [];
    let customServices = [];
    let customCategories = new Map();
    let customToggleRef = null;
    let selectedCustomCategoryKey = null;
    let vehicles = [];
    let vehicleHeaders = [];
    let vehicleMarkersVisible = true;
    let hotspotsVisible = true;
    let blacklistMarkersVisible = true;
    const serviceHeadersByCategory = {};
    let editingService = null;
    let editingVehicleId = null;
    let selectedVehicleId = null;
    let selectedTechId = null;
    const vehicleMarkers = new Map();
    let sidebarStateController = null;
    let techSidebarVisible = false;
    let towingSidebarVisible = false;
    let resellerSidebarVisible = false;
    let repairSidebarVisible = false;
    let locksmithSidebarVisible = false;
    let dispatcherSidebarVisible = false;
    let tireSidebarVisible = false;
    let inspectorSidebarVisible = false;
    let customSidebarVisible = false;
    let activeLeftPanel = null;
    let lastClientLocation = null;
    let renderedTechIds = '';
    let lastOriginPoint = null;
    const serviceFilters = {
      tech: '',
      towing: '',
      reseller: '',
      repair: '',
      locksmith: '',
      dispatcher: '',
      tire: '',
      inspector: ''
    };
    const vehicleFilters = {
      invPrep: 'all',
      gpsFix: 'all',
      moving: 'all',
      dealStatus: 'all',
      ptStatus: 'all',
      dealMin: 0,
      dealMax: 100,
    };

    const MILES_TO_METERS = 1609.34;
    const HOTSPOT_RADIUS_MILES = 50;
    const selectedServiceByType = {};
    const locationCache = new Map();

    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';
    const supabaseClient =
      window.supabaseClient ||
      (window.supabase?.createClient
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
        : null);
    const SERVICE_TABLE = 'Services';
    const SERVICE_CATEGORIES = {
      technicians: 'GPS Technician',
      towing: 'Towing',
      resellers: 'dealer/auction',
      repair: 'Repair Shop',
      locksmiths: 'Locksmiths',
      dispatchers: 'Dispatcher',
      tire: 'Tires Services',
      inspectors: 'inspector',
    };

    const TABLES = {
      services: SERVICE_TABLE,
      vehicles: 'vehicles',
      hotspots: 'Hotspots',
      blacklist: 'Seervices_Blacklist'
    };

    const getServiceCategoryLabel = (type) => {
      const key = SERVICE_CATEGORY_KEYS_BY_TYPE[type];
      return key ? SERVICE_CATEGORIES[key] : '';
    };

    const normalizeCategoryLabel = (value = '') => `${value}`.trim();
    const getCustomCategoryKey = (label = '') => normalizeKey(label) || `custom-${customCategories.size + 1}`;
    const ensureCustomCategoryMeta = (label = '') => {
      const normalizedLabel = normalizeCategoryLabel(label) || 'Custom';
      const key = getCustomCategoryKey(normalizedLabel);
      if (!customCategories.has(key)) {
        const color = CUSTOM_COLOR_PALETTE[customCategories.size % CUSTOM_COLOR_PALETTE.length] || SERVICE_COLORS.custom;
        const layer = map ? L.layerGroup() : null;
        customCategories.set(key, { key, label: normalizedLabel, color, layer });
      }
      return customCategories.get(key);
    };

    function rebuildCustomCategoryToggles() {
      const slot = document.getElementById('custom-category-toggles');
      if (!slot) return;

      slot.innerHTML = '';
      selectedCustomCategoryKey = null;

      if (!customCategoryLabels.size) {
        slot.classList.add('hidden');
        customToggleRef = null;
        return;
      }

      const buttons = [];

      const updateCustomToggleStates = () => {
        buttons.forEach((button) => {
          const key = button.dataset.categoryKey || '';
          const isActive = key && selectedCustomCategoryKey === key;
          button.classList.toggle('active', isActive);
        });
      };

      const buildButton = (label, key = null) => {
        const button = document.createElement('button');
        button.className = 'sidebar-toggle-btn';
        button.textContent = label;
        button.dataset.categoryKey = key || '';
        button.addEventListener('click', () => {
          selectedCustomCategoryKey = selectedCustomCategoryKey === key ? null : key;
          sidebarStateController?.setState?.('custom', true);
          renderCustomServices();
          updateCustomToggleStates();
        });
        slot.appendChild(button);
        buttons.push(button);
      };

      Array.from(customCategoryLabels)
        .sort((a, b) => `${a}`.localeCompare(`${b}`))
        .forEach((label) => {
          const meta = ensureCustomCategoryMeta(label);
          buildButton(meta.label, meta.key);
        });

      customToggleRef = buttons[0] || null;
      slot.classList.remove('hidden');
      updateCustomToggleStates();
      sidebarStateController?.updateTogglePositions?.();
    }

    const isServiceTypeEnabled = (type) => enabledServiceTypes.has(type);

    const getEnabledServiceTypes = () => SERVICE_TYPES.filter(isServiceTypeEnabled);

    async function syncAvailableServiceTypes() {
      if (!supabaseClient) return;

      try {
        const { data, error } = await supabaseClient.from(SERVICE_TABLE).select('category');
        if (error) throw error;

        const rawCategories = new Map();
        (data || []).forEach((row) => {
          const raw = `${row?.category ?? ''}`.trim();
          if (!raw) return;
          const key = raw.toLowerCase();
          if (!rawCategories.has(key)) rawCategories.set(key, raw);
        });

        const normalizedCategories = new Set(rawCategories.keys());

        const detected = SERVICE_TYPES.filter((type) => {
          if (type === 'custom') return false;
          const label = `${getServiceCategoryLabel(type)}`.toLowerCase();
          return label && normalizedCategories.has(label);
        });

        const knownLabels = new Set(Object.values(SERVICE_CATEGORIES).map((c) => `${c}`.trim().toLowerCase()));
        const customLabelMap = new Map();
        rawCategories.forEach((original, key) => {
          if (!knownLabels.has(key)) customLabelMap.set(key, original);
        });
        customCategoryLabels = new Set(customLabelMap.values());

        if (customCategoryLabels.size) detected.push('custom');

        rebuildCustomCategoryToggles();

        enabledServiceTypes = detected.length ? new Set(detected) : new Set();
      } catch (err) {
        console.warn(`Service availability warning: ${err.message}`);
      }

      updateServiceVisibilityUI();
    }

    const updateServiceVisibilityUI = () => {
      SERVICE_TYPES.forEach((type) => {
        const config = SERVICE_UI_CONFIG[type];
        if (!config) return;

        const enabled = isServiceTypeEnabled(type);
        if (type === 'custom') {
          const slot = document.getElementById('custom-category-toggles');
          if (slot) slot.classList.toggle('hidden', !enabled || !customCategoryLabels.size);
        }

        const toggle = config.toggleId ? document.getElementById(config.toggleId) : null;
        const sidebar = document.getElementById(config.sidebarId);
        const layer = config.layer?.();

        if (toggle) {
          toggle.classList.toggle('hidden', !enabled);
          toggle.setAttribute('aria-hidden', (!enabled).toString());
        }

        if (sidebar) {
          sidebar.classList.toggle('hidden', !enabled);
          if (!enabled && config.collapsedClass) sidebar.classList.add(config.collapsedClass);
        }

        if (config.legendSelector) {
          document.querySelectorAll(config.legendSelector).forEach((el) => {
            el.classList.toggle('hidden', !enabled);
          });
        }

        if (!enabled) layer?.clearLayers?.();
      });
    };

    const setServiceHeaders = (category, data = []) => {
      if (!category || !Array.isArray(data) || !data.length) return;
      serviceHeadersByCategory[category] = Object.keys(data[0]);
    };

    const getServiceHeaders = (category) => serviceHeadersByCategory[category] || [];

    const isAdminUser = () => `${window.currentUserRole || ''}`.toLowerCase() === 'administrator';

    const toStateCode = (value = '') => {
      if (!value) return '';
      const match = `${value}`.match(/([A-Z]{2})/i);
      return match ? match[1].toUpperCase() : '';
    };

    const normalizeKey = (key = '') => `${key}`.trim().toLowerCase().replace(/\s+/g, '_');

    const escapeHTML = (value = '') => `${value}`
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const getField = (row, ...keys) => {
      for (const key of keys) {
        const rawValue = row?.[key];
        if (rawValue !== undefined && rawValue !== null && String(rawValue).trim() !== '') return rawValue;

        const lowerKey = typeof key === 'string' ? key.toLowerCase() : key;
        const lowerValue = row?.[lowerKey];
        if (lowerValue !== undefined && lowerValue !== null && String(lowerValue).trim() !== '') return lowerValue;

        const snakeKey = normalizeKey(key);
        const snakeValue = row?.[snakeKey];
        if (snakeValue !== undefined && snakeValue !== null && String(snakeValue).trim() !== '') return snakeValue;
      }

      if (row?.metadata) {
        for (const key of keys) {
          const metaValue = row.metadata?.[key] ?? row.metadata?.[normalizeKey(key)];
          if (metaValue !== undefined && metaValue !== null && String(metaValue).trim() !== '') return metaValue;
        }
      }

      return '';
    };

    const formatPhoneNumber = (value) => {
      const raw = String(value ?? '').replace(/\s+/g, ' ').trim();
      if (!raw) return { display: '', tel: '' };

      const digits = raw.replace(/\D+/g, '');

      if (digits.length === 11 && digits.startsWith('1')) {
        const ten = digits.slice(1);
        return { display: `${ten.slice(0, 3)}-${ten.slice(3, 6)}-${ten.slice(6)}`, tel: digits };
      }

      if (digits.length === 10) {
        return { display: `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`, tel: digits };
      }

      const compact = raw.replace(/\s+/g, '');
      return { display: digits || compact, tel: digits || compact };
    };

    const deriveCoords = ({ zip = '', city = '', stateCode = '', fallbackLatLng = null, seed = 0 }) => {
      if (fallbackLatLng && Number.isFinite(fallbackLatLng.lat) && Number.isFinite(fallbackLatLng.lng)) {
        return { lat: fallbackLatLng.lat, lng: fallbackLatLng.lng };
      }

      const base = (() => {
        if (STATE_CENTERS[stateCode]) return STATE_CENTERS[stateCode];
        return STATE_CENTERS.DEFAULT || [39.8, -98.5];
      })();

      const cleanZip = `${zip}`.trim();
      if (cleanZip) {
        const zipKey = `${cleanZip}-${stateCode}`.toLowerCase();
        if (locationCache.has(zipKey)) return locationCache.get(zipKey);

        const zipNumber = parseInt(cleanZip.replace(/\D/g, ''), 10);
        if (Number.isFinite(zipNumber)) {
          const angle = (zipNumber % 360) * (Math.PI / 180);
          const radius = 0.15 + ((zipNumber % 700) / 1200);
          const coords = { lat: base[0] + (radius * Math.cos(angle)), lng: base[1] + (radius * Math.sin(angle) * 1.3) };
          locationCache.set(zipKey, coords);
          return coords;
        }
      }

      const cleanCity = `${city}`.trim().toLowerCase();
      if (cleanCity) {
        const cityKey = `${cleanCity}-${stateCode}`;
        if (locationCache.has(cityKey)) return locationCache.get(cityKey);

        const cityHash = cleanCity.split('').reduce((acc, ch) => acc + ch.charCodeAt(0), seed || 1);
        const angle = (cityHash % 360) * (Math.PI / 180);
        const radius = 0.18 + ((cityHash % 500) / 1400);
        const coords = { lat: base[0] + (radius * Math.cos(angle)), lng: base[1] + (radius * Math.sin(angle) * 1.25) };
        locationCache.set(cityKey, coords);
        return coords;
      }

      return { lat: base[0], lng: base[1] };
    };

    const resolveCoords = (row, { zip = '', city = '', stateCode = '', seed = 0, fallbackLatLng = null } = {}) => {
      const rawLat = parseFloat(getField(row, 'lat', 'Lat', 'latitude', 'Latitude'));
      const rawLng = parseFloat(getField(row, 'lng', 'Lng', 'long', 'Long', 'longitude', 'Longitude'));
      const hasExactCoords = Number.isFinite(rawLat) && Number.isFinite(rawLng) && rawLat !== 0 && rawLng !== 0;
      if (hasExactCoords) {
        return { coords: { lat: rawLat, lng: rawLng }, hasExactCoords: true, accuracy: 'exact' };
      }

      if (fallbackLatLng && Number.isFinite(fallbackLatLng.lat) && Number.isFinite(fallbackLatLng.lng)) {
        return { coords: fallbackLatLng, hasExactCoords: true, accuracy: 'exact' };
      }

      const coordsFromZip = deriveCoords({ zip, stateCode, seed });
      if (`${zip}`.trim()) {
        return { coords: coordsFromZip, hasExactCoords: false, accuracy: 'zip' };
      }

      const coordsFromCity = deriveCoords({ city, stateCode, seed });
      if (`${city}`.trim()) {
        return { coords: coordsFromCity, hasExactCoords: false, accuracy: 'city' };
      }

      return { coords: deriveCoords({ stateCode, seed }), hasExactCoords: false, accuracy: 'state' };
    };

    const normalizeInstaller = (row, idx = 0) => {
      const company = getField(row, 'company_name', 'Installation Company', 'Company', 'company', 'name');
      const stateCode = toStateCode(getField(row, 'State', 'state', 'state_code')) || 'US';
      const city = getField(row, 'City', 'city');
      const zip = getField(row, 'Zip', 'zip');
      const { coords, hasExactCoords, accuracy } = resolveCoords(row, { zip, city, stateCode, seed: idx });
      const { display: phone, tel: phoneDial } = formatPhoneNumber(getField(row, 'Phone', 'phone'));
      return {
        id: row?.id ?? idx,
        type: 'technicians',
        name: company || 'Installer',
        company: company || 'Installer',
        email: getField(row, 'Email', 'email') || '-',
        phone: phone || '-',
        phoneDial,
        city: city || '',
        state: stateCode,
        zip: zip || '',
        lat: coords.lat,
        lng: coords.lng,
        locationAccuracy: accuracy,
        details: row || {},
        seed: idx,
      };
    };

    const normalizePartner = (row, type = 'towing', idx = 0) => {
      const stateCode = toStateCode(getField(row, 'state', 'region', 'State', 'Region', 'state_code')) || 'US';
      const city = getField(row, 'city', 'City');
      const zip = getField(row, 'zip', 'Zip', 'zipcode', 'postal_code');
      const { coords, hasExactCoords, accuracy } = resolveCoords(row, { zip, city, stateCode, seed: idx });
      const { display: phone, tel: phoneDial } = formatPhoneNumber(getField(row, 'phone', 'Phone'));
      return {
        id: row?.id ?? `${type}-${idx}`,
        type,
        company: getField(row, 'company_name', 'company', 'Company', 'name') || 'Partner',
        region: getField(row, 'region', 'Region', 'state') || stateCode,
        phone,
        phoneDial,
        contact: getField(row, 'contact', 'Contact', 'contact_name'),
        availability: getField(row, 'availability', 'tier', 'Availability'),
        authorization: getField(row, 'authorization', 'Authorization'),
        notes: getField(row, 'notes', 'Notes'),
        city: city || '',
        state: stateCode,
        zip: zip || '',
        lat: coords.lat,
        lng: coords.lng,
        locationAccuracy: accuracy,
        details: row,
        seed: idx
      };
    };

    const normalizeVehicle = (row, idx = 0) => {
      const stateCode = toStateCode(getField(row, 'State Loc', 'State', 'state', 'state_code'));
      const rawLat = parseFloat(getField(row, 'Lat', 'lat'));
      const rawLng = parseFloat(getField(row, 'Long', 'Lng', 'long', 'lng'));
      const hasExactCoords = Number.isFinite(rawLat) && Number.isFinite(rawLng) && rawLat !== 0 && rawLng !== 0;
      const zip = getField(row, 'PT ZipCode', 'Zip', 'zip');
      const city = getField(row, 'PT City', 'City', 'city');
      const { coords, accuracy } = resolveCoords(row, { zip, city, stateCode, seed: idx, fallbackLatLng: hasExactCoords ? { lat: rawLat, lng: rawLng } : null });
      const dealCompletion = getField(row, 'Deal Completion', 'Deal completion', 'Deal completition', 'Remaining');
      return {
        id: row?.id ?? idx,
        status: getField(row, 'Deal Status', 'status') || 'ACTIVE',
        invPrepStatus: getField(row, 'INV Prep Stat', 'Inv. Prep. Stat.', 'Inv Prep Stat'),
        dealCompletion,
        type: getField(row, 'Unit Type', 'type') || 'Vehicle',
        year: getField(row, 'Model Year', 'year'),
        model: getField(row, 'Model', 'model') || 'Vehicle',
        vin: getField(row, 'ShortVIN', 'VIN', 'vin') || 'N/A',
        gpsFix: getField(row, 'GPS Fix', 'gps_fix'),
        gpsReason: getField(row, 'GPS Fix Reason', 'gps_fix_reason'),
        gpsMoving: getField(row, 'GPS Moving', 'gps_moving'),
        moving: getField(row, 'Moving', 'moving'),
        movingCalc: getField(row, 'Moving (Calc)', 'moving_calc'),
        ptStatus: getField(row, 'PT Status', 'pt_status'),
        ptSerial: getField(row, 'PT Serial ', 'PT Serial', 'pt_serial'),
        encoreSerial: getField(row, 'Encore Serial', 'encore_serial'),
        lastRead: getField(row, 'PT Last Read', 'pt_last_read'),
        state: stateCode,
        city: city || '',
        zipcode: zip || '',
        lat: coords.lat,
        lng: coords.lng,
        locationAccuracy: accuracy,
        customerId: getField(row, 'Customer ID', 'Customer', 'customer_id'),
        customer: getField(row, 'PT City', 'City', 'city')
          ? `${getField(row, 'PT City', 'City', 'city')}, ${stateCode || 'US'}`
          : stateCode || 'Unknown area',
        lastLocation: `${getField(row, 'PT City', 'City', 'city') || 'Unknown'}, ${stateCode || 'USA'}${zip ? ' ' + zip : ''}`.trim(),
        payment: getField(row, 'Payment Schedule', 'payment'),
        details: row,
      };
    };

    const normalizeHotspot = (row, idx = 0) => {
      const stateCode = toStateCode(getField(row, 'state', 'State')) || 'US';
      const city = getField(row, 'city', 'City');
      const zip = getField(row, 'zip', 'Zip');
      const rawLat = parseFloat(getField(row, 'lat', 'Lat'));
      const rawLng = parseFloat(getField(row, 'long', 'Long', 'lng', 'Lng', 'longitude', 'Longitude'));
      const rawRadius = parseFloat(getField(row, 'radius', 'Radius'));
      const fallbackLatLng = Number.isFinite(rawLat) && Number.isFinite(rawLng) ? { lat: rawLat, lng: rawLng } : null;

      const { coords } = resolveCoords(row, { zip, city, stateCode, seed: idx, fallbackLatLng });

      return {
        id: row?.id ?? `hotspot-${idx}`,
        city: city || '',
        state: stateCode,
        zip: zip || '',
        lat: coords.lat,
        lng: coords.lng,
        radiusMiles: Number.isFinite(rawRadius) ? rawRadius : HOTSPOT_RADIUS_MILES,
      };
    };

    const normalizeBlacklistEntry = (row, idx = 0) => {
      // Use explicit lat/long columns from Supabase (no geocoding fallbacks)
      const lat = parseFloat(getField(row, 'lat', 'Lat', 'latitude', 'Latitude'));
      const lng = parseFloat(getField(row, 'long', 'Long', 'lng', 'Lng', 'longitude', 'Longitude'));

      return {
        id: row?.id ?? `blacklist-${idx}`,
        company: getField(row, 'company_name', 'Company', 'company', 'name'),
        assocUnit: getField(row, 'Assoc.Unit', 'assoc_unit', 'AssocUnit'),
        note: getField(row, 'Note', 'note', 'notes', 'Notes'),
        lat,
        lng,
      };
    };

    const hasValidCoords = (entry) => Number.isFinite(entry?.lat) && Number.isFinite(entry?.lng) && entry.lat !== 0 && entry.lng !== 0;

    const getLocationNote = (accuracy = '') => {
      if (accuracy === 'zip') return 'Ubicación aproximada (Basada en Zip Code)';
      if (accuracy === 'city') return 'Ubicación aproximada (Basada en Ciudad)';
      if (accuracy === 'state') return 'Ubicación aproximada (Centro del estado)';
      return '';
    };

    const getAccuracyDot = (accuracy = '') => {
      return accuracy === 'exact' ? 'bg-emerald-300' : 'bg-amber-300';
    };

    const iconLib = typeof window !== 'undefined' && window.lucide && typeof window.lucide.createIcons === 'function'
      ? window.lucide
      : { createIcons: () => {} };

    const SERVICE_TYPES = ['tech', 'towing', 'reseller', 'repair', 'locksmith', 'dispatcher', 'tire', 'inspector', 'custom'];
    const SERVICE_CATEGORY_KEYS_BY_TYPE = {
      tech: 'technicians',
      towing: 'towing',
      reseller: 'resellers',
      repair: 'repair',
      locksmith: 'locksmiths',
      dispatcher: 'dispatchers',
      tire: 'tire',
      inspector: 'inspectors'
    };
    const SERVICE_COLORS = {
      tech: '#3b82f6',
      towing: '#c084fc',
      reseller: '#34d399',
      repair: '#fb923c',
      locksmith: '#facc15',
      dispatcher: '#38bdf8',
      tire: '#a3e635',
      inspector: '#818cf8',
      custom: '#f472b6'
    };
    const SERVICE_SIDEBAR_KEYS = {
      tech: 'left',
      towing: 'towing',
      reseller: 'reseller',
      repair: 'repair',
      locksmith: 'locksmith',
      dispatcher: 'dispatcher',
      tire: 'tire',
      inspector: 'inspector',
      custom: 'custom'
    };

    const SERVICE_UI_CONFIG = {
      tech: { sidebarId: 'left-sidebar', toggleId: 'open-left-sidebar', legendSelector: '[data-legend="tech"]', collapsedClass: 'collapsed-left', layer: () => techLayer },
      towing: { sidebarId: 'towing-sidebar', toggleId: 'open-towing-sidebar', legendSelector: '[data-legend="towing"]', collapsedClass: 'collapsed-towing', layer: () => towingLayer },
      reseller: { sidebarId: 'reseller-sidebar', toggleId: 'open-reseller-sidebar', legendSelector: '[data-legend="reseller"]', collapsedClass: 'collapsed-reseller', layer: () => resellerLayer },
      repair: { sidebarId: 'repair-sidebar', toggleId: 'open-repair-sidebar', legendSelector: '[data-legend="repair"]', collapsedClass: 'collapsed-repair', layer: () => repairLayer },
      locksmith: { sidebarId: 'locksmith-sidebar', toggleId: 'open-locksmith-sidebar', legendSelector: '[data-legend="locksmith"]', collapsedClass: 'collapsed-locksmith', layer: () => locksmithLayer },
      dispatcher: { sidebarId: 'dispatcher-sidebar', toggleId: 'open-dispatcher-sidebar', legendSelector: '[data-legend="dispatcher"]', collapsedClass: 'collapsed-dispatcher', layer: () => dispatcherLayer },
      tire: { sidebarId: 'tire-sidebar', toggleId: 'open-tire-sidebar', legendSelector: '[data-legend="tire"]', collapsedClass: 'collapsed-tire', layer: () => tireLayer },
      inspector: { sidebarId: 'inspector-sidebar', toggleId: 'open-inspector-sidebar', legendSelector: '[data-legend="inspector"]', collapsedClass: 'collapsed-inspector', layer: () => inspectorLayer },
      custom: { sidebarId: 'custom-sidebar', toggleId: null, legendSelector: '#custom-legend-slot [data-legend]', collapsedClass: 'collapsed-custom', layer: () => customServiceLayer }
    };

    let enabledServiceTypes = new Set(SERVICE_TYPES);
    let customCategoryLabels = new Set();
    const CUSTOM_COLOR_PALETTE = ['#f472b6', '#f97316', '#14b8a6', '#a78bfa', '#ec4899', '#10b981', '#fb7185', '#22d3ee'];

    const isUnauthorizedPartner = (partner = {}) => {
      const value = `${partner.authorization || partner.details?.authorization || ''}`.trim().toLowerCase();
      return value === 'no' || value === 'unauthorized';
    };

    const getPartnerColor = (partner, defaultColor) => isUnauthorizedPartner(partner) ? '#94a3b8' : defaultColor;

    const formatPartnerLocation = (partner = {}) => {
      const cityText = partner.city ? `${partner.city}, ` : '';
      const stateText = partner.state || partner.region || 'US';
      const zipText = partner.zip ? ` ${partner.zip}` : '';
      return `${cityText}${stateText}${zipText}`.trim();
    };

    const showServicePreviewCard = (partner) => {
      if (!map || !partner) return;
      const locationText = formatPartnerLocation(partner) || 'Location unavailable';
      const popup = L.popup({
        className: 'service-mini-popup',
        closeButton: true,
        autoClose: true,
        closeOnClick: true,
        maxWidth: 220,
        offset: [0, -6]
      })
        .setLatLng([partner.lat, partner.lng])
        .setContent(`
          <div class="service-mini-card">
            <p class="service-mini-title">${partner.company || 'Service'}</p>
            <p class="service-mini-location">${locationText}</p>
          </div>
        `);

      popup.openOn(map);
    };

    const createServiceIcon = (color, { unauthorized = false } = {}) => L.divIcon({
      className: 'service-triangle-icon',
      html: `<div class="service-icon-wrapper"><svg width="18" height="16" viewBox="0 0 18 16" fill="${color}" stroke="#0f172a" stroke-width="1.4" xmlns="http://www.w3.org/2000/svg"><path d="M9 1.1L17 14.8H1L9 1.1Z"/></svg>${unauthorized ? '<span class="service-cross">✕</span>' : ''}</div>`,
      iconSize: [18, 16],
      iconAnchor: [9, 14],
      popupAnchor: [0, -10]
    });

    const localDatasetKey = (key, suffix = 'csv') => `techloc:dataset:${key}:${suffix}`;

    async function loadDatasetText({ key, path }) {
      const override = localStorage.getItem(localDatasetKey(key));
      if (override) return override;
      const response = await fetch(path);
      if (!response.ok) throw new Error(`Unable to read ${path} (Status ${response.status})`);
      return response.text();
    }

    // --- 1. Initialize map ---
    function initMap() {
      map = L.map('tech-map', {
        zoomControl: false,
        minZoom: 3,
        zoomSnap: 0.25,
        zoomDelta: 0.5
      }).setView([39.8, -98.5], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3 }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3, opacity: 0.95 }).addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      hotspotLayer = L.layerGroup().addTo(map);
      blacklistLayer = L.layerGroup().addTo(map);
      techLayer = L.layerGroup().addTo(map);
      vehicleLayer = L.layerGroup().addTo(map);
      targetLayer = L.layerGroup().addTo(map);
      connectionLayer = L.layerGroup().addTo(map);
      serviceLayer = L.layerGroup().addTo(map);
      serviceConnectionLayer = L.layerGroup().addTo(map);
      highlightLayer = L.layerGroup().addTo(map);
      towingLayer = L.layerGroup().addTo(map);
      resellerLayer = L.layerGroup().addTo(map);
      repairLayer = L.layerGroup().addTo(map);
      locksmithLayer = L.layerGroup().addTo(map);
      tireLayer = L.layerGroup().addTo(map);
      inspectorLayer = L.layerGroup().addTo(map);
      dispatcherLayer = L.layerGroup().addTo(map);
      customServiceLayer = L.layerGroup().addTo(map);

      const invalidateMapSize = () => map?.invalidateSize();

      const mapContainer = document.getElementById('tech-map');
      if (mapContainer && typeof ResizeObserver !== 'undefined') {
        const resizeObserver = new ResizeObserver(() => {
          invalidateMapSize();
        });
        resizeObserver.observe(mapContainer);
      }

      const authBlock = document.querySelector('[data-auth-protected]');
      if (authBlock && typeof MutationObserver !== 'undefined') {
        const authObserver = new MutationObserver(() => {
          if (!authBlock.classList.contains('hidden')) {
            requestAnimationFrame(() => invalidateMapSize());
          }
        });
        authObserver.observe(authBlock, { attributes: true, attributeFilter: ['class'] });
      }

      map.on('click', (e) => {
        if (e.originalEvent?.handledByMarker) return;

        const lat = parseFloat(e.latlng.lat.toFixed(6));
        const lng = parseFloat(e.latlng.lng.toFixed(6));

        const hasActiveMapSelection = selectedVehicleId !== null || lastClientLocation !== null || lastOriginPoint !== null;
        if (hasActiveMapSelection) {
          resetSelection();
          lastOriginPoint = null;
          lastClientLocation = null;
          targetLayer?.clearLayers();
          renderVisibleSidebars();
          return;
        }

        resetSelection();
        targetLayer?.clearLayers();
        const locationPoint = { lat, lng, name: 'Pinned location' };
        lastClientLocation = locationPoint;
        lastOriginPoint = locationPoint;
        const targetIcon = L.divIcon({
          className: '',
          html: `<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>`
        });
        L.marker([lat, lng], { icon: targetIcon }).addTo(targetLayer);
        const popup = L.marker([lat, lng]).addTo(targetLayer);
        popup.bindPopup(`<b>Selected point</b><br>${lat.toFixed(4)}, ${lng.toFixed(4)}`).openPopup();

        showServicesFromOrigin(locationPoint, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });
        renderVisibleSidebars();
      });
    }

    // --- 2. Load data from Supabase ---
    async function loadTechnicians() {
      if (!isServiceTypeEnabled('tech')) return;
      if (!supabaseClient) {
        console.warn('Supabase unavailable: showing local installer placeholders.');
        document.getElementById('tech-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            <i data-lucide="alert-circle" class="mx-auto h-8 w-8 text-slate-600 mb-2"></i>
            <p class="text-slate-500 text-xs">Supabase is offline. Unable to load installers.</p>
          </div>
        `;
        iconLib.createIcons();
        return;
      }
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.technicians);
        if (error) throw error;
        technicians = (data || []).map((row, idx) => normalizeInstaller(row, idx)).filter(t => t.company || t.city || t.state);
        setServiceHeaders('technicians', data || []);
        renderedTechIds = '';
        document.getElementById('total-count').textContent = technicians.length;
        updateTechUI(technicians);
        renderVehicles();
      } catch (err) {
        console.warn("System warning: " + err.message);
        document.getElementById('file-error').classList.remove('hidden');
        document.getElementById('tech-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            <i data-lucide="file-warning" class="mx-auto h-8 w-8 text-slate-600 mb-2"></i>
            <p class="text-slate-500 text-xs">No installer data detected.</p>
          </div>
        `;
        iconLib.createIcons();
      }
    }

    async function loadVehicles() {
      if (!supabaseClient) {
        console.warn('Supabase unavailable: skipping vehicle load.');
        return;
      }
      try {
        const { data, error } = await supabaseClient.from(TABLES.vehicles).select('*');
        if (error) throw error;
        vehicles = (data || []).map((row, idx) => normalizeVehicle(row, idx));
        vehicleHeaders = data?.length ? Object.keys(data[0]) : [];
        updateVehicleFilterOptions();
        syncVehicleFilterInputs();
        renderVehicles();
      } catch (err) {
        console.warn("Vehicle load warning: " + err.message);
        document.getElementById('vehicle-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            <i data-lucide="file-warning" class="mx-auto h-8 w-8 text-slate-600 mb-2"></i>
            <p class="text-slate-500 text-xs">Unable to load vehicle data.</p>
          </div>
        `;
        iconLib.createIcons();
      }
    }

    function renderHotspots() {
      if (!hotspotLayer) return;
      hotspotLayer.clearLayers();

      hotspots.filter(hasValidCoords).forEach((hotspot) => {
        const circle = L.circle([hotspot.lat, hotspot.lng], {
          radius: hotspot.radiusMiles * MILES_TO_METERS,
          color: '#22c55e',
          weight: 1.5,
          fillColor: '#22c55e',
          fillOpacity: 0.18,
          opacity: 0.7,
        }).addTo(hotspotLayer);

        circle?.bringToBack?.();

        const locationText = [hotspot.city, hotspot.state, hotspot.zip].filter(Boolean).join(', ');
        circle.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-white text-sm">Hotspot</p>
            <p class="text-[11px] text-slate-300">${locationText || 'Location unavailable'}</p>
            <p class="text-[11px] text-emerald-300">Coverage radius: ${hotspot.radiusMiles} miles</p>
          </div>
        `);
      });
    }

    const createBlacklistIcon = () => L.divIcon({
      className: 'blacklist-triangle-icon',
      html: `<div class="blacklist-marker">!</div>`,
      iconSize: [18, 24],
      iconAnchor: [9, 20],
      popupAnchor: [0, -18]
    });

    function renderBlacklistSites() {
      if (!blacklistLayer) return;
      blacklistLayer.clearLayers();

      blacklistSites.filter(hasValidCoords).forEach((entry) => {
        const marker = L.marker([entry.lat, entry.lng], { icon: createBlacklistIcon() }).addTo(blacklistLayer);
        marker.on('click', (e) => { e.originalEvent.handledByMarker = true; });

        marker.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-amber-200 flex items-center gap-2 text-sm">
              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-amber-500/20 text-amber-200 border border-amber-400/60">!</span>
              Device removal location
            </p>
            <p class="text-[11px] text-slate-300"><span class="text-slate-400">Company:</span> ${escapeHTML(entry.company || 'Unknown')}</p>
            ${entry.assocUnit ? `<p class="text-[11px] text-slate-300"><span class="text-slate-400">Assoc. Unit:</span> ${escapeHTML(entry.assocUnit)}</p>` : ''}
            ${entry.note ? `<p class="text-[11px] text-amber-200 font-semibold">${escapeHTML(entry.note)}</p>` : ''}
          </div>
        `);
      });
    }

    async function loadHotspots() {
      if (!supabaseClient) {
        console.warn('Supabase unavailable: skipping hotspot load.');
        return;
      }
      try {
        const { data, error } = await supabaseClient.from(TABLES.hotspots).select('*');
        if (error) throw error;
        hotspots = (data || []).map((row, idx) => normalizeHotspot(row, idx)).filter(hasValidCoords);
        renderHotspots();
      } catch (err) {
        console.warn(`Hotspot load warning: ${err.message}`);
      }
    }

    async function loadBlacklistSites() {
      if (!supabaseClient) {
        console.warn('Supabase unavailable: skipping blacklist load.');
        return;
      }

      const blacklistTables = ['Seervices_Blacklist', 'Services_Blacklist'];
      for (const tableName of blacklistTables) {
        try {
          const { data, error } = await supabaseClient.from(tableName).select('*');
          if (error) throw error;
          if (Array.isArray(data)) {
            blacklistSites = data.map((row, idx) => normalizeBlacklistEntry(row, idx)).filter(hasValidCoords);
            renderBlacklistSites();
            return;
          }
        } catch (err) {
          console.warn(`Blacklist load warning from ${tableName}: ${err.message}`);
        }
      }
    }

    async function loadTowingCompanies() {
      if (!isServiceTypeEnabled('towing')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.towing);
        if (error) throw error;
        setServiceHeaders('towing', data);
        towingCompanies = (data || []).map((row, idx) => normalizePartner(row, 'towing', idx));
        updateTowingUI(towingCompanies);
      } catch (err) {
        console.warn("Towing load warning: " + err.message);
      }
    }

    async function loadResellers() {
      if (!isServiceTypeEnabled('reseller')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.resellers);
        if (error) throw error;
        setServiceHeaders('reseller', data);
        resellers = (data || []).map((row, idx) => normalizePartner(row, 'reseller', idx));
        updateResellerUI(resellers);
      } catch (err) {
        console.warn("Reseller load warning: " + err.message);
      }
    }

    async function loadRepairShops() {
      if (!isServiceTypeEnabled('repair')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.repair);
        if (error) throw error;
        setServiceHeaders('repair', data);
        repairShops = (data || []).map((row, idx) => normalizePartner(row, 'repair', idx));
        updateRepairUI(repairShops);
      } catch (err) {
        console.warn("Repair shop load warning: " + err.message);
      }
    }

    async function loadLocksmiths() {
      if (!isServiceTypeEnabled('locksmith')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.locksmiths);
        if (error) throw error;
        setServiceHeaders('locksmith', data);
        locksmiths = (data || []).map((row, idx) => normalizePartner(row, 'locksmith', idx));
        updateLocksmithUI(locksmiths);
      } catch (err) {
        console.warn("Locksmith load warning: " + err.message);
      }
    }

    async function loadDispatchers() {
      if (!isServiceTypeEnabled('dispatcher')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.dispatchers);
        if (error) throw error;
        setServiceHeaders('dispatcher', data);
        dispatchers = (data || []).map((row, idx) => normalizePartner(row, 'dispatcher', idx));
        updateDispatcherUI(dispatchers);
      } catch (err) {
        console.warn("Dispatcher load warning: " + err.message);
      }
    }

    async function loadTireServices() {
      if (!isServiceTypeEnabled('tire')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.tire);
        if (error) throw error;
        setServiceHeaders('tire', data);
        tirePartners = (data || []).map((row, idx) => normalizePartner(row, 'tire', idx));
        updateTireUI(tirePartners);
      } catch (err) {
        console.warn("Tire services load warning: " + err.message);
      }
    }

    async function loadInspectors() {
      if (!isServiceTypeEnabled('inspector')) return;
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient
          .from(SERVICE_TABLE)
          .select('*')
          .eq('category', SERVICE_CATEGORIES.inspectors);
        if (error) throw error;
        setServiceHeaders('inspector', data);
        inspectors = (data || []).map((row, idx) => normalizePartner(row, 'inspector', idx));
        updateInspectorUI(inspectors);
      } catch (err) {
        console.warn("Inspector load warning: " + err.message);
      }
    }

    async function loadCustomServices() {
      if (!isServiceTypeEnabled('custom') || !customCategoryLabels.size) return;
      if (!supabaseClient) {
        console.warn('Supabase unavailable: skipping custom categories.');
        return;
      }

      try {
        const labels = Array.from(customCategoryLabels);
        const { data, error } = await supabaseClient.from(SERVICE_TABLE).select('*').in('category', labels);
        if (error) throw error;

        customCategories.forEach(({ layer }) => layer?.clearLayers?.());
        customServices = (data || []).map((row, idx) => {
          const rawLabel = normalizeCategoryLabel(row?.category || 'Custom');
          const meta = ensureCustomCategoryMeta(rawLabel);
          const partner = normalizePartner(row, 'custom', idx);
          return { ...partner, categoryKey: meta.key, categoryLabel: meta.label, color: meta.color, type: `custom-${meta.key}` };
        });

        renderCustomServices();
      } catch (err) {
        console.warn(`Custom service warning: ${err.message}`);
      }
    }

    // --- 3. Process CSV text ---
    function parseCSV(csvText) {
      const rows = [];
      let currentValue = '';
      let currentRow = [];
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];

        if (char === '"') {
          const next = csvText[i + 1];
          if (inQuotes && next === '"') {
            currentValue += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (!inQuotes && (char === ',' || char === '\n' || char === '\r')) {
          currentRow.push(currentValue);
          currentValue = '';

          if (char === ',') continue;

          if (char === '\r' && csvText[i + 1] === '\n') i++;
          if (currentRow.some(cell => cell.trim() !== '')) rows.push(currentRow);
          currentRow = [];
          continue;
        }

        currentValue += char;
      }

      currentRow.push(currentValue);
      if (currentRow.some(cell => cell.trim() !== '')) rows.push(currentRow);

      return rows.filter(r => r.length > 0);
    }

    async function parseTechCSV(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return;

      const headers = rows[0].map(h => h.trim().replace(/"/g, '')).map(h => h.toLowerCase());

      const techPromises = rows.slice(1).map(async (values, idx) => {
        const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

        const row = {};
        headers.forEach((h, i) => row[h] = cleanValues[i] || '');

        const companyName = row['installation company'] || row['company'] || 'Installer';
        const stateCode = toStateCode(row['state']) || 'US';
        const coords = deriveCoords({
          zip: row['zip'],
          city: row['city'],
          stateCode,
          seed: idx
        });
        const { display: phone, tel: phoneDial } = formatPhoneNumber(row['phone']);

        return {
          id: idx,
          name: companyName,
          company: companyName,
          email: row['email'] || '-',
          phone: phone || '-',
          phoneDial,
          city: row['city'] || '',
          state: stateCode,
          zip: row['zip'] || '',
          lat: coords.lat,
          lng: coords.lng
        };
      });

      technicians = await Promise.all(techPromises);
      renderedTechIds = '';

      document.getElementById('total-count').textContent = technicians.length;
      updateTechUI(technicians);
      renderVehicles();
    }

    function parseVehicleCSV(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      const headers = rows[0].map(h => h.replace(/^"|"$/g, '').trim());

      const vehiclesData = rows.slice(1).map((values, idx) => {
        const clean = values.map(v => v.replace(/^"|"$/g, '').trim());
        const row = {};
        headers.forEach((h, i) => {
          const value = (clean[i] ?? '').trim();
          row[h] = value;
          const normalized = normalizeKey(h);
          if (!(normalized in row)) row[normalized] = value;
        });

        const stateCode = toStateCode(getField(row, 'State Loc', 'State', 'state_loc'));
        const numericLat = parseFloat(getField(row, 'Lat', 'lat'));
        const numericLng = parseFloat(getField(row, 'Long', 'Lng', 'long', 'lng'));
        const hasExactCoords = Number.isFinite(numericLat) && Number.isFinite(numericLng) && numericLat !== 0 && numericLng !== 0;
        const { coords, accuracy } = resolveCoords(row, {
          zip: getField(row, 'PT ZipCode', 'Zip', 'zip'),
          city: getField(row, 'PT City', 'City', 'city'),
          stateCode,
          seed: idx,
          fallbackLatLng: hasExactCoords ? { lat: numericLat, lng: numericLng } : null
        });

        const dealCompletion = getField(row, 'Deal Completion', 'Deal completion', 'Deal completition', 'Remaining');

        return {
          id: idx,
          status: getField(row, 'Deal Status', 'status') || 'ACTIVE',
          invPrepStatus: getField(row, 'INV Prep Stat', 'Inv. Prep. Stat.', 'Inv Prep Stat', 'inv_prep_stat'),
          dealCompletion,
          type: getField(row, 'Unit Type', 'type') || 'Vehicle',
          year: getField(row, 'Model Year', 'year'),
          model: getField(row, 'Model', 'model') || 'Vehicle',
          vin: getField(row, 'ShortVIN', 'VIN', 'vin') || 'N/A',
          gpsFix: getField(row, 'GPS Fix', 'gps_fix'),
          gpsReason: getField(row, 'GPS Fix Reason', 'gps_fix_reason'),
          gpsMoving: getField(row, 'GPS Moving', 'gps_moving'),
          moving: getField(row, 'Moving', 'moving'),
          movingCalc: getField(row, 'Moving (Calc)', 'moving_calc'),
          ptStatus: getField(row, 'PT Status', 'pt_status'),
          ptSerial: getField(row, 'PT Serial ', 'PT Serial', 'pt_serial'),
          encoreSerial: getField(row, 'Encore Serial', 'encore_serial'),
          lastRead: getField(row, 'PT Last Read', 'pt_last_read'),
          state: stateCode,
          city: getField(row, 'PT City', 'City', 'city') || '',
          zipcode: getField(row, 'PT ZipCode', 'Zip', 'zip') || '',
          lat: coords.lat,
          lng: coords.lng,
          locationAccuracy: accuracy,
          customerId: getField(row, 'Customer ID', 'Customer', 'customer_id'),
          customer: getField(row, 'PT City', 'City', 'city')
            ? `${getField(row, 'PT City', 'City', 'city')}, ${stateCode || 'US'}`
            : stateCode || 'Unknown area',
          lastLocation: `${getField(row, 'PT City', 'City', 'city') || 'Unknown'}, ${stateCode || 'USA'}${getField(row, 'PT ZipCode', 'Zip', 'zip') ? ' ' + getField(row, 'PT ZipCode', 'Zip', 'zip') : ''}`.trim(),
          payment: getField(row, 'Payment Schedule', 'payment'),
          details: row
        };
      });

      document.getElementById('vehicles-count').textContent = vehiclesData.length;
      return { headers, rows: vehiclesData };
    }

    function parsePartnerCSV(csvText, type = 'towing') {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      const headers = rows[0].map(h => h.replace(/^"|"$/g, '').trim().toLowerCase());
      return rows.slice(1).map((values, idx) => {
        const clean = values.map(v => v.replace(/^"|"$/g, '').trim());
        const row = {};
        headers.forEach((h, i) => row[h] = (clean[i] ?? '').trim());

        const stateCode = toStateCode(row['state']) || toStateCode(row['region']) || 'US';
        const coords = deriveCoords({
          zip: row['zip'],
          city: row['city'],
          stateCode,
          seed: idx
        });

        const { display: phone, tel: phoneDial } = formatPhoneNumber(row['phone']);

        return {
          id: `${type}-${idx}`,
          type,
          company: row['company'] || row['name'] || 'Partner',
          region: row['region'] || stateCode,
          phone,
          phoneDial,
          contact: row['contact'] || '',
          availability: row['availability'] || row['tier'] || '',
          notes: row['notes'] || '',
          city: row['city'] || '',
          state: stateCode,
          zip: row['zip'] || '',
          lat: coords.lat,
          lng: coords.lng
        };
      });
    }

    // --- 4. Update map and list ---
    function updateTechUI(techList, target = null, clientLocation = null) {
      if (!techSidebarVisible) {
        techLayer?.clearLayers();
        return;
      }
      const listContainer = document.getElementById('tech-list');
      listContainer.innerHTML = '';

      const origin = clientLocation || getCurrentOrigin();
      const sortedList = origin
        ? techList
            .map(t => ({ ...t, distance: getDistance(origin.lat, origin.lng, t.lat, t.lng) }))
            .sort((a, b) => a.distance - b.distance)
        : [...techList];

      const selectedTech = selectedTechId !== null
        ? sortedList.find(t => t.id === selectedTechId) || techList.find(t => t.id === selectedTechId)
        : null;

      const displayList = selectedTech
        ? [selectedTech, ...sortedList.filter(t => t.id !== selectedTech.id)]
        : sortedList;

      const displayKey = displayList.map(t => t.id).join('|');
      const shouldRenderMarkers = techSidebarVisible && displayKey !== renderedTechIds;

      if (shouldRenderMarkers) {
        techLayer.clearLayers();
      }

      if (displayList.length === 0) {
        listContainer.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No technicians match this selection.</div>`;
      }

      if (shouldRenderMarkers) {
        displayList.forEach(tech => {
          const marker = L.marker([tech.lat, tech.lng], {
            icon: createServiceIcon(SERVICE_COLORS.tech)
          }).addTo(techLayer);

          marker.bindPopup(`
            <div class="text-slate-900 p-1 font-sans">
              <strong class="block text-sm font-bold mb-1">${tech.company}</strong>
              <div class="text-xs text-slate-500 mb-2">${tech.city}, ${tech.state} ${tech.zip}</div>
              <a href="tel:${tech.phoneDial || tech.phone}" class="block bg-blue-100 text-blue-700 px-2 py-1 rounded text-center text-xs font-bold mb-1">${tech.phone}</a>
              <div class="text-[10px] text-slate-400 truncate">${tech.email}</div>
            </div>
          `);

          marker.on('click', (e) => {
            e.originalEvent.handledByMarker = true;
            map.panTo([tech.lat, tech.lng]);
            applySelection(null, tech.id);
          });
        });

        renderedTechIds = displayKey;
      }

      displayList.slice(0, 50).forEach((tech, idx) => {
        const isNearest = target && idx === 0;

        const card = document.createElement('div');
        card.className = `p-3 rounded-lg border transition-colors cursor-pointer ${isNearest ? 'bg-slate-800 border-blue-500 ring-1 ring-blue-500' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;

        const distanceLabel = origin ? `${Math.round(getDistance(origin.lat, origin.lng, tech.lat, tech.lng))} mi` : '';

        card.innerHTML = `
          <div class="flex justify-between items-start gap-3">
            <div class="min-w-0 space-y-1">
              <h3 class="font-bold text-white text-sm break-words leading-tight" title="${tech.company}">${tech.company}</h3>
              <p class="flex items-center gap-1 text-[11px] text-slate-400 leading-tight"><i data-lucide="map-pin" class="h-3 w-3"></i><span class="truncate">${tech.city || 'Unknown'}, ${tech.state || 'US'}</span></p>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight space-y-0.5">
              <p class="font-semibold text-slate-200">${tech.phone || ''}</p>
              ${tech.email ? `<p class="flex items-center gap-1 justify-end text-slate-400"><i data-lucide="mail" class="h-3 w-3"></i><span class="truncate max-w-[160px]">${tech.email}</span></p>` : ''}
              ${distanceLabel ? `<p class="flex items-center gap-1 justify-end text-slate-300"><i data-lucide="navigation" class="h-3 w-3"></i><span class="font-semibold text-slate-100">${distanceLabel}</span></p>` : ''}
            </div>
          </div>
          ${tech.zip ? `<p class="text-[10px] text-slate-500 mt-1">${tech.zip}</p>` : ''}
          
        `;

        card.addEventListener('click', () => {
          map.panTo([tech.lat, tech.lng]);
          applySelection(null, tech.id);
        });

        listContainer.appendChild(card);
      });

      iconLib.createIcons();
    }

    const isAnyServiceSidebarOpen = () => (
      (techSidebarVisible && isServiceTypeEnabled('tech')) ||
      (towingSidebarVisible && isServiceTypeEnabled('towing')) ||
      (resellerSidebarVisible && isServiceTypeEnabled('reseller')) ||
      (repairSidebarVisible && isServiceTypeEnabled('repair')) ||
      (locksmithSidebarVisible && isServiceTypeEnabled('locksmith')) ||
      (dispatcherSidebarVisible && isServiceTypeEnabled('dispatcher')) ||
      (tireSidebarVisible && isServiceTypeEnabled('tire')) ||
      (inspectorSidebarVisible && isServiceTypeEnabled('inspector'))
    );

    const getPartnerFilterValue = (type = 'tech') => `${serviceFilters[type] || ''}`.trim().toLowerCase();

    const applyServiceFilter = (list = [], type = 'tech') => {
      const query = getPartnerFilterValue(type);
      if (!query) return list;
      return list.filter((partner) => {
        return [partner.company, partner.contact, partner.city, partner.state, partner.zip, partner.region]
          .some(value => `${value || ''}`.toLowerCase().includes(query));
      });
    };

    const updateServiceCount = (type, total, filteredTotal = total) => {
      const el = document.getElementById(`${type}-count`);
      if (el) {
        el.textContent = filteredTotal !== total ? `${filteredTotal}/${total}` : total;
      }
    };

    const getCurrentOrigin = () => {
      if (selectedVehicleId !== null) {
        const vehicle = vehicles.find(v => v.id === selectedVehicleId && hasValidCoords(v));
        if (vehicle) return vehicle;
      }

      if (selectedTechId !== null) {
        const tech = technicians.find(t => t.id === selectedTechId && hasValidCoords(t));
        if (tech) return tech;
      }

      const selectedPartner = Object.values(selectedServiceByType).find(Boolean);
      if (selectedPartner && hasValidCoords(selectedPartner)) return selectedPartner;

      if (lastOriginPoint) return lastOriginPoint;
      if (lastClientLocation) return lastClientLocation;
      return null;
    };

    const getSelectedService = (type) => selectedServiceByType[type] || null;

    function renderPartnerUI(partners = [], options) {
      const { containerId, layer, visible, accentColor, badgeLabel, type } = options;
      if (!isServiceTypeEnabled(type)) return;
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!visible) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">Open this sidebar to view nearby partners.</div>`;
        layer?.clearLayers();
        updateServiceCount(type, partners.length, applyServiceFilter(partners, type).length);
        return;
      }

      container.innerHTML = '';
      layer?.clearLayers();

      const totalPartners = partners.length;
      const filteredPartners = applyServiceFilter(partners, type);
      const selectedService = getSelectedService(type);
      const origin = getCurrentOrigin() || selectedService;
      const sorted = origin
        ? filteredPartners
            .map(p => ({
              ...p,
              distance: map.distance([origin.lat, origin.lng], [p.lat, p.lng]) / 1609.34
            }))
            .sort((a, b) => a.distance - b.distance)
        : [...filteredPartners];

      const prioritized = selectedService
        ? [sorted.find(p => p.id === selectedService.id) || selectedService, ...sorted.filter(p => p.id !== selectedService.id)]
        : sorted;

      updateServiceCount(type, totalPartners, prioritized.length);

      if (!prioritized.length) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No partners available.</div>`;
        return;
      }

      prioritized.slice(0, 75).forEach((partner, idx) => {
        const unauthorized = isUnauthorizedPartner(partner);
        const markerColor = getPartnerColor(partner, accentColor);
        const marker = L.marker([partner.lat, partner.lng], {
          icon: createServiceIcon(markerColor, { unauthorized })
        }).addTo(layer);

        const locationText = formatPartnerLocation(partner);

        marker.bindPopup(`
          <div class="text-slate-900 p-1 font-sans">
            <strong class="block text-sm font-bold mb-1">${partner.company}</strong>
            <div class="text-xs text-slate-500 mb-2">${locationText || 'US'}</div>
            <a href="tel:${partner.phoneDial || partner.phone}" class="block bg-slate-100 text-slate-800 px-2 py-1 rounded text-center text-xs font-bold mb-1">${partner.phone || 'Contact'}</a>
            <div class="text-[10px] text-slate-500">${partner.availability || ''}</div>
          </div>
        `);

        marker.on('click', (e) => {
          e.originalEvent.handledByMarker = true;
          sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
          selectedServiceByType[type] = partner;
          const originPoint = getCurrentOrigin() || partner;
          if (originPoint) {
            showServicesFromOrigin(originPoint, { forceType: type });
          }
          showServicePreviewCard(partner);
          renderPartnerUI(partners, options);
          map.panTo([partner.lat, partner.lng]);
        });

        const card = document.createElement('div');
        const isSelected = selectedService?.id === partner.id;
        card.className = `p-3 rounded-lg border transition-colors cursor-pointer ${isSelected || (idx === 0 && origin) ? 'bg-slate-800 border-amber-400 ring-1 ring-amber-400' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;
        card.innerHTML = `
          <div class="flex justify-between items-start gap-3">
            <div class="min-w-0">
              <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">${badgeLabel}</p>
              <h3 class="font-bold text-white text-sm break-words leading-tight" title="${partner.company}">${partner.company}</h3>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight">
              <p class="font-semibold text-slate-200">${partner.contact || 'Dispatch'}</p>
              <a class="block font-bold text-blue-200" href="tel:${partner.phoneDial || partner.phone}">${partner.phone || ''}</a>
              <p class="text-[10px] text-slate-500">${partner.availability || ''}</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2 text-[11px] text-slate-300">
            <div class="flex items-center gap-1 text-slate-400"><i data-lucide="map-pin" class="h-3 w-3"></i><span>${locationText || 'US'}</span></div>
            ${origin ? `<div class="flex items-center gap-1 justify-end text-slate-300"><i data-lucide="navigation" class="h-3 w-3"></i><span class="font-semibold text-slate-100">${Math.round(partner.distance)} mi</span></div>` : ''}
            ${partner.notes ? `<div class="col-span-2 text-[10px] text-slate-400 leading-tight">${partner.notes}</div>` : ''}
          </div>
          
        `;

          card.addEventListener('click', () => {
            sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
            map.panTo([partner.lat, partner.lng]);
            selectedServiceByType[type] = partner;
            const originPoint = getCurrentOrigin() || partner;
            if (originPoint) {
              showServicesFromOrigin(originPoint, { forceType: type });
            }
            renderPartnerUI(partners, options);
          });

        container.appendChild(card);
      });

      iconLib.createIcons();
    }

    function updateTowingUI(list = towingCompanies) {
      renderPartnerUI(list, { containerId: 'towing-list', layer: towingLayer, visible: towingSidebarVisible, accentColor: '#c084fc', badgeLabel: 'Towing', type: 'towing', countId: 'towing-count' });
    }

    function updateResellerUI(list = resellers) {
      renderPartnerUI(list, { containerId: 'reseller-list', layer: resellerLayer, visible: resellerSidebarVisible, accentColor: '#34d399', badgeLabel: 'Reseller', type: 'reseller', countId: 'reseller-count' });
    }

    function updateRepairUI(list = repairShops) {
      renderPartnerUI(list, { containerId: 'repair-list', layer: repairLayer, visible: repairSidebarVisible, accentColor: '#fb923c', badgeLabel: 'Repair shop', type: 'repair', countId: 'repair-count' });
    }

    function updateLocksmithUI(list = locksmiths) {
      renderPartnerUI(list, { containerId: 'locksmith-list', layer: locksmithLayer, visible: locksmithSidebarVisible, accentColor: '#facc15', badgeLabel: 'Locksmiths', type: 'locksmith', countId: 'locksmith-count' });
    }

    function updateDispatcherUI(list = dispatchers) {
      renderPartnerUI(list, { containerId: 'dispatcher-list', layer: dispatcherLayer, visible: dispatcherSidebarVisible, accentColor: '#38bdf8', badgeLabel: 'Dispatcher', type: 'dispatcher', countId: 'dispatcher-count' });
    }

    function updateTireUI(list = tirePartners) {
      renderPartnerUI(list, { containerId: 'tire-list', layer: tireLayer, visible: tireSidebarVisible, accentColor: '#a3e635', badgeLabel: 'Tire service', type: 'tire', countId: 'tire-count' });
    }

    function updateInspectorUI(list = inspectors) {
      renderPartnerUI(list, { containerId: 'inspector-list', layer: inspectorLayer, visible: inspectorSidebarVisible, accentColor: '#818cf8', badgeLabel: 'Inspector', type: 'inspector', countId: 'inspector-count' });
    }

    function renderCustomServices(list = customServices) {
      const container = document.getElementById('custom-list');
      const counter = document.getElementById('custom-count');
      if (!container) return;

      const enabled = customSidebarVisible && isServiceTypeEnabled('custom');
      if (!enabled) {
        customCategories.forEach(({ layer }) => layer?.clearLayers?.());
        container.innerHTML = '<div class="text-center mt-10 text-slate-600 text-xs">Open this sidebar to view nearby partners.</div>';
        counter && (counter.textContent = list.length.toString());
        document.getElementById('custom-legend-slot')?.replaceChildren();
        return;
      }

      container.innerHTML = '';
      customCategories.forEach(({ layer }) => layer?.clearLayers?.());

      const filtered = selectedCustomCategoryKey
        ? list.filter((item) => item?.categoryKey === selectedCustomCategoryKey)
        : list;

      const grouped = new Map();
      filtered.forEach((item) => {
        const key = item?.categoryKey || 'custom';
        if (!grouped.has(key)) grouped.set(key, []);
        grouped.get(key).push(item);
      });

      if (!grouped.size) {
        container.innerHTML = '<div class="text-center mt-10 text-slate-600 text-xs">No services available.</div>';
        counter && (counter.textContent = '0');
        document.getElementById('custom-legend-slot')?.replaceChildren();
        return;
      }

      let total = 0;
      grouped.forEach((items, key) => {
        const meta = customCategories.get(key) || ensureCustomCategoryMeta(key);
        const section = document.createElement('section');
        section.className = 'space-y-2';
        section.innerHTML = `
          <div class="flex items-center justify-between gap-3 bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2">
            <div class="flex items-center gap-2">
              <span class="h-2.5 w-2.5 rounded-full" style="background:${meta.color}"></span>
              <p class="text-sm font-semibold text-white">${escapeHTML(meta.label)}</p>
            </div>
            <span class="text-[11px] font-semibold text-slate-300">${items.length} services</span>
          </div>
        `;

        const listWrap = document.createElement('div');
        listWrap.className = 'grid gap-2';

        items.forEach((partner) => {
          const locationText = formatPartnerLocation(partner) || 'US';
          const card = document.createElement('article');
          card.className = 'rounded-xl border border-slate-800 bg-slate-900/70 p-3 shadow-sm cursor-pointer hover:border-amber-400/60 transition-colors';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-sm font-bold text-white leading-tight">${escapeHTML(partner.company || partner.name || 'Service')}</p>
                <p class="text-[11px] text-slate-400">${escapeHTML(locationText)}</p>
                ${partner.phone ? `<a class="mt-1 inline-flex items-center gap-2 text-[11px] font-semibold text-blue-200 hover:text-blue-100" href="tel:${partner.phoneDial || partner.phone}"><i data-lucide="phone" class="h-3 w-3"></i><span>${escapeHTML(partner.phone)}</span></a>` : ''}
              </div>
              <span class="text-[10px] font-semibold px-2 py-1 rounded-full border border-slate-700 text-slate-200">${escapeHTML(meta.label)}</span>
            </div>
            ${partner.notes ? `<p class="mt-2 text-[11px] text-slate-400 leading-tight">${escapeHTML(partner.notes)}</p>` : ''}
          `;

          if (map && meta.layer && hasValidCoords(partner)) {
            const icon = createServiceIcon(meta.color, { unauthorized: isUnauthorizedPartner(partner) });
            const marker = L.marker([partner.lat, partner.lng], { icon });
            marker.on('click', (e) => {
              e.originalEvent.handledByMarker = true;
              showServicePopup(partner, meta.color);
            });
            marker.addTo(meta.layer);
          }

          card.addEventListener('click', () => {
            sidebarStateController?.setState?.('custom', true);
            if (hasValidCoords(partner) && map) {
              map.panTo([partner.lat, partner.lng]);
              showServicePopup(partner, meta.color);
            }
          });

          listWrap.appendChild(card);
        });

        section.appendChild(listWrap);
        container.appendChild(section);
        total += items.length;
      });

      counter && (counter.textContent = total);

      const legendSlot = document.getElementById('custom-legend-slot');
      if (legendSlot) {
        legendSlot.innerHTML = '';
        grouped.forEach((items, key) => {
          const meta = customCategories.get(key) || ensureCustomCategoryMeta(key);
          const pill = document.createElement('div');
          pill.className = 'legend-pill flex items-center gap-2';
          pill.dataset.legend = `custom-${key}`;
          pill.innerHTML = `
            <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16" fill="${meta.color}" stroke="#0f172a" stroke-width="1.2"><path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path></svg></span>
            ${escapeHTML(meta.label)}
          `;
          legendSlot.appendChild(pill);
        });
      }
    }

      function renderVisibleSidebars() {
        if (techSidebarVisible && isServiceTypeEnabled('tech')) updateTechUI(getTechList(technicians));
        if (towingSidebarVisible && isServiceTypeEnabled('towing')) updateTowingUI(towingCompanies);
        if (resellerSidebarVisible && isServiceTypeEnabled('reseller')) updateResellerUI(resellers);
        if (repairSidebarVisible && isServiceTypeEnabled('repair')) updateRepairUI(repairShops);
        if (locksmithSidebarVisible && isServiceTypeEnabled('locksmith')) updateLocksmithUI(locksmiths);
      if (dispatcherSidebarVisible && isServiceTypeEnabled('dispatcher')) updateDispatcherUI(dispatchers);
      if (tireSidebarVisible && isServiceTypeEnabled('tire')) updateTireUI(tirePartners);
      if (inspectorSidebarVisible && isServiceTypeEnabled('inspector')) updateInspectorUI(inspectors);
      if (customSidebarVisible && isServiceTypeEnabled('custom')) renderCustomServices(customServices);
    }

    function updateHotspotToggle() {
      const toggle = document.getElementById('toggle-hotspots');
      if (!toggle) return;

      toggle.textContent = hotspotsVisible ? 'Hide Hotspot Areas' : 'Show Hotspot Areas';
      toggle.classList.toggle('active', hotspotsVisible);
      toggle.setAttribute('aria-pressed', hotspotsVisible ? 'true' : 'false');
    }

    function setHotspotsVisible(visible) {
      hotspotsVisible = !!visible;
      updateHotspotToggle();

      if (!hotspotLayer || !map) return;
      if (!hotspotsVisible) {
        if (map.hasLayer(hotspotLayer)) map.removeLayer(hotspotLayer);
        return;
      }

      if (!map.hasLayer(hotspotLayer)) hotspotLayer.addTo(map);
      renderHotspots();
    }

    function setupHotspotToggle() {
      const toggle = document.getElementById('toggle-hotspots');
      if (!toggle) return;

      toggle.addEventListener('click', () => setHotspotsVisible(!hotspotsVisible));
      updateHotspotToggle();
    }

    function updateBlacklistToggle() {
      const toggle = document.getElementById('toggle-blacklist');
      if (!toggle) return;

      toggle.textContent = blacklistMarkersVisible ? 'Hide Blacklist Marks' : 'Show Blacklist Marks';
      toggle.classList.toggle('active', blacklistMarkersVisible);
      toggle.setAttribute('aria-pressed', blacklistMarkersVisible ? 'true' : 'false');
    }

    function setBlacklistVisible(visible) {
      blacklistMarkersVisible = !!visible;
      updateBlacklistToggle();

      if (!blacklistLayer || !map) return;
      if (!blacklistMarkersVisible) {
        if (map.hasLayer(blacklistLayer)) map.removeLayer(blacklistLayer);
        return;
      }

      if (!map.hasLayer(blacklistLayer)) blacklistLayer.addTo(map);
      renderBlacklistSites();
    }

    function setupBlacklistToggle() {
      const toggle = document.getElementById('toggle-blacklist');
      if (!toggle) return;

      toggle.addEventListener('click', () => setBlacklistVisible(!blacklistMarkersVisible));
      updateBlacklistToggle();
    }

    function updateVehicleMarkerToggle() {
      const toggle = document.getElementById('toggle-vehicle-markers');
      if (!toggle) return;

      toggle.textContent = vehicleMarkersVisible ? 'Hide Vehicles Marks' : 'Show Vehicles Marks';
      toggle.classList.toggle('active', vehicleMarkersVisible);
      toggle.setAttribute('aria-pressed', vehicleMarkersVisible ? 'true' : 'false');
    }

    function setVehicleMarkersVisible(visible) {
      vehicleMarkersVisible = !!visible;
      updateVehicleMarkerToggle();

      if (!vehicleMarkersVisible) {
        if (vehicleLayer) {
          vehicleLayer.clearLayers();
          if (map?.hasLayer(vehicleLayer)) map.removeLayer(vehicleLayer);
        }
        vehicleMarkers.clear();
        highlightLayer?.clearLayers();
        return;
      }

      if (vehicleLayer && map && !map.hasLayer(vehicleLayer)) {
        vehicleLayer.addTo(map);
      }

      renderVehicles();
    }

    function setupVehicleMarkerToggle() {
      const toggle = document.getElementById('toggle-vehicle-markers');
      if (!toggle) return;

      toggle.addEventListener('click', () => setVehicleMarkersVisible(!vehicleMarkersVisible));
      updateVehicleMarkerToggle();
    }

    function renderVehicles() {
      const container = document.getElementById('vehicle-list');
      if (!container) return;
      container.innerHTML = '';
      vehicleLayer.clearLayers();
      vehicleMarkers.clear();

      if (!vehicleMarkersVisible && map?.hasLayer(vehicleLayer)) {
        map.removeLayer(vehicleLayer);
      } else if (vehicleMarkersVisible && map && vehicleLayer && !map.hasLayer(vehicleLayer)) {
        vehicleLayer.addTo(map);
      }

      const searchBox = document.getElementById('vehicle-search');
      const filtered = getVehicleList(searchBox?.value || '');
      document.getElementById('vehicles-count').textContent = filtered.length;

      if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No vehicles match your search.</div>`;
        return;
      }

      const fragment = document.createDocumentFragment();

      filtered.forEach((vehicle) => {
        const movingMeta = getMovingMeta(vehicle);

          const card = document.createElement('div');
          card.className = 'p-3 rounded-lg border border-slate-800 bg-slate-900/80 hover:border-amber-500/80 transition-all cursor-pointer shadow-sm hover:shadow-amber-500/20 backdrop-blur space-y-3';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-300">${vehicle.model}</p>
                <h3 class="font-extrabold text-white text-sm leading-tight flex items-center gap-2">${vehicle.year || '—'} <span class="text-slate-600">•</span> ${vehicle.vin || 'VIN N/A'}</h3>
                <p class="text-[11px] text-slate-400 flex items-center gap-1"><i data-lucide="map-pin" class="h-3 w-3"></i> ${vehicle.lastLocation || 'No location provided'}</p>
                ${vehicle.locationNote ? `<p class="text-[10px] text-amber-200 font-semibold">${vehicle.locationNote}</p>` : ''}
                <p class="text-[11px] text-blue-200 font-semibold">Customer ID: <span class="text-slate-100">${vehicle.customerId || '—'}</span></p>
              </div>
              <div class="flex flex-col items-end gap-1 text-right">
                <div class="inline-flex items-center gap-2 text-[10px] font-bold text-slate-300">
                  <span class="px-2 py-1 rounded-full border border-amber-400/40 bg-amber-500/10 text-amber-100">${vehicle.status}</span>
                </div>
                <div class="inline-flex items-center gap-2 text-[10px] font-semibold ${movingMeta.text} px-2 py-1 rounded-full border border-slate-800 ${movingMeta.bg}">
                  <span class="w-2 h-2 rounded-full ${movingMeta.dot}"></span>
                  <span>${movingMeta.label}</span>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                <i data-lucide="wifi-off" class="h-3 w-3 text-amber-300"></i>
                <div class="text-left leading-tight">
                  <p class="font-semibold">${vehicle.gpsFix || 'GPS issue'}</p>
                  <p class="text-[10px] text-slate-400">${vehicle.gpsReason || 'Pending'}</p>
                </div>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                <i data-lucide="hash" class="h-3 w-3 text-blue-400"></i>
                <div class="text-left leading-tight">
                  <p class="font-semibold">VIN</p>
                  <p class="text-[10px] text-slate-400">${vehicle.vin || 'Not available'}</p>
                </div>
              </div>
            </div>
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[10px] text-slate-200 space-y-2">
              <div class="grid grid-cols-4 gap-2">
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.status || '—'}</p>
                </div>
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Prep</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.invPrepStatus || '—'}</p>
                </div>
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.dealCompletion || '—'}</p>
                </div>
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">PT</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.ptStatus || '—'}</p>
                </div>
              </div>
              <div class="flex items-center justify-between text-[11px] text-slate-400">
                <span class="flex items-center gap-2 font-semibold text-slate-200"><i data-lucide="clock-3" class="h-3 w-3"></i> ${vehicle.lastRead || '—'}</span>
                <span class="text-slate-400">${vehicle.payment || ''}</span>
              </div>
            </div>
            <div class="pt-1 flex items-center justify-end gap-2">
              <button data-view-more class="inline-flex items-center gap-1.5 rounded-lg border border-amber-400/50 bg-amber-500/15 px-3 py-1 text-[10px] font-bold text-amber-100 hover:bg-amber-500/25 transition-colors">
                <i data-lucide="info" class="h-3.5 w-3.5"></i>
                See more
              </button>
            </div>
          `;

          const focusHandler = () => {
            if (!hasValidCoords(vehicle)) {
              console.warn(`No coordinates available for vehicle ${vehicle.vin || vehicle.id || 'unknown'}`);
              return;
            }
            applySelection(vehicle.id, null);
            focusVehicle(vehicle);
          };

          card.addEventListener('click', focusHandler);

          const viewMoreBtn = card.querySelector('[data-view-more]');
          if (viewMoreBtn) {
            viewMoreBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              openVehicleModal(vehicle);
            });
          }

          let coords = null;
          if (hasValidCoords(vehicle)) {
            vehicle.locationAccuracy = vehicle.locationAccuracy || 'exact';
            vehicle.locationNote = getLocationNote(vehicle.locationAccuracy);
            coords = { lat: vehicle.lat, lng: vehicle.lng };
          } else if (vehicle.zipcode || vehicle.city || vehicle.state) {
            const derived = resolveCoords(vehicle, { zip: vehicle.zipcode, city: vehicle.city, stateCode: vehicle.state });
            coords = derived.coords;
            vehicle.lat = coords.lat;
            vehicle.lng = coords.lng;
            vehicle.locationAccuracy = derived.accuracy;
            vehicle.locationNote = getLocationNote(vehicle.locationAccuracy);
          } else {
            console.warn(`No location data for vehicle ${vehicle.vin || vehicle.id || 'unknown'}`);
          }

          if (coords && vehicleMarkersVisible) {
            const markerColor = getVehicleMarkerColor(vehicle);
            const borderColor = getVehicleMarkerBorderColor(markerColor);

            const marker = L.circleMarker([coords.lat, coords.lng], {
              radius: 8,
              color: borderColor,
              weight: 2.6,
              opacity: 0.95,
              fillColor: markerColor,
              fillOpacity: 0.92,
              className: 'vehicle-dot'
            }).addTo(vehicleLayer);

            marker.on('click', (e) => { e.originalEvent.handledByMarker = true; focusHandler(); });

            if (isVehicleNotMoving(vehicle)) {
              L.marker([coords.lat, coords.lng], {
                icon: L.divIcon({ className: 'vehicle-cross', html: '<div class="vehicle-cross-badge">✕</div>', iconSize: [16, 16], iconAnchor: [8, 8] }),
                interactive: false,
                zIndexOffset: 500
              }).addTo(vehicleLayer);
            }

            vehicleMarkers.set(vehicle.id, { marker });
          }

          fragment.appendChild(card);
        });

      container.appendChild(fragment);
      iconLib.createIcons();
    }

    function focusVehicle(vehicle) {
      if (!vehicle) return;
      if (!hasValidCoords(vehicle)) return;
      if (!vehicleMarkersVisible) return;
      highlightLayer.clearLayers();

      const storedMarker = vehicleMarkers.get(vehicle.id)?.marker;
      const markerColor = getVehicleMarkerColor(vehicle);
      const anchorMarker = storedMarker || L.circleMarker([vehicle.lat, vehicle.lng], {
        radius: 9,
        color: '#0b1220',
        weight: 2.8,
        fillColor: markerColor,
        fillOpacity: 0.95,
        opacity: 0.98,
        className: 'vehicle-dot'
      }).addTo(highlightLayer);

      const halo = L.circleMarker([vehicle.lat, vehicle.lng], { radius: 12, color: markerColor, weight: 1.2, fillColor: markerColor, fillOpacity: 0.18 }).addTo(highlightLayer);
      halo.bringToBack();

      if (isVehicleNotMoving(vehicle)) {
        L.marker([vehicle.lat, vehicle.lng], {
          icon: L.divIcon({ className: 'vehicle-cross', html: '<div class="vehicle-cross-badge">✕</div>', iconSize: [16, 16], iconAnchor: [8, 8] }),
          interactive: false,
          zIndexOffset: 500
        }).addTo(highlightLayer);
      }

      anchorMarker.bindPopup(vehicleCard(vehicle), {
        className: 'vehicle-popup',
        autoPan: false,
        keepInView: false,
      }).openPopup();

      setTimeout(attachPopupHandlers, 50);

      showServicesFromOrigin(vehicle, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });

      applySelection(vehicle.id, null);
    }

    function vehicleCard(vehicle) {
      const accuracyDot = getAccuracyDot(vehicle.locationAccuracy);
      const modelYear = [vehicle.model || 'Vehicle', vehicle.year].filter(Boolean).join(' · ');
      return `
        <div class="w-[240px] bg-slate-950/90 text-white">
          <div class="p-3 space-y-2">
            <div class="flex items-start justify-between gap-2">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-400">Vehicle</p>
                <h3 class="text-base font-extrabold leading-tight text-white">${modelYear}</h3>
                <p class="text-[11px] text-slate-300">VIN ${vehicle.vin || 'N/A'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/15 px-2 py-1 text-[10px] font-semibold text-amber-200 border border-amber-400/40">${vehicle.status || 'ACTIVE'}</span>
            </div>

            <div class="text-[12px] text-slate-200 space-y-1">
              <p class="font-semibold">${vehicle.customer || 'Customer pending'}</p>
              <p class="flex items-center gap-2">
                <span class="inline-flex h-2 w-2 rounded-full ${accuracyDot}"></span>
                <span>${vehicle.lastLocation || 'No location provided'}</span>
              </p>
              ${vehicle.locationNote ? `<p class="text-[11px] text-amber-200 font-semibold">${vehicle.locationNote}</p>` : ''}
            </div>

            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">GPS</p>
                <p class="font-semibold text-slate-50">${vehicle.gpsFix || 'Unknown'}</p>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                <p class="font-semibold text-slate-50">${vehicle.dealCompletion || '—'}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function parseDealCompletion(value) {
      if (value === null || value === undefined) return null;
      const raw = String(value).replace(/%/g, '').trim();
      const num = parseFloat(raw);
      if (!Number.isFinite(num)) return null;
      if (num <= 1) return num * 100;
      return num;
    }

    function matchesRange(value, min, max) {
      const pct = parseDealCompletion(value);
      if (!Number.isFinite(pct)) return min <= 0; // allow unknowns only when the range starts at 0
      return pct >= min && pct <= max;
    }

    const normalizeFilterValue = (value) => (value ?? '').toString().trim().toLowerCase();

    function matchesVehicleFilters(vehicle, query) {
      const q = (query || '').toLowerCase();
      if (q) {
        const matchesSearch =
          vehicle.model.toLowerCase().includes(q) ||
          vehicle.vin.toLowerCase().includes(q) ||
          vehicle.lastLocation.toLowerCase().includes(q) ||
          vehicle.customer.toLowerCase().includes(q);
        if (!matchesSearch) return false;
      }

      const invPrep = normalizeFilterValue(vehicle.invPrepStatus);
      if (vehicleFilters.invPrep !== 'all' && invPrep !== vehicleFilters.invPrep) return false;

      const gpsFix = normalizeFilterValue(vehicle.gpsFix);
      if (vehicleFilters.gpsFix !== 'all' && gpsFix !== vehicleFilters.gpsFix) return false;

      const dealStatus = normalizeFilterValue(vehicle.status);
      if (vehicleFilters.dealStatus !== 'all' && dealStatus !== vehicleFilters.dealStatus) return false;

      const ptStatus = normalizeFilterValue(vehicle.ptStatus);
      if (vehicleFilters.ptStatus !== 'all' && ptStatus !== vehicleFilters.ptStatus) return false;

      if (!matchesRange(vehicle.dealCompletion, vehicleFilters.dealMin, vehicleFilters.dealMax)) return false;

      const isStopped = isVehicleNotMoving(vehicle);
      if (vehicleFilters.moving === 'moving' && isStopped) return false;
      if (vehicleFilters.moving === 'stopped' && !isStopped) return false;

      return true;
    }

    function filterVehicles(list, query) {
      return list.filter(v => matchesVehicleFilters(v, query));
    }

    function getVehiclesForTech(tech) {
      if (!tech || !map) return [];
      const withDistance = vehicles
        .filter(hasValidCoords)
        .map(v => ({
          vehicle: v,
          distance: getDistance(v.lat, v.lng, tech.lat, tech.lng)
        }));
      return withDistance
        .filter(item => item.distance <= 180)
        .sort((a, b) => a.distance - b.distance)
        .map(item => item.vehicle);
    }

    function getUniqueVehicleValues(field) {
      return Array.from(new Set(vehicles
        .map(v => normalizeFilterValue(v?.[field]))
        .filter(Boolean)))
        .sort();
    }

    function setSelectOptions(selectId, values) {
      const select = document.getElementById(selectId);
      if (!select) return;
      const previous = select.value;
      select.innerHTML = '<option value="all">All</option>';
      values.forEach((val) => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
      if (values.includes(previous)) {
        select.value = previous;
      }
    }

    function updateVehicleFilterOptions() {
      setSelectOptions('filter-invprep', getUniqueVehicleValues('invPrepStatus'));
      setSelectOptions('filter-gps', getUniqueVehicleValues('gpsFix'));
      setSelectOptions('filter-deal-status', getUniqueVehicleValues('status'));
      setSelectOptions('filter-pt', getUniqueVehicleValues('ptStatus'));
    }

    function syncVehicleFilterInputs() {
      const invPrepSelect = document.getElementById('filter-invprep');
      const gpsSelect = document.getElementById('filter-gps');
      const movingSelect = document.getElementById('filter-moving');
      const dealStatusSelect = document.getElementById('filter-deal-status');
      const ptSelect = document.getElementById('filter-pt');
      const minInput = document.getElementById('filter-deal-min');
      const maxInput = document.getElementById('filter-deal-max');

      if (invPrepSelect) invPrepSelect.value = vehicleFilters.invPrep;
      if (gpsSelect) gpsSelect.value = vehicleFilters.gpsFix;
      if (movingSelect) movingSelect.value = vehicleFilters.moving;
      if (dealStatusSelect) dealStatusSelect.value = vehicleFilters.dealStatus;
      if (ptSelect) ptSelect.value = vehicleFilters.ptStatus;
      if (minInput) minInput.value = vehicleFilters.dealMin;
      if (maxInput) maxInput.value = vehicleFilters.dealMax;
    }

    function resetVehicleFilters() {
      vehicleFilters.invPrep = 'all';
      vehicleFilters.gpsFix = 'all';
      vehicleFilters.moving = 'all';
      vehicleFilters.dealStatus = 'all';
      vehicleFilters.ptStatus = 'all';
      vehicleFilters.dealMin = 0;
      vehicleFilters.dealMax = 100;
      syncVehicleFilterInputs();
      renderVehicles();
    }

    function bindVehicleFilterHandlers() {
      const selectHandlers = [
        { id: 'filter-invprep', key: 'invPrep' },
        { id: 'filter-gps', key: 'gpsFix' },
        { id: 'filter-moving', key: 'moving' },
        { id: 'filter-deal-status', key: 'dealStatus' },
        { id: 'filter-pt', key: 'ptStatus' }
      ];

      selectHandlers.forEach(({ id, key }) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('change', () => {
          vehicleFilters[key] = el.value || 'all';
          renderVehicles();
        });
      });

      const minInput = document.getElementById('filter-deal-min');
      const maxInput = document.getElementById('filter-deal-max');
      [minInput, maxInput].forEach((input, idx) => {
        if (!input) return;
        input.addEventListener('input', () => {
          const val = parseFloat(input.value);
          if (Number.isFinite(val)) {
            if (idx === 0) vehicleFilters.dealMin = Math.max(0, Math.min(val, 100));
            else vehicleFilters.dealMax = Math.max(0, Math.min(val, 100));
          } else {
            if (idx === 0) vehicleFilters.dealMin = 0;
            else vehicleFilters.dealMax = 100;
          }
          if (vehicleFilters.dealMin > vehicleFilters.dealMax) {
            vehicleFilters.dealMin = vehicleFilters.dealMax;
            syncVehicleFilterInputs();
          }
          renderVehicles();
        });
      });

      const resetBtn = document.getElementById('vehicle-filters-reset');
      resetBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        resetVehicleFilters();
      });
    }

    function getVehicleList(query) {
      if (selectedVehicleId !== null) {
        return vehicles.filter(v => v.id === selectedVehicleId);
      }

      if (selectedTechId !== null) {
        const tech = technicians.find(t => t.id === selectedTechId);
        const nearby = getVehiclesForTech(tech);
        return nearby.length ? nearby : vehicles;
      }

      return filterVehicles(vehicles, query);
    }

    function getTechList(baseList = technicians) {
      const origin = getCurrentOrigin();

      const sorted = origin
        ? baseList
            .map(t => ({ ...t, distance: getDistance(origin.lat, origin.lng, t.lat, t.lng) }))
            .sort((a, b) => a.distance - b.distance)
        : [...baseList];

      if (selectedTechId !== null) {
        const selectedTech = sorted.find(t => t.id === selectedTechId) || baseList.find(t => t.id === selectedTechId);
        if (selectedTech) {
          return [selectedTech, ...sorted.filter(t => t.id !== selectedTech.id)];
        }
      }

      return sorted;
    }

    function findNearestTechnician(point, maxDistanceMeters = 40000) {
      if (!technicians.length || !map) return null;
      let closest = null;
      let closestDistance = Infinity;

      technicians.forEach((tech) => {
        const dist = map.distance([point.lat, point.lng], [tech.lat, tech.lng]);
        if (dist < closestDistance) {
          closestDistance = dist;
          closest = tech;
        }
      });

      return closestDistance <= maxDistanceMeters ? closest : null;
    }

    function getVehicleMarkerColor(vehicle) {
      const fix = (vehicle.gpsFix || '').trim().toLowerCase();
      if (fix.includes('fully working')) return '#22c55e';
      if (fix === 'all' || fix.includes('all')) return '#ef4444';
      return '#f59e0b';
    }

    function getVehicleMarkerBorderColor(fillColor) {
      const color = (fillColor || '').toLowerCase();
      if (color === '#22c55e') return '#166534';
      if (color === '#f59e0b') return '#92400e';
      return '#991b1b';
    }

    function getMovingMeta(vehicle) {
      const movingValue = parseInt(vehicle.moving || vehicle.movingCalc || vehicle.gpsMoving || '', 10);
      if (movingValue === 1) {
        return { label: 'Moving', text: 'text-emerald-200', bg: 'bg-emerald-500/10', dot: 'bg-emerald-400' };
      }
      if (movingValue === -1) {
        return { label: 'Not moving', text: 'text-amber-200', bg: 'bg-amber-500/10', dot: 'bg-amber-400' };
      }
      return { label: 'Unknown', text: 'text-slate-300', bg: 'bg-slate-800/70', dot: 'bg-slate-400' };
    }

    function isVehicleNotMoving(vehicle) {
      const movingValue = parseInt(vehicle.moving || vehicle.movingCalc || vehicle.gpsMoving || '', 10);
      return movingValue === -1;
    }

    function toggleSelectionBanner() {
      const banner = document.getElementById('selection-banner');
      const text = document.getElementById('selection-text');
      if (!banner || !text) return;

      if (selectedVehicleId === null && selectedTechId === null) {
        banner.classList.add('hidden');
        return;
      }

      const vehicle = vehicles.find(v => v.id === selectedVehicleId);
      const tech = technicians.find(t => t.id === selectedTechId);
      const parts = [];
      if (vehicle) parts.push(`Vehículo ${vehicle.vin || vehicle.model}`);
      if (tech) parts.push(`Técnico ${tech.company}`);
      text.textContent = `Filtered by ${parts.join(' & ')}`;
      banner.classList.remove('hidden');
    }

    function applySelection(vehicleId = null, techId = null) {
      selectedVehicleId = vehicleId;
      selectedTechId = techId;
      if (vehicleId !== null) {
        sidebarStateController?.setState?.('right', true);
      }
      renderVehicles();
      renderVisibleSidebars();
      toggleSelectionBanner();
    }

    function resetSelection() {
      selectedVehicleId = null;
      selectedTechId = null;
      Object.keys(selectedServiceByType).forEach(key => delete selectedServiceByType[key]);
      highlightLayer?.clearLayers();
      connectionLayer?.clearLayers();
      serviceLayer?.clearLayers();
      serviceConnectionLayer?.clearLayers();
      lastOriginPoint = null;
      lastClientLocation = null;
      renderVehicles();
      renderVisibleSidebars();
      toggleSelectionBanner();
      sidebarStateController?.setState?.('right', false);
    }

    function findNearestVehicle(point, maxDistanceMeters = 80000) {
      if (!vehicles.length || !map) return null;
      let closest = null;
      let closestDistance = Infinity;

      vehicles.forEach((vehicle) => {
        if (!hasValidCoords(vehicle)) return;
        const dist = map.distance([point.lat, point.lng], [vehicle.lat, vehicle.lng]);
        if (dist < closestDistance) {
          closestDistance = dist;
          closest = vehicle;
        }
      });

      return closestDistance <= maxDistanceMeters ? closest : null;
    }

    // --- 5. Real search logic (Nominatim) ---
    async function geocodeAddress(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", USA")}`);
        const data = await response.json();
        if (data && data.length > 0) {
          return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
        }
        return null;
      } catch (e) {
        console.error("Geocoding error", e);
        return null;
      }
    }

    function processLocation(location, label = '', partnerTypeOverride = null) {
      if (!location) return;

      if (label) {
        document.getElementById('address-input').value = label;
      }

      targetLayer.clearLayers();
      connectionLayer.clearLayers();
      serviceLayer?.clearLayers();
      serviceConnectionLayer?.clearLayers();
      const targetIcon = L.divIcon({
        className: '',
        html: `<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>`
      });
      L.marker([location.lat, location.lng], { icon: targetIcon }).addTo(targetLayer);
      const popup = L.marker([location.lat, location.lng]).addTo(targetLayer);
      popup.bindPopup(`<b>Client</b><br>${label || location.name || ''}`).openPopup();
      lastClientLocation = location;

      const partnerType = partnerTypeOverride || (isAnyServiceSidebarOpen() ? getActivePartnerType() : null);
      if (partnerType) {
        const partnerList = getPartnerListByType(partnerType);
        if (partnerType === 'tech') {
          updateTechUI(partnerList, true, location);
        } else if (partnerType === 'towing') {
          updateTowingUI(partnerList);
        } else if (partnerType === 'reseller') {
          updateResellerUI(partnerList);
        } else if (partnerType === 'repair') {
          updateRepairUI(partnerList);
        } else if (partnerType === 'locksmith') {
          updateLocksmithUI(partnerList);
        } else if (partnerType === 'dispatcher') {
          updateDispatcherUI(partnerList);
        } else if (partnerType === 'tire') {
          updateTireUI(partnerList);
        } else if (partnerType === 'inspector') {
          updateInspectorUI(partnerList);
        }
      }

      showServicesFromOrigin(location, { forceType: partnerType });
    }

    function setupAddressSearch({ formId, inputId, buttonId, statusId, partnerType }) {
      const form = document.getElementById(formId);
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      const status = statusId ? document.getElementById(statusId) : null;
      if (!form || !input || !button) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = input.value.trim();
        const partners = getPartnerListByType(partnerType);
        if (!query || partners.length === 0) return;

        const originalBtnText = button.innerHTML;
        button.innerHTML = `<i data-lucide="loader-2" class="animate-spin h-4 w-4"></i>`;
        button.disabled = true;
        status?.classList.remove('hidden');
        iconLib.createIcons();

        const location = await geocodeAddress(query);

        button.innerHTML = originalBtnText;
        button.disabled = false;
        status?.classList.add('hidden');

        if (!location) {
          alert("Address not found. Try a ZIP code or city name.");
          return;
        }

        processLocation(location, location.name || query, partnerType);
      });
    }

    setupAddressSearch({
      formId: 'search-form',
      inputId: 'address-input',
      buttonId: 'search-btn',
      statusId: 'search-status',
      partnerType: 'tech'
    });

    setupAddressSearch({
      formId: 'towing-search-form',
      inputId: 'towing-address-input',
      buttonId: 'towing-search-btn',
      statusId: 'towing-search-status',
      partnerType: 'towing'
    });

    setupAddressSearch({
      formId: 'reseller-search-form',
      inputId: 'reseller-address-input',
      buttonId: 'reseller-search-btn',
      statusId: 'reseller-search-status',
      partnerType: 'reseller'
    });

    setupAddressSearch({
      formId: 'repair-search-form',
      inputId: 'repair-address-input',
      buttonId: 'repair-search-btn',
      statusId: 'repair-search-status',
      partnerType: 'repair'
    });

    setupAddressSearch({
      formId: 'locksmith-search-form',
      inputId: 'locksmith-address-input',
      buttonId: 'locksmith-search-btn',
      statusId: 'locksmith-search-status',
      partnerType: 'locksmith'
    });

    setupAddressSearch({
      formId: 'dispatcher-search-form',
      inputId: 'dispatcher-address-input',
      buttonId: 'dispatcher-search-btn',
      statusId: 'dispatcher-search-status',
      partnerType: 'dispatcher'
    });

    setupAddressSearch({
      formId: 'tire-search-form',
      inputId: 'tire-address-input',
      buttonId: 'tire-search-btn',
      statusId: 'tire-search-status',
      partnerType: 'tire'
    });

    setupAddressSearch({
      formId: 'inspector-search-form',
      inputId: 'inspector-address-input',
      buttonId: 'inspector-search-btn',
      statusId: 'inspector-search-status',
      partnerType: 'inspector'
    });

    function openVehicleModal(vehicle) {
      const modal = document.getElementById('vehicle-modal');
      const title = document.getElementById('vehicle-modal-title');
      const body = document.getElementById('vehicle-modal-body');
      if (!modal || !title || !body) return;

      title.textContent = `${vehicle.model || 'Vehículo'} ${vehicle.year || ''} • ${vehicle.vin || ''}`;
      const detailRows = vehicleHeaders.map(header => {
        const value = vehicle.details?.[header] || vehicle[header] || vehicle[header.toLowerCase()] || '—';
        return `<tr class="border-b border-slate-800/80"><th class="text-left text-xs font-semibold text-slate-300 py-2 pr-3">${header}</th><td class="text-xs text-slate-100 py-2">${value || '—'}</td></tr>`;
      }).join('');
      body.innerHTML = `<table class="w-full text-left">${detailRows}</table>`;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeVehicleModal() {
      const modal = document.getElementById('vehicle-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function setEditStatus(message = '', tone = 'info') {
      const status = document.getElementById('vehicle-edit-status');
      if (!status) return;

      if (!message) {
        status.classList.add('hidden');
        status.textContent = '';
        return;
      }

      const toneClasses = {
        success: 'border-emerald-700 bg-emerald-500/15 text-emerald-100',
        error: 'border-red-700 bg-red-600/15 text-red-100',
        info: 'border-amber-700 bg-amber-600/15 text-amber-100'
      };

      status.className = `rounded-lg border px-3 py-2 text-xs font-semibold ${toneClasses[tone] || toneClasses.info}`;
      status.textContent = message;
      status.classList.remove('hidden');
    }

    const coerceValueForUpdate = (value, original) => {
      if (value === '') return null;
      if (typeof original === 'number') {
        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : original;
      }
      if (typeof original === 'boolean') return value === 'true' || value === '1' || value === 'yes';
      return value;
    };

    const buildEditableFields = (vehicle) => {
      return vehicleHeaders
        .filter(header => header !== 'id' && header !== 'created_at')
        .map((header) => ({
          key: header,
          value: vehicle[header] ?? vehicle[header?.toLowerCase()] ?? ''
        }));
    };

    function openVehicleEditModal(vehicle) {
      if (!isAdminUser() || !supabaseClient) return;

      const modal = document.getElementById('vehicle-edit-modal');
      const title = document.getElementById('vehicle-edit-title');
      const fieldsContainer = document.getElementById('vehicle-edit-fields');
      const saveBtn = document.getElementById('vehicle-edit-save');

      if (!modal || !title || !fieldsContainer || !saveBtn) return;

      editingVehicleId = vehicle.id;
      title.textContent = `${vehicle.model || 'Vehículo'} ${vehicle.year || ''} • ${vehicle.vin || ''}`.trim();

      const editableFields = buildEditableFields(vehicle);
      const staticIdField = `
        <div class="space-y-1">
          <label class="block text-[11px] font-semibold text-slate-300">ID</label>
          <input type="text" value="${escapeHTML(vehicle.id)}" class="w-full rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-xs text-slate-200" disabled>
        </div>
      `;

      fieldsContainer.innerHTML = [staticIdField, ...editableFields.map(({ key, value }) => `
        <div class="space-y-1">
          <label class="block text-[11px] font-semibold text-slate-300">${key}</label>
          <input
            name="field-${key}"
            type="text"
            value="${escapeHTML(value ?? '')}"
            class="w-full rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-xs text-slate-100 placeholder-slate-500 focus:border-amber-400 focus:ring-1 focus:ring-amber-400"
          >
        </div>
      `)].join('');

      setEditStatus('');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      saveBtn.disabled = false;
      iconLib.createIcons();
    }

    function closeVehicleEditModal() {
      const modal = document.getElementById('vehicle-edit-modal');
      const form = document.getElementById('vehicle-edit-form');
      if (!modal || !form) return;
      editingVehicleId = null;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      form.reset();
      setEditStatus('');
    }

    async function handleVehicleEditSubmit(event) {
      event.preventDefault();
      if (!isAdminUser() || !supabaseClient || !editingVehicleId) return;

      const vehicle = vehicles.find(v => v.id === editingVehicleId);
      if (!vehicle) {
        setEditStatus('No se encontró el vehículo seleccionado.', 'error');
        return;
      }

      const saveBtn = document.getElementById('vehicle-edit-save');
      const form = document.getElementById('vehicle-edit-form');
      if (!form || !saveBtn) return;

      const editableFields = buildEditableFields(vehicle);
      const updates = {};

      editableFields.forEach(({ key }) => {
        const input = form.querySelector(`[name="field-${key}"]`);
        if (input) {
          updates[key] = coerceValueForUpdate(input.value, vehicle[key]);
        }
      });

      saveBtn.disabled = true;
      setEditStatus('Guardando cambios…', 'info');

      const { error } = await supabaseClient
        .from(TABLES.vehicles)
        .update(updates)
        .eq('id', editingVehicleId);

      if (error) {
        console.error('Error updating vehicle:', error.message);
        setEditStatus(`No se pudo guardar: ${error.message}`, 'error');
        saveBtn.disabled = false;
        return;
      }

      Object.assign(vehicle, updates);
      setEditStatus('Cambios guardados correctamente.', 'success');
      renderVehicles();
      setTimeout(closeVehicleEditModal, 600);
    }

    const getPartnerCollection = (type = '') => {
      const collections = {
        technicians,
        towing: towingCompanies,
        reseller: resellers,
        repair: repairShops,
        locksmith: locksmiths,
        dispatcher: dispatchers,
        tire: tirePartners,
        inspector: inspectors,
      };
      return collections[type] || [];
    };

    const refreshServiceUI = (type = '') => {
      const redraw = {
        technicians: () => updateTechUI(getTechList(technicians)),
        towing: () => updateTowingUI(towingCompanies),
        reseller: () => updateResellerUI(resellers),
        repair: () => updateRepairUI(repairShops),
        locksmith: () => updateLocksmithUI(locksmiths),
        dispatcher: () => updateDispatcherUI(dispatchers),
        tire: () => updateTireUI(tirePartners),
        inspector: () => updateInspectorUI(inspectors),
      };

      if (typeof redraw[type] === 'function') {
        redraw[type]();
      }
    };

    const getServiceHeadersForPartner = (partner) => {
      if (!partner) return [];
      const headers = getServiceHeaders(partner.type);
      if (headers.length) return headers;
      return partner.details ? Object.keys(partner.details) : [];
    };

    const buildServiceEditableFields = (partner) => {
      return getServiceHeadersForPartner(partner)
        .filter(header => header !== 'id' && header !== 'created_at')
        .map((header) => ({
          key: header,
          value: partner.details?.[header] ?? partner[header] ?? ''
        }));
    };

    function setServiceEditStatus(message = '', tone = 'info') {
      const status = document.getElementById('service-edit-status');
      if (!status) return;

      if (!message) {
        status.classList.add('hidden');
        status.textContent = '';
        return;
      }

      const toneClasses = {
        success: 'border-emerald-700 bg-emerald-600/15 text-emerald-100',
        error: 'border-red-700 bg-red-600/15 text-red-100',
        info: 'border-emerald-700 bg-emerald-600/15 text-emerald-100'
      };

      status.className = `rounded-lg border px-3 py-2 text-xs font-semibold ${toneClasses[tone] || toneClasses.info}`;
      status.textContent = message;
      status.classList.remove('hidden');
    }

    function openServiceEditModal(partner) {
      if (!isAdminUser() || !supabaseClient || !partner) return;

      const modal = document.getElementById('service-edit-modal');
      const title = document.getElementById('service-edit-title');
      const fieldsContainer = document.getElementById('service-edit-fields');
      const saveBtn = document.getElementById('service-edit-save');

      if (!modal || !title || !fieldsContainer || !saveBtn) return;

      editingService = { id: partner.id, type: partner.type };
      title.textContent = `${partner.company || 'Servicio'} ${partner.city ? '• ' + partner.city : ''}`.trim();

      const editableFields = buildServiceEditableFields(partner);
      const staticIdField = `
        <div class="space-y-1">
          <label class="block text-[11px] font-semibold text-slate-300">ID</label>
          <input type="text" value="${escapeHTML(partner.id)}" class="w-full rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-xs text-slate-200" disabled>
        </div>
      `;

      fieldsContainer.innerHTML = [staticIdField, ...editableFields.map(({ key, value }) => `
        <div class="space-y-1">
          <label class="block text-[11px] font-semibold text-slate-300">${key}</label>
          <input
            name="service-field-${key}"
            type="text"
            value="${escapeHTML(value ?? '')}"
            class="w-full rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-xs text-slate-100 placeholder-slate-500 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400"
          >
        </div>
      `)].join('');

      setServiceEditStatus('');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      saveBtn.disabled = false;
      iconLib.createIcons();
    }

    function closeServiceEditModal() {
      const modal = document.getElementById('service-edit-modal');
      const form = document.getElementById('service-edit-form');
      if (!modal || !form) return;
      editingService = null;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      form.reset();
      setServiceEditStatus('');
    }

    async function handleServiceEditSubmit(event) {
      event.preventDefault();
      if (!isAdminUser() || !supabaseClient || !editingService) return;

      const { id, type } = editingService;
      const collection = getPartnerCollection(type);
      const partner = collection.find((p) => p.id === id);
      if (!partner) {
        setServiceEditStatus('No se encontró el servicio seleccionado.', 'error');
        return;
      }

      const saveBtn = document.getElementById('service-edit-save');
      const form = document.getElementById('service-edit-form');
      if (!form || !saveBtn) return;

      const editableFields = buildServiceEditableFields(partner);
      const updates = {};

      editableFields.forEach(({ key }) => {
        const input = form.querySelector(`[name="service-field-${key}"]`);
        if (input) {
          updates[key] = coerceValueForUpdate(input.value, partner.details?.[key] ?? partner[key]);
        }
      });

      saveBtn.disabled = true;
      setServiceEditStatus('Guardando cambios…', 'info');

      const { error } = await supabaseClient
        .from(TABLES.services)
        .update(updates)
        .eq('id', id);

      if (error) {
        console.error('Error updating service:', error.message);
        setServiceEditStatus(`No se pudo guardar: ${error.message}`, 'error');
        saveBtn.disabled = false;
        return;
      }

      const updatedRow = { ...(partner.details || {}), ...updates };
      const refreshed = partner.type === 'technicians'
        ? normalizeInstaller(updatedRow, partner.seed ?? 0)
        : normalizePartner(updatedRow, partner.type, partner.seed ?? 0);
      Object.assign(partner, refreshed);
      setServiceEditStatus('Cambios guardados correctamente.', 'success');
      refreshServiceUI(partner.type);
      setTimeout(closeServiceEditModal, 600);
    }

    function attachPopupHandlers() {
      const btn = document.querySelector('.vehicle-popup button[data-view-more-popup]');
      if (btn) {
        btn.addEventListener('click', () => {
          const vehicleId = selectedVehicleId;
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) openVehicleModal(vehicle);
        });
      }
      iconLib.createIcons();
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function getPartnerListByType(type) {
      if (type === 'towing') return towingCompanies;
      if (type === 'reseller') return resellers;
      if (type === 'repair') return repairShops;
      if (type === 'locksmith') return locksmiths;
      if (type === 'dispatcher') return dispatchers;
      if (type === 'tire') return tirePartners;
      if (type === 'inspector') return inspectors;
      return technicians;
    }

    function getActivePartnerType() {
      const visibleTypes = getVisibleServiceTypes();
      if (visibleTypes.length) return visibleTypes[0];
      const typeMap = {
        left: 'tech',
        towing: 'towing',
        reseller: 'reseller',
        repair: 'repair',
        locksmith: 'locksmith',
        dispatcher: 'dispatcher',
        tire: 'tire',
        inspector: 'inspector'
      };
      if (activeLeftPanel && typeMap[activeLeftPanel]) return typeMap[activeLeftPanel];
      if (towingSidebarVisible && isServiceTypeEnabled('towing')) return 'towing';
      if (resellerSidebarVisible && isServiceTypeEnabled('reseller')) return 'reseller';
      if (repairSidebarVisible && isServiceTypeEnabled('repair')) return 'repair';
      if (locksmithSidebarVisible && isServiceTypeEnabled('locksmith')) return 'locksmith';
      if (dispatcherSidebarVisible && isServiceTypeEnabled('dispatcher')) return 'dispatcher';
      if (tireSidebarVisible && isServiceTypeEnabled('tire')) return 'tire';
      if (inspectorSidebarVisible && isServiceTypeEnabled('inspector')) return 'inspector';
      const [firstEnabled] = getEnabledServiceTypes();
      return firstEnabled || 'tech';
    }

    function getVisibleServiceTypes() {
      const visibleTypes = [];
      if (techSidebarVisible && isServiceTypeEnabled('tech')) visibleTypes.push('tech');
      if (towingSidebarVisible && isServiceTypeEnabled('towing')) visibleTypes.push('towing');
      if (resellerSidebarVisible && isServiceTypeEnabled('reseller')) visibleTypes.push('reseller');
      if (repairSidebarVisible && isServiceTypeEnabled('repair')) visibleTypes.push('repair');
        if (locksmithSidebarVisible && isServiceTypeEnabled('locksmith')) visibleTypes.push('locksmith');
        if (dispatcherSidebarVisible && isServiceTypeEnabled('dispatcher')) visibleTypes.push('dispatcher');
        if (tireSidebarVisible && isServiceTypeEnabled('tire')) visibleTypes.push('tire');
        if (inspectorSidebarVisible && isServiceTypeEnabled('inspector')) visibleTypes.push('inspector');
        if (customSidebarVisible && isServiceTypeEnabled('custom')) visibleTypes.push('custom');
        return visibleTypes;
      }

    function getPartnerLabel(type) {
      if (type === 'towing') return 'towing company';
      if (type === 'reseller') return 'reseller';
      if (type === 'repair') return 'repair shop';
      if (type === 'locksmith') return 'locksmith';
      if (type === 'dispatcher') return 'dispatcher';
      if (type === 'tire') return 'tire service';
      if (type === 'inspector') return 'inspector';
      return 'technician';
    }

    function getNearestFromList(point, list, type) {
      if (!point || !list.length) return null;
      let nearest = null;
      let bestDist = Infinity;
      list.forEach(item => {
        const dist = getDistance(point.lat, point.lng, item.lat, item.lng);
        if (dist < bestDist) {
          bestDist = dist;
          nearest = item;
        }
      });
      return nearest ? { entry: nearest, distance: bestDist, type } : null;
    }

    function getNearestPartner(vehicle) {
      const type = getActivePartnerType();
      const list = getPartnerListByType(type);
      return getNearestFromList(vehicle, list, type);
    }

    function addLabeledConnection(layer, start, end, distance, color, options = {}) {
      if (!layer || !start || !end) return null;
      const { dashArray = '6 4', weight = 3, opacity = 0.85 } = options;

      L.polyline(
        [
          [start.lat, start.lng],
          [end.lat, end.lng]
        ],
        { color, weight, opacity, dashArray }
      ).addTo(layer);

      const midLat = (start.lat + end.lat) / 2;
      const midLng = (start.lng + end.lng) / 2;
      const label = L.marker([midLat, midLng], {
        icon: L.divIcon({
          className: 'distance-label-wrapper',
          html: `<div class="distance-label" style="--line-color:${color}">${distance.toFixed(1)} mi</div>`,
          iconSize: [0, 0],
          iconAnchor: [0, 0]
        }),
        interactive: false
      });

      label.addTo(layer);
      return label;
    }

    function showServicesFromOrigin(origin, { forceType = null } = {}) {
      serviceLayer?.clearLayers();
      serviceConnectionLayer?.clearLayers();
      const hasSidebarOpen = isAnyServiceSidebarOpen();
      const hasExplicitType = !!forceType;
      if (!origin || (!hasSidebarOpen && !hasExplicitType)) return;

      lastOriginPoint = { lat: origin.lat, lng: origin.lng, name: origin.name || origin.customer || '' };

      const visibleTypes = getVisibleServiceTypes();
      const activeTypes = forceType
        ? [forceType]
        : visibleTypes;

      activeTypes.forEach((type) => {
        const baseList = getPartnerListByType(type);
        if (!baseList.length) return;
        const filtered = applyServiceFilter(baseList, type);
        const selectedPartner = getSelectedService(type);
        const chosen = selectedPartner || getNearestFromList(origin, filtered, type)?.entry;
        if (!chosen) return;

        const unauthorized = isUnauthorizedPartner(chosen);
        const color = getPartnerColor(chosen, SERVICE_COLORS[type] || '#38bdf8');
        const marker = L.marker([chosen.lat, chosen.lng], {
          icon: createServiceIcon(color, { unauthorized })
        }).addTo(serviceLayer);

        marker.on('click', (e) => {
          e.originalEvent.handledByMarker = true;
          sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
          selectedServiceByType[type] = chosen;
          showServicePreviewCard(chosen);
          map.panTo([chosen.lat, chosen.lng]);
        });

        const distance = getDistance(origin.lat, origin.lng, chosen.lat, chosen.lng);
        addLabeledConnection(
          serviceConnectionLayer,
          origin,
          chosen,
          Math.max(distance, 0),
          color,
          { dashArray: '6 4', weight: 3, opacity: 0.85 }
        );
      });
    }

    function drawConnection(origin, partnerInfo) {
      const type = partnerInfo?.type || getActivePartnerType();
      const target = partnerInfo?.entry || partnerInfo;
      const isVisible = (type === 'tech' && techSidebarVisible) || (type === 'towing' && towingSidebarVisible) || (type === 'reseller' && resellerSidebarVisible) || (type === 'repair' && repairSidebarVisible) || (type === 'locksmith' && locksmithSidebarVisible) || (type === 'dispatcher' && dispatcherSidebarVisible) || (type === 'tire' && tireSidebarVisible) || (type === 'inspector' && inspectorSidebarVisible);
      if (!target || !origin || !isVisible) return;
      const color = type === 'towing'
        ? '#c084fc'
        : type === 'reseller'
        ? '#34d399'
        : type === 'repair'
        ? '#fb923c'
        : type === 'locksmith'
        ? '#facc15'
        : type === 'dispatcher'
        ? '#38bdf8'
        : type === 'tire'
        ? '#a3e635'
        : '#818cf8';
      connectionLayer.clearLayers();
      const miles = getDistance(origin.lat, origin.lng, target.lat, target.lng);
      addLabeledConnection(
        connectionLayer,
        origin,
        target,
        miles,
        color,
        { dashArray: '6 6', weight: 3, opacity: 0.8 }
      );
    }

    function setupResizableSidebars() {
      const layout = document.getElementById('map-layout');
      const leftSidebar = document.getElementById('left-sidebar');
      const rightSidebar = document.getElementById('right-sidebar');
      if (!layout || !leftSidebar || !rightSidebar) return;

      const rootStyle = document.documentElement.style;
      const minWidth = 260;
      const maxWidth = 720;
      let activeDrag = null;

      const clampWidth = (value) => Math.min(Math.max(value, minWidth), maxWidth);

      const applyWidth = (side, width) => {
        rootStyle.setProperty(side === 'left' ? '--left-sidebar-width' : '--right-sidebar-width', `${width}px`);
        if (map) {
          map.invalidateSize();
        }
      };

      const onMouseMove = (event) => {
        if (!activeDrag) return;
        const bounds = layout.getBoundingClientRect();

        if (activeDrag === 'left') {
          const newWidth = clampWidth(event.clientX - bounds.left);
          applyWidth('left', newWidth);
        }

        if (activeDrag === 'right') {
          const newWidth = clampWidth(bounds.right - event.clientX);
          applyWidth('right', newWidth);
        }
      };

      const stopDrag = () => {
        activeDrag = null;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', stopDrag);
      };

      const startDrag = (side, event) => {
        event.preventDefault();
        activeDrag = side;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', stopDrag);
      };

      leftSidebar.querySelector('.resize-handle')?.addEventListener('mousedown', (e) => startDrag('left', e));
      rightSidebar.querySelector('.resize-handle')?.addEventListener('mousedown', (e) => startDrag('right', e));
    }

    const defaultSidebarVisible = false;

    function setupSidebarToggles() {
      const leftSidebar = document.getElementById('left-sidebar');
      const rightSidebar = document.getElementById('right-sidebar');
      const towingSidebar = document.getElementById('towing-sidebar');
      const resellerSidebar = document.getElementById('reseller-sidebar');
      const repairSidebar = document.getElementById('repair-sidebar');
      const locksmithSidebar = document.getElementById('locksmith-sidebar');
        const dispatcherSidebar = document.getElementById('dispatcher-sidebar');
        const tireSidebar = document.getElementById('tire-sidebar');
        const inspectorSidebar = document.getElementById('inspector-sidebar');
        const customSidebar = document.getElementById('custom-sidebar');
        const openLeft = document.getElementById('open-left-sidebar');
        const openRight = document.getElementById('open-right-sidebar');
        const openTowing = document.getElementById('open-towing-sidebar');
        const openReseller = document.getElementById('open-reseller-sidebar');
        const openRepair = document.getElementById('open-repair-sidebar');
        const openLocksmith = document.getElementById('open-locksmith-sidebar');
        const openDispatcher = document.getElementById('open-dispatcher-sidebar');
        const openTire = document.getElementById('open-tire-sidebar');
        const openInspector = document.getElementById('open-inspector-sidebar');
        const openCustom = customToggleRef || document.querySelector('#custom-category-toggles .sidebar-toggle-btn');
        const collapseLeft = document.getElementById('collapse-left');
        const collapseRight = document.getElementById('collapse-right');
        const collapseTowing = document.getElementById('collapse-towing');
        const collapseReseller = document.getElementById('collapse-reseller');
        const collapseRepair = document.getElementById('collapse-repair');
        const collapseLocksmith = document.getElementById('collapse-locksmith');
        const collapseDispatcher = document.getElementById('collapse-dispatcher');
        const collapseTire = document.getElementById('collapse-tire');
        const collapseInspector = document.getElementById('collapse-inspector');
        const collapseCustom = document.getElementById('collapse-custom');

      const defaultLeftOffset = 12;
      const defaultRightOffset = 12;
      const syncSidebarVisibility = () => {
        const previousVisibility = {
          tech: techSidebarVisible,
          towing: towingSidebarVisible,
          reseller: resellerSidebarVisible,
          repair: repairSidebarVisible,
          locksmith: locksmithSidebarVisible,
          dispatcher: dispatcherSidebarVisible,
          tire: tireSidebarVisible,
          inspector: inspectorSidebarVisible,
          custom: customSidebarVisible,
        };

        techSidebarVisible = isServiceTypeEnabled('tech') && !!leftSidebar && !leftSidebar.classList.contains('collapsed-left');
        towingSidebarVisible = isServiceTypeEnabled('towing') && !!towingSidebar && !towingSidebar.classList.contains('collapsed-towing');
        resellerSidebarVisible = isServiceTypeEnabled('reseller') && !!resellerSidebar && !resellerSidebar.classList.contains('collapsed-reseller');
        repairSidebarVisible = isServiceTypeEnabled('repair') && !!repairSidebar && !repairSidebar.classList.contains('collapsed-repair');
        locksmithSidebarVisible = isServiceTypeEnabled('locksmith') && !!locksmithSidebar && !locksmithSidebar.classList.contains('collapsed-locksmith');
        dispatcherSidebarVisible = isServiceTypeEnabled('dispatcher') && !!dispatcherSidebar && !dispatcherSidebar.classList.contains('collapsed-dispatcher');
        tireSidebarVisible = isServiceTypeEnabled('tire') && !!tireSidebar && !tireSidebar.classList.contains('collapsed-tire');
        inspectorSidebarVisible = isServiceTypeEnabled('inspector') && !!inspectorSidebar && !inspectorSidebar.classList.contains('collapsed-inspector');
        customSidebarVisible = isServiceTypeEnabled('custom') && !!customSidebar && !customSidebar.classList.contains('collapsed-custom');

        if (!techSidebarVisible) {
          if (map?.hasLayer(techLayer)) map.removeLayer(techLayer);
          connectionLayer?.clearLayers();
        } else if (techLayer && map && !map.hasLayer(techLayer)) {
          techLayer.addTo(map);
        }

        if (!towingSidebarVisible) {
          towingLayer?.clearLayers();
        } else if (towingLayer && map && !map.hasLayer(towingLayer)) {
          towingLayer.addTo(map);
        }

        if (!resellerSidebarVisible) {
          resellerLayer?.clearLayers();
        } else if (resellerLayer && map && !map.hasLayer(resellerLayer)) {
          resellerLayer.addTo(map);
        }

        if (!repairSidebarVisible) {
          repairLayer?.clearLayers();
        } else if (repairLayer && map && !map.hasLayer(repairLayer)) {
          repairLayer.addTo(map);
        }

        if (!locksmithSidebarVisible) {
          locksmithLayer?.clearLayers();
        } else if (locksmithLayer && map && !map.hasLayer(locksmithLayer)) {
          locksmithLayer.addTo(map);
        }

        if (!dispatcherSidebarVisible) {
          dispatcherLayer?.clearLayers();
        } else if (dispatcherLayer && map && !map.hasLayer(dispatcherLayer)) {
          dispatcherLayer.addTo(map);
        }

        if (!tireSidebarVisible) {
          tireLayer?.clearLayers();
        } else if (tireLayer && map && !map.hasLayer(tireLayer)) {
          tireLayer.addTo(map);
        }

        if (!inspectorSidebarVisible) {
          inspectorLayer?.clearLayers();
        } else if (inspectorLayer && map && !map.hasLayer(inspectorLayer)) {
          inspectorLayer.addTo(map);
        }

        if (!customSidebarVisible) {
          customServiceLayer?.clearLayers?.();
          customCategories.forEach(({ layer }) => layer?.clearLayers?.());
        } else if (customServiceLayer && map && !map.hasLayer(customServiceLayer)) {
          customServiceLayer.addTo(map);
          customCategories.forEach(({ layer }) => layer && !map.hasLayer(layer) && layer.addTo(map));
        }

        if (previousVisibility.tech !== techSidebarVisible) {
          updateTechUI(getTechList(technicians));
        }

        if (previousVisibility.towing !== towingSidebarVisible) {
          updateTowingUI(towingCompanies);
        }

        if (previousVisibility.reseller !== resellerSidebarVisible) {
          updateResellerUI(resellers);
        }

        if (previousVisibility.repair !== repairSidebarVisible) {
          updateRepairUI(repairShops);
        }

        if (previousVisibility.locksmith !== locksmithSidebarVisible) {
          updateLocksmithUI(locksmiths);
        }

        if (previousVisibility.dispatcher !== dispatcherSidebarVisible) {
          updateDispatcherUI(dispatchers);
        }

        if (previousVisibility.tire !== tireSidebarVisible) {
          updateTireUI(tirePartners);
        }

        if (previousVisibility.inspector !== inspectorSidebarVisible) {
          updateInspectorUI(inspectors);
        }

        if (previousVisibility.custom !== customSidebarVisible) {
          renderCustomServices(customServices);
        }

          activeLeftPanel = leftSideKeys.find(key => {
            const cfg = configs[key];
            return cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass);
        }) || null;

        renderVisibleSidebars();

        if (!isAnyServiceSidebarOpen()) {
          serviceLayer?.clearLayers();
          serviceConnectionLayer?.clearLayers();
        } else {
          const origin = getCurrentOrigin();
          if (origin) {
            showServicesFromOrigin(origin, { forceType: getActivePartnerType() });
          }
        }
      };

        const getSidebarWidth = (sidebar) => sidebar?.getBoundingClientRect().width || 0;

        const rawConfigs = {
          left: { sidebar: leftSidebar, toggle: openLeft, collapse: collapseLeft, collapsedClass: 'collapsed-left', group: 'left' },
          towing: { sidebar: towingSidebar, toggle: openTowing, collapse: collapseTowing, collapsedClass: 'collapsed-towing', group: 'left', type: 'towing' },
          reseller: { sidebar: resellerSidebar, toggle: openReseller, collapse: collapseReseller, collapsedClass: 'collapsed-reseller', group: 'left', type: 'reseller' },
          repair: { sidebar: repairSidebar, toggle: openRepair, collapse: collapseRepair, collapsedClass: 'collapsed-repair', group: 'left', type: 'repair' },
          locksmith: { sidebar: locksmithSidebar, toggle: openLocksmith, collapse: collapseLocksmith, collapsedClass: 'collapsed-locksmith', group: 'left', type: 'locksmith' },
          dispatcher: { sidebar: dispatcherSidebar, toggle: openDispatcher, collapse: collapseDispatcher, collapsedClass: 'collapsed-dispatcher', group: 'left', type: 'dispatcher' },
          tire: { sidebar: tireSidebar, toggle: openTire, collapse: collapseTire, collapsedClass: 'collapsed-tire', group: 'left', type: 'tire' },
            inspector: { sidebar: inspectorSidebar, toggle: openInspector, collapse: collapseInspector, collapsedClass: 'collapsed-inspector', group: 'left', type: 'inspector' },
            custom: { sidebar: customSidebar, toggle: openCustom, collapse: collapseCustom, collapsedClass: 'collapsed-custom', group: 'left', type: 'custom' },
            right: { sidebar: rightSidebar, toggle: openRight, collapse: collapseRight, collapsedClass: 'collapsed-right', group: 'right' }
          };

        const configs = Object.fromEntries(
          Object.entries(rawConfigs).filter(([, cfg]) => {
            if (!cfg.sidebar || !cfg.toggle) return false;
            if (!cfg.type) return true;
            return isServiceTypeEnabled(cfg.type);
          })
        );

        const syncMap = () => { if (map) setTimeout(() => map.invalidateSize(), 320); };

        const leftSideKeys = Object.keys(configs).filter((key) => configs[key]?.group === 'left');

        const updateTogglePositions = () => {
        const expandedEntry = leftSideKeys
          .map((key) => configs[key])
          .find(cfg => cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass));

        const anchorLeft = expandedEntry
          ? getSidebarWidth(expandedEntry.sidebar) + defaultLeftOffset
          : defaultLeftOffset;

        leftSideKeys.forEach(key => {
          const toggle = configs[key]?.toggle;
          if (toggle) toggle.style.left = `${anchorLeft}px`;
        });

        const customSlot = document.getElementById('custom-toggle-slot');
        if (customSlot) customSlot.style.left = `${anchorLeft}px`;
        document.querySelectorAll('#custom-category-toggles .sidebar-toggle-btn').forEach((btn) => {
          btn.style.left = `${anchorLeft}px`;
        });

        const rightSidebarIsCollapsed = configs.right?.sidebar?.classList.contains(configs.right.collapsedClass);
        const anchorRight = rightSidebarIsCollapsed
          ? defaultRightOffset
          : getSidebarWidth(configs.right.sidebar) + defaultRightOffset;

        const rightToggleGroup = document.getElementById('right-toggle-group');
        if (rightToggleGroup) {
          rightToggleGroup.style.right = `${anchorRight}px`;
        }
      };

      const applyState = (side, expanded) => {
        const config = configs[side];
        if (!config?.sidebar || !config?.toggle) return false;
        const wasCollapsed = config.sidebar.classList.contains(config.collapsedClass);
        const shouldCollapse = !expanded;
        if (shouldCollapse && !wasCollapsed) {
          config.sidebar.classList.add(config.collapsedClass);
          config.toggle.classList.remove('active');
          config.toggle.setAttribute('aria-pressed', 'false');
        } else if (!shouldCollapse && wasCollapsed) {
          config.sidebar.classList.remove(config.collapsedClass);
          config.toggle.classList.add('active');
          config.toggle.setAttribute('aria-pressed', 'true');
        }
        return wasCollapsed !== shouldCollapse;
      };

      const setState = (side, expanded) => {
        const changed = applyState(side, expanded);
        if (!changed) return;

        if (expanded && configs[side]?.group === 'left') {
          leftSideKeys.forEach(key => {
            if (key !== side) applyState(key, false);
          });
        }

        updateTogglePositions();
        syncSidebarVisibility();
        syncMap();
      };

      sidebarStateController = { setState, updateTogglePositions };

      Object.entries(configs).forEach(([side, config]) => {
        if (config.toggle) {
          config.toggle.addEventListener('click', () => {
            const isCollapsed = config.sidebar?.classList.contains(config.collapsedClass);
            setState(side, isCollapsed);
          });
        }
        if (config.collapse) config.collapse.addEventListener('click', () => setState(side, false));
        setState(side, defaultSidebarVisible);
      });

      updateTogglePositions();
      window.addEventListener('resize', updateTogglePositions);
    }

    document.addEventListener('DOMContentLoaded', () => {
      (async () => {
        iconLib.createIcons();
        initMap();
        await syncAvailableServiceTypes();
        updateServiceVisibilityUI();
        if (isServiceTypeEnabled('tech')) loadTechnicians();
        loadHotspots();
        loadBlacklistSites();
        loadVehicles();
        if (isServiceTypeEnabled('towing')) loadTowingCompanies();
        if (isServiceTypeEnabled('reseller')) loadResellers();
        if (isServiceTypeEnabled('repair')) loadRepairShops();
        if (isServiceTypeEnabled('locksmith')) loadLocksmiths();
        if (isServiceTypeEnabled('dispatcher')) loadDispatchers();
        if (isServiceTypeEnabled('tire')) loadTireServices();
        if (isServiceTypeEnabled('inspector')) loadInspectors();
        if (isServiceTypeEnabled('custom')) loadCustomServices();
        setupResizableSidebars();
        setupSidebarToggles();
        setupHotspotToggle();
        setupBlacklistToggle();
        setupVehicleMarkerToggle();
        bindVehicleFilterHandlers();
        syncVehicleFilterInputs();
        const filterConfigs = [
          { id: 'towing-filter', type: 'towing' },
          { id: 'reseller-filter', type: 'reseller' },
          { id: 'repair-filter', type: 'repair' },
          { id: 'locksmith-filter', type: 'locksmith' },
          { id: 'dispatcher-filter', type: 'dispatcher' },
          { id: 'tire-filter', type: 'tire' },
          { id: 'inspector-filter', type: 'inspector' }
        ].filter(({ type }) => isServiceTypeEnabled(type));

        filterConfigs.forEach(({ id, type }) => {
          const input = document.getElementById(id);
          if (!input) return;
          input.addEventListener('input', () => {
            serviceFilters[type] = input.value;
            renderVisibleSidebars();
            const origin = getCurrentOrigin();
            if (origin) {
              showServicesFromOrigin(origin, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });
            }
          });
        });

        document.getElementById('vehicle-search').addEventListener('input', () => renderVehicles());

        document.getElementById('clear-selection')?.addEventListener('click', () => resetSelection());
        document.getElementById('vehicle-modal-close')?.addEventListener('click', closeVehicleModal);
        document.getElementById('vehicle-modal')?.addEventListener('click', (e) => {
          if (e.target.id === 'vehicle-modal') closeVehicleModal();
        });
        document.getElementById('vehicle-edit-close')?.addEventListener('click', closeVehicleEditModal);
        document.getElementById('vehicle-edit-cancel')?.addEventListener('click', closeVehicleEditModal);
        document.getElementById('vehicle-edit-modal')?.addEventListener('click', (e) => {
          if (e.target.id === 'vehicle-edit-modal') closeVehicleEditModal();
        });
        document.getElementById('vehicle-edit-form')?.addEventListener('submit', handleVehicleEditSubmit);
        document.getElementById('service-edit-close')?.addEventListener('click', closeServiceEditModal);
        document.getElementById('service-edit-cancel')?.addEventListener('click', closeServiceEditModal);
        document.getElementById('service-edit-modal')?.addEventListener('click', (e) => {
          if (e.target.id === 'service-edit-modal') closeServiceEditModal();
        });
        document.getElementById('service-edit-form')?.addEventListener('submit', handleServiceEditSubmit);

        window.addEventListener('auth:role-ready', () => renderVehicles());
      })();
    });
  </script>
  <script type="module">
    import { createConstellationBackground } from './assets/scripts/constellation.js';

    document.addEventListener('DOMContentLoaded', () => {
      createConstellationBackground();
    });
  </script>
</div>
</body>
</html>
