<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Control View</title>

  <!-- Styles & Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { slate: { 850: '#1a2233', 950: '#020617' } }
        },
      },
    };
  </script>

  <style>
    :root {
      --left-sidebar-width: 360px;
      --right-sidebar-width: 360px;
      --towing-sidebar-width: 320px;
      --reseller-sidebar-width: 320px;
      --repair-sidebar-width: 320px;
      --locksmith-sidebar-width: 320px;
      --dispatcher-sidebar-width: 320px;
    }

    /* Map */
    #tech-map { height: 100%; width: 100%; background-color: #0b1220; z-index: 1; position: absolute; inset: 0; }
    .leaflet-control-container .leaflet-top, .leaflet-control-container .leaflet-bottom { z-index: 500; }

    .resizable-sidebar {
      position: absolute;
      top: 0;
      bottom: 0;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.9);
      transition: transform 0.3s ease;
    }

    .collapsed-left { transform: translateX(calc(-1 * var(--left-sidebar-width))); }
    .collapsed-right { transform: translateX(var(--right-sidebar-width)); }
    .collapsed-towing { transform: translateX(calc(-1 * var(--towing-sidebar-width))); }
    .collapsed-reseller { transform: translateX(calc(-1 * var(--reseller-sidebar-width))); }
    .collapsed-repair { transform: translateX(calc(-1 * var(--repair-sidebar-width))); }
    .collapsed-locksmith { transform: translateX(calc(-1 * var(--locksmith-sidebar-width))); }
    .collapsed-dispatcher { transform: translateX(calc(-1 * var(--dispatcher-sidebar-width))); }

    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 10px;
      cursor: col-resize;
      z-index: 60;
      background: linear-gradient(90deg, transparent 30%, rgba(148, 163, 184, 0.12), transparent 70%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .resizable-sidebar:hover .resize-handle { opacity: 1; }
    .resize-handle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 28px;
      background: rgba(226, 232, 240, 0.35);
      border-radius: 9999px;
      transform: translate(-50%, -50%);
    }

    /* Vehicle popup styling */
    .vehicle-popup .leaflet-popup-content-wrapper {
      background: #0b1120ee;
      color: #e2e8f0;
      border: 1px solid #1f2937;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
      overflow: hidden;
      width: min(360px, calc(100vw - 80px));
      max-width: min(360px, calc(100vw - 80px));
    }
    .vehicle-popup .leaflet-popup-content { margin: 0; width: 100%; }
    .vehicle-popup .leaflet-popup-tip { background: #0b1120; border: 1px solid #1f2937; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    .vehicle-cross div {
      color: #ef4444;
      font-size: 16px;
      font-weight: 800;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.45);
      line-height: 1;
    }

    .sidebar-toggle-btn {
      position: absolute;
      z-index: 500;
      padding: 0.5rem 0.75rem;
      font-size: 12px;
      font-weight: 700;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      transition: all 0.2s ease;
    }

    .sidebar-toggle-btn:hover { border-color: rgba(251, 191, 36, 0.7); color: #fef9c3; }
  </style>
</head>
<body class="h-screen bg-slate-950 font-sans text-slate-50 overflow-hidden flex flex-col">

  <!-- App Header -->
  <header class="flex-none border-b border-slate-800 bg-slate-950/90 backdrop-blur z-50">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
      <a href="index.html" class="flex items-center gap-3">
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-sm font-black uppercase tracking-[0.2em] text-white">TL</span>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.18em] text-blue-200">TechLoc Network</p>
          <h1 class="text-lg font-black leading-tight text-white">Control View</h1>
        </div>
      </a>
      <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
        <a href="index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
        <a href="vehicles.html" class="rounded-full px-3 py-1 bg-blue-600 text-white shadow shadow-blue-500/20">Control View</a>
        <a href="Admin/index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
      </nav>
      <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex">
        <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span> Live coverage
      </div>
    </div>
  </header>

  <main id="map-layout" class="relative flex-1 overflow-hidden bg-slate-950">

    <div class="absolute inset-0">
      <div id="tech-map"></div>
    </div>

    <div id="selection-banner" class="pointer-events-auto absolute top-4 left-1/2 z-[450] hidden -translate-x-1/2 transform rounded-full border border-amber-400/60 bg-amber-500/15 px-4 py-2 text-xs font-semibold text-amber-100 shadow-lg shadow-amber-500/20 backdrop-blur">
      <span id="selection-text">Filtered by selection</span>
      <button id="clear-selection" class="ml-3 rounded-full bg-amber-400/20 px-3 py-1 text-[11px] font-bold text-amber-50 hover:bg-amber-400/30 border border-amber-300/70">Clear</button>
    </div>

    <button id="open-left-sidebar" class="sidebar-toggle-btn left-3 top-24">GPS Technicians</button>
    <button id="open-towing-sidebar" class="sidebar-toggle-btn left-3 top-36">Towing Companies</button>
    <button id="open-reseller-sidebar" class="sidebar-toggle-btn left-3 top-48">Resellers</button>
    <button id="open-repair-sidebar" class="sidebar-toggle-btn left-3 top-60">Repair Shops</button>
    <button id="open-locksmith-sidebar" class="sidebar-toggle-btn left-3 top-72">Locksmiths</button>
    <button id="open-dispatcher-sidebar" class="sidebar-toggle-btn left-3 top-84">Dispatchers</button>
    <button id="open-right-sidebar" class="sidebar-toggle-btn right-3 top-24">Show Vehicles</button>

    <!-- Floating Legend -->
      <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-[400] bg-slate-900/90 backdrop-blur border border-slate-700 p-3 rounded shadow-lg text-[10px] text-slate-300 space-y-1">
        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Technician</div>
        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400 border border-yellow-300"></span> Vehicle (GPS issue)</div>
        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400 border border-green-400"></span> Vehicle (Fully Working)</div>
        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400 border border-red-500"></span> Vehicle (All)</div>
        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 border border-white"></span> Client location</div>
      </div>

    <!-- Sidebar: Control Panel -->
    <aside id="left-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-30 shadow-2xl" style="width: var(--left-sidebar-width)">
      <div class="resize-handle right-0"></div>

      <!-- Search -->
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-slate-400 mb-1">Client starting point</p>
            <h2 class="text-xl font-black text-white leading-tight">Find the nearest installer</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Installers</p>
              <p id="total-count" class="text-2xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-left" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize sidebar">-</button>
          </div>
        </div>
        <form id="search-form" class="relative">
          <input
            id="address-input"
            type="text"
            class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
            placeholder="Ex: 33101, Phoenix, AZ..."
            autocomplete="off"
          >
          <button type="submit" id="search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
            CALCULATE
          </button>
        </form>

        <div class="flex justify-between items-end">
          <div id="search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
          <div id="file-error" class="hidden text-xs text-red-300">Unable to read installer partner data.</div>
        </div>
      </div>

      <!-- Technicians List -->
      <div id="tech-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Waiting for installer data...</div>
      </div>
    </aside>

    <!-- Towing Sidebar -->
    <aside id="towing-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--towing-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-blue-300 mb-1">Towing partners</p>
            <h2 class="text-xl font-black text-white leading-tight">Towing companies nearby</h2>
          </div>
          <button id="collapse-towing" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize towing sidebar">-</button>
        </div>
      </div>
      <div id="towing-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Towing companies will appear here.</div>
      </div>
    </aside>

    <!-- Reseller Sidebar -->
    <aside id="reseller-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--reseller-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-emerald-300 mb-1">Reseller network</p>
            <h2 class="text-xl font-black text-white leading-tight">Nearby resellers</h2>
          </div>
          <button id="collapse-reseller" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize reseller sidebar">-</button>
        </div>
      </div>
      <div id="reseller-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Resellers will appear here.</div>
      </div>
    </aside>

    <!-- Repair Shops Sidebar -->
    <aside id="repair-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--repair-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-orange-200 mb-1">Repair network</p>
            <h2 class="text-xl font-black text-white leading-tight">Repair shops nearby</h2>
          </div>
          <button id="collapse-repair" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize repair sidebar">-</button>
        </div>
      </div>
      <div id="repair-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Repair shops will appear here.</div>
      </div>
    </aside>

    <!-- Locksmith Sidebar -->
    <aside id="locksmith-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--locksmith-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-yellow-200 mb-1">Locksmith network</p>
            <h2 class="text-xl font-black text-white leading-tight">Locksmith coverage</h2>
          </div>
          <button id="collapse-locksmith" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize locksmith sidebar">-</button>
        </div>
      </div>
      <div id="locksmith-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Locksmiths will appear here.</div>
      </div>
    </aside>

    <!-- Dispatcher Sidebar -->
    <aside id="dispatcher-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--dispatcher-sidebar-width)">
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-sky-200 mb-1">Dispatch desks</p>
            <h2 class="text-xl font-black text-white leading-tight">Dispatcher partners</h2>
          </div>
          <button id="collapse-dispatcher" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize dispatcher sidebar">-</button>
        </div>
      </div>
      <div id="dispatcher-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Dispatchers will appear here.</div>
      </div>
    </aside>

    <!-- Vehicles Sidebar -->
    <aside id="right-sidebar" class="resizable-sidebar right-0 border-l border-slate-800 flex flex-col z-30 shadow-2xl" style="width: var(--right-sidebar-width)">
      <div class="resize-handle left-0"></div>
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-bold uppercase text-amber-300 mb-1">Control View</p>
            <h2 class="text-xl font-black text-white leading-tight">GPS issues around the network</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
              <p id="vehicles-count" class="text-2xl font-black text-white leading-none">0</p>
            </div>
            <button id="collapse-right" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize vehicles sidebar">-</button>
          </div>
        </div>
        <div class="mt-4 relative">
          <input id="vehicle-search" type="text" placeholder="Search by VIN, model, city..." class="w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-10 py-2.5 text-sm text-white placeholder-slate-500 focus:border-amber-400 focus:ring-1 focus:ring-amber-400 outline-none transition-all">
          <i data-lucide="search" class="h-4 w-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2"></i>
        </div>
      </div>
      <div id="vehicle-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
        <div class="text-center mt-10 text-slate-600 text-xs">Waiting for vehicle data...</div>
      </div>
    </aside>
  </main>

  <!-- Vehicle detail modal -->
  <div id="vehicle-modal" class="fixed inset-0 z-[500] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-slate-800 bg-slate-950 shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between border-b border-slate-800 bg-slate-900/70 px-4 py-3">
        <div>
          <p class="text-[10px] font-black uppercase tracking-[0.18em] text-amber-300">Vehicle details</p>
          <h3 id="vehicle-modal-title" class="text-lg font-bold text-white"></h3>
        </div>
        <button id="vehicle-modal-close" class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:border-amber-400 hover:text-amber-200 transition-colors">Close</button>
      </div>
      <div class="max-h-[70vh] overflow-y-auto p-4" id="vehicle-modal-body"></div>
    </div>
  </div>

  <script>
    // --- Base Config ---
    const STATE_CENTERS = {
      'AL': [32.8067, -86.7911], 'AK': [61.3707, -152.4044], 'AZ': [33.7298, -111.4312], 'AR': [34.9697, -92.3731],
      'CA': [36.1162, -119.6816], 'CO': [39.0598, -105.3111], 'CT': [41.5978, -72.7554], 'DE': [39.3185, -75.5071],
      'FL': [27.7663, -81.6868], 'GA': [33.0406, -83.6431], 'HI': [21.0943, -157.4983], 'ID': [44.2405, -114.4788],
      'IL': [40.3495, -88.9861], 'IN': [39.8494, -86.2583], 'IA': [42.0115, -93.2105], 'KS': [38.5266, -96.7265],
      'KY': [37.6681, -84.6701], 'LA': [31.1695, -91.8678], 'ME': [44.6939, -69.3819], 'MD': [39.0639, -76.8021],
      'MA': [42.2302, -71.5301], 'MI': [43.3266, -84.5361], 'MN': [45.6945, -93.9002], 'MS': [32.7416, -89.6787],
      'MO': [38.4561, -92.2884], 'MT': [46.9219, -110.4544], 'NE': [41.1254, -98.2681], 'NV': [38.3135, -117.0554],
      'NH': [43.4525, -71.5639], 'NJ': [40.2989, -74.5210], 'NM': [34.8405, -106.2485], 'NY': [42.1657, -74.9481],
      'NC': [35.6301, -79.8064], 'ND': [47.5289, -99.7840], 'OH': [40.3888, -82.7649], 'OK': [35.5653, -96.9289],
      'OR': [43.9336, -120.5583], 'PA': [40.5908, -77.2098], 'RI': [41.6809, -71.5118], 'SC': [33.8569, -80.9450],
      'SD': [44.2998, -99.4388], 'TN': [35.7478, -86.6923], 'TX': [31.0545, -97.5635], 'UT': [40.1500, -111.8624],
      'VT': [44.0459, -72.7107], 'VA': [37.7693, -78.1699], 'WA': [47.4009, -121.4905], 'WV': [38.4912, -80.9545],
      'WI': [44.2685, -89.6165], 'WY': [42.7559, -107.3025], 'DC': [38.9072, -77.0369]
    };

    let map, techLayer, targetLayer, connectionLayer, vehicleLayer, highlightLayer, towingLayer, resellerLayer, repairLayer, locksmithLayer, dispatcherLayer;
    let technicians = [];
    let towingCompanies = [];
    let resellers = [];
    let repairShops = [];
    let locksmiths = [];
    let dispatchers = [];
    let vehicles = [];
    let vehicleHeaders = [];
    let selectedVehicleId = null;
    let selectedTechId = null;
    const vehicleMarkers = new Map();
    let sidebarStateController = null;
    let techSidebarVisible = false;
    let towingSidebarVisible = false;
    let resellerSidebarVisible = false;
    let repairSidebarVisible = false;
    let locksmithSidebarVisible = false;
    let dispatcherSidebarVisible = false;
    let activeLeftPanel = null;
    let lastClientLocation = null;
    let renderedTechIds = '';
    const cityCache = new Map();

    const iconLib = typeof window !== 'undefined' && window.lucide && typeof window.lucide.createIcons === 'function'
      ? window.lucide
      : { createIcons: () => {} };

    const localDatasetKey = (key, suffix = 'csv') => `techloc:dataset:${key}:${suffix}`;

    async function loadDatasetText({ key, path }) {
      const override = localStorage.getItem(localDatasetKey(key));
      if (override) return override;
      const response = await fetch(path);
      if (!response.ok) throw new Error(`Unable to read ${path} (Status ${response.status})`);
      return response.text();
    }

    // --- 1. Initialize map ---
    function initMap() {
      map = L.map('tech-map', { zoomControl: false, minZoom: 3 }).setView([39.8, -98.5], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3 }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3, opacity: 0.95 }).addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      techLayer = L.layerGroup().addTo(map);
      vehicleLayer = L.layerGroup().addTo(map);
      targetLayer = L.layerGroup().addTo(map);
      connectionLayer = L.layerGroup().addTo(map);
      highlightLayer = L.layerGroup().addTo(map);
      towingLayer = L.layerGroup().addTo(map);
      resellerLayer = L.layerGroup().addTo(map);
      repairLayer = L.layerGroup().addTo(map);
      locksmithLayer = L.layerGroup().addTo(map);
      dispatcherLayer = L.layerGroup().addTo(map);

      map.on('click', (e) => {
        if (e.originalEvent?.handledByMarker) return;

        if (selectedVehicleId !== null || selectedTechId !== null) {
          resetSelection();
          return;
        }

        if (technicians.length === 0) return;
        const lat = parseFloat(e.latlng.lat.toFixed(6));
        const lng = parseFloat(e.latlng.lng.toFixed(6));

        const nearbyTech = findNearestTechnician({ lat, lng }, 32000);
        if (nearbyTech) {
          const vehicleForTech = findNearestVehicle({ lat: nearbyTech.lat, lng: nearbyTech.lng }, 120000);
          if (vehicleForTech) {
            applySelection(vehicleForTech.id, null);
            focusVehicle(vehicleForTech);
            return;
          }
        }

        const nearbyVehicle = findNearestVehicle({ lat, lng });
        if (nearbyVehicle) {
          applySelection(nearbyVehicle.id, null);
          focusVehicle(nearbyVehicle);
          return;
        }

        processLocation({ lat, lng, name: 'Pinned location' }, `${lat.toFixed(4)}, ${lng.toFixed(4)}`);
      });
    }

    // --- 2. Load CSVs ---
    async function loadTechnicians() {
      try {
        const text = await loadDatasetText({ key: 'installers', path: 'assets/installers.csv' });
        await parseTechCSV(text);
      } catch (err) {
        console.warn("System warning: " + err.message);
        document.getElementById('file-error').classList.remove('hidden');
        document.getElementById('tech-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            <i data-lucide="file-warning" class="mx-auto h-8 w-8 text-slate-600 mb-2"></i>
            <p class="text-slate-500 text-xs">No installer data detected.</p>
          </div>
        `;
        iconLib.createIcons();
      }
    }

    async function loadVehicles() {
      try {
        const text = await loadDatasetText({ key: 'vehicles', path: 'assets/vehicles.csv' });
        const parsed = parseVehicleCSV(text);
        vehicles = parsed.rows;
        vehicleHeaders = parsed.headers;
        renderVehicles();
      } catch (err) {
        console.warn("Vehicle load warning: " + err.message);
        document.getElementById('vehicle-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            <i data-lucide="file-warning" class="mx-auto h-8 w-8 text-slate-600 mb-2"></i>
            <p class="text-slate-500 text-xs">Unable to load vehicle data.</p>
          </div>
        `;
        iconLib.createIcons();
      }
    }

    async function loadTowingCompanies() {
      try {
        const text = await loadDatasetText({ key: 'towing_companies', path: 'assets/towing_companies.csv' });
        towingCompanies = parsePartnerCSV(text, 'towing');
        updateTowingUI(towingCompanies);
      } catch (err) {
        console.warn("Towing load warning: " + err.message);
      }
    }

    async function loadResellers() {
      try {
        const text = await loadDatasetText({ key: 'resellers', path: 'assets/resellers.csv' });
        resellers = parsePartnerCSV(text, 'reseller');
        updateResellerUI(resellers);
      } catch (err) {
        console.warn("Reseller load warning: " + err.message);
      }
    }

    async function loadRepairShops() {
      try {
        const text = await loadDatasetText({ key: 'repair_shops', path: 'assets/repair_shops.csv' });
        repairShops = parsePartnerCSV(text, 'repair');
        updateRepairUI(repairShops);
      } catch (err) {
        console.warn("Repair shop load warning: " + err.message);
      }
    }

    async function loadLocksmiths() {
      try {
        const text = await loadDatasetText({ key: 'locksmiths', path: 'assets/locksmiths.csv' });
        locksmiths = parsePartnerCSV(text, 'locksmith');
        updateLocksmithUI(locksmiths);
      } catch (err) {
        console.warn("Locksmith load warning: " + err.message);
      }
    }

    async function loadDispatchers() {
      try {
        const text = await loadDatasetText({ key: 'dispatchers', path: 'assets/dispatchers.csv' });
        dispatchers = parsePartnerCSV(text, 'dispatcher');
        updateDispatcherUI(dispatchers);
      } catch (err) {
        console.warn("Dispatcher load warning: " + err.message);
      }
    }

    // --- 3. Process CSV text ---
    function parseCSV(csvText) {
      const rows = [];
      let currentValue = '';
      let currentRow = [];
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];

        if (char === '"') {
          const next = csvText[i + 1];
          if (inQuotes && next === '"') {
            currentValue += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (!inQuotes && (char === ',' || char === '\n' || char === '\r')) {
          currentRow.push(currentValue);
          currentValue = '';

          if (char === ',') continue;

          if (char === '\r' && csvText[i + 1] === '\n') i++;
          if (currentRow.some(cell => cell.trim() !== '')) rows.push(currentRow);
          currentRow = [];
          continue;
        }

        currentValue += char;
      }

      currentRow.push(currentValue);
      if (currentRow.some(cell => cell.trim() !== '')) rows.push(currentRow);

      return rows.filter(r => r.length > 0);
    }

    async function parseTechCSV(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return;

      const headers = rows[0].map(h => h.trim().replace(/"/g, '')).map(h => h.toLowerCase());

      const techPromises = rows.slice(1).map(async (values, idx) => {
        const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

        const row = {};
        headers.forEach((h, i) => row[h] = cleanValues[i] || '');

        const companyName = row['installation company'] || row['company'] || 'Installer';

        let stateRaw = row['state'] || '';
        let stateCode = stateRaw.match(/\(([A-Z]{2})\)/)?.[1] || (stateRaw.length === 2 ? stateRaw : 'US');

        let base = STATE_CENTERS[stateCode] || [39.8, -98.5];
        let zipSeed = parseInt((row['zip'] || '0').replace(/\D/g, '')) || idx;

        // Cloud-style dispersion
        let angle = (zipSeed * 137.5) * (Math.PI / 180);
        let radius = 0.1 + ((zipSeed % 50) / 100);
        let lat = base[0] + (radius * Math.cos(angle));
        let lng = base[1] + (radius * Math.sin(angle) * 1.3);

        if (!row['zip'] && row['city']) {
          const cityCoords = await geocodeCity(row['city'], stateCode);
          if (cityCoords) {
            lat = cityCoords.lat;
            lng = cityCoords.lng;
          }
        }

        return {
          id: idx,
          name: companyName,
          company: companyName,
          email: row['email'] || '-',
          phone: row['phone'] || '-',
          city: row['city'] || '',
          state: stateCode,
          zip: row['zip'] || '',
          lat: lat,
          lng: lng
        };
      });

      technicians = await Promise.all(techPromises);
      renderedTechIds = '';

      document.getElementById('total-count').textContent = technicians.length;
      updateTechUI(technicians);
      renderVehicles();
    }

    async function geocodeCity(city, stateCode) {
      const key = `${city},${stateCode}`.toLowerCase();
      if (cityCache.has(key)) return cityCache.get(key);

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(`${city}, ${stateCode}, USA`)}`);
        const data = await response.json();
        if (data && data.length > 0) {
          const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
          cityCache.set(key, coords);
          return coords;
        }
      } catch (e) {
        console.warn('City geocode failed', city, stateCode, e);
      }

      cityCache.set(key, null);
      return null;
    }

    function parseVehicleCSV(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      const headers = rows[0].map(h => h.replace(/^"|"$/g, '').trim());

      const vehiclesData = rows.slice(1).map((values, idx) => {
        const clean = values.map(v => v.replace(/^"|"$/g, '').trim());
        const row = {};
        headers.forEach((h, i) => row[h] = (clean[i] ?? '').trim());

        const stateCode = (row['State Loc'] || row['State'] || '').trim();
        const base = STATE_CENTERS[stateCode] || [39.8, -98.5];
        const numericLat = parseFloat(row['Lat']);
        const numericLng = parseFloat(row['Long'] || row['Lng']);
        const coords = Number.isFinite(numericLat) && Number.isFinite(numericLng)
          ? { lat: numericLat, lng: numericLng }
          : { lat: base[0], lng: base[1] };

        return {
          id: idx,
          status: row['Deal Status'] || 'ACTIVE',
          invPrepStatus: row['INV Prep Stat'] || row['Inv. Prep. Stat.'] || row['Inv Prep Stat'] || '',
          remaining: row['Remaining'] || '',
          type: row['Unit Type'] || 'Vehicle',
          year: row['Model Year'] || '',
          model: row['Model'] || 'Vehicle',
          vin: row['ShortVIN'] || row['VIN'] || 'N/A',
          gpsFix: row['GPS Fix'] || '',
          gpsReason: row['GPS Fix Reason'] || '',
          gpsMoving: row['GPS Moving'] || '',
          movingCalc: row['Moving (Calc)'] || '',
          ptStatus: row['PT Status'] || '',
          ptSerial: row['PT Serial '] || row['PT Serial'] || '',
          encoreSerial: row['Encore Serial'] || '',
          lastRead: row['PT Last Read'] || '',
          state: stateCode,
          city: row['PT City'] || row['City'] || '',
          zipcode: row['PT ZipCode'] || row['Zip'] || '',
          lat: coords.lat,
          lng: coords.lng,
          customer: row['PT City'] ? `${row['PT City']}, ${stateCode}` : stateCode || 'Unknown area',
          lastLocation: `${row['PT City'] || 'Unknown'}, ${stateCode || 'USA'}`.trim(),
          payment: row['Payment Schedule'] || '',
          details: row
        };
      });

      document.getElementById('vehicles-count').textContent = vehiclesData.length;
      return { headers, rows: vehiclesData };
    }

    function parsePartnerCSV(csvText, type = 'towing') {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      const headers = rows[0].map(h => h.replace(/^"|"$/g, '').trim().toLowerCase());
      return rows.slice(1).map((values, idx) => {
        const clean = values.map(v => v.replace(/^"|"$/g, '').trim());
        const row = {};
        headers.forEach((h, i) => row[h] = (clean[i] ?? '').trim());

        const stateCode = (row['region'] || '').substring(0, 2).toUpperCase();
        const base = STATE_CENTERS[stateCode] || STATE_CENTERS.DEFAULT || [39.8, -98.5];
        const angle = ((idx + 3) * 54) * (Math.PI / 180);
        const radius = 0.35 + ((idx % 6) * 0.08);
        const lat = base[0] + (radius * Math.cos(angle));
        const lng = base[1] + (radius * Math.sin(angle) * 1.2);

        return {
          id: `${type}-${idx}`,
          type,
          company: row['company'] || row['name'] || 'Partner',
          region: stateCode,
          phone: row['phone'] || '',
          contact: row['contact'] || '',
          availability: row['availability'] || row['tier'] || '',
          notes: row['notes'] || '',
          lat,
          lng
        };
      });
    }

    // --- 4. Update map and list ---
    function updateTechUI(techList, target = null, clientLocation = null) {
      if (!techSidebarVisible) {
        techLayer?.clearLayers();
        return;
      }
      const listContainer = document.getElementById('tech-list');
      listContainer.innerHTML = '';

      const displayList = selectedTechId !== null ? techList.filter(t => t.id === selectedTechId) : techList;
      const displayKey = displayList.map(t => t.id).join('|');
      const shouldRenderMarkers = techSidebarVisible && displayKey !== renderedTechIds;

      if (shouldRenderMarkers) {
        techLayer.clearLayers();
      }

      if (displayList.length === 0) {
        listContainer.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No technicians match this selection.</div>`;
      }

      if (shouldRenderMarkers) {
        displayList.forEach(tech => {
          const marker = L.circleMarker([tech.lat, tech.lng], {
            radius: 5,
            fillColor: '#3b82f6',
            color: '#0f172a',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(techLayer);

          marker.bindPopup(`
            <div class="text-slate-900 p-1 font-sans">
              <strong class="block text-sm font-bold mb-1">${tech.company}</strong>
              <div class="text-xs text-slate-500 mb-2">${tech.city}, ${tech.state} ${tech.zip}</div>
              <a href="tel:${tech.phone}" class="block bg-blue-100 text-blue-700 px-2 py-1 rounded text-center text-xs font-bold mb-1">${tech.phone}</a>
              <div class="text-[10px] text-slate-400 truncate">${tech.email}</div>
            </div>
          `);

          marker.on('click', (e) => {
            e.originalEvent.handledByMarker = true;
            map.panTo([tech.lat, tech.lng]);
            applySelection(null, tech.id);
          });
        });

        renderedTechIds = displayKey;
      }

      displayList.slice(0, 50).forEach((tech, idx) => {
        const isNearest = target && idx === 0;

        const card = document.createElement('div');
        card.className = `p-4 rounded-lg border transition-colors cursor-pointer ${isNearest ? 'bg-slate-800 border-blue-500 ring-1 ring-blue-500' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;

        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Company</p>
              <h3 class="font-bold text-white text-sm break-words" title="${tech.company}">${tech.company}</h3>
              <p class="text-xs text-slate-400 flex items-center gap-1 mt-1">
                <i data-lucide="map-pin" class="h-3 w-3"></i>
                <span>${tech.city || 'Unknown'}, ${tech.state || 'US'}</span>
              </p>
              <p class="text-[11px] text-slate-400">${tech.email || ''}</p>
            </div>
            <div class="text-right">
              <p class="text-[10px] uppercase font-bold text-slate-400">Contact</p>
              <a class="text-sm font-extrabold text-blue-200" href="tel:${tech.phone}">${tech.phone}</a>
              <p class="text-[10px] text-slate-500">${tech.zip}</p>
            </div>
          </div>
          <div class="flex items-center gap-2 text-[11px] text-slate-400">
            <i data-lucide="navigation" class="h-3 w-3"></i>
            <span class="font-semibold text-slate-200">${clientLocation ? 'Distance to client' : 'Location'}</span>
            ${clientLocation ? `<span>${Math.round(getDistance(clientLocation.lat, clientLocation.lng, tech.lat, tech.lng))} mi</span>` : ''}
          </div>
        `;

        card.addEventListener('click', () => {
          map.panTo([tech.lat, tech.lng]);
          applySelection(null, tech.id);
        });

        listContainer.appendChild(card);
      });

      iconLib.createIcons();
    }

    function renderPartnerUI(partners = [], options) {
      const { containerId, layer, visible, accentColor, badgeLabel } = options;
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!visible) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">Open this sidebar to view nearby partners.</div>`;
        layer?.clearLayers();
        return;
      }

      container.innerHTML = '';
      layer?.clearLayers();

      const vehicle = vehicles.find(v => v.id === selectedVehicleId);
      const sorted = vehicle
        ? partners.map(p => {
            const meters = map.distance([vehicle.lat, vehicle.lng], [p.lat, p.lng]);
            return { ...p, distance: meters / 1609.34 };
          }).sort((a, b) => a.distance - b.distance)
        : partners;

      if (!sorted.length) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No partners available.</div>`;
        return;
      }

      sorted.slice(0, 75).forEach((partner, idx) => {
        const marker = L.circleMarker([partner.lat, partner.lng], {
          radius: 6,
          color: accentColor,
          fillColor: accentColor,
          fillOpacity: 0.85,
          weight: 1.5,
          opacity: 1
        }).addTo(layer);

        marker.bindPopup(`
          <div class="text-slate-900 p-1 font-sans">
            <strong class="block text-sm font-bold mb-1">${partner.company}</strong>
            <div class="text-xs text-slate-500 mb-2">${partner.region || 'US'}</div>
            <a href="tel:${partner.phone}" class="block bg-slate-100 text-slate-800 px-2 py-1 rounded text-center text-xs font-bold mb-1">${partner.phone || 'Contact'}</a>
            <div class="text-[10px] text-slate-500">${partner.availability || ''}</div>
          </div>
        `);

        marker.on('click', (e) => {
          e.originalEvent.handledByMarker = true;
          map.panTo([partner.lat, partner.lng]);
        });

        const card = document.createElement('div');
        card.className = `p-4 rounded-lg border transition-colors cursor-pointer ${idx === 0 && vehicle ? 'bg-slate-800 border-amber-400 ring-1 ring-amber-400' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">${badgeLabel}</p>
              <h3 class="font-bold text-white text-sm break-words" title="${partner.company}">${partner.company}</h3>
              <p class="text-xs text-slate-400 flex items-center gap-1 mt-1">
                <i data-lucide="map-pin" class="h-3 w-3"></i>
                <span>${partner.region || 'US'}</span>
              </p>
            </div>
            <div class="text-right text-xs text-slate-400">
              <p class="font-semibold text-slate-200">${partner.contact || 'Dispatch'}</p>
              <a class="block font-bold text-slate-100" href="tel:${partner.phone}">${partner.phone || ''}</a>
              <p class="text-[10px] text-slate-500">${partner.availability || ''}</p>
            </div>
          </div>
          ${vehicle ? `<div class="flex items-center gap-2 text-[11px] text-slate-400">
            <i data-lucide="navigation" class="h-3 w-3"></i>
            <span class="font-semibold text-slate-200">${Math.round(partner.distance)} mi</span>
          </div>` : ''}
          <p class="mt-2 text-[11px] text-slate-400">${partner.notes || ''}</p>
        `;

        card.addEventListener('click', () => {
          map.panTo([partner.lat, partner.lng]);
        });

        container.appendChild(card);
      });

      iconLib.createIcons();
    }

    function updateTowingUI(list = towingCompanies) {
      renderPartnerUI(list, { containerId: 'towing-list', layer: towingLayer, visible: towingSidebarVisible, accentColor: '#c084fc', badgeLabel: 'Towing' });
    }

    function updateResellerUI(list = resellers) {
      renderPartnerUI(list, { containerId: 'reseller-list', layer: resellerLayer, visible: resellerSidebarVisible, accentColor: '#34d399', badgeLabel: 'Reseller' });
    }

    function updateRepairUI(list = repairShops) {
      renderPartnerUI(list, { containerId: 'repair-list', layer: repairLayer, visible: repairSidebarVisible, accentColor: '#fb923c', badgeLabel: 'Repair shop' });
    }

    function updateLocksmithUI(list = locksmiths) {
      renderPartnerUI(list, { containerId: 'locksmith-list', layer: locksmithLayer, visible: locksmithSidebarVisible, accentColor: '#facc15', badgeLabel: 'Locksmith' });
    }

    function updateDispatcherUI(list = dispatchers) {
      renderPartnerUI(list, { containerId: 'dispatcher-list', layer: dispatcherLayer, visible: dispatcherSidebarVisible, accentColor: '#38bdf8', badgeLabel: 'Dispatcher' });
    }

    function renderVisibleSidebars() {
      if (techSidebarVisible) updateTechUI(getTechList(technicians));
      if (towingSidebarVisible) updateTowingUI(towingCompanies);
      if (resellerSidebarVisible) updateResellerUI(resellers);
      if (repairSidebarVisible) updateRepairUI(repairShops);
      if (locksmithSidebarVisible) updateLocksmithUI(locksmiths);
      if (dispatcherSidebarVisible) updateDispatcherUI(dispatchers);
    }

    function renderVehicles() {
      const container = document.getElementById('vehicle-list');
      if (!container) return;
      container.innerHTML = '';
      vehicleLayer.clearLayers();
      vehicleMarkers.clear();

      const searchBox = document.getElementById('vehicle-search');
      const filtered = getVehicleList(searchBox?.value || '');
      document.getElementById('vehicles-count').textContent = filtered.length;

      if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No vehicles match your search.</div>`;
        return;
      }

      filtered.forEach((vehicle) => {
        const nearest = getNearestPartner(vehicle);

          const card = document.createElement('div');
          card.className = 'p-4 rounded-xl border border-slate-800 bg-slate-900/80 hover:border-amber-500/80 transition-all cursor-pointer shadow-sm hover:shadow-amber-500/20 backdrop-blur';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-300">${vehicle.model}</p>
                <h3 class="font-extrabold text-white text-base leading-tight">${vehicle.year || '—'} • ${vehicle.vin || 'VIN N/A'}</h3>
                <p class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i data-lucide="map-pin" class="h-3 w-3"></i> ${vehicle.lastLocation || 'No location provided'}</p>
                <p class="text-[11px] text-slate-400 mt-1">${vehicle.customer || 'Unknown customer'}</p>
              </div>
              <div class="text-right">
                <span class="text-[10px] uppercase font-bold text-slate-400">Status</span>
                <div class="mt-1 text-[11px] px-2 py-1 rounded-full border border-amber-400/40 bg-amber-500/10 text-amber-200 font-semibold">${vehicle.status}</div>
                ${nearest ? `<p class="text-xs text-slate-400 mt-1">${Math.round(nearest.distance)} mi</p>` : ''}
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                <i data-lucide="wifi-off" class="h-3 w-3 text-amber-300"></i>
                <div class="text-left">
                  <p class="font-semibold leading-tight">${vehicle.gpsFix || 'GPS issue'}</p>
                  <p class="text-[10px] text-slate-400">${vehicle.gpsReason || 'Pending'}</p>
                </div>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                <i data-lucide="hash" class="h-3 w-3 text-blue-400"></i>
                <div class="text-left">
                  <p class="font-semibold leading-tight">VIN</p>
                  <p class="text-[10px] text-slate-400">${vehicle.vin || 'Not available'}</p>
                </div>
              </div>
            </div>
            <div class="mt-3 rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[10px] text-slate-200 space-y-2">
              <p class="uppercase tracking-wide text-slate-500 font-bold">Ops snapshot</p>
              <div class="grid grid-cols-2 gap-2">
                <div class="rounded-lg border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.status || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Prep</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.invPrepStatus || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Remaining</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.remaining || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">PT</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.ptStatus || '—'}</p>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[11px] text-slate-400">
                <i data-lucide="clock-3" class="h-3 w-3"></i>
                <span class="font-semibold text-slate-200">Last read:</span>
                <span class="truncate">${vehicle.lastRead || '—'}</span>
              </div>
            </div>
            ${nearest ? `<div class="mt-3 rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[11px] text-slate-200 flex items-center justify-between">
              <div>
                <p class="text-[10px] uppercase tracking-wide text-slate-400 font-bold">Nearest ${getPartnerLabel(nearest.type)}</p>
                <p class="font-semibold leading-tight">${nearest.entry.company}</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-slate-400">${Math.round(nearest.distance)} mi</p>
                <p class="text-[10px] text-slate-500">${nearest.entry.region || nearest.entry.state || ''}</p>
              </div>
            </div>` : ''}

            <div class="pt-2 flex justify-end">
              <button data-view-more class="inline-flex items-center gap-2 rounded-lg border border-amber-400/50 bg-amber-500/15 px-3 py-1.5 text-[11px] font-bold text-amber-100 hover:bg-amber-500/25 transition-colors">
                <i data-lucide="info" class="h-4 w-4"></i>
                See more
              </button>
            </div>
          `;

          const ringColor = getVehicleRingColor(vehicle);
          const ring = L.circleMarker([vehicle.lat, vehicle.lng], {
            radius: 9,
            color: ringColor,
            weight: 1.5,
            opacity: 1,
            fillColor: '#fbbf24',
            fillOpacity: 0.85
          }).addTo(vehicleLayer);

          const core = L.circleMarker([vehicle.lat, vehicle.lng], {
            radius: 4,
            color: '#7c2d12',
            weight: 2,
            opacity: 1,
            fillColor: '#fb923c',
            fillOpacity: 0.95
          }).addTo(vehicleLayer);

          const focusHandler = () => {
            applySelection(vehicle.id, null);
            focusVehicle(vehicle);
          };

          ring.on('click', (e) => { e.originalEvent.handledByMarker = true; focusHandler(); });
          core.on('click', (e) => { e.originalEvent.handledByMarker = true; focusHandler(); });
          card.addEventListener('click', focusHandler);

          const viewMoreBtn = card.querySelector('[data-view-more]');
          if (viewMoreBtn) {
            viewMoreBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              openVehicleModal(vehicle);
            });
          }

          if (vehicle.movingCalc === '-1') {
            L.marker([vehicle.lat, vehicle.lng], {
              icon: L.divIcon({ className: 'vehicle-cross', html: '<div>✕</div>', iconSize: [18, 18], iconAnchor: [9, 9] }),
              interactive: false
            }).addTo(vehicleLayer);
          }

          vehicleMarkers.set(vehicle.id, { marker: ring, nearest });
          container.appendChild(card);
        });

      iconLib.createIcons();
    }

    function focusVehicle(vehicle) {
      if (!vehicle) return;
      map.panTo([vehicle.lat, vehicle.lng]);
      highlightLayer.clearLayers();

      const nearest = getNearestPartner(vehicle);
      const storedMarker = vehicleMarkers.get(vehicle.id)?.marker;
      const anchorMarker = storedMarker || L.circleMarker([vehicle.lat, vehicle.lng], { radius: 7, color: '#f59e0b', weight: 1.5, fillColor: '#fbbf24', fillOpacity: 0.95 }).addTo(highlightLayer);

      const halo = L.circleMarker([vehicle.lat, vehicle.lng], { radius: 11, color: '#f59e0b', weight: 1.5, fillColor: '#fbbf24', fillOpacity: 0.15 }).addTo(highlightLayer);
      halo.bringToBack();

      if (vehicle.movingCalc === '-1') {
        L.marker([vehicle.lat, vehicle.lng], {
          icon: L.divIcon({ className: 'vehicle-cross', html: '<div>✕</div>', iconSize: [18, 18], iconAnchor: [9, 9] }),
          interactive: false
        }).addTo(highlightLayer);
      }

      anchorMarker.bindPopup(vehicleCard(vehicle, nearest), {
        className: 'vehicle-popup',
        autoPan: true,
        keepInView: true,
        autoPanPadding: [40, 40]
      }).openPopup();

      setTimeout(attachPopupHandlers, 50);

      if (nearest?.entry) {
        const color = nearest.type === 'towing' ? '#c084fc' : nearest.type === 'reseller' ? '#34d399' : '#3b82f6';
        L.circleMarker([nearest.entry.lat, nearest.entry.lng], { radius: 9, color, weight: 2, fillColor: color, fillOpacity: 0.9 }).addTo(highlightLayer);
        L.polyline([[vehicle.lat, vehicle.lng], [nearest.entry.lat, nearest.entry.lng]], { color, weight: 3, dashArray: '6 4', opacity: 0.9 }).addTo(highlightLayer);
      }

      applySelection(vehicle.id, null);
    }

    function vehicleCard(vehicle, nearest) {
      return `
        <div class="w-[300px] bg-slate-950/90 text-white">
          <div class="p-4 space-y-3">
            <div class="flex items-start justify-between gap-2">
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-400">Vehicle</p>
                <h3 class="text-lg font-extrabold leading-tight text-white">${vehicle.model} ${vehicle.year || ''}</h3>
                <p class="text-[13px] text-slate-200 mt-1">VIN: <span class="font-semibold text-white">${vehicle.vin || 'N/A'}</span></p>
                <p class="text-sm text-slate-300">${vehicle.customer || 'Customer pending'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/15 px-2 py-1 text-[11px] font-semibold text-amber-200 border border-amber-400/40">${vehicle.status}</span>
            </div>

            <div class="flex items-center gap-2 text-sm text-slate-200">
              <span class="inline-flex h-2 w-2 rounded-full bg-amber-400"></span>
              <span>${vehicle.lastLocation || 'No location provided'}</span>
            </div>

            <div class="rounded-xl border border-amber-300/40 bg-amber-500/15 p-3 text-sm text-amber-50 space-y-1">
              <p class="text-[11px] font-bold uppercase tracking-wide text-amber-200">GPS</p>
              <p class="text-base font-extrabold text-amber-100 leading-tight">${vehicle.gpsFix || 'Issue detected'}</p>
              <p class="text-[13px] text-amber-200">${vehicle.gpsReason || 'Pending review'}</p>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-3 py-3 text-[11px] text-slate-200 space-y-2">
              <p class="text-[10px] uppercase tracking-wide text-slate-500 font-bold">Ops snapshot</p>
              <div class="grid grid-cols-2 gap-2">
                <div class="rounded-lg border border-slate-800 bg-slate-950 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.status || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-950 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Prep</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.invPrepStatus || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-950 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Remaining</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.remaining || '—'}</p>
                </div>
                <div class="rounded-lg border border-slate-800 bg-slate-950 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">PT</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.ptStatus || '—'}</p>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[11px] text-slate-400">
                <i data-lucide="clock-3" class="h-3 w-3"></i>
                <span class="font-semibold text-slate-200">Last read:</span>
                <span class="truncate">${vehicle.lastRead || '—'}</span>
              </div>
            </div>

            ${nearest ? `
              <div class="rounded-xl border border-sky-300/40 bg-sky-500/10 p-3 text-sm text-sky-50 space-y-1">
                <p class="text-[11px] font-bold uppercase tracking-wide text-sky-200">Nearest ${getPartnerLabel(nearest.type)}</p>
                <p class="text-base font-extrabold text-sky-100 leading-tight">${nearest.entry.company}</p>
                <p class="text-[13px] text-sky-200">${Math.round(nearest.distance)} miles away</p>
              </div>
            ` : '<p class="mt-3 text-xs text-red-200">No partner nearby.</p>'}

            <div class="pt-2 flex justify-end">
              <button data-view-more-popup class="inline-flex items-center gap-2 rounded-lg border border-amber-400/50 bg-amber-500/15 px-3 py-1.5 text-[11px] font-bold text-amber-100 hover:bg-amber-500/25 transition-colors">
                <i data-lucide="info" class="h-4 w-4"></i>
                See more
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function filterVehicles(list, query) {
      const q = (query || '').toLowerCase();
      if (!q) return list;
      return list.filter(v =>
        v.model.toLowerCase().includes(q) ||
        v.vin.toLowerCase().includes(q) ||
        v.lastLocation.toLowerCase().includes(q) ||
        v.customer.toLowerCase().includes(q)
      );
    }

    function getVehiclesForTech(tech) {
      if (!tech || !map) return [];
      const withDistance = vehicles.map(v => ({
        vehicle: v,
        distance: getDistance(v.lat, v.lng, tech.lat, tech.lng)
      }));
      return withDistance
        .filter(item => item.distance <= 180)
        .sort((a, b) => a.distance - b.distance)
        .map(item => item.vehicle);
    }

    function getVehicleList(query) {
      if (selectedVehicleId !== null) {
        return vehicles.filter(v => v.id === selectedVehicleId);
      }

      if (selectedTechId !== null) {
        const tech = technicians.find(t => t.id === selectedTechId);
        const nearby = getVehiclesForTech(tech);
        return nearby.length ? nearby : vehicles;
      }

      return filterVehicles(vehicles, query);
    }

    function getTechList(baseList = technicians) {
      if (selectedTechId !== null) {
        return baseList.filter(t => t.id === selectedTechId);
      }

      if (selectedVehicleId !== null) {
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return baseList;
        return baseList
          .map(t => ({ ...t, distance: getDistance(vehicle.lat, vehicle.lng, t.lat, t.lng) }))
          .sort((a, b) => a.distance - b.distance);
      }

      return baseList;
    }

    function findNearestTechnician(point, maxDistanceMeters = 40000) {
      if (!technicians.length || !map) return null;
      let closest = null;
      let closestDistance = Infinity;

      technicians.forEach((tech) => {
        const dist = map.distance([point.lat, point.lng], [tech.lat, tech.lng]);
        if (dist < closestDistance) {
          closestDistance = dist;
          closest = tech;
        }
      });

      return closestDistance <= maxDistanceMeters ? closest : null;
    }

    function getVehicleRingColor(vehicle) {
      const fix = (vehicle.gpsFix || '').trim().toLowerCase();
      if (fix === 'all') return '#ef4444';
      if (fix === 'fully working') return '#22c55e';
      return '#facc15';
    }

    function toggleSelectionBanner() {
      const banner = document.getElementById('selection-banner');
      const text = document.getElementById('selection-text');
      if (!banner || !text) return;

      if (selectedVehicleId === null && selectedTechId === null) {
        banner.classList.add('hidden');
        return;
      }

      const vehicle = vehicles.find(v => v.id === selectedVehicleId);
      const tech = technicians.find(t => t.id === selectedTechId);
      const parts = [];
      if (vehicle) parts.push(`Vehículo ${vehicle.vin || vehicle.model}`);
      if (tech) parts.push(`Técnico ${tech.company}`);
      text.textContent = `Filtered by ${parts.join(' & ')}`;
      banner.classList.remove('hidden');
    }

    function applySelection(vehicleId = null, techId = null) {
      selectedVehicleId = vehicleId;
      selectedTechId = techId;
      if (vehicleId !== null) {
        sidebarStateController?.setState?.('right', true);
      }
      renderVehicles();
      renderVisibleSidebars();
      toggleSelectionBanner();
    }

    function resetSelection() {
      selectedVehicleId = null;
      selectedTechId = null;
      highlightLayer?.clearLayers();
      connectionLayer?.clearLayers();
      renderVehicles();
      renderVisibleSidebars();
      toggleSelectionBanner();
      sidebarStateController?.setState?.('right', false);
    }

    function findNearestVehicle(point, maxDistanceMeters = 80000) {
      if (!vehicles.length || !map) return null;
      let closest = null;
      let closestDistance = Infinity;

      vehicles.forEach((vehicle) => {
        const dist = map.distance([point.lat, point.lng], [vehicle.lat, vehicle.lng]);
        if (dist < closestDistance) {
          closestDistance = dist;
          closest = vehicle;
        }
      });

      return closestDistance <= maxDistanceMeters ? closest : null;
    }

    // --- 5. Real search logic (Nominatim) ---
    async function geocodeAddress(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", USA")}`);
        const data = await response.json();
        if (data && data.length > 0) {
          return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
        }
        return null;
      } catch (e) {
        console.error("Geocoding error", e);
        return null;
      }
    }

    function processLocation(location, label = '') {
      if (!location) return;

      if (label) {
        document.getElementById('address-input').value = label;
      }

      targetLayer.clearLayers();
      connectionLayer.clearLayers();
      const targetIcon = L.divIcon({
        className: '',
        html: `<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>`
      });
      L.marker([location.lat, location.lng], { icon: targetIcon }).addTo(targetLayer);
      const popup = L.marker([location.lat, location.lng]).addTo(targetLayer);
      popup.bindPopup(`<b>Client</b><br>${label || location.name || ''}`).openPopup();
      lastClientLocation = location;

      const partnerType = getActivePartnerType();
      const partnerList = getPartnerListByType(partnerType);
      const sortedPartners = partnerList.map(item => ({
        ...item,
        distance: getDistance(location.lat, location.lng, item.lat, item.lng)
      })).sort((a, b) => a.distance - b.distance);

      if (partnerType === 'tech') {
        updateTechUI(sortedPartners, true, location);
      } else if (partnerType === 'towing') {
        updateTowingUI(sortedPartners);
      } else {
        updateResellerUI(sortedPartners);
      }

      if (sortedPartners.length > 0) {
        const nearest = { entry: sortedPartners[0], distance: sortedPartners[0].distance, type: partnerType };
        const bounds = L.latLngBounds([[location.lat, location.lng], [nearest.entry.lat, nearest.entry.lng]]);
        map.fitBounds(bounds, { padding: [100, 100], maxZoom: 9 });
        drawConnection(location, nearest);
      } else {
        map.setView([location.lat, location.lng], 9);
      }
    }

    document.getElementById('search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = document.getElementById('address-input').value.trim();
      if (!query || technicians.length === 0) return;

      const btn = document.getElementById('search-btn');
      const status = document.getElementById('search-status');
      const originalBtnText = btn.innerHTML;

      btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin h-4 w-4"></i>`;
      btn.disabled = true;
      status.classList.remove('hidden');
      iconLib.createIcons();

      const location = await geocodeAddress(query);

      btn.innerHTML = originalBtnText;
      btn.disabled = false;
      status.classList.add('hidden');

      if (!location) {
        alert("Address not found. Try a ZIP code or city name.");
        return;
      }

      processLocation(location, location.name || query);
    });

    function openVehicleModal(vehicle) {
      const modal = document.getElementById('vehicle-modal');
      const title = document.getElementById('vehicle-modal-title');
      const body = document.getElementById('vehicle-modal-body');
      if (!modal || !title || !body) return;

      title.textContent = `${vehicle.model || 'Vehículo'} ${vehicle.year || ''} • ${vehicle.vin || ''}`;
      const detailRows = vehicleHeaders.map(header => {
        const value = vehicle.details?.[header] || vehicle[header] || vehicle[header.toLowerCase()] || '—';
        return `<tr class="border-b border-slate-800/80"><th class="text-left text-xs font-semibold text-slate-300 py-2 pr-3">${header}</th><td class="text-xs text-slate-100 py-2">${value || '—'}</td></tr>`;
      }).join('');
      body.innerHTML = `<table class="w-full text-left">${detailRows}</table>`;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeVehicleModal() {
      const modal = document.getElementById('vehicle-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function attachPopupHandlers() {
      const btn = document.querySelector('.vehicle-popup button[data-view-more-popup]');
      if (btn) {
        btn.addEventListener('click', () => {
          const vehicleId = selectedVehicleId;
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) openVehicleModal(vehicle);
        });
      }
      iconLib.createIcons();
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function getPartnerListByType(type) {
      if (type === 'towing') return towingCompanies;
      if (type === 'reseller') return resellers;
      if (type === 'repair') return repairShops;
      if (type === 'locksmith') return locksmiths;
      if (type === 'dispatcher') return dispatchers;
      return technicians;
    }

    function getActivePartnerType() {
      const typeMap = {
        left: 'tech',
        towing: 'towing',
        reseller: 'reseller',
        repair: 'repair',
        locksmith: 'locksmith',
        dispatcher: 'dispatcher'
      };
      if (activeLeftPanel && typeMap[activeLeftPanel]) return typeMap[activeLeftPanel];
      if (towingSidebarVisible) return 'towing';
      if (resellerSidebarVisible) return 'reseller';
      if (repairSidebarVisible) return 'repair';
      if (locksmithSidebarVisible) return 'locksmith';
      if (dispatcherSidebarVisible) return 'dispatcher';
      return 'tech';
    }

    function getPartnerLabel(type) {
      if (type === 'towing') return 'towing company';
      if (type === 'reseller') return 'reseller';
      if (type === 'repair') return 'repair shop';
      if (type === 'locksmith') return 'locksmith';
      if (type === 'dispatcher') return 'dispatcher';
      return 'technician';
    }

    function getNearestFromList(point, list, type) {
      if (!point || !list.length) return null;
      let nearest = null;
      let bestDist = Infinity;
      list.forEach(item => {
        const dist = getDistance(point.lat, point.lng, item.lat, item.lng);
        if (dist < bestDist) {
          bestDist = dist;
          nearest = item;
        }
      });
      return nearest ? { entry: nearest, distance: bestDist, type } : null;
    }

    function getNearestPartner(vehicle) {
      const type = getActivePartnerType();
      const list = getPartnerListByType(type);
      return getNearestFromList(vehicle, list, type);
    }

    function drawConnection(origin, partnerInfo) {
      const type = partnerInfo?.type || getActivePartnerType();
      const target = partnerInfo?.entry || partnerInfo;
      const isVisible = (type === 'tech' && techSidebarVisible) || (type === 'towing' && towingSidebarVisible) || (type === 'reseller' && resellerSidebarVisible) || (type === 'repair' && repairSidebarVisible) || (type === 'locksmith' && locksmithSidebarVisible) || (type === 'dispatcher' && dispatcherSidebarVisible);
      if (!target || !origin || !isVisible) return;
      const color = type === 'towing'
        ? '#c084fc'
        : type === 'reseller'
        ? '#34d399'
        : type === 'repair'
        ? '#fb923c'
        : type === 'locksmith'
        ? '#facc15'
        : type === 'dispatcher'
        ? '#38bdf8'
        : '#38bdf8';
      connectionLayer.clearLayers();
      L.polyline(
        [
          [origin.lat, origin.lng],
          [target.lat, target.lng]
        ],
        { color, weight: 3, opacity: 0.8, dashArray: '6 6' }
      ).addTo(connectionLayer);
    }

    function setupResizableSidebars() {
      const layout = document.getElementById('map-layout');
      const leftSidebar = document.getElementById('left-sidebar');
      const rightSidebar = document.getElementById('right-sidebar');
      if (!layout || !leftSidebar || !rightSidebar) return;

      const rootStyle = document.documentElement.style;
      const minWidth = 260;
      const maxWidth = 720;
      let activeDrag = null;

      const clampWidth = (value) => Math.min(Math.max(value, minWidth), maxWidth);

      const applyWidth = (side, width) => {
        rootStyle.setProperty(side === 'left' ? '--left-sidebar-width' : '--right-sidebar-width', `${width}px`);
        if (map) {
          map.invalidateSize();
        }
      };

      const onMouseMove = (event) => {
        if (!activeDrag) return;
        const bounds = layout.getBoundingClientRect();

        if (activeDrag === 'left') {
          const newWidth = clampWidth(event.clientX - bounds.left);
          applyWidth('left', newWidth);
        }

        if (activeDrag === 'right') {
          const newWidth = clampWidth(bounds.right - event.clientX);
          applyWidth('right', newWidth);
        }
      };

      const stopDrag = () => {
        activeDrag = null;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', stopDrag);
      };

      const startDrag = (side, event) => {
        event.preventDefault();
        activeDrag = side;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', stopDrag);
      };

      leftSidebar.querySelector('.resize-handle')?.addEventListener('mousedown', (e) => startDrag('left', e));
      rightSidebar.querySelector('.resize-handle')?.addEventListener('mousedown', (e) => startDrag('right', e));
    }

    function setupSidebarToggles() {
      const leftSidebar = document.getElementById('left-sidebar');
      const rightSidebar = document.getElementById('right-sidebar');
      const towingSidebar = document.getElementById('towing-sidebar');
      const resellerSidebar = document.getElementById('reseller-sidebar');
      const repairSidebar = document.getElementById('repair-sidebar');
      const locksmithSidebar = document.getElementById('locksmith-sidebar');
      const dispatcherSidebar = document.getElementById('dispatcher-sidebar');
      const openLeft = document.getElementById('open-left-sidebar');
      const openRight = document.getElementById('open-right-sidebar');
      const openTowing = document.getElementById('open-towing-sidebar');
      const openReseller = document.getElementById('open-reseller-sidebar');
      const openRepair = document.getElementById('open-repair-sidebar');
      const openLocksmith = document.getElementById('open-locksmith-sidebar');
      const openDispatcher = document.getElementById('open-dispatcher-sidebar');
      const collapseLeft = document.getElementById('collapse-left');
      const collapseRight = document.getElementById('collapse-right');
      const collapseTowing = document.getElementById('collapse-towing');
      const collapseReseller = document.getElementById('collapse-reseller');
      const collapseRepair = document.getElementById('collapse-repair');
      const collapseLocksmith = document.getElementById('collapse-locksmith');
      const collapseDispatcher = document.getElementById('collapse-dispatcher');

      const defaultLeftOffset = 12;
      const syncSidebarVisibility = () => {
        techSidebarVisible = !!leftSidebar && !leftSidebar.classList.contains('collapsed-left');
        towingSidebarVisible = !!towingSidebar && !towingSidebar.classList.contains('collapsed-towing');
        resellerSidebarVisible = !!resellerSidebar && !resellerSidebar.classList.contains('collapsed-reseller');
        repairSidebarVisible = !!repairSidebar && !repairSidebar.classList.contains('collapsed-repair');
        locksmithSidebarVisible = !!locksmithSidebar && !locksmithSidebar.classList.contains('collapsed-locksmith');
        dispatcherSidebarVisible = !!dispatcherSidebar && !dispatcherSidebar.classList.contains('collapsed-dispatcher');

        if (!techSidebarVisible) {
          if (map?.hasLayer(techLayer)) map.removeLayer(techLayer);
          connectionLayer?.clearLayers();
        } else if (techLayer && map && !map.hasLayer(techLayer)) {
          techLayer.addTo(map);
        }

        if (!towingSidebarVisible) {
          towingLayer?.clearLayers();
        } else if (towingLayer && map && !map.hasLayer(towingLayer)) {
          towingLayer.addTo(map);
        }

        if (!resellerSidebarVisible) {
          resellerLayer?.clearLayers();
        } else if (resellerLayer && map && !map.hasLayer(resellerLayer)) {
          resellerLayer.addTo(map);
        }

        if (!repairSidebarVisible) {
          repairLayer?.clearLayers();
        } else if (repairLayer && map && !map.hasLayer(repairLayer)) {
          repairLayer.addTo(map);
        }

        if (!locksmithSidebarVisible) {
          locksmithLayer?.clearLayers();
        } else if (locksmithLayer && map && !map.hasLayer(locksmithLayer)) {
          locksmithLayer.addTo(map);
        }

        if (!dispatcherSidebarVisible) {
          dispatcherLayer?.clearLayers();
        } else if (dispatcherLayer && map && !map.hasLayer(dispatcherLayer)) {
          dispatcherLayer.addTo(map);
        }

        activeLeftPanel = leftSideKeys.find(key => {
          const cfg = configs[key];
          return cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass);
        }) || null;

        renderVisibleSidebars();
      };

      const getSidebarWidth = (sidebar) => sidebar?.getBoundingClientRect().width || 0;

        const configs = {
          left: { sidebar: leftSidebar, toggle: openLeft, collapse: collapseLeft, collapsedClass: 'collapsed-left', group: 'left' },
          towing: { sidebar: towingSidebar, toggle: openTowing, collapse: collapseTowing, collapsedClass: 'collapsed-towing', group: 'left' },
          reseller: { sidebar: resellerSidebar, toggle: openReseller, collapse: collapseReseller, collapsedClass: 'collapsed-reseller', group: 'left' },
          repair: { sidebar: repairSidebar, toggle: openRepair, collapse: collapseRepair, collapsedClass: 'collapsed-repair', group: 'left' },
          locksmith: { sidebar: locksmithSidebar, toggle: openLocksmith, collapse: collapseLocksmith, collapsedClass: 'collapsed-locksmith', group: 'left' },
          dispatcher: { sidebar: dispatcherSidebar, toggle: openDispatcher, collapse: collapseDispatcher, collapsedClass: 'collapsed-dispatcher', group: 'left' },
          right: { sidebar: rightSidebar, toggle: openRight, collapse: collapseRight, collapsedClass: 'collapsed-right', group: 'right' }
        };

      const syncMap = () => { if (map) setTimeout(() => map.invalidateSize(), 320); };

        const leftSideKeys = ['left', 'towing', 'reseller', 'repair', 'locksmith', 'dispatcher'];

      const updateTogglePositions = () => {
        const expandedEntry = leftSideKeys
          .map((key) => configs[key])
          .find(cfg => cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass));

        const anchorLeft = expandedEntry
          ? getSidebarWidth(expandedEntry.sidebar) + defaultLeftOffset
          : defaultLeftOffset;

        leftSideKeys.forEach(key => {
          const toggle = configs[key]?.toggle;
          if (toggle) toggle.style.left = `${anchorLeft}px`;
        });
      };

      const applyState = (side, expanded) => {
        const config = configs[side];
        if (!config?.sidebar || !config?.toggle) return false;
        const wasCollapsed = config.sidebar.classList.contains(config.collapsedClass);
        const shouldCollapse = !expanded;
        if (shouldCollapse && !wasCollapsed) {
          config.sidebar.classList.add(config.collapsedClass);
          config.toggle.classList.remove('hidden');
        } else if (!shouldCollapse && wasCollapsed) {
          config.sidebar.classList.remove(config.collapsedClass);
          config.toggle.classList.add('hidden');
        }
        return wasCollapsed !== shouldCollapse;
      };

      const setState = (side, expanded) => {
        const changed = applyState(side, expanded);
        if (!changed) return;

        if (expanded && configs[side]?.group === 'left') {
          leftSideKeys.forEach(key => {
            if (key !== side) applyState(key, false);
          });
        }

        updateTogglePositions();
        syncSidebarVisibility();
        syncMap();
      };

      sidebarStateController = { setState, updateTogglePositions };

      Object.entries(configs).forEach(([side, config]) => {
        if (config.toggle) config.toggle.addEventListener('click', () => setState(side, true));
        if (config.collapse) config.collapse.addEventListener('click', () => setState(side, false));
        setState(side, false);
      });

      updateTogglePositions();
      window.addEventListener('resize', updateTogglePositions);
    }

    document.addEventListener('DOMContentLoaded', () => {
      iconLib.createIcons();
      initMap();
      loadTechnicians();
      loadVehicles();
      loadTowingCompanies();
      loadResellers();
      loadRepairShops();
      loadLocksmiths();
      loadDispatchers();
      setupResizableSidebars();
      setupSidebarToggles();
      document.getElementById('vehicle-search').addEventListener('input', () => renderVehicles());

      document.getElementById('clear-selection')?.addEventListener('click', () => resetSelection());
      document.getElementById('vehicle-modal-close')?.addEventListener('click', closeVehicleModal);
      document.getElementById('vehicle-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'vehicle-modal') closeVehicleModal();
      });
    });
  </script>
</body>
</html>
