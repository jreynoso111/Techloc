<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Services Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Minimal analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="../assets/scripts/supabaseClient.js"></script>
  <script src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>

  <link rel="stylesheet" href="../assets/visuals/theme.css" />

  <style>
    html, body { width: 100%; height: auto; }
    body { overflow-x: hidden; overflow-y: auto; }
    main { width: 100%; height: auto; overflow: visible; }

    .directory-shell { display: flex; flex-direction: column; gap: 0.75rem; overflow: visible; height: auto !important; min-height: 0 !important; }

    .analytics-wrap { max-width: 100%; overflow: hidden; }
    .mini-analytics { display: grid; grid-template-columns: minmax(0, 1fr); gap: .75rem; max-width: 100%; overflow: hidden; }
    @media (min-width: 1024px) { .mini-analytics { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .mini-chart { height: 150px; max-width: 100%; overflow: hidden; }
    .mini-chart canvas { width: 100% !important; height: 100% !important; display: block; max-width: 100% !important; }

    .table-window { display: flex; flex-direction: column; gap: 0.6rem; flex: none; min-height: 0; overflow: visible; }

    .top-scrollbar-shell { flex: 0 0 auto; position: sticky; top: 0; z-index: 20; padding: 0.5rem; border: 1px solid rgb(30 41 59); background: rgba(2, 6, 23, 0.75); border-radius: 0.75rem; backdrop-filter: blur(6px); }
    .top-scrollbar { overflow-x: auto; overflow-y: hidden; height: 14px; border-radius: 0.75rem; }
    .top-scrollbar::-webkit-scrollbar { height: 12px; }
    .top-scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    .top-scrollbar::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    #table-scroll { overflow-x: auto; overflow-y: visible; width: 100%; max-width: 100%; border-radius: 0.75rem; }
    #table-scroll::-webkit-scrollbar { height: 12px; width: 12px; }
    #table-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    #table-scroll::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    thead.sticky-head th { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px); }

    th.resizable { position: relative; user-select: none; }
    .col-resizer { position: absolute; right: 0; top: 0; height: 100%; width: 10px; cursor: col-resize; display: flex; align-items: center; justify-content: center; }
    .col-resizer::after { content: ""; display: block; width: 2px; height: 55%; background: rgba(148,163,184,.35); border-radius: 999px; }

    th.dragging { opacity: .55; }
    th.drop-target { outline: 2px dashed rgba(59,130,246,.55); outline-offset: -6px; }

    table.fixed-layout { table-layout: fixed; width: max-content; min-width: 100%; }

    #services-table th, #services-table td { white-space: normal !important; overflow-wrap: anywhere; word-break: break-word; vertical-align: top; }
    .th-inner { display: flex; align-items: center; gap: .5rem; justify-content: space-between; width: 100%; padding-right: 10px; min-width: 0; }
    .popover { position: absolute; right: 0; top: calc(100% + 8px); width: min(340px, 92vw); z-index: 50; }
    .compact-th { padding: 0.5rem 0.8rem; }
    .compact-td { padding: 0.5rem 0.8rem; }
    .compact-text { font-size: 12.5px; line-height: 1.25rem; }
    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(0, 1fr)); }

    /* Inline editing visuals */
    td[data-editable="true"] { cursor: text; }
    td.editing { outline: 2px solid rgba(59,130,246,.65); outline-offset: -2px; background: rgba(2,6,23,.65); }
    td.saving { opacity: .75; }
    td.saved { box-shadow: inset 0 0 0 2px rgba(16,185,129,.4); }
    td.failed { box-shadow: inset 0 0 0 2px rgba(239,68,68,.45); }
    .cell-input, .cell-select {
      width: 100%;
      border: 1px solid rgba(51,65,85,.8);
      background: rgba(2,6,23,.9);
      color: rgba(248,250,252,.95);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12.5px;
      line-height: 1.25rem;
      outline: none;
    }
    .cell-input:focus, .cell-select:focus { border-color: rgba(59,130,246,.9); }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 relative">

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur" style="height:72px;">
    <div class="flex items-center justify-between px-6 py-4 lg:px-10">
      <a href="../index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>
          <h1 class="text-base font-black leading-tight text-white">Services</h1>
        </div>
      </a>

      <div class="flex flex-wrap items-center justify-end gap-3">
        <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
          <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
          <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>
          <a id="nav-dashboard" href="./index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
        </nav>

        <div class="flex items-center gap-2">
          <a id="nav-login" href="../login.html" class="hidden rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
          <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex" data-admin-actions>
            <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span> Admin Tools
          </div>
        </div>
      </div>
    </div>
  </header>

  <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>

  <main class="px-6 py-5 lg:px-10">
    <div class="flex flex-col gap-5 lg:flex-row">
      <!-- LEFT NAV -->
      <aside class="hidden w-64 shrink-0 space-y-4 lg:sticky lg:top-6 lg:h-[calc(100svh-96px)] lg:overflow-y-auto lg:block">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Navigation</p>
          <h2 class="text-lg font-black text-white">Admin workspace</h2>
        </div>

        <nav class="flex flex-col gap-2 text-sm font-semibold">
          <a href="./index.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Dashboard <span class="text-xs font-medium text-slate-400">Overview</span>
          </a>
          <a href="./profiles.html" data-admin-only class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Profiles <span class="text-xs font-medium text-slate-400">Access levels</span>
          </a>
          <a href="./services.html" class="flex items-center justify-between gap-2 rounded-xl border border-blue-500 bg-blue-600/90 px-3 py-2 text-white shadow shadow-blue-500/40">
            Services <span class="text-xs font-medium text-blue-100">Technicians</span>
          </a>
          <a href="./vehicles.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Vehicles <span class="text-xs font-medium text-slate-400">Fleet</span>
          </a>
          <a href="./analytics.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Analytics <span class="text-xs font-medium text-slate-400">Insights</span>
          </a>
        </nav>
      </aside>

      <!-- MAIN -->
      <section class="flex min-w-0 flex-1 flex-col gap-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Partner network</p>
            <h2 class="text-2xl font-black text-white">Service roster and coverage</h2>
            <p class="text-sm text-slate-400">Double-click any cell to edit (admins only). Enter = save, Esc = cancel.</p>
          </div>

          <div class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300">
            <i data-lucide="cloud" class="h-4 w-4"></i>
            <span id="dataset-status">Connecting…</span>
          </div>
        </div>

        <!-- STATS -->
        <section class="grid stats-grid gap-3 sm:grid-cols-3">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Total services</p>
            <p id="tech-total" class="text-3xl font-black text-white">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">States covered</p>
            <p id="tech-states" class="text-3xl font-black text-amber-300">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Companies</p>
            <p id="tech-companies" class="text-3xl font-black text-emerald-300">-</p>
          </div>
        </section>

        <!-- DIRECTORY -->
        <section class="directory-shell rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/60">
          <div class="flex flex-col gap-3">

            <div class="flex flex-col gap-2">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Directory</p>
                <h3 class="text-lg font-bold text-white">Service list</h3>
              </div>

              <!-- ANALYTICS -->
              <div class="analytics-wrap" id="analytics-wrap">
                <div class="mini-analytics">
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                    <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                    <h3 class="text-sm font-bold text-white">Top states (filtered)</h3>
                    <div class="mt-3 mini-chart"><canvas id="chart-states"></canvas></div>
                  </div>
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                    <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                    <h3 class="text-sm font-bold text-white">Categories share (filtered)</h3>
                    <div class="mt-3 mini-chart"><canvas id="chart-categories"></canvas></div>
                  </div>
                </div>
              </div>

              <!-- FILTERS / ACTIONS -->
              <div class="flex flex-col gap-2 pt-1">
                <div class="flex flex-wrap gap-2">
                  <select id="company-filter" class="w-40 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                    <option value="all">All companies</option>
                  </select>
                  <select id="state-filter" class="w-36 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                    <option value="all">All states</option>
                  </select>
                  <div class="relative" id="category-filter-shell">
                    <button id="category-filter-toggle" class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white" type="button">
                      <i data-lucide="filter" class="h-4 w-4"></i>
                      <span id="category-filter-label">All categories</span>
                      <i data-lucide="chevron-down" class="h-4 w-4"></i>
                    </button>

                    <div id="category-filter-popover" class="popover hidden rounded-2xl border border-slate-800 bg-slate-950/95 p-3 shadow-2xl shadow-black">
                      <div class="flex items-center justify-between px-2 pb-2">
                        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Categories</p>
                        <button id="category-filter-clear" type="button" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">Clear</button>
                      </div>
                      <div id="category-filter-list" class="max-h-56 overflow-y-auto px-2 pb-2 space-y-1"></div>
                      <p class="px-2 pt-1 text-[11px] text-slate-500">Select one or more categories to filter the table.</p>
                    </div>
                  </div>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                  <input id="search" type="search" placeholder="Search by company, category, address, state, or city"
                    class="w-72 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none" />

                  <div class="relative">
                    <button id="columns-btn" class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white" type="button">
                      <i data-lucide="columns-3" class="h-4 w-4"></i> Columns
                      <i data-lucide="chevron-down" class="h-4 w-4"></i>
                    </button>

                    <div id="columns-popover" class="popover hidden rounded-2xl border border-slate-800 bg-slate-950/95 p-3 shadow-2xl shadow-black">
                      <div class="flex items-center justify-between px-2 pb-2">
                        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Visible columns</p>
                        <div class="flex items-center gap-2">
                          <button id="cols-all" type="button" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">All</button>
                          <button id="cols-none" type="button" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">None</button>
                        </div>
                      </div>
                      <div id="columns-list" class="max-h-56 overflow-y-auto px-2 pb-2"></div>
                      <p class="px-2 pt-1 text-[11px] text-slate-500">Tip: drag headers to reorder • drag header edge to resize</p>
                    </div>
                  </div>

                  <button id="add-record" class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 shadow shadow-emerald-600/30 transition hover:-translate-y-0.5" data-admin-actions type="button">
                    <i data-lucide="plus" class="h-4 w-4"></i> New record
                  </button>

                  <button id="refresh-button" class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 shadow shadow-blue-600/30 transition hover:-translate-y-0.5" type="button">
                    <i data-lucide="refresh-ccw" class="h-4 w-4"></i> Refresh
                  </button>

                  <div class="ml-auto hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300 md:flex">
                    <i data-lucide="mouse-pointer-2" class="h-4 w-4"></i> <span>Resize • Reorder • Sort</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- PAGINATION (TOP) -->
            <div class="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
              <p id="pagination-summary" class="text-sm text-slate-300">Showing 0-0 of 0</p>
              <div class="flex items-center gap-2">
                <button id="prev-page" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                  <i data-lucide="chevron-left" class="h-4 w-4"></i> Prev
                </button>
                <span id="page-indicator" class="text-sm font-semibold text-slate-100">1 / 1</span>
                <button id="next-page" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                  Next <i data-lucide="chevron-right" class="h-4 w-4"></i>
                </button>
              </div>
            </div>

            <div class="table-window">
              <div class="top-scrollbar-shell">
                <div id="top-scrollbar" class="top-scrollbar">
                  <div id="top-scrollbar-inner" style="height:1px;"></div>
                </div>
              </div>

              <div id="table-scroll" class="w-full border border-slate-800 bg-slate-950/25">
                <table id="services-table" class="fixed-layout divide-y divide-slate-800 compact-text">
                  <colgroup id="colgroup"></colgroup>
                  <thead id="table-head" class="sticky-head bg-slate-950/60 text-slate-300"></thead>
                  <tbody id="table-body" class="divide-y divide-slate-800 bg-slate-950/40"></tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
      </section>
    </div>
  </main>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';

    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';
    const READ_TABLE = 'Services';
    const WRITE_TABLE = 'Services';
    const PAGE_CATEGORY = 'GPS Technician';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const toBool = (v) => {
      if (v === true || v === false) return v;
      const s = String(v ?? '').trim().toLowerCase();
      if (['true', '1', 'yes', 'y', 'verified'].includes(s)) return true;
      if (['false', '0', 'no', 'n', 'unverified', 'not verified'].includes(s)) return false;
      return null;
    };
    const boolToLabel = (v) => {
      if (v === true) return 'Verified';
      if (v === false) return 'Not verified';
      if (v === null || v === undefined || String(v).trim() === '') return '—';
      return String(v);
    };

    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row[key];
        if (value !== undefined && value !== null && String(value).trim() !== '') return value;
      }
      return '';
    };

    const normalizeVerified = (value) => {
      const boolVal = toBool(value);
      if (boolVal === true || boolVal === false) return boolVal;
      const raw = value === null || value === undefined ? '' : String(value).trim();
      return raw === '' ? null : raw;
    };

    const normalizeRow = (row) => ({
      id: row.id,
      company: getField(row, 'company_name', 'Installation Company', 'Company', 'company', 'name'),
      authorization: getField(row, 'Authorization', 'authorization'),
      category: getField(row, 'category', 'Category'),
      phone: getField(row, 'Phone', 'phone'),
      contact: getField(row, 'contact', 'Contact'),
      address: getField(row, 'address', 'Address'),
      city: getField(row, 'City', 'city'),
      state: getField(row, 'State', 'state', 'state_code'),
      zip: getField(row, 'Zip', 'zip', 'zipcode', 'postal_code'),
      email: getField(row, 'Email', 'email'),
      notes: getField(row, 'Notes', 'notes'),
      website: getField(row, 'website', 'Website'),
      availability: getField(row, 'availability', 'Availability'),
      verified: normalizeVerified(getField(row, 'Verified', 'verified', 'is_verified', 'Is Verified')),
      lat: getField(row, 'lat', 'latitude', 'Lat'),
      long: getField(row, 'long', 'lng', 'longitude', 'Lon'),
    });

    // IMPORTANT: map UI columns -> DB columns for updates
    const DB_FIELD_BY_COL_ID = {
      company: 'company_name',
      authorization: 'authorization',
      category: 'category',
      verified: 'verified',
      phone: 'phone',
      contact: 'contact',
      address: 'address',
      city: 'city',
      state: 'state',
      zip: 'zip',
      email: 'email',
      notes: 'notes',
      website: 'website',
      availability: 'availability',
      lat: 'lat',
      long: 'long',
    };

    const els = {
      status: document.getElementById('dataset-status'),
      total: document.getElementById('tech-total'),
      states: document.getElementById('tech-states'),
      companies: document.getElementById('tech-companies'),
      companyFilter: document.getElementById('company-filter'),
      stateFilter: document.getElementById('state-filter'),
      categoryFilterToggle: document.getElementById('category-filter-toggle'),
      categoryFilterPopover: document.getElementById('category-filter-popover'),
      categoryFilterList: document.getElementById('category-filter-list'),
      categoryFilterLabel: document.getElementById('category-filter-label'),
      categoryFilterClear: document.getElementById('category-filter-clear'),
      search: document.getElementById('search'),
      paginationSummary: document.getElementById('pagination-summary'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageIndicator: document.getElementById('page-indicator'),
      refresh: document.getElementById('refresh-button'),
      addRecord: document.getElementById('add-record'),
      colgroup: document.getElementById('colgroup'),
      thead: document.getElementById('table-head'),
      tbody: document.getElementById('table-body'),
      tableScroll: document.getElementById('table-scroll'),
      topScrollbar: document.getElementById('top-scrollbar'),
      topScrollbarInner: document.getElementById('top-scrollbar-inner'),
      columnsBtn: document.getElementById('columns-btn'),
      columnsPopover: document.getElementById('columns-popover'),
      columnsList: document.getElementById('columns-list'),
      colsAll: document.getElementById('cols-all'),
      colsNone: document.getElementById('cols-none'),
      analyticsWrap: document.getElementById('analytics-wrap'),
    };

    const ALL_COLUMNS = [
      { id: 'company', label: 'Company Name', key: 'company', defaultWidth: 220 },
      { id: 'authorization', label: 'Authorization', key: 'authorization', defaultWidth: 160 },
      { id: 'category', label: 'Category', key: 'category', defaultWidth: 170 },
      { id: 'verified', label: 'Verified', key: 'verified', defaultWidth: 120 },
      { id: 'phone', label: 'Phone', key: 'phone', defaultWidth: 150 },
      { id: 'contact', label: 'Contact', key: 'contact', defaultWidth: 160 },
      { id: 'address', label: 'Address', key: 'address', defaultWidth: 260 },
      { id: 'city', label: 'City', key: 'city', defaultWidth: 140 },
      { id: 'state', label: 'State', key: 'state', defaultWidth: 100 },
      { id: 'zip', label: 'Zip', key: 'zip', defaultWidth: 100 },
      { id: 'email', label: 'Email', key: 'email', defaultWidth: 240 },
      { id: 'notes', label: 'Notes', key: 'notes', defaultWidth: 260 },
      { id: 'website', label: 'Website', key: 'website', defaultWidth: 220 },
      { id: 'availability', label: 'Availability', key: 'availability', defaultWidth: 180 },
      { id: 'lat', label: 'Lat', key: 'lat', defaultWidth: 120 },
      { id: 'long', label: 'Long', key: 'long', defaultWidth: 120 },
    ];

    const state = {
      rows: [],
      currentUserRole: 'user',
      currentUserId: 'anon',
      filters: { search: '', company: 'all', state: 'all', categories: [] },
      sort: { key: '', dir: 'asc' },
      pagination: { page: 1, pageSize: 20 },
      columnOrder: ['actions', ...ALL_COLUMNS.map(c => c.id)],
      columnVisibility: Object.fromEntries([['actions', true], ...ALL_COLUMNS.map(c => [c.id, true])]),
      columnWidths: Object.fromEntries([['actions', 140], ...ALL_COLUMNS.map(c => [c.id, c.defaultWidth])]),
      drag: { resizing: null, draggingCol: null },

      // inline edit session
      inlineEdit: { td: null, rowId: null, colId: null, original: null, inputEl: null, saving: false }
    };

    // ================== PERSISTENCE ==================
    const STORAGE_PREFIX = 'techloc_services_table_prefs_v1';
    const storageKey = () => `${STORAGE_PREFIX}:${state.currentUserId}`;
    const safeParse = (raw) => { try { return JSON.parse(raw); } catch { return null; } };

    const savePrefs = () => {
      localStorage.setItem(storageKey(), JSON.stringify({
        columnOrder: state.columnOrder,
        columnVisibility: state.columnVisibility,
        columnWidths: state.columnWidths,
        filters: state.filters,
        pagination: state.pagination,
      }));
    };

    const loadPrefs = () => {
      const prefs = safeParse(localStorage.getItem(storageKey()) || '');
      if (!prefs) return;

      const validCols = new Set(['actions', ...ALL_COLUMNS.map(c => c.id)]);

      if (Array.isArray(prefs.columnOrder)) {
        const cleaned = prefs.columnOrder.filter(c => validCols.has(c));
        const missing = [...validCols].filter(c => !cleaned.includes(c));
        state.columnOrder = [...cleaned, ...missing];
      }

      if (prefs.columnVisibility && typeof prefs.columnVisibility === 'object') {
        const next = { ...state.columnVisibility };
        for (const [k, v] of Object.entries(prefs.columnVisibility)) {
          if (validCols.has(k)) next[k] = !!v;
        }
        next.actions = true;
        state.columnVisibility = next;
      }

      if (prefs.columnWidths && typeof prefs.columnWidths === 'object') {
        const next = { ...state.columnWidths };
        for (const [k, v] of Object.entries(prefs.columnWidths)) {
          if (validCols.has(k) && Number.isFinite(+v)) next[k] = +v;
        }
        state.columnWidths = next;
      }

      if (prefs.filters && typeof prefs.filters === 'object') {
        const savedCategories = (() => {
          if (Array.isArray(prefs.filters.categories)) return prefs.filters.categories;
          if (typeof prefs.filters.category === 'string') {
            return prefs.filters.category === 'all' ? [] : [prefs.filters.category];
          }
          return [];
        })();

        state.filters = {
          search: prefs.filters.search ?? '',
          company: prefs.filters.company ?? 'all',
          state: prefs.filters.state ?? 'all',
          categories: savedCategories,
        };
      }

      if (prefs.pagination && typeof prefs.pagination === 'object') {
        const page = Number.isFinite(+prefs.pagination.page) ? +prefs.pagination.page : 1;
        state.pagination.page = Math.max(1, page);
        if (Number.isFinite(+prefs.pagination.pageSize)) state.pagination.pageSize = +prefs.pagination.pageSize;
      }
    };

    // ---------------- AUTH ----------------
    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();

      if (data?.session) {
        state.currentUserId = data.session.user.id;
        if (window.currentUserRole) {
          state.currentUserRole = window.currentUserRole;
        } else {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', data.session.user.id)
            .single();
          state.currentUserRole = profile?.role || 'user';
        }
      } else {
        state.currentUserRole = 'anon';
        state.currentUserId = 'anon';
      }

      loadPrefs();

      const isAdmin = state.currentUserRole === 'administrator';
      if (els.addRecord) {
        els.addRecord.classList.toggle('hidden', !isAdmin);
        els.addRecord.disabled = !isAdmin;
      }
    };

    supabaseClient.auth.onAuthStateChange((_event, session) => {
      const nextUserId = session?.user?.id || 'anon';
      if (nextUserId === state.currentUserId) return;
      state.currentUserId = nextUserId;
      loadPrefs();
      renderTable();
    });

    // ---------------- HELPERS ----------------
    const getText = (value) => String(value ?? '').toLowerCase().trim();

    const updateStats = () => {
      const total = state.rows.length;
      const statesCount = new Set(state.rows.map(r => (r.state || '').trim()).filter(Boolean)).size;
      const companiesCount = new Set(state.rows.map(r => (r.company || '').trim()).filter(Boolean)).size;
      els.total.textContent = total;
      els.states.textContent = statesCount;
      els.companies.textContent = companiesCount;
      els.status.textContent = total ? `Connected • ${total} records` : 'Awaiting data';
    };

    const populateSelect = (element, values, label) => {
      const options = Array.from(new Set(values.filter(Boolean).map(v => getText(v)))).sort();
      const current = element.value;
      element.innerHTML = `<option value="all">${label}</option>`;
      options.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value.toUpperCase();
        if (value === current) option.selected = true;
        element.appendChild(option);
      });
    };

    const renderCategoryFilterOptions = () => {
      if (!els.categoryFilterList) return;
      const values = Array.from(new Set(state.rows.map(r => getText(r.category)).filter(Boolean))).sort();
      const selected = new Set(state.filters.categories);

      els.categoryFilterList.innerHTML = '';

      if (!values.length) {
        const empty = document.createElement('p');
        empty.className = 'px-2 text-sm text-slate-400';
        empty.textContent = 'No categories available';
        els.categoryFilterList.appendChild(empty);
        return;
      }

      values.forEach((value, idx) => {
        const id = `cat-filter-${idx}`;
        const label = document.createElement('label');
        label.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = `
          <span class="truncate font-semibold">${value.toUpperCase()}</span>
        `;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'h-4 w-4 accent-blue-600';
        input.id = id;
        input.value = value;
        input.checked = selected.has(value);
        input.addEventListener('change', () => {
          const next = new Set(state.filters.categories);
          if (input.checked) {
            next.add(value);
          } else {
            next.delete(value);
          }
          state.filters.categories = Array.from(next);
          state.pagination.page = 1;
          savePrefs();
          updateCategoryFilterLabel();
          renderTable();
        });

        label.appendChild(left);
        label.appendChild(input);
        els.categoryFilterList.appendChild(label);
      });
    };

    const updateCategoryFilterLabel = () => {
      if (!els.categoryFilterLabel) return;
      const count = state.filters.categories.length;
      els.categoryFilterLabel.textContent = count ? `${count} selected` : 'All categories';
    };

    const syncFilterControls = () => {
      if (els.search) els.search.value = state.filters.search || '';

      const setSelect = (el, value) => {
        if (!el) return;
        const fallback = 'all';
        const has = [...el.options].some(o => o.value === value);
        el.value = has ? value : fallback;
      };

      setSelect(els.companyFilter, state.filters.company);
      setSelect(els.stateFilter, state.filters.state);
      updateCategoryFilterLabel();
    };

    const applySearch = (rows, term) => {
      if (!term) return rows;
      const q = term.toLowerCase();
      return rows.filter((row) =>
        [
          row.company, row.authorization, row.category,
          boolToLabel(row.verified),
          row.phone, row.contact, row.address, row.city, row.state, row.zip,
          row.email, row.notes, row.website, row.availability
        ].some((v) => String(v || '').toLowerCase().includes(q))
      );
    };

    const applyFilters = () => {
      const f = state.filters;
      let result = applySearch([...state.rows], f.search);
      if (f.company !== 'all') result = result.filter(r => getText(r.company) === f.company);
      if (f.state !== 'all') result = result.filter(r => getText(r.state) === f.state);
      if (Array.isArray(f.categories) && f.categories.length) {
        const selected = new Set(f.categories.map(getText));
        result = result.filter((r) => {
          const cat = getText(r.category);
          if (!cat) return true; // keep blank/unassigned rows visible while filtering
          return selected.has(cat);
        });
      }
      return result;
    };

    const applySort = (rows) => {
      const { key, dir } = state.sort;
      if (!key) return rows;
      const col = ALL_COLUMNS.find(c => c.id === key);
      if (!col) return rows;

      const sorted = [...rows].sort((a, b) => {
        if (col.id === 'verified') {
          const normalize = (v) => (v === true ? '2' : v === false ? '1' : getText(v));
          const as = normalize(a.verified);
          const bs = normalize(b.verified);
          return as.localeCompare(bs, undefined, { numeric: true, sensitivity: 'base' });
        }
        return getText(a[col.key]).localeCompare(getText(b[col.key]), undefined, { numeric: true, sensitivity: 'base' });
      });

      return dir === 'asc' ? sorted : sorted.reverse();
    };

    const getVisibleOrderedColumns = () => state.columnOrder.filter(colId => state.columnVisibility[colId]);

    // ---------------- TABLE RENDER ----------------
    const renderColgroup = () => {
      const cols = getVisibleOrderedColumns();
      els.colgroup.innerHTML = '';
      cols.forEach((colId) => {
        const colEl = document.createElement('col');
        colEl.setAttribute('data-col', colId);
        colEl.style.width = `${state.columnWidths[colId] || 140}px`;
        els.colgroup.appendChild(colEl);
      });
    };

    const syncTopScrollbar = () => {
      els.topScrollbarInner.style.width = els.tableScroll.scrollWidth + 'px';
      els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
    };

    const setColWidth = (colId, px) => {
      const min = 72;
      const max = 800;
      state.columnWidths[colId] = Math.max(min, Math.min(max, px));
      const colEl = els.colgroup.querySelector(`col[data-col="${colId}"]`);
      if (colEl) colEl.style.width = `${state.columnWidths[colId]}px`;
      const th = els.thead.querySelector(`th[data-col="${colId}"]`);
      if (th) {
        th.style.width = `${state.columnWidths[colId]}px`;
        th.style.minWidth = `${state.columnWidths[colId]}px`;
      }
      syncTopScrollbar();
      savePrefs();
      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    const sortIcon = (colId) => {
      if (state.sort.key !== colId) return 'arrow-up-down';
      return state.sort.dir === 'asc' ? 'arrow-up' : 'arrow-down';
    };

    const toggleSort = (colId) => {
      if (state.sort.key === colId) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
      else { state.sort.key = colId; state.sort.dir = 'asc'; }
      state.pagination.page = 1;
      renderTable();
    };

    const buildHeaderCell = (colId) => {
      const th = document.createElement('th');
      th.className = 'text-left font-semibold text-slate-200 resizable bg-slate-950/60 compact-th';
      th.setAttribute('data-col', colId);

      const startingWidth = state.columnWidths[colId] || 140;
      th.style.width = `${startingWidth}px`;
      th.style.minWidth = `${startingWidth}px`;

      if (colId === 'actions') {
        th.className = 'text-left font-semibold text-blue-300 resizable bg-slate-950/60 compact-th';
        th.style.width = `${state.columnWidths[colId] || 110}px`;
        th.style.minWidth = `${state.columnWidths[colId] || 110}px`;
        th.innerHTML = `
          <div class="th-inner">
            <span class="text-blue-300">Actions</span>
            <span class="opacity-60 text-[11px] uppercase tracking-wide">—</span>
          </div>
          <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
        `;
        return th;
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      const label = col?.label || colId;

      th.setAttribute('draggable', 'true');
      th.innerHTML = `
        <div class="th-inner">
          <div class="flex items-center gap-2 min-w-0">
            <span class="truncate">${label}</span>
          </div>
          <button type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-950/50 px-2 py-1 text-[11px] font-semibold text-slate-200 hover:border-blue-500 hover:text-white"
            data-sort-col="${colId}" title="Sort">
            <i data-lucide="${sortIcon(colId)}" class="h-3.5 w-3.5"></i>
          </button>
        </div>
        <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
      `;
      return th;
    };

    const renderHeader = () => {
      const cols = getVisibleOrderedColumns();
      const tr = document.createElement('tr');
      cols.forEach((colId) => tr.appendChild(buildHeaderCell(colId)));
      els.thead.innerHTML = '';
      els.thead.appendChild(tr);

      els.thead.querySelectorAll('th[draggable="true"]').forEach((th) => {
        th.addEventListener('dragstart', (e) => {
          const colId = th.dataset.col;
          state.drag.draggingCol = colId;
          th.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', colId);
        });

        th.addEventListener('dragend', () => {
          th.classList.remove('dragging');
          state.drag.draggingCol = null;
          els.thead.querySelectorAll('th').forEach(x => x.classList.remove('drop-target'));
        });

        th.addEventListener('dragover', (e) => {
          e.preventDefault();
          const targetCol = th.dataset.col;
          if (!state.drag.draggingCol || state.drag.draggingCol === targetCol) return;
          th.classList.add('drop-target');
        });

        th.addEventListener('dragleave', () => th.classList.remove('drop-target'));

        th.addEventListener('drop', (e) => {
          e.preventDefault();
          const from = state.drag.draggingCol;
          const to = th.dataset.col;
          if (!from || !to || from === to) return;
          const order = [...state.columnOrder];
          const fromIdx = order.indexOf(from);
          const toIdx = order.indexOf(to);
          if (fromIdx === -1 || toIdx === -1) return;
          order.splice(fromIdx, 1);
          order.splice(toIdx, 0, from);
          state.columnOrder = order;
          savePrefs();
          renderTable();
        });
      });

      els.thead.querySelectorAll('[data-sort-col]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSort(btn.getAttribute('data-sort-col'));
        });
      });

      lucide.createIcons();
    };

    const renderBody = (pageRows) => {
      const cols = getVisibleOrderedColumns();
      const isAdmin = state.currentUserRole === 'administrator';
      els.tbody.innerHTML = '';

      pageRows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.className = 'transition hover:bg-slate-800/40';

        cols.forEach((colId) => {
          const td = document.createElement('td');
          td.className = 'align-top text-slate-200 compact-td';

          if (colId === 'actions') {
            td.className = 'text-center align-top compact-td';

            if (isAdmin) {
              const actions = document.createElement('div');
              actions.className = 'inline-flex items-center justify-center gap-2';

              const duplicateBtn = document.createElement('button');
              duplicateBtn.type = 'button';
              duplicateBtn.className = 'text-blue-300 transition hover:text-blue-200 hover:scale-110';
              duplicateBtn.innerHTML = '<i data-lucide="copy" class="h-4 w-4"></i>';
              duplicateBtn.onclick = () => duplicateRow(row);
              actions.appendChild(duplicateBtn);

              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'text-red-400 transition hover:text-red-300 hover:scale-110';
              deleteBtn.innerHTML = '<i data-lucide="trash-2" class="h-4 w-4"></i>';
              deleteBtn.onclick = () => deleteRow(row);
              actions.appendChild(deleteBtn);

              td.appendChild(actions);
            } else {
              td.innerHTML = '<span class="text-slate-600 text-xs">Read Only</span>';
            }

            tr.appendChild(td);
            return;
          }

          const col = ALL_COLUMNS.find(c => c.id === colId);
          let value = col ? row[col.key] : '';

          // display formatting for verified
          if (colId === 'verified') value = boolToLabel(row.verified);

          if (colId === 'company') td.className = 'font-semibold text-white align-top compact-td';

          td.textContent = (value === '' || value === null || value === undefined) ? '—' : String(value);

          // ✅ make cells editable by dblclick (admin only)
          td.dataset.rowId = row.id;
          td.dataset.colId = colId;
          td.dataset.editable = (isAdmin && colId !== 'actions') ? 'true' : 'false';

          tr.appendChild(td);
        });

        els.tbody.appendChild(tr);
      });

      lucide.createIcons();
    };

    const renderPagination = (rows) => {
      const totalPages = Math.max(1, Math.ceil(rows.length / state.pagination.pageSize));
      const prevPage = state.pagination.page;
      if (state.pagination.page > totalPages) state.pagination.page = totalPages;

      const start = (state.pagination.page - 1) * state.pagination.pageSize;
      const end = Math.min(rows.length, start + state.pagination.pageSize);

      els.paginationSummary.textContent = rows.length
        ? `Showing ${start + 1}-${end} of ${rows.length}`
        : 'No entries to display';

      els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;
      els.prevPage.disabled = state.pagination.page === 1 || rows.length === 0;
      els.nextPage.disabled = state.pagination.page >= totalPages || rows.length === 0;

      if (prevPage !== state.pagination.page) savePrefs();

      return { start, end };
    };

    const renderTable = () => {
      const filtered = applyFilters();
      const sorted = applySort(filtered);
      const { start, end } = renderPagination(sorted);
      renderColgroup();
      renderHeader();
      renderBody(sorted.slice(start, end));
      renderColumnsPopover();
      syncTopScrollbar();
      renderCharts(sorted);
      lucide.createIcons();
    };

    // ---------------- INLINE CELL EDITING ----------------
    const withTimeout = (promise, ms = 20000) => {
      let t;
      const timeout = new Promise((_, reject) => {
        t = setTimeout(() => reject(new Error(`Request timed out after ${ms / 1000}s`)), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    };

    const getRowById = (id) => state.rows.find(r => String(r.id) === String(id));

    const endInlineEdit = (opts = { save: false }) => {
      const ses = state.inlineEdit;
      if (!ses.td) return;

      const td = ses.td;
      const rowId = ses.rowId;
      const colId = ses.colId;
      const original = ses.original;

      td.classList.remove('editing');
      td.classList.remove('failed');
      td.classList.remove('saved');

      // restore view (if not saving)
      if (!opts.save) {
        td.innerHTML = '';
        td.textContent = original === '' ? '—' : original;
        ses.td = null; ses.rowId = null; ses.colId = null; ses.original = null; ses.inputEl = null;
        return;
      }

      // if saving handled elsewhere, just cleanup refs
      ses.td = null; ses.rowId = null; ses.colId = null; ses.original = null; ses.inputEl = null;
    };

    const parseEditedValue = (colId, raw) => {
      if (colId === 'verified') {
        const v = String(raw ?? '').trim();
        if (v === '') return null;
        if (v === 'true') return true;
        if (v === 'false') return false;
        return v;
      }
      const v = String(raw ?? '').trim();
      return v === '' ? null : v;
    };

    const valueForDisplay = (colId, value) => {
      if (colId === 'verified') return boolToLabel(value);
      if (value === null || value === undefined || String(value).trim() === '') return '—';
      return String(value);
    };

    const selectColumns = new Set(['category', 'authorization', 'state', 'verified']);

    const optionLabel = (colId, value) => {
      if (colId === 'state') return String(value).toUpperCase();
      if (colId === 'verified') return boolToLabel(value);
      return String(value);
    };

    const INSERT_NEW_VALUE = '__insert_new__';

    const getSelectOptions = (colId) => {
      if (colId === 'verified') {
        const base = [
          { value: '', label: '—' },
          { value: 'true', label: 'Verified' },
          { value: 'false', label: 'Not verified' },
        ];
        const seen = new Set(base.map(o => o.value));
        const custom = [];
        state.rows.forEach((row) => {
          const val = row.verified;
          const value = val === true ? 'true' : val === false ? 'false' : (val === null || val === undefined ? '' : String(val));
          if (!value || seen.has(value)) return;
          seen.add(value);
          custom.push({ value, label: optionLabel(colId, val) });
        });
        return [...base, ...custom, { value: INSERT_NEW_VALUE, label: 'Insert new…' }];
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return [];
      const seen = new Set();
      const opts = [];
      state.rows.forEach((row) => {
        const raw = row[col.key];
        const value = raw === null || raw === undefined ? '' : String(raw).trim();
        if (!value) return;
        const key = getText(value);
        if (seen.has(key)) return;
        seen.add(key);
        opts.push({ value, label: optionLabel(colId, value) });
      });
      return [{ value: '', label: '—' }, ...opts, { value: INSERT_NEW_VALUE, label: 'Insert new…' }];
    };

    const addSelectOption = (select, value, label) => {
      if ([...select.options].some(o => o.value === value)) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      const insertOpt = [...select.options].find(o => o.value === INSERT_NEW_VALUE);
      if (insertOpt) {
        select.insertBefore(opt, insertOpt);
      } else {
        select.appendChild(opt);
      }
    };

    const writeLocalRowValue = (rowId, colId, newValue) => {
      const row = getRowById(rowId);
      if (!row) return;
      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return;
      row[col.key] = newValue;
    };

    const saveCellToSupabase = async ({ rowId, colId, newValue, td }) => {
      const dbField = DB_FIELD_BY_COL_ID[colId];
      if (!dbField) throw new Error(`No DB mapping for column "${colId}"`);

      td.classList.add('saving');

      const payload = { [dbField]: newValue };

      const { error } = await withTimeout(
        supabaseClient.from(WRITE_TABLE).update(payload).eq('id', rowId),
        20000
      );

      td.classList.remove('saving');

      if (error) throw error;
    };

    const commitInlineEdit = async () => {
      const ses = state.inlineEdit;
      if (!ses.td || ses.saving) return;

      const td = ses.td;
      const rowId = ses.rowId;
      const colId = ses.colId;

      const input = ses.inputEl;
      if (!input) return;

      const raw = input.value;
      const newValue = parseEditedValue(colId, raw);

      // compute original value (from local row, not formatted)
      const row = getRowById(rowId);
      const col = ALL_COLUMNS.find(c => c.id === colId);
      const currentValue = colId === 'verified' ? (row?.verified ?? null) : (row?.[col?.key] ?? null);

      const same =
        (colId === 'verified')
          ? (String(currentValue ?? '').trim() === String(newValue ?? '').trim())
          : (String(currentValue ?? '') === String(newValue ?? ''));

      if (same) {
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, currentValue);
        endInlineEdit({ save: true });
        return;
      }

      try {
        ses.saving = true;
        td.classList.remove('failed');
        td.classList.remove('saved');

        // optimistic UI
        writeLocalRowValue(rowId, colId, newValue);
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, colId === 'verified' ? newValue : newValue);

        await saveCellToSupabase({ rowId, colId, newValue, td });

        td.classList.add('saved');
        setTimeout(() => td.classList.remove('saved'), 900);

        endInlineEdit({ save: true });

        // refresh charts/stats based on local changes
        renderCharts(applySort(applyFilters()));
      } catch (err) {
        console.error('Cell save failed:', err);

        // revert local value
        writeLocalRowValue(rowId, colId, currentValue);

        td.classList.add('failed');
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, currentValue);

        endInlineEdit({ save: true });
        alert('Error saving cell: ' + (err?.message || JSON.stringify(err)));
      } finally {
        ses.saving = false;
      }
    };

    const startInlineEdit = (td) => {
      const editable = td?.dataset?.editable === 'true';
      if (!editable) return;

      const rowId = td.dataset.rowId;
      const colId = td.dataset.colId;

      // only known columns
      if (!rowId || !colId || colId === 'actions') return;

      // end any existing edit first (cancel)
      if (state.inlineEdit.td) endInlineEdit({ save: false });

      const row = getRowById(rowId);
      if (!row) return;

      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return;

      const rawCurrent = (colId === 'verified')
        ? row.verified
        : (row[col.key] ?? null);

      const displayCurrent = valueForDisplay(colId, rawCurrent);

      state.inlineEdit.td = td;
      state.inlineEdit.rowId = rowId;
      state.inlineEdit.colId = colId;
      state.inlineEdit.original = displayCurrent === '—' ? '—' : displayCurrent;

      td.classList.add('editing');
      td.innerHTML = '';

      let inputEl;

      if (selectColumns.has(colId)) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2';

        const sel = document.createElement('select');
        sel.className = 'cell-select flex-1 min-w-0';

        const opts = getSelectOptions(colId);
        opts.forEach(({ value, label }) => addSelectOption(sel, value, label));

        const currentValue = colId === 'verified'
          ? (rawCurrent === true ? 'true' : rawCurrent === false ? 'false' : (rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent)))
          : (rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent));
        sel.value = [...sel.options].some(o => o.value === currentValue) ? currentValue : '';

        let previousValue = sel.value;

        sel.addEventListener('change', () => {
          if (sel.value !== INSERT_NEW_VALUE) {
            previousValue = sel.value;
            return;
          }

          const label = colId === 'verified' ? 'verification' : col.label.toLowerCase();
          const entry = prompt(`Enter a new ${label} value:`);
          if (entry === null) {
            sel.value = previousValue;
            return;
          }

          const trimmed = entry.trim();
          if (trimmed === '') {
            sel.value = previousValue;
            return;
          }

          let value = trimmed;
          if (colId === 'verified') {
            const boolVal = toBool(trimmed);
            if (boolVal === true) value = 'true';
            else if (boolVal === false) value = 'false';
          }

          addSelectOption(sel, value, optionLabel(colId, trimmed));
          sel.value = value;
          previousValue = value;
        });

        wrapper.appendChild(sel);
        inputEl = sel;
        state.inlineEdit.inputEl = inputEl;
        td.appendChild(wrapper);
      } else {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'cell-input';
        inp.value = rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent);
        inputEl = inp;
        state.inlineEdit.inputEl = inputEl;
        td.appendChild(inputEl);
      }

      // focus + select
      setTimeout(() => {
        inputEl.focus();
        if (inputEl.select) inputEl.select();
      }, 0);

      // handlers
      inputEl.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await commitInlineEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          endInlineEdit({ save: false });
        } else if (e.key === 'Tab') {
          // save current and move to next cell in the row
          e.preventDefault();
          await commitInlineEdit();
          focusNextEditableCell(td, e.shiftKey ? -1 : 1);
        }
      });

      inputEl.addEventListener('blur', async () => {
        // save on blur
        await commitInlineEdit();
      });
    };

    const focusNextEditableCell = (fromTd, dir) => {
      const tr = fromTd.closest('tr');
      if (!tr) return;
      const tds = Array.from(tr.querySelectorAll('td[data-editable="true"]'));
      const idx = tds.indexOf(fromTd);
      const next = tds[idx + dir];
      if (!next) return;
      startInlineEdit(next);
    };

    // delegate dblclick to tbody
    const attachInlineEditing = () => {
      els.tbody.addEventListener('dblclick', (e) => {
        const td = e.target.closest('td');
        if (!td) return;
        startInlineEdit(td);
      });

      // click outside to commit (blur usually handles, but this is extra safety)
      document.addEventListener('mousedown', (e) => {
        const ses = state.inlineEdit;
        if (!ses.td) return;
        const inside = e.target.closest('td.editing');
        if (inside) return;
        // if clicked elsewhere, attempt to commit (blur will also fire)
        // no-op here to avoid double commits
      });
    };

    // ---------------- RESIZE ----------------
    const onMouseMoveResize = (e) => {
      if (!state.drag.resizing) return;
      const { colId, startX, startW } = state.drag.resizing;
      const dx = e.clientX - startX;
      setColWidth(colId, startW + dx);
    };

    const stopResize = () => {
      if (!state.drag.resizing) return;
      state.drag.resizing = null;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', onMouseMoveResize);
      document.removeEventListener('mouseup', stopResize);
    };

    const attachResizeHandles = () => {
      els.thead.addEventListener('mousedown', (e) => {
        const handle = e.target.closest('[data-resize]');
        if (!handle) return;
        e.preventDefault();
        e.stopPropagation();

        const colId = handle.getAttribute('data-resize');
        const th = handle.closest('th');
        const thWidth = th ? parseFloat(getComputedStyle(th).width) : 0;
        const startWidth = Number.isFinite(state.columnWidths[colId]) ? state.columnWidths[colId] : (thWidth || 140);

        state.drag.resizing = { colId, startX: e.clientX, startW: startWidth };
        document.body.style.cursor = 'col-resize';
        document.addEventListener('mousemove', onMouseMoveResize);
        document.addEventListener('mouseup', stopResize);
      });
    };

    // ---------------- COLUMN PICKER ----------------
    const renderColumnsPopover = () => {
      els.columnsList.innerHTML = '';

      const makeRow = (colId, label, locked = false) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = `
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">${locked ? 'Locked' : 'Show'}</span>
          <span class="truncate font-semibold">${label}</span>
        `;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !!state.columnVisibility[colId];
        input.disabled = locked;
        input.className = 'h-4 w-4 accent-blue-600';
        input.addEventListener('change', () => {
          state.columnVisibility[colId] = input.checked;
          state.columnVisibility.actions = true;
          savePrefs();
          renderTable();
        });

        wrapper.appendChild(left);
        wrapper.appendChild(input);
        return wrapper;
      };

      els.columnsList.appendChild(makeRow('actions', 'Actions', true));
      ALL_COLUMNS.forEach((c) => els.columnsList.appendChild(makeRow(c.id, c.label)));

      lucide.createIcons();
    };

    const toggleColumnsPopover = (force) => {
      const willShow = typeof force === 'boolean' ? force : els.columnsPopover.classList.contains('hidden');
      els.columnsPopover.classList.toggle('hidden', !willShow);
      if (willShow) renderColumnsPopover();
    };

    const toggleCategoryFilterPopover = (force) => {
      if (!els.categoryFilterPopover) return;
      const willShow = typeof force === 'boolean' ? force : els.categoryFilterPopover.classList.contains('hidden');
      els.categoryFilterPopover.classList.toggle('hidden', !willShow);
      if (willShow) {
        renderCategoryFilterOptions();
        lucide.createIcons();
      }
    };

    document.addEventListener('click', (e) => {
      const insideColumns = e.target.closest('#columns-popover') || e.target.closest('#columns-btn');
      if (!insideColumns) toggleColumnsPopover(false);

      const insideCategories = e.target.closest('#category-filter-popover') || e.target.closest('#category-filter-toggle');
      if (!insideCategories) toggleCategoryFilterPopover(false);
    });

    els.columnsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleColumnsPopover();
    });

    if (els.categoryFilterToggle) {
      els.categoryFilterToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleCategoryFilterPopover();
      });
    }

    if (els.categoryFilterClear) {
      els.categoryFilterClear.addEventListener('click', () => {
        state.filters.categories = [];
        state.pagination.page = 1;
        savePrefs();
        renderCategoryFilterOptions();
        updateCategoryFilterLabel();
        renderTable();
      });
    }

    els.colsAll.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = true);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    els.colsNone.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = false);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    // ---------------- TOP SCROLLBAR SYNC ----------------
    const attachScrollSync = () => {
      let syncing = false;

      els.tableScroll.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
        syncing = false;
      });

      els.topScrollbar.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.tableScroll.scrollLeft = els.topScrollbar.scrollLeft;
        syncing = false;
      });

      window.addEventListener('resize', () => {
        syncTopScrollbar();
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    // ---------------- CHARTS ----------------
    let chartStates = null;
    let chartCategories = null;

    const buildCounts = (rows, key) => {
      const m = new Map();
      rows.forEach((r) => {
        const k = (r[key] || '—').toString().trim() || '—';
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    };

    const makeChartOptions = () => ({
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } },
        tooltip: {
          backgroundColor: 'rgba(2,6,23,.95)',
          borderColor: 'rgba(51,65,85,.8)',
          borderWidth: 1,
          titleColor: 'rgba(226,232,240,.95)',
          bodyColor: 'rgba(226,232,240,.85)',
        }
      },
      scales: {
        x: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } },
        y: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } }
      }
    });

    const renderCharts = (filteredRows) => {
      const topStates = buildCounts(filteredRows, 'state').slice(0, 10);
      const topCats = buildCounts(filteredRows, 'category').slice(0, 8);

      const stateLabels = topStates.map(([k]) => (k === '—' ? 'Unknown' : k.toUpperCase()));
      const stateValues = topStates.map(([, v]) => v);

      const catLabels = topCats.map(([k]) => (k === '—' ? 'Unknown' : k));
      const catValues = topCats.map(([, v]) => v);

      const palette = [
        'rgba(59,130,246,.55)', 'rgba(99,102,241,.55)', 'rgba(16,185,129,.55)',
        'rgba(245,158,11,.55)', 'rgba(236,72,153,.55)', 'rgba(148,163,184,.45)',
        'rgba(34,197,94,.45)', 'rgba(14,165,233,.45)',
      ];

      const ctxStates = document.getElementById('chart-states');
      const ctxCats = document.getElementById('chart-categories');
      if (!ctxStates || !ctxCats) return;

      if (chartStates) chartStates.destroy();
      if (chartCategories) chartCategories.destroy();

      chartStates = new Chart(ctxStates, {
        type: 'bar',
        data: { labels: stateLabels, datasets: [{ label: 'Services', data: stateValues, backgroundColor: palette[0], borderColor: 'rgba(59,130,246,.85)', borderWidth: 1, borderRadius: 10 }] },
        options: { ...makeChartOptions() }
      });

      chartCategories = new Chart(ctxCats, {
        type: 'doughnut',
        data: { labels: catLabels, datasets: [{ label: 'Services', data: catValues, backgroundColor: catValues.map((_, i) => palette[i % palette.length]), borderColor: 'rgba(15,23,42,.9)', borderWidth: 2, hoverOffset: 6 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          animation: false,
          plugins: { legend: { position: 'right', labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } }, tooltip: makeChartOptions().plugins.tooltip },
        }
      });

      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
        syncTopScrollbar();
      });
    };

    const attachAnalyticsResizeObserver = () => {
      if (!('ResizeObserver' in window)) return;
      const ro = new ResizeObserver(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
      ro.observe(els.analyticsWrap);
    };

    // ---------------- DATA FETCH ----------------
    const refresh = async () => {
      els.status.textContent = 'Loading from Supabase…';
      const { data, error } = await supabaseClient.from(READ_TABLE).select('*');
      if (error) {
        console.error('Error fetching services:', error);
        els.status.textContent = 'Error loading data';
        return;
      }

      state.rows = (data || []).map(normalizeRow);

      updateStats();
      populateSelect(els.companyFilter, state.rows.map(r => r.company), 'All companies');
      populateSelect(els.stateFilter, state.rows.map(r => r.state), 'All states');
      renderCategoryFilterOptions();

      syncFilterControls();
      renderTable();
      savePrefs();
    };

    const buildInsertPayload = (row) => {
      const payload = {};
      ALL_COLUMNS.forEach((col) => {
        const dbField = DB_FIELD_BY_COL_ID[col.id];
        if (!dbField) return;
        payload[dbField] = row[col.key] ?? null;
      });
      return payload;
    };

    async function duplicateRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can duplicate records.'); return; }
      const confirmed = confirm(`Duplicate "${row.company}"?`);
      if (!confirmed) return;

      try {
        const payload = buildInsertPayload(row);
        const { data, error } = await supabaseClient
          .from(WRITE_TABLE)
          .insert([payload])
          .select('*')
          .single();

        if (error) throw error;

        const duplicated = normalizeRow(data);
        const index = state.rows.findIndex(r => r.id === row.id);
        if (index >= 0) {
          state.rows.splice(index + 1, 0, duplicated);
        } else {
          state.rows.push(duplicated);
        }

        renderTable();
      } catch (err) {
        console.error(err);
        alert('Error duplicating record: ' + (err?.message || JSON.stringify(err)));
      }
    }

    async function deleteRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can delete records.'); return; }
      const confirmed = confirm(`Delete "${row.company}"?`);
      if (!confirmed) return;
      const { error } = await supabaseClient.from(WRITE_TABLE).delete().eq('id', row.id);
      if (error) alert('Error deleting: ' + error.message);
      else refresh();
    }

    // ---------------- EVENTS ----------------
    els.companyFilter.addEventListener('change', (e) => { state.filters.company = e.target.value; state.pagination.page = 1; savePrefs(); renderTable(); });
    els.stateFilter.addEventListener('change', (e) => { state.filters.state = e.target.value; state.pagination.page = 1; savePrefs(); renderTable(); });
    els.search.addEventListener('input', (e) => { state.filters.search = e.target.value; state.pagination.page = 1; savePrefs(); renderTable(); });

    els.prevPage.addEventListener('click', () => { if (state.pagination.page > 1) { state.pagination.page -= 1; savePrefs(); renderTable(); } });
    els.nextPage.addEventListener('click', () => {
      const total = applySort(applyFilters()).length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.pageSize));
      if (state.pagination.page < totalPages) { state.pagination.page += 1; savePrefs(); renderTable(); }
    });

    els.refresh.addEventListener('click', refresh);

    // Create new record inline (adds blank row in DB, then you edit cells)
    els.addRecord?.addEventListener('click', async () => {
      if (state.currentUserRole !== 'administrator') return;
      try {
        const payload = {
          company_name: '',
          authorization: '',
          category: '',
          verified: null,
          phone: '',
          contact: '',
          address: '',
          city: '',
          state: '',
          zip: '',
          email: '',
          notes: '',
          website: '',
          availability: '',
          lat: null,
          long: null,
        };
        const { data, error } = await supabaseClient.from(WRITE_TABLE).insert([payload]).select('*').single();
        if (error) throw error;
        state.rows.unshift(normalizeRow(data));
        state.pagination.page = 1;
        renderTable();
        savePrefs();
      } catch (err) {
        console.error(err);
        alert('Error creating record: ' + (err?.message || JSON.stringify(err)));
      }
    });

    // ---------------- INIT ----------------
    const init = async () => {
      createConstellationBackground();
      await requireSession();
      syncFilterControls();
      attachResizeHandles();
      attachScrollSync();
      attachAnalyticsResizeObserver();
      attachInlineEditing();
      await refresh();
      renderColumnsPopover();
      syncTopScrollbar();
      lucide.createIcons();
    };
    init();
  </script>
</body>
</html>
