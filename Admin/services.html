<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Services Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Minimal analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="../assets/scripts/supabaseClient.js"></script>
  <script src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>

  <link rel="stylesheet" href="../assets/visuals/theme.css" />

  <style>
    /* Make the table area fit the screen */
    .table-viewport {
      max-height: calc(100vh - 25rem); /* header + stats + filters + pagination */
    }
    @media (min-width: 1024px) {
      .table-viewport {
        max-height: calc(100vh - 22rem);
      }
    }

    /* top horizontal scrollbar */
    .top-scrollbar {
      overflow-x: auto;
      overflow-y: hidden;
      height: 14px;
      border-radius: 0.75rem;
    }
    .top-scrollbar::-webkit-scrollbar { height: 12px; }
    .top-scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    .top-scrollbar::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    /* table scrollbars */
    .table-scroll::-webkit-scrollbar { height: 12px; width: 12px; }
    .table-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    .table-scroll::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    /* Sticky header */
    thead.sticky-head th {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
    }

    /* Column resizing handle */
    th.resizable {
      position: relative;
      user-select: none;
    }
    .col-resizer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 10px;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .col-resizer::after {
      content: "";
      display: block;
      width: 2px;
      height: 55%;
      background: rgba(148,163,184,.35);
      border-radius: 999px;
    }

    /* Dragging header visual */
    th.dragging {
      opacity: .55;
    }
    th.drop-target {
      outline: 2px dashed rgba(59,130,246,.55);
      outline-offset: -6px;
    }

    /* Keep fixed layout so resizing works predictably */
    table.fixed-layout {
      table-layout: fixed;
      width: max-content; /* enables horizontal scroll naturally */
      min-width: 100%;
    }

    /* Header content layout */
    .th-inner {
      display: flex;
      align-items: center;
      gap: .5rem;
      justify-content: space-between;
      width: 100%;
      padding-right: 10px; /* leave space for resizer */
    }

    /* Column picker */
    .popover {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      width: min(320px, 92vw);
      z-index: 50;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 relative">

  <!-- EDIT MODAL -->
  <div id="edit-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4">
    <div class="w-full max-w-4xl rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl shadow-black">
      <div class="flex items-center justify-between border-b border-slate-800 px-6 py-4">
        <h3 id="modal-title" class="text-lg font-bold text-white">Edit Service</h3>
        <button id="close-modal" class="rounded-full p-1 text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>

      <form id="edit-form" class="flex flex-col gap-4 p-6">
        <input type="hidden" id="edit-id" />

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Company Name</label>
            <input type="text" id="edit-company" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Authorization</label>
            <input type="text" id="edit-authorization" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Category</label>
            <input type="text" id="edit-category" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Phone</label>
            <input type="text" id="edit-phone" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Contact</label>
            <input type="text" id="edit-contact" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Email</label>
            <input type="email" id="edit-email" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Address</label>
            <input type="text" id="edit-address" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Website</label>
            <input type="text" id="edit-website" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">City</label>
            <input type="text" id="edit-city" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">State</label>
            <input type="text" id="edit-state" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Zip</label>
            <input type="text" id="edit-zip" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Availability</label>
            <input type="text" id="edit-availability" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Notes</label>
            <textarea id="edit-notes" rows="3" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none"></textarea>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Latitude</label>
            <input type="text" id="edit-lat" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Longitude</label>
            <input type="text" id="edit-long" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" id="cancel-edit" class="rounded-lg px-4 py-2 text-sm font-semibold text-slate-300 hover:text-white">Cancel</button>
          <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 hover:bg-blue-500">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
    <div class="flex items-center justify-between px-6 py-4 lg:px-10">
      <a href="../index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>
          <h1 class="text-base font-black leading-tight text-white">Services</h1>
        </div>
      </a>

      <div class="flex flex-wrap items-center justify-end gap-3">
        <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
          <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
          <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>
          <a id="nav-dashboard" href="./index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
        </nav>

        <div class="flex items-center gap-2">
          <a id="nav-login" href="../login.html" class="hidden rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
          <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex" data-admin-actions>
            <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span> Admin Tools
          </div>
        </div>
      </div>
    </div>
  </header>

  <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>

  <main class="px-6 py-8 lg:px-10">
    <div class="flex flex-col gap-8 lg:flex-row">

      <!-- LEFT NAV -->
      <aside class="hidden w-64 shrink-0 space-y-4 lg:sticky lg:top-8 lg:max-h-[calc(100vh-4rem)] lg:overflow-y-auto lg:block">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Navigation</p>
          <h2 class="text-lg font-black text-white">Admin workspace</h2>
        </div>
        <nav class="flex flex-col gap-2 text-sm font-semibold">
          <a href="./index.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Dashboard
            <span class="text-xs font-medium text-slate-400">Overview</span>
          </a>
          <a href="./profiles.html" data-admin-only class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Profiles
            <span class="text-xs font-medium text-slate-400">Access levels</span>
          </a>
          <a href="./services.html" class="flex items-center justify-between gap-2 rounded-xl border border-blue-500 bg-blue-600/90 px-3 py-2 text-white shadow shadow-blue-500/40">
            Services
            <span class="text-xs font-medium text-blue-100">Technicians</span>
          </a>
          <a href="./vehicles.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Vehicles
            <span class="text-xs font-medium text-slate-400">Fleet</span>
          </a>
          <a href="./analytics.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Analytics
            <span class="text-xs font-medium text-slate-400">Insights</span>
          </a>
        </nav>
      </aside>

      <!-- MAIN -->
      <section class="flex-1 space-y-8">

        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Partner network</p>
            <h2 class="text-2xl font-black text-white">Service roster and coverage</h2>
            <p class="text-sm text-slate-400">Search, filter, sort, reorder, resize columns, and manage your services directory.</p>
          </div>
          <div class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300">
            <i data-lucide="cloud" class="h-4 w-4"></i>
            <span id="dataset-status">Connecting…</span>
          </div>
        </div>

        <!-- STATS -->
        <section class="grid gap-3 sm:grid-cols-3">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Total services</p>
            <p id="tech-total" class="text-3xl font-black text-white">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">States covered</p>
            <p id="tech-states" class="text-3xl font-black text-amber-300">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Companies</p>
            <p id="tech-companies" class="text-3xl font-black text-emerald-300">-</p>
          </div>
        </section>

        <!-- MINIMAL ANALYTICS -->
        <section class="grid gap-3 lg:grid-cols-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                <h3 class="text-lg font-bold text-white">Top states (filtered)</h3>
              </div>
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Bar</span>
            </div>
            <div class="mt-4 h-56">
              <canvas id="chart-states"></canvas>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                <h3 class="text-lg font-bold text-white">Categories share (filtered)</h3>
              </div>
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Doughnut</span>
            </div>
            <div class="mt-4 h-56">
              <canvas id="chart-categories"></canvas>
            </div>
          </div>
        </section>

        <!-- DIRECTORY -->
        <section class="space-y-3 rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/60">
          <div class="flex flex-col gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Directory</p>
              <h3 class="text-lg font-bold text-white">Service list</h3>
            </div>

            <!-- FILTERS / ACTIONS -->
            <div class="flex flex-col gap-2">
              <div class="flex flex-wrap gap-2">
                <select id="company-filter" class="w-40 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                  <option value="all">All companies</option>
                </select>
                <select id="state-filter" class="w-36 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                  <option value="all">All states</option>
                </select>
                <select id="category-filter" class="w-40 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                  <option value="all">All categories</option>
                </select>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <input id="search" type="search" placeholder="Search by company, category, address, state, or city"
                       class="w-72 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none" />

                <!-- Column picker -->
                <div class="relative">
                  <button id="columns-btn"
                          class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white">
                    <i data-lucide="columns-3" class="h-4 w-4"></i>
                    Columns
                    <i data-lucide="chevron-down" class="h-4 w-4"></i>
                  </button>

                  <div id="columns-popover" class="popover hidden rounded-2xl border border-slate-800 bg-slate-950/95 p-3 shadow-2xl shadow-black">
                    <div class="flex items-center justify-between px-2 pb-2">
                      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Visible columns</p>
                      <div class="flex items-center gap-2">
                        <button id="cols-all" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">All</button>
                        <button id="cols-none" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">None</button>
                      </div>
                    </div>
                    <div id="columns-list" class="max-h-56 overflow-y-auto px-2 pb-2"></div>
                    <p class="px-2 pt-1 text-[11px] text-slate-500">Tip: drag headers to reorder • drag header edge to resize</p>
                  </div>
                </div>

                <button id="add-record"
                        class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 shadow shadow-emerald-600/30 transition hover:-translate-y-0.5"
                        data-admin-actions>
                  <i data-lucide="plus" class="h-4 w-4"></i>
                  New record
                </button>

                <button id="refresh-button"
                        class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 shadow shadow-blue-600/30 transition hover:-translate-y-0.5">
                  <i data-lucide="refresh-ccw" class="h-4 w-4"></i>
                  Refresh
                </button>

                <div class="ml-auto hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300 md:flex">
                  <i data-lucide="mouse-pointer-2" class="h-4 w-4"></i>
                  <span>Resize • Reorder • Sort</span>
                </div>
              </div>
            </div>
          </div>

          <!-- TOP HORIZONTAL SCROLLBAR -->
          <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-2">
            <div id="top-scrollbar" class="top-scrollbar">
              <div id="top-scrollbar-inner" style="height:1px;"></div>
            </div>
          </div>

          <!-- TABLE -->
          <div id="table-scroll" class="table-scroll table-viewport overflow-auto rounded-xl border border-slate-800">
            <table id="services-table" class="fixed-layout divide-y divide-slate-800 text-sm whitespace-nowrap">
              <colgroup id="colgroup"></colgroup>
              <thead id="table-head" class="sticky-head bg-slate-950/60 text-slate-300"></thead>
              <tbody id="table-body" class="divide-y divide-slate-800 bg-slate-950/40"></tbody>
            </table>
          </div>

          <!-- PAGINATION -->
          <div class="flex flex-col gap-3 rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
            <p id="pagination-summary" class="text-sm text-slate-300">Showing 0-0 of 0</p>
            <div class="flex items-center gap-2">
              <button id="prev-page" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                <i data-lucide="chevron-left" class="h-4 w-4"></i>
                Prev
              </button>
              <span id="page-indicator" class="text-sm font-semibold text-slate-100">1 / 1</span>
              <button id="next-page" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                Next
                <i data-lucide="chevron-right" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </section>
      </section>
    </div>
  </main>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';

    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';

    const READ_TABLE = 'Services';
    const WRITE_TABLE = 'Services';
    const PAGE_CATEGORY = 'GPS Technician';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row[key];
        if (value !== undefined && value !== null && String(value).trim() !== '') return value;
      }
      return '';
    };

    const normalizeRow = (row) => ({
      id: row.id,
      company: getField(row, 'company_name', 'Installation Company', 'Company', 'company', 'name'),
      authorization: getField(row, 'Authorization', 'authorization'),
      category: getField(row, 'category', 'Category'),
      phone: getField(row, 'Phone', 'phone'),
      contact: getField(row, 'contact', 'Contact'),
      address: getField(row, 'address', 'Address'),
      city: getField(row, 'City', 'city'),
      state: getField(row, 'State', 'state', 'state_code'),
      zip: getField(row, 'Zip', 'zip', 'zipcode', 'postal_code'),
      email: getField(row, 'Email', 'email'),
      notes: getField(row, 'Notes', 'notes'),
      website: getField(row, 'website', 'Website'),
      availability: getField(row, 'availability', 'Availability'),
      lat: getField(row, 'lat', 'latitude', 'Lat'),
      long: getField(row, 'long', 'lng', 'longitude', 'Lon'),
    });

    const els = {
      status: document.getElementById('dataset-status'),
      total: document.getElementById('tech-total'),
      states: document.getElementById('tech-states'),
      companies: document.getElementById('tech-companies'),

      companyFilter: document.getElementById('company-filter'),
      stateFilter: document.getElementById('state-filter'),
      categoryFilter: document.getElementById('category-filter'),
      search: document.getElementById('search'),

      paginationSummary: document.getElementById('pagination-summary'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageIndicator: document.getElementById('page-indicator'),

      refresh: document.getElementById('refresh-button'),
      addRecord: document.getElementById('add-record'),

      // table
      table: document.getElementById('services-table'),
      colgroup: document.getElementById('colgroup'),
      thead: document.getElementById('table-head'),
      tbody: document.getElementById('table-body'),
      tableScroll: document.getElementById('table-scroll'),

      // top scrollbar
      topScrollbar: document.getElementById('top-scrollbar'),
      topScrollbarInner: document.getElementById('top-scrollbar-inner'),

      // columns popover
      columnsBtn: document.getElementById('columns-btn'),
      columnsPopover: document.getElementById('columns-popover'),
      columnsList: document.getElementById('columns-list'),
      colsAll: document.getElementById('cols-all'),
      colsNone: document.getElementById('cols-none'),

      // Modal
      modal: document.getElementById('edit-modal'),
      closeModal: document.getElementById('close-modal'),
      cancelEdit: document.getElementById('cancel-edit'),
      editForm: document.getElementById('edit-form'),
    };

    const ALL_COLUMNS = [
      { id: 'company', label: 'Company Name', key: 'company', defaultWidth: 220 },
      { id: 'authorization', label: 'Authorization', key: 'authorization', defaultWidth: 160 },
      { id: 'category', label: 'Category', key: 'category', defaultWidth: 170 },
      { id: 'phone', label: 'Phone', key: 'phone', defaultWidth: 150 },
      { id: 'contact', label: 'Contact', key: 'contact', defaultWidth: 160 },
      { id: 'address', label: 'Address', key: 'address', defaultWidth: 260 },
      { id: 'city', label: 'City', key: 'city', defaultWidth: 140 },
      { id: 'state', label: 'State', key: 'state', defaultWidth: 100 },
      { id: 'zip', label: 'Zip', key: 'zip', defaultWidth: 100 },
      { id: 'email', label: 'Email', key: 'email', defaultWidth: 240 },
      { id: 'notes', label: 'Notes', key: 'notes', defaultWidth: 260 },
      { id: 'website', label: 'Website', key: 'website', defaultWidth: 220 },
      { id: 'availability', label: 'Availability', key: 'availability', defaultWidth: 180 },
      { id: 'lat', label: 'Lat', key: 'lat', defaultWidth: 120 },
      { id: 'long', label: 'Long', key: 'long', defaultWidth: 120 },
    ];

    const state = {
      rows: [],
      currentUserRole: 'user',

      filters: {
        search: '',
        company: 'all',
        state: 'all',
        category: 'all',
      },

      sort: {
        key: '',   // matches column.id
        dir: 'asc' // 'asc'|'desc'
      },

      pagination: {
        page: 1,
        pageSize: 20,
      },

      // column UX
      columnOrder: ['actions', ...ALL_COLUMNS.map(c => c.id)],
      columnVisibility: Object.fromEntries([['actions', true], ...ALL_COLUMNS.map(c => [c.id, true])]),
      columnWidths: Object.fromEntries([['actions', 110], ...ALL_COLUMNS.map(c => [c.id, c.defaultWidth])]),

      drag: {
        resizing: null, // { colId, startX, startW }
        draggingCol: null,
      }
    };

    // ---------------- AUTH ----------------
    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();

      if (data?.session) {
        if (window.currentUserRole) {
          state.currentUserRole = window.currentUserRole;
        } else {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', data.session.user.id)
            .single();
          state.currentUserRole = profile?.role || 'user';
        }
      } else {
        state.currentUserRole = 'anon';
      }

      const isAdmin = state.currentUserRole === 'administrator';
      if (els.addRecord) {
        els.addRecord.classList.toggle('hidden', !isAdmin);
        els.addRecord.disabled = !isAdmin;
      }
    };

    // ---------------- HELPERS ----------------
    const getText = (value) => String(value ?? '').toLowerCase().trim();

    const updateStats = () => {
      const total = state.rows.length;
      const statesCount = new Set(state.rows.map(r => (r.state || '').trim()).filter(Boolean)).size;
      const companiesCount = new Set(state.rows.map(r => (r.company || '').trim()).filter(Boolean)).size;

      els.total.textContent = total;
      els.states.textContent = statesCount;
      els.companies.textContent = companiesCount;
      els.status.textContent = total ? `Connected • ${total} records` : 'Awaiting data';
    };

    const populateSelect = (element, values, label) => {
      const options = Array.from(new Set(values.filter(Boolean).map(v => getText(v)))).sort();
      const current = element.value;
      element.innerHTML = `<option value="all">${label}</option>`;
      options.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value.toUpperCase();
        if (value === current) option.selected = true;
        element.appendChild(option);
      });
    };

    const applySearch = (rows, term) => {
      if (!term) return rows;
      const q = term.toLowerCase();
      return rows.filter((row) =>
        [row.company, row.authorization, row.category, row.phone, row.contact, row.address, row.city, row.state, row.zip, row.email, row.notes, row.website, row.availability]
          .some((v) => String(v || '').toLowerCase().includes(q))
      );
    };

    const applyFilters = () => {
      const f = state.filters;
      let result = applySearch([...state.rows], f.search);

      if (f.company !== 'all') result = result.filter(r => getText(r.company) === f.company);
      if (f.state !== 'all') result = result.filter(r => getText(r.state) === f.state);
      if (f.category !== 'all') result = result.filter(r => getText(r.category) === f.category);

      return result;
    };

    const applySort = (rows) => {
      const { key, dir } = state.sort;
      if (!key) return rows;

      const col = ALL_COLUMNS.find(c => c.id === key);
      if (!col) return rows;

      const sorted = [...rows].sort((a, b) => {
        const av = getText(a[col.key]);
        const bv = getText(b[col.key]);
        return av.localeCompare(bv, undefined, { numeric: true, sensitivity: 'base' });
      });

      return dir === 'asc' ? sorted : sorted.reverse();
    };

    const getVisibleOrderedColumns = () => {
      return state.columnOrder.filter(colId => state.columnVisibility[colId]);
    };

    // ---------------- TABLE RENDER ----------------
    const renderColgroup = () => {
      const cols = getVisibleOrderedColumns();
      els.colgroup.innerHTML = '';
      cols.forEach((colId) => {
        const colEl = document.createElement('col');
        colEl.setAttribute('data-col', colId);
        colEl.style.width = `${state.columnWidths[colId] || 140}px`;
        els.colgroup.appendChild(colEl);
      });
    };

    const setColWidth = (colId, px) => {
      const min = colId === 'actions' ? 90 : 90;
      const max = 800;
      state.columnWidths[colId] = Math.max(min, Math.min(max, px));

      // Update matching col in colgroup
      const colEl = els.colgroup.querySelector(`col[data-col="${colId}"]`);
      if (colEl) colEl.style.width = `${state.columnWidths[colId]}px`;

      // keep top scrollbar width in sync
      syncTopScrollbar();
    };

    const sortIcon = (colId) => {
      if (state.sort.key !== colId) return 'arrow-up-down';
      return state.sort.dir === 'asc' ? 'arrow-up' : 'arrow-down';
    };

    const toggleSort = (colId) => {
      if (state.sort.key === colId) {
        state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        state.sort.key = colId;
        state.sort.dir = 'asc';
      }
      state.pagination.page = 1;
      renderTable();
    };

    const buildHeaderCell = (colId) => {
      const th = document.createElement('th');
      th.className = 'px-4 py-3 text-left font-semibold text-slate-200 resizable bg-slate-950/60';
      th.setAttribute('data-col', colId);

      // actions header
      if (colId === 'actions') {
        th.className = 'px-4 py-3 text-left font-semibold text-blue-300 resizable bg-slate-950/60';
        th.innerHTML = `
          <div class="th-inner">
            <span class="text-blue-300">Actions</span>
            <span class="opacity-60 text-[11px] uppercase tracking-wide">—</span>
          </div>
          <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
        `;
        return th;
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      const label = col?.label || colId;

      th.setAttribute('draggable', 'true');
      th.innerHTML = `
        <div class="th-inner">
          <div class="flex items-center gap-2 min-w-0">
            <span class="truncate">${label}</span>
          </div>

          <button type="button"
                  class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-950/50 px-2 py-1 text-[11px] font-semibold text-slate-200 hover:border-blue-500 hover:text-white"
                  data-sort-col="${colId}"
                  title="Sort">
            <i data-lucide="${sortIcon(colId)}" class="h-3.5 w-3.5"></i>
          </button>
        </div>
        <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
      `;
      return th;
    };

    const renderHeader = () => {
      const cols = getVisibleOrderedColumns();

      const tr = document.createElement('tr');
      cols.forEach((colId) => tr.appendChild(buildHeaderCell(colId)));

      els.thead.innerHTML = '';
      els.thead.appendChild(tr);

      // Header drag & drop
      els.thead.querySelectorAll('th[draggable="true"]').forEach((th) => {
        th.addEventListener('dragstart', (e) => {
          const colId = th.dataset.col;
          state.drag.draggingCol = colId;
          th.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', colId);
        });

        th.addEventListener('dragend', () => {
          th.classList.remove('dragging');
          state.drag.draggingCol = null;
          els.thead.querySelectorAll('th').forEach(x => x.classList.remove('drop-target'));
        });

        th.addEventListener('dragover', (e) => {
          e.preventDefault();
          const targetCol = th.dataset.col;
          if (!state.drag.draggingCol || state.drag.draggingCol === targetCol) return;
          th.classList.add('drop-target');
        });

        th.addEventListener('dragleave', () => th.classList.remove('drop-target'));

        th.addEventListener('drop', (e) => {
          e.preventDefault();
          const from = state.drag.draggingCol;
          const to = th.dataset.col;
          if (!from || !to || from === to) return;

          // Only reorder among visible columns (actions can also move, but keep it allowed)
          const order = [...state.columnOrder];
          const fromIdx = order.indexOf(from);
          const toIdx = order.indexOf(to);
          if (fromIdx === -1 || toIdx === -1) return;

          order.splice(fromIdx, 1);
          order.splice(toIdx, 0, from);
          state.columnOrder = order;

          renderTable(); // rerender header + body
        });
      });

      // Sort buttons
      els.thead.querySelectorAll('[data-sort-col]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSort(btn.getAttribute('data-sort-col'));
        });
      });

      lucide.createIcons();
    };

    const renderBody = (pageRows) => {
      const cols = getVisibleOrderedColumns();
      const canEdit = state.currentUserRole === 'administrator';
      const canDelete = state.currentUserRole === 'administrator';

      els.tbody.innerHTML = '';

      pageRows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.className = 'transition hover:bg-slate-800/40';

        cols.forEach((colId) => {
          const td = document.createElement('td');
          td.className = 'px-4 py-3 align-top text-slate-200';

          if (colId === 'actions') {
            td.className = 'px-4 py-3 text-center align-top';
            if (canEdit) {
              const editBtn = document.createElement('button');
              editBtn.className = 'mr-2 text-blue-400 transition hover:text-blue-300 hover:scale-110';
              editBtn.innerHTML = '<i data-lucide="pencil" class="h-4 w-4"></i>';
              editBtn.onclick = () => openEditModal(row);
              td.appendChild(editBtn);

              if (canDelete) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 transition hover:text-red-300 hover:scale-110';
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="h-4 w-4"></i>';
                deleteBtn.onclick = () => deleteRow(row);
                td.appendChild(deleteBtn);
              }
            } else {
              td.innerHTML = '<span class="text-slate-600 text-xs">Read Only</span>';
            }
            tr.appendChild(td);
            return;
          }

          const col = ALL_COLUMNS.find(c => c.id === colId);
          const value = col ? row[col.key] : '';

          if (colId === 'company') td.className = 'px-4 py-3 font-semibold text-white align-top';
          td.textContent = value || '—';
          tr.appendChild(td);
        });

        els.tbody.appendChild(tr);
      });

      lucide.createIcons();
    };

    const renderPagination = (rows) => {
      const totalPages = Math.max(1, Math.ceil(rows.length / state.pagination.pageSize));
      if (state.pagination.page > totalPages) state.pagination.page = totalPages;

      const start = (state.pagination.page - 1) * state.pagination.pageSize;
      const end = Math.min(rows.length, start + state.pagination.pageSize);

      els.paginationSummary.textContent = rows.length
        ? `Showing ${start + 1}-${end} of ${rows.length}`
        : 'No entries to display';

      els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;
      els.prevPage.disabled = state.pagination.page === 1 || rows.length === 0;
      els.nextPage.disabled = state.pagination.page >= totalPages || rows.length === 0;

      return { start, end, totalPages };
    };

    const syncTopScrollbar = () => {
      // make the "inner" div match actual scroll width of table scroll container content
      const scrollWidth = els.table.scrollWidth;
      els.topScrollbarInner.style.width = scrollWidth + 'px';
      els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
    };

    const renderTable = () => {
      const filtered = applyFilters();
      const sorted = applySort(filtered);

      const { start, end } = renderPagination(sorted);

      renderColgroup();
      renderHeader();
      renderBody(sorted.slice(start, end));
      renderColumnsPopover();
      syncTopScrollbar();
      renderCharts(sorted); // analytics over filtered+sorted (same set)

      // keep icons correct after header sort state changes
      lucide.createIcons();
    };

    // ---------------- RESIZE (drag border) ----------------
    const onMouseMoveResize = (e) => {
      if (!state.drag.resizing) return;
      const { colId, startX, startW } = state.drag.resizing;
      const dx = e.clientX - startX;
      setColWidth(colId, startW + dx);
    };

    const stopResize = () => {
      if (!state.drag.resizing) return;
      state.drag.resizing = null;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', onMouseMoveResize);
      document.removeEventListener('mouseup', stopResize);
    };

    const attachResizeHandles = () => {
      // delegate from thead for new renders
      els.thead.addEventListener('mousedown', (e) => {
        const handle = e.target.closest('[data-resize]');
        if (!handle) return;

        e.preventDefault();
        e.stopPropagation();

        const colId = handle.getAttribute('data-resize');
        state.drag.resizing = {
          colId,
          startX: e.clientX,
          startW: state.columnWidths[colId] || 140,
        };
        document.body.style.cursor = 'col-resize';
        document.addEventListener('mousemove', onMouseMoveResize);
        document.addEventListener('mouseup', stopResize);
      });
    };

    // ---------------- COLUMN PICKER ----------------
    const renderColumnsPopover = () => {
      const visibleIds = Object.keys(state.columnVisibility);

      // Actions is always visible, but still show it as locked
      els.columnsList.innerHTML = '';

      const makeRow = (colId, label, locked = false) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = `
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">${locked ? 'Locked' : 'Show'}</span>
          <span class="truncate font-semibold">${label}</span>
        `;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !!state.columnVisibility[colId];
        input.disabled = locked;
        input.className = 'h-4 w-4 accent-blue-600';

        input.addEventListener('change', () => {
          state.columnVisibility[colId] = input.checked;
          renderTable();
        });

        wrapper.appendChild(left);
        wrapper.appendChild(input);
        return wrapper;
      };

      els.columnsList.appendChild(makeRow('actions', 'Actions', true));
      ALL_COLUMNS.forEach((c) => els.columnsList.appendChild(makeRow(c.id, c.label)));
      lucide.createIcons();
    };

    const toggleColumnsPopover = (force) => {
      const willShow = typeof force === 'boolean'
        ? force
        : els.columnsPopover.classList.contains('hidden');

      els.columnsPopover.classList.toggle('hidden', !willShow);
      if (willShow) renderColumnsPopover();
    };

    // click-away
    document.addEventListener('click', (e) => {
      const inside = e.target.closest('#columns-popover') || e.target.closest('#columns-btn');
      if (!inside) toggleColumnsPopover(false);
    });

    els.columnsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleColumnsPopover();
    });

    els.colsAll.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => {
        state.columnVisibility[k] = true;
      });
      state.columnVisibility.actions = true;
      renderTable();
    });

    els.colsNone.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => {
        state.columnVisibility[k] = false;
      });
      // keep actions visible
      state.columnVisibility.actions = true;
      renderTable();
    });

    // ---------------- TOP SCROLLBAR SYNC ----------------
    const attachScrollSync = () => {
      let syncing = false;

      els.tableScroll.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
        syncing = false;
      });

      els.topScrollbar.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.tableScroll.scrollLeft = els.topScrollbar.scrollLeft;
        syncing = false;
      });

      window.addEventListener('resize', syncTopScrollbar);
    };

    // ---------------- CHARTS ----------------
    let chartStates = null;
    let chartCategories = null;

    const buildCounts = (rows, key) => {
      const m = new Map();
      rows.forEach((r) => {
        const k = (r[key] || '—').toString().trim() || '—';
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    };

    const makeChartOptions = () => ({
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: 'rgba(226,232,240,.85)',
            boxWidth: 10,
            boxHeight: 10,
            usePointStyle: true,
          }
        },
        tooltip: {
          backgroundColor: 'rgba(2,6,23,.95)',
          borderColor: 'rgba(51,65,85,.8)',
          borderWidth: 1,
          titleColor: 'rgba(226,232,240,.95)',
          bodyColor: 'rgba(226,232,240,.85)',
        }
      },
      scales: {
        x: {
          ticks: { color: 'rgba(148,163,184,.8)' },
          grid: { color: 'rgba(51,65,85,.35)' }
        },
        y: {
          ticks: { color: 'rgba(148,163,184,.8)' },
          grid: { color: 'rgba(51,65,85,.35)' }
        }
      }
    });

    const renderCharts = (filteredRows) => {
      const topStates = buildCounts(filteredRows, 'state').slice(0, 10);
      const topCats = buildCounts(filteredRows, 'category').slice(0, 8);

      const stateLabels = topStates.map(([k]) => (k === '—' ? 'Unknown' : k.toUpperCase()));
      const stateValues = topStates.map(([, v]) => v);

      const catLabels = topCats.map(([k]) => (k === '—' ? 'Unknown' : k));
      const catValues = topCats.map(([, v]) => v);

      // Minimal palette (soft, consistent)
      const palette = [
        'rgba(59,130,246,.55)',  // blue
        'rgba(99,102,241,.55)',  // indigo
        'rgba(16,185,129,.55)',  // emerald
        'rgba(245,158,11,.55)',  // amber
        'rgba(236,72,153,.55)',  // pink
        'rgba(148,163,184,.45)', // slate
        'rgba(34,197,94,.45)',   // green
        'rgba(14,165,233,.45)',  // sky
      ];

      const ctxStates = document.getElementById('chart-states');
      const ctxCats = document.getElementById('chart-categories');

      if (chartStates) chartStates.destroy();
      if (chartCategories) chartCategories.destroy();

      chartStates = new Chart(ctxStates, {
        type: 'bar',
        data: {
          labels: stateLabels,
          datasets: [{
            label: 'Services',
            data: stateValues,
            backgroundColor: palette[0],
            borderColor: 'rgba(59,130,246,.85)',
            borderWidth: 1,
            borderRadius: 10,
          }]
        },
        options: {
          ...makeChartOptions(),
          scales: {
            ...makeChartOptions().scales,
            x: { ...makeChartOptions().scales.x, ticks: { ...makeChartOptions().scales.x.ticks, maxRotation: 0 } }
          }
        }
      });

      chartCategories = new Chart(ctxCats, {
        type: 'doughnut',
        data: {
          labels: catLabels,
          datasets: [{
            label: 'Services',
            data: catValues,
            backgroundColor: catValues.map((_, i) => palette[i % palette.length]),
            borderColor: 'rgba(15,23,42,.9)',
            borderWidth: 2,
            hoverOffset: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(226,232,240,.85)',
                boxWidth: 10,
                boxHeight: 10,
                usePointStyle: true,
              }
            },
            tooltip: makeChartOptions().plugins.tooltip
          }
        }
      });
    };

    // ---------------- DATA FETCH ----------------
    const refresh = async () => {
      els.status.textContent = 'Loading from Supabase…';

      const { data, error } = await supabaseClient
        .from(READ_TABLE)
        .select('*');

      if (error) {
        console.error('Error fetching services:', error);
        els.status.textContent = 'Error loading data';
        return;
      }

      state.rows = (data || []).map(normalizeRow);

      updateStats();
      populateSelect(els.companyFilter, state.rows.map(r => r.company), 'All companies');
      populateSelect(els.stateFilter, state.rows.map(r => r.state), 'All states');
      populateSelect(els.categoryFilter, state.rows.map(r => r.category), 'All categories');

      state.pagination.page = 1;
      renderTable();
    };

    // ---------------- MODAL FUNCTIONS ----------------
    function setFormValues(row = {}) {
      document.getElementById('edit-id').value = row.id || '';
      document.getElementById('edit-company').value = row.company || '';
      document.getElementById('edit-authorization').value = row.authorization || '';
      document.getElementById('edit-category').value = row.category || PAGE_CATEGORY;
      document.getElementById('edit-phone').value = row.phone || '';
      document.getElementById('edit-contact').value = row.contact || '';
      document.getElementById('edit-email').value = row.email || '';
      document.getElementById('edit-address').value = row.address || '';
      document.getElementById('edit-city').value = row.city || '';
      document.getElementById('edit-state').value = row.state || '';
      document.getElementById('edit-zip').value = row.zip || '';
      document.getElementById('edit-website').value = row.website || '';
      document.getElementById('edit-availability').value = row.availability || '';
      document.getElementById('edit-lat').value = row.lat || '';
      document.getElementById('edit-long').value = row.long || '';
      document.getElementById('edit-notes').value = row.notes || '';
    }

    function openEditModal(row) {
      if (state.currentUserRole !== 'administrator') {
        alert('Only administrators can edit services.');
        return;
      }
      document.getElementById('modal-title').textContent = 'Edit Service';
      setFormValues(row);
      els.modal.classList.remove('hidden');
      els.modal.classList.add('flex');
    }

    function openCreateModal() {
      if (state.currentUserRole !== 'administrator') {
        alert('Only administrators can add services.');
        return;
      }
      document.getElementById('modal-title').textContent = 'Add new record';
      setFormValues({ category: PAGE_CATEGORY });
      els.modal.classList.remove('hidden');
      els.modal.classList.add('flex');
    }

    function closeEditModal() {
      els.modal.classList.add('hidden');
      els.modal.classList.remove('flex');
    }

    els.closeModal.addEventListener('click', closeEditModal);
    els.cancelEdit.addEventListener('click', closeEditModal);

    async function deleteRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') {
        alert('Only administrators can delete records.');
        return;
      }
      const confirmed = confirm(`Delete "${row.company}"?`);
      if (!confirmed) return;

      const { error } = await supabaseClient.from(WRITE_TABLE).delete().eq('id', row.id);
      if (error) alert('Error deleting: ' + error.message);
      else refresh();
    }

    // SAVE CHANGES
    els.editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (state.currentUserRole !== 'administrator') {
        alert('Only administrators can save changes.');
        return;
      }
      const id = document.getElementById('edit-id').value;

      const payload = {
        company_name: document.getElementById('edit-company').value,
        authorization: document.getElementById('edit-authorization').value,
        category: document.getElementById('edit-category').value || PAGE_CATEGORY,
        phone: document.getElementById('edit-phone').value,
        contact: document.getElementById('edit-contact').value,
        email: document.getElementById('edit-email').value,
        address: document.getElementById('edit-address').value,
        city: document.getElementById('edit-city').value,
        state: document.getElementById('edit-state').value,
        zip: document.getElementById('edit-zip').value,
        notes: document.getElementById('edit-notes').value,
        website: document.getElementById('edit-website').value,
        availability: document.getElementById('edit-availability').value,
        lat: document.getElementById('edit-lat').value,
        long: document.getElementById('edit-long').value,
      };

      const btn = els.editForm.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      let error;
      if (id) ({ error } = await supabaseClient.from(WRITE_TABLE).update(payload).eq('id', id));
      else ({ error } = await supabaseClient.from(WRITE_TABLE).insert([{ ...payload, category: payload.category || PAGE_CATEGORY }]));

      btn.textContent = originalText;
      btn.disabled = false;

      if (error) alert('Error saving: ' + error.message);
      else {
        closeEditModal();
        refresh();
      }
    });

    // ---------------- EVENTS ----------------
    els.companyFilter.addEventListener('change', (e) => { state.filters.company = e.target.value; state.pagination.page = 1; renderTable(); });
    els.stateFilter.addEventListener('change', (e) => { state.filters.state = e.target.value; state.pagination.page = 1; renderTable(); });
    els.categoryFilter.addEventListener('change', (e) => { state.filters.category = e.target.value; state.pagination.page = 1; renderTable(); });
    els.search.addEventListener('input', (e) => { state.filters.search = e.target.value; state.pagination.page = 1; renderTable(); });

    els.prevPage.addEventListener('click', () => {
      if (state.pagination.page > 1) {
        state.pagination.page -= 1;
        renderTable();
      }
    });

    els.nextPage.addEventListener('click', () => {
      const total = applySort(applyFilters()).length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.pageSize));
      if (state.pagination.page < totalPages) {
        state.pagination.page += 1;
        renderTable();
      }
    });

    els.refresh.addEventListener('click', refresh);
    els.addRecord?.addEventListener('click', openCreateModal);

    // ---------------- INIT ----------------
    const init = async () => {
      createConstellationBackground();
      await requireSession();

      attachResizeHandles();
      attachScrollSync();

      await refresh();
      renderColumnsPopover();
      syncTopScrollbar();

      lucide.createIcons();
    };

    init();
  </script>
</body>
</html>
