<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Services Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Minimal analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="../assets/scripts/supabaseClient.js"></script>
  <script src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>

  <link rel="stylesheet" href="../assets/visuals/theme.css" />

  <style>
    html, body { width: 100%; height: auto; }
    body { overflow-x: hidden; overflow-y: auto; }
    main { width: 100%; height: auto; overflow: visible; }

    .directory-shell { display: flex; flex-direction: column; gap: 0.75rem; overflow: visible; height: auto !important; min-height: 0 !important; }

    .analytics-wrap { max-width: 100%; overflow: hidden; }
    .mini-analytics { display: grid; grid-template-columns: minmax(0, 1fr); gap: .75rem; max-width: 100%; overflow: hidden; }
    @media (min-width: 1024px) { .mini-analytics { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .mini-chart { height: 150px; max-width: 100%; overflow: hidden; }
    .mini-chart canvas { width: 100% !important; height: 100% !important; display: block; max-width: 100% !important; }

    .table-window { display: flex; flex-direction: column; gap: 0.6rem; flex: none; min-height: 0; overflow: visible; }

    .top-scrollbar-shell { flex: 0 0 auto; position: sticky; top: 0; z-index: 20; padding: 0.5rem; border: 1px solid rgb(30 41 59); background: rgba(2, 6, 23, 0.75); border-radius: 0.75rem; backdrop-filter: blur(6px); }
    .top-scrollbar { overflow-x: auto; overflow-y: hidden; height: 14px; border-radius: 0.75rem; }
    .top-scrollbar::-webkit-scrollbar { height: 12px; }
    .top-scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    .top-scrollbar::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    #table-scroll { overflow-x: auto; overflow-y: visible; width: 100%; max-width: 100%; border-radius: 0.75rem; }
    #table-scroll::-webkit-scrollbar { height: 12px; width: 12px; }
    #table-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.25); border-radius: 999px; }
    #table-scroll::-webkit-scrollbar-track { background: rgba(15,23,42,.35); border-radius: 999px; }

    thead.sticky-head th { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px); }

    th.resizable { position: relative; user-select: none; }
    .col-resizer { position: absolute; right: 0; top: 0; height: 100%; width: 10px; cursor: col-resize; display: flex; align-items: center; justify-content: center; }
    .col-resizer::after { content: ""; display: block; width: 2px; height: 55%; background: rgba(148,163,184,.35); border-radius: 999px; }

    th.dragging { opacity: .55; }
    th.drop-target { outline: 2px dashed rgba(59,130,246,.55); outline-offset: -6px; }

    table.fixed-layout { table-layout: fixed; width: max-content; min-width: 100%; }

    #services-table th, #services-table td { white-space: normal !important; overflow-wrap: anywhere; word-break: break-word; vertical-align: top; }
    .th-inner { display: flex; align-items: center; gap: .5rem; justify-content: space-between; width: 100%; padding-right: 10px; min-width: 0; }
    .popover { position: absolute; right: 0; top: calc(100% + 8px); width: min(340px, 92vw); z-index: 50; }
    .compact-th { padding: 0.5rem 0.8rem; }
    .compact-td { padding: 0.5rem 0.8rem; }
    .compact-text { font-size: 12.5px; line-height: 1.25rem; }
    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(0, 1fr)); }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 relative">
  <!-- EDIT MODAL -->
  <div id="edit-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4">
    <div class="w-full max-w-4xl rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl shadow-black">
      <div class="flex items-center justify-between border-b border-slate-800 px-6 py-4">
        <h3 id="modal-title" class="text-lg font-bold text-white">Edit Service</h3>
        <button id="close-modal" type="button" class="rounded-full p-1 text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>

      <form id="edit-form" class="flex flex-col gap-4 p-6">
        <input type="hidden" id="edit-id" />

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Company Name</label>
            <input type="text" id="edit-company" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Authorization</label>
            <input type="text" id="edit-authorization" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Category</label>
            <input type="text" id="edit-category" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Phone</label>
            <input type="text" id="edit-phone" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Contact</label>
            <input type="text" id="edit-contact" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Email</label>
            <input type="email" id="edit-email" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Address</label>
            <input type="text" id="edit-address" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Website</label>
            <input type="text" id="edit-website" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">City</label>
            <input type="text" id="edit-city" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">State</label>
            <input type="text" id="edit-state" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Zip</label>
            <input type="text" id="edit-zip" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Availability</label>
            <input type="text" id="edit-availability" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Verified</label>
            <select id="edit-verified" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
              <option value="">—</option>
              <option value="true">Verified</option>
              <option value="false">Not verified</option>
            </select>
            <p class="mt-1 text-[11px] text-slate-500">Saved to Supabase as a boolean when possible.</p>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-400">Notes</label>
            <textarea id="edit-notes" rows="3" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none"></textarea>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div class="space-y-1">
              <label class="text-xs font-semibold uppercase text-slate-400">Latitude</label>
              <input type="text" id="edit-lat" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
            </div>
            <div class="space-y-1">
              <label class="text-xs font-semibold uppercase text-slate-400">Longitude</label>
              <input type="text" id="edit-long" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" id="cancel-edit" class="rounded-lg px-4 py-2 text-sm font-semibold text-slate-300 hover:text-white">Cancel</button>
          <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 hover:bg-blue-500">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur" style="height:72px;">
    <div class="flex items-center justify-between px-6 py-4 lg:px-10">
      <a href="../index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>
          <h1 class="text-base font-black leading-tight text-white">Services</h1>
        </div>
      </a>

      <div class="flex flex-wrap items-center justify-end gap-3">
        <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
          <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
          <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>
          <a id="nav-dashboard" href="./index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
        </nav>

        <div class="flex items-center gap-2">
          <a id="nav-login" href="../login.html" class="hidden rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
          <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex" data-admin-actions>
            <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span> Admin Tools
          </div>
        </div>
      </div>
    </div>
  </header>

  <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>

  <main class="px-6 py-5 lg:px-10">
    <div class="flex flex-col gap-5 lg:flex-row">
      <!-- LEFT NAV -->
      <aside class="hidden w-64 shrink-0 space-y-4 lg:sticky lg:top-6 lg:h-[calc(100svh-96px)] lg:overflow-y-auto lg:block">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Navigation</p>
          <h2 class="text-lg font-black text-white">Admin workspace</h2>
        </div>

        <nav class="flex flex-col gap-2 text-sm font-semibold">
          <a href="./index.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Dashboard <span class="text-xs font-medium text-slate-400">Overview</span>
          </a>
          <a href="./profiles.html" data-admin-only class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Profiles <span class="text-xs font-medium text-slate-400">Access levels</span>
          </a>
          <a href="./services.html" class="flex items-center justify-between gap-2 rounded-xl border border-blue-500 bg-blue-600/90 px-3 py-2 text-white shadow shadow-blue-500/40">
            Services <span class="text-xs font-medium text-blue-100">Technicians</span>
          </a>
          <a href="./vehicles.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Vehicles <span class="text-xs font-medium text-slate-400">Fleet</span>
          </a>
          <a href="./analytics.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Analytics <span class="text-xs font-medium text-slate-400">Insights</span>
          </a>
        </nav>
      </aside>

      <!-- MAIN -->
      <section class="flex min-w-0 flex-1 flex-col gap-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Partner network</p>
            <h2 class="text-2xl font-black text-white">Service roster and coverage</h2>
            <p class="text-sm text-slate-400">Search, filter, sort, reorder, resize columns, and manage your services directory.</p>
          </div>

          <div class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300">
            <i data-lucide="cloud" class="h-4 w-4"></i>
            <span id="dataset-status">Connecting…</span>
          </div>
        </div>

        <!-- STATS -->
        <section class="grid stats-grid gap-3 sm:grid-cols-3">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Total services</p>
            <p id="tech-total" class="text-3xl font-black text-white">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">States covered</p>
            <p id="tech-states" class="text-3xl font-black text-amber-300">-</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
            <p class="text-sm font-semibold text-slate-300">Companies</p>
            <p id="tech-companies" class="text-3xl font-black text-emerald-300">-</p>
          </div>
        </section>

        <!-- DIRECTORY -->
        <section class="directory-shell rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/60">
          <div class="flex flex-col gap-3">

            <div class="flex flex-col gap-2">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Directory</p>
                <h3 class="text-lg font-bold text-white">Service list</h3>
              </div>

              <!-- ANALYTICS -->
              <div class="analytics-wrap" id="analytics-wrap">
                <div class="mini-analytics">
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                    <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                    <h3 class="text-sm font-bold text-white">Top states (filtered)</h3>
                    <div class="mt-3 mini-chart"><canvas id="chart-states"></canvas></div>
                  </div>
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                    <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                    <h3 class="text-sm font-bold text-white">Categories share (filtered)</h3>
                    <div class="mt-3 mini-chart"><canvas id="chart-categories"></canvas></div>
                  </div>
                </div>
              </div>

              <!-- FILTERS / ACTIONS -->
              <div class="flex flex-col gap-2 pt-1">
                <div class="flex flex-wrap gap-2">
                  <select id="company-filter" class="w-40 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                    <option value="all">All companies</option>
                  </select>
                  <select id="state-filter" class="w-36 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                    <option value="all">All states</option>
                  </select>
                  <select id="category-filter" class="w-40 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-100 focus:border-blue-500 focus:outline-none">
                    <option value="all">All categories</option>
                  </select>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                  <input id="search" type="search" placeholder="Search by company, category, address, state, or city"
                    class="w-72 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none" />

                  <div class="relative">
                    <button id="columns-btn" class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white" type="button">
                      <i data-lucide="columns-3" class="h-4 w-4"></i> Columns
                      <i data-lucide="chevron-down" class="h-4 w-4"></i>
                    </button>

                    <div id="columns-popover" class="popover hidden rounded-2xl border border-slate-800 bg-slate-950/95 p-3 shadow-2xl shadow-black">
                      <div class="flex items-center justify-between px-2 pb-2">
                        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Visible columns</p>
                        <div class="flex items-center gap-2">
                          <button id="cols-all" type="button" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">All</button>
                          <button id="cols-none" type="button" class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">None</button>
                        </div>
                      </div>
                      <div id="columns-list" class="max-h-56 overflow-y-auto px-2 pb-2"></div>
                      <p class="px-2 pt-1 text-[11px] text-slate-500">Tip: drag headers to reorder • drag header edge to resize</p>
                    </div>
                  </div>

                  <button id="add-record" class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 shadow shadow-emerald-600/30 transition hover:-translate-y-0.5" data-admin-actions type="button">
                    <i data-lucide="plus" class="h-4 w-4"></i> New record
                  </button>

                  <button id="refresh-button" class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 shadow shadow-blue-600/30 transition hover:-translate-y-0.5" type="button">
                    <i data-lucide="refresh-ccw" class="h-4 w-4"></i> Refresh
                  </button>

                  <div class="ml-auto hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300 md:flex">
                    <i data-lucide="mouse-pointer-2" class="h-4 w-4"></i> <span>Resize • Reorder • Sort</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- PAGINATION (TOP) -->
            <div class="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
              <p id="pagination-summary" class="text-sm text-slate-300">Showing 0-0 of 0</p>
              <div class="flex items-center gap-2">
                <button id="prev-page" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                  <i data-lucide="chevron-left" class="h-4 w-4"></i> Prev
                </button>
                <span id="page-indicator" class="text-sm font-semibold text-slate-100">1 / 1</span>
                <button id="next-page" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                  Next <i data-lucide="chevron-right" class="h-4 w-4"></i>
                </button>
              </div>
            </div>

            <div class="table-window">
              <div class="top-scrollbar-shell">
                <div id="top-scrollbar" class="top-scrollbar">
                  <div id="top-scrollbar-inner" style="height:1px;"></div>
                </div>
              </div>

              <div id="table-scroll" class="w-full border border-slate-800 bg-slate-950/25">
                <table id="services-table" class="fixed-layout divide-y divide-slate-800 compact-text">
                  <colgroup id="colgroup"></colgroup>
                  <thead id="table-head" class="sticky-head bg-slate-950/60 text-slate-300"></thead>
                  <tbody id="table-body" class="divide-y divide-slate-800 bg-slate-950/40"></tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
      </section>
    </div>
  </main>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';

    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';
    const READ_TABLE = 'Services';
    const WRITE_TABLE = 'Services';
    const PAGE_CATEGORY = 'GPS Technician';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Accept both boolean or text-like values
    const toBool = (v) => {
      if (v === true || v === false) return v;
      const s = String(v ?? '').trim().toLowerCase();
      if (['true', '1', 'yes', 'y', 'verified'].includes(s)) return true;
      if (['false', '0', 'no', 'n', 'unverified', 'not verified'].includes(s)) return false;
      return null; // unknown / not set
    };
    const boolToLabel = (v) => (v === true ? 'Verified' : v === false ? 'Not verified' : '—');

    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row[key];
        if (value !== undefined && value !== null && String(value).trim() !== '') return value;
      }
      return '';
    };

    const normalizeRow = (row) => ({
      id: row.id,
      company: getField(row, 'company_name', 'Installation Company', 'Company', 'company', 'name'),
      authorization: getField(row, 'Authorization', 'authorization'),
      category: getField(row, 'category', 'Category'),
      phone: getField(row, 'Phone', 'phone'),
      contact: getField(row, 'contact', 'Contact'),
      address: getField(row, 'address', 'Address'),
      city: getField(row, 'City', 'city'),
      state: getField(row, 'State', 'state', 'state_code'),
      zip: getField(row, 'Zip', 'zip', 'zipcode', 'postal_code'),
      email: getField(row, 'Email', 'email'),
      notes: getField(row, 'Notes', 'notes'),
      website: getField(row, 'website', 'Website'),
      availability: getField(row, 'availability', 'Availability'),
      verified: toBool(getField(row, 'Verified', 'verified', 'is_verified', 'Is Verified')),
      lat: getField(row, 'lat', 'latitude', 'Lat'),
      long: getField(row, 'long', 'lng', 'longitude', 'Lon'),
    });

    const els = {
      status: document.getElementById('dataset-status'),
      total: document.getElementById('tech-total'),
      states: document.getElementById('tech-states'),
      companies: document.getElementById('tech-companies'),
      companyFilter: document.getElementById('company-filter'),
      stateFilter: document.getElementById('state-filter'),
      categoryFilter: document.getElementById('category-filter'),
      search: document.getElementById('search'),
      paginationSummary: document.getElementById('pagination-summary'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageIndicator: document.getElementById('page-indicator'),
      refresh: document.getElementById('refresh-button'),
      addRecord: document.getElementById('add-record'),
      colgroup: document.getElementById('colgroup'),
      thead: document.getElementById('table-head'),
      tbody: document.getElementById('table-body'),
      tableScroll: document.getElementById('table-scroll'),
      topScrollbar: document.getElementById('top-scrollbar'),
      topScrollbarInner: document.getElementById('top-scrollbar-inner'),
      columnsBtn: document.getElementById('columns-btn'),
      columnsPopover: document.getElementById('columns-popover'),
      columnsList: document.getElementById('columns-list'),
      colsAll: document.getElementById('cols-all'),
      colsNone: document.getElementById('cols-none'),
      modal: document.getElementById('edit-modal'),
      closeModal: document.getElementById('close-modal'),
      cancelEdit: document.getElementById('cancel-edit'),
      editForm: document.getElementById('edit-form'),
      analyticsWrap: document.getElementById('analytics-wrap'),
      editVerified: document.getElementById('edit-verified'),
    };

    // ✅ Added "verified" column definition
    const ALL_COLUMNS = [
      { id: 'company', label: 'Company Name', key: 'company', defaultWidth: 220 },
      { id: 'authorization', label: 'Authorization', key: 'authorization', defaultWidth: 160 },
      { id: 'category', label: 'Category', key: 'category', defaultWidth: 170 },
      { id: 'verified', label: 'Verified', key: 'verified', defaultWidth: 120 },  // ✅ NEW
      { id: 'phone', label: 'Phone', key: 'phone', defaultWidth: 150 },
      { id: 'contact', label: 'Contact', key: 'contact', defaultWidth: 160 },
      { id: 'address', label: 'Address', key: 'address', defaultWidth: 260 },
      { id: 'city', label: 'City', key: 'city', defaultWidth: 140 },
      { id: 'state', label: 'State', key: 'state', defaultWidth: 100 },
      { id: 'zip', label: 'Zip', key: 'zip', defaultWidth: 100 },
      { id: 'email', label: 'Email', key: 'email', defaultWidth: 240 },
      { id: 'notes', label: 'Notes', key: 'notes', defaultWidth: 260 },
      { id: 'website', label: 'Website', key: 'website', defaultWidth: 220 },
      { id: 'availability', label: 'Availability', key: 'availability', defaultWidth: 180 },
      { id: 'lat', label: 'Lat', key: 'lat', defaultWidth: 120 },
      { id: 'long', label: 'Long', key: 'long', defaultWidth: 120 },
    ];

    const state = {
      rows: [],
      currentUserRole: 'user',
      currentUserId: 'anon',
      filters: { search: '', company: 'all', state: 'all', category: 'all' },
      sort: { key: '', dir: 'asc' },
      pagination: { page: 1, pageSize: 20 },
      columnOrder: ['actions', ...ALL_COLUMNS.map(c => c.id)],
      columnVisibility: Object.fromEntries([['actions', true], ...ALL_COLUMNS.map(c => [c.id, true])]),
      columnWidths: Object.fromEntries([['actions', 110], ...ALL_COLUMNS.map(c => [c.id, c.defaultWidth])]),
      drag: { resizing: null, draggingCol: null },
    };

    // ================== PERSISTENCE (per profile) ==================
    const STORAGE_PREFIX = 'techloc_services_table_prefs_v1';
    const storageKey = () => `${STORAGE_PREFIX}:${state.currentUserId}`;
    const safeParse = (raw) => { try { return JSON.parse(raw); } catch { return null; } };

    const savePrefs = () => {
      localStorage.setItem(storageKey(), JSON.stringify({
        columnOrder: state.columnOrder,
        columnVisibility: state.columnVisibility,
        columnWidths: state.columnWidths
      }));
    };

    const loadPrefs = () => {
      const prefs = safeParse(localStorage.getItem(storageKey()) || '');
      if (!prefs) return;

      const validCols = new Set(['actions', ...ALL_COLUMNS.map(c => c.id)]);

      if (Array.isArray(prefs.columnOrder)) {
        const cleaned = prefs.columnOrder.filter(c => validCols.has(c));
        const missing = [...validCols].filter(c => !cleaned.includes(c));
        state.columnOrder = [...cleaned, ...missing];
      }

      if (prefs.columnVisibility && typeof prefs.columnVisibility === 'object') {
        const next = { ...state.columnVisibility };
        for (const [k, v] of Object.entries(prefs.columnVisibility)) {
          if (validCols.has(k)) next[k] = !!v;
        }
        next.actions = true;
        state.columnVisibility = next;
      }

      if (prefs.columnWidths && typeof prefs.columnWidths === 'object') {
        const next = { ...state.columnWidths };
        for (const [k, v] of Object.entries(prefs.columnWidths)) {
          if (validCols.has(k) && Number.isFinite(+v)) next[k] = +v;
        }
        state.columnWidths = next;
      }
    };

    // ---------------- AUTH ----------------
    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();

      if (data?.session) {
        state.currentUserId = data.session.user.id;
        if (window.currentUserRole) {
          state.currentUserRole = window.currentUserRole;
        } else {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', data.session.user.id)
            .single();
          state.currentUserRole = profile?.role || 'user';
        }
      } else {
        state.currentUserRole = 'anon';
        state.currentUserId = 'anon';
      }

      loadPrefs();

      const isAdmin = state.currentUserRole === 'administrator';
      if (els.addRecord) {
        els.addRecord.classList.toggle('hidden', !isAdmin);
        els.addRecord.disabled = !isAdmin;
      }
    };

    supabaseClient.auth.onAuthStateChange((_event, session) => {
      const nextUserId = session?.user?.id || 'anon';
      if (nextUserId === state.currentUserId) return;
      state.currentUserId = nextUserId;
      loadPrefs();
      renderTable();
    });

    // ---------------- HELPERS ----------------
    const getText = (value) => String(value ?? '').toLowerCase().trim();

    const updateStats = () => {
      const total = state.rows.length;
      const statesCount = new Set(state.rows.map(r => (r.state || '').trim()).filter(Boolean)).size;
      const companiesCount = new Set(state.rows.map(r => (r.company || '').trim()).filter(Boolean)).size;
      els.total.textContent = total;
      els.states.textContent = statesCount;
      els.companies.textContent = companiesCount;
      els.status.textContent = total ? `Connected • ${total} records` : 'Awaiting data';
    };

    const populateSelect = (element, values, label) => {
      const options = Array.from(new Set(values.filter(Boolean).map(v => getText(v)))).sort();
      const current = element.value;
      element.innerHTML = `<option value="all">${label}</option>`;
      options.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value.toUpperCase();
        if (value === current) option.selected = true;
        element.appendChild(option);
      });
    };

    const applySearch = (rows, term) => {
      if (!term) return rows;
      const q = term.toLowerCase();
      return rows.filter((row) =>
        [
          row.company, row.authorization, row.category,
          boolToLabel(row.verified), // ✅ searchable
          row.phone, row.contact, row.address, row.city, row.state, row.zip,
          row.email, row.notes, row.website, row.availability
        ].some((v) => String(v || '').toLowerCase().includes(q))
      );
    };

    const applyFilters = () => {
      const f = state.filters;
      let result = applySearch([...state.rows], f.search);
      if (f.company !== 'all') result = result.filter(r => getText(r.company) === f.company);
      if (f.state !== 'all') result = result.filter(r => getText(r.state) === f.state);
      if (f.category !== 'all') result = result.filter(r => getText(r.category) === f.category);
      return result;
    };

    const applySort = (rows) => {
      const { key, dir } = state.sort;
      if (!key) return rows;
      const col = ALL_COLUMNS.find(c => c.id === key);
      if (!col) return rows;

      const sorted = [...rows].sort((a, b) => {
        let av = a[col.key];
        let bv = b[col.key];

        // ✅ stable sort for booleans
        if (col.id === 'verified') {
          const as = a.verified === true ? '1' : a.verified === false ? '0' : '';
          const bs = b.verified === true ? '1' : b.verified === false ? '0' : '';
          return as.localeCompare(bs, undefined, { numeric: true, sensitivity: 'base' });
        }

        return getText(av).localeCompare(getText(bv), undefined, { numeric: true, sensitivity: 'base' });
      });

      return dir === 'asc' ? sorted : sorted.reverse();
    };

    const getVisibleOrderedColumns = () => state.columnOrder.filter(colId => state.columnVisibility[colId]);

    // ---------------- TABLE RENDER ----------------
    const renderColgroup = () => {
      const cols = getVisibleOrderedColumns();
      els.colgroup.innerHTML = '';
      cols.forEach((colId) => {
        const colEl = document.createElement('col');
        colEl.setAttribute('data-col', colId);
        colEl.style.width = `${state.columnWidths[colId] || 140}px`;
        els.colgroup.appendChild(colEl);
      });
    };

    const setColWidth = (colId, px) => {
      const min = 72;
      const max = 800;
      state.columnWidths[colId] = Math.max(min, Math.min(max, px));
      const colEl = els.colgroup.querySelector(`col[data-col="${colId}"]`);
      if (colEl) colEl.style.width = `${state.columnWidths[colId]}px`;
      const th = els.thead.querySelector(`th[data-col="${colId}"]`);
      if (th) {
        th.style.width = `${state.columnWidths[colId]}px`;
        th.style.minWidth = `${state.columnWidths[colId]}px`;
      }
      syncTopScrollbar();
      savePrefs();
      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    const sortIcon = (colId) => {
      if (state.sort.key !== colId) return 'arrow-up-down';
      return state.sort.dir === 'asc' ? 'arrow-up' : 'arrow-down';
    };

    const toggleSort = (colId) => {
      if (state.sort.key === colId) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
      else { state.sort.key = colId; state.sort.dir = 'asc'; }
      state.pagination.page = 1;
      renderTable();
    };

    const buildHeaderCell = (colId) => {
      const th = document.createElement('th');
      th.className = 'text-left font-semibold text-slate-200 resizable bg-slate-950/60 compact-th';
      th.setAttribute('data-col', colId);

      const startingWidth = state.columnWidths[colId] || 140;
      th.style.width = `${startingWidth}px`;
      th.style.minWidth = `${startingWidth}px`;

      if (colId === 'actions') {
        th.className = 'text-left font-semibold text-blue-300 resizable bg-slate-950/60 compact-th';
        th.style.width = `${state.columnWidths[colId] || 110}px`;
        th.style.minWidth = `${state.columnWidths[colId] || 110}px`;
        th.innerHTML = `
          <div class="th-inner">
            <span class="text-blue-300">Actions</span>
            <span class="opacity-60 text-[11px] uppercase tracking-wide">—</span>
          </div>
          <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
        `;
        return th;
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      const label = col?.label || colId;

      th.setAttribute('draggable', 'true');
      th.innerHTML = `
        <div class="th-inner">
          <div class="flex items-center gap-2 min-w-0">
            <span class="truncate">${label}</span>
          </div>
          <button type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-950/50 px-2 py-1 text-[11px] font-semibold text-slate-200 hover:border-blue-500 hover:text-white"
            data-sort-col="${colId}" title="Sort">
            <i data-lucide="${sortIcon(colId)}" class="h-3.5 w-3.5"></i>
          </button>
        </div>
        <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
      `;
      return th;
    };

    const renderHeader = () => {
      const cols = getVisibleOrderedColumns();
      const tr = document.createElement('tr');
      cols.forEach((colId) => tr.appendChild(buildHeaderCell(colId)));
      els.thead.innerHTML = '';
      els.thead.appendChild(tr);

      els.thead.querySelectorAll('th[draggable="true"]').forEach((th) => {
        th.addEventListener('dragstart', (e) => {
          const colId = th.dataset.col;
          state.drag.draggingCol = colId;
          th.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', colId);
        });

        th.addEventListener('dragend', () => {
          th.classList.remove('dragging');
          state.drag.draggingCol = null;
          els.thead.querySelectorAll('th').forEach(x => x.classList.remove('drop-target'));
        });

        th.addEventListener('dragover', (e) => {
          e.preventDefault();
          const targetCol = th.dataset.col;
          if (!state.drag.draggingCol || state.drag.draggingCol === targetCol) return;
          th.classList.add('drop-target');
        });

        th.addEventListener('dragleave', () => th.classList.remove('drop-target'));

        th.addEventListener('drop', (e) => {
          e.preventDefault();
          const from = state.drag.draggingCol;
          const to = th.dataset.col;
          if (!from || !to || from === to) return;
          const order = [...state.columnOrder];
          const fromIdx = order.indexOf(from);
          const toIdx = order.indexOf(to);
          if (fromIdx === -1 || toIdx === -1) return;
          order.splice(fromIdx, 1);
          order.splice(toIdx, 0, from);
          state.columnOrder = order;
          savePrefs();
          renderTable();
        });
      });

      els.thead.querySelectorAll('[data-sort-col]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSort(btn.getAttribute('data-sort-col'));
        });
      });

      lucide.createIcons();
    };

    const renderBody = (pageRows) => {
      const cols = getVisibleOrderedColumns();
      const canEdit = state.currentUserRole === 'administrator';
      const canDelete = state.currentUserRole === 'administrator';
      els.tbody.innerHTML = '';

      pageRows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.className = 'transition hover:bg-slate-800/40';

        cols.forEach((colId) => {
          const td = document.createElement('td');
          td.className = 'align-top text-slate-200 compact-td';

          if (colId === 'actions') {
            td.className = 'text-center align-top compact-td';

            if (canEdit) {
              const editBtn = document.createElement('button');
              editBtn.type = 'button';
              editBtn.className = 'mr-2 text-blue-400 transition hover:text-blue-300 hover:scale-110';
              editBtn.innerHTML = '<i data-lucide="pencil" class="h-4 w-4"></i>';
              editBtn.onclick = () => openEditModal(row);
              td.appendChild(editBtn);

              if (canDelete) {
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'text-red-400 transition hover:text-red-300 hover:scale-110';
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="h-4 w-4"></i>';
                deleteBtn.onclick = () => deleteRow(row);
                td.appendChild(deleteBtn);
              }
            } else {
              td.innerHTML = '<span class="text-slate-600 text-xs">Read Only</span>';
            }

            tr.appendChild(td);
            return;
          }

          const col = ALL_COLUMNS.find(c => c.id === colId);

          let value = col ? row[col.key] : '';
          if (colId === 'verified') value = boolToLabel(row.verified); // ✅ pretty value

          if (colId === 'company') td.className = 'font-semibold text-white align-top compact-td';
          td.textContent = value || '—';

          tr.appendChild(td);
        });

        els.tbody.appendChild(tr);
      });

      lucide.createIcons();
    };

    const renderPagination = (rows) => {
      const totalPages = Math.max(1, Math.ceil(rows.length / state.pagination.pageSize));
      if (state.pagination.page > totalPages) state.pagination.page = totalPages;

      const start = (state.pagination.page - 1) * state.pagination.pageSize;
      const end = Math.min(rows.length, start + state.pagination.pageSize);

      els.paginationSummary.textContent = rows.length
        ? `Showing ${start + 1}-${end} of ${rows.length}`
        : 'No entries to display';

      els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;
      els.prevPage.disabled = state.pagination.page === 1 || rows.length === 0;
      els.nextPage.disabled = state.pagination.page >= totalPages || rows.length === 0;

      return { start, end };
    };

    const syncTopScrollbar = () => {
      els.topScrollbarInner.style.width = els.tableScroll.scrollWidth + 'px';
      els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
    };

    const renderTable = () => {
      const filtered = applyFilters();
      const sorted = applySort(filtered);
      const { start, end } = renderPagination(sorted);
      renderColgroup();
      renderHeader();
      renderBody(sorted.slice(start, end));
      renderColumnsPopover();
      syncTopScrollbar();
      renderCharts(sorted);
      lucide.createIcons();
    };

    // ---------------- RESIZE ----------------
    const onMouseMoveResize = (e) => {
      if (!state.drag.resizing) return;
      const { colId, startX, startW } = state.drag.resizing;
      const dx = e.clientX - startX;
      setColWidth(colId, startW + dx);
    };

    const stopResize = () => {
      if (!state.drag.resizing) return;
      state.drag.resizing = null;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', onMouseMoveResize);
      document.removeEventListener('mouseup', stopResize);
    };

    const attachResizeHandles = () => {
      els.thead.addEventListener('mousedown', (e) => {
        const handle = e.target.closest('[data-resize]');
        if (!handle) return;
        e.preventDefault();
        e.stopPropagation();

        const colId = handle.getAttribute('data-resize');
        const th = handle.closest('th');
        const thWidth = th ? parseFloat(getComputedStyle(th).width) : 0;
        const startWidth = Number.isFinite(state.columnWidths[colId]) ? state.columnWidths[colId] : (thWidth || 140);

        state.drag.resizing = { colId, startX: e.clientX, startW: startWidth };
        document.body.style.cursor = 'col-resize';
        document.addEventListener('mousemove', onMouseMoveResize);
        document.addEventListener('mouseup', stopResize);
      });
    };

    // ---------------- COLUMN PICKER ----------------
    const renderColumnsPopover = () => {
      els.columnsList.innerHTML = '';

      const makeRow = (colId, label, locked = false) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = `
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">${locked ? 'Locked' : 'Show'}</span>
          <span class="truncate font-semibold">${label}</span>
        `;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !!state.columnVisibility[colId];
        input.disabled = locked;
        input.className = 'h-4 w-4 accent-blue-600';
        input.addEventListener('change', () => {
          state.columnVisibility[colId] = input.checked;
          state.columnVisibility.actions = true;
          savePrefs();
          renderTable();
        });

        wrapper.appendChild(left);
        wrapper.appendChild(input);
        return wrapper;
      };

      els.columnsList.appendChild(makeRow('actions', 'Actions', true));
      ALL_COLUMNS.forEach((c) => els.columnsList.appendChild(makeRow(c.id, c.label)));

      lucide.createIcons();
    };

    const toggleColumnsPopover = (force) => {
      const willShow = typeof force === 'boolean' ? force : els.columnsPopover.classList.contains('hidden');
      els.columnsPopover.classList.toggle('hidden', !willShow);
      if (willShow) renderColumnsPopover();
    };

    document.addEventListener('click', (e) => {
      const inside = e.target.closest('#columns-popover') || e.target.closest('#columns-btn');
      if (!inside) toggleColumnsPopover(false);
    });

    els.columnsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleColumnsPopover();
    });

    els.colsAll.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = true);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    els.colsNone.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = false);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    // ---------------- TOP SCROLLBAR SYNC ----------------
    const attachScrollSync = () => {
      let syncing = false;

      els.tableScroll.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
        syncing = false;
      });

      els.topScrollbar.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.tableScroll.scrollLeft = els.topScrollbar.scrollLeft;
        syncing = false;
      });

      window.addEventListener('resize', () => {
        syncTopScrollbar();
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    // ---------------- CHARTS ----------------
    let chartStates = null;
    let chartCategories = null;

    const buildCounts = (rows, key) => {
      const m = new Map();
      rows.forEach((r) => {
        const k = (r[key] || '—').toString().trim() || '—';
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    };

    const makeChartOptions = () => ({
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } },
        tooltip: {
          backgroundColor: 'rgba(2,6,23,.95)',
          borderColor: 'rgba(51,65,85,.8)',
          borderWidth: 1,
          titleColor: 'rgba(226,232,240,.95)',
          bodyColor: 'rgba(226,232,240,.85)',
        }
      },
      scales: {
        x: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } },
        y: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } }
      }
    });

    const renderCharts = (filteredRows) => {
      const topStates = buildCounts(filteredRows, 'state').slice(0, 10);
      const topCats = buildCounts(filteredRows, 'category').slice(0, 8);

      const stateRawLabels = topStates.map(([k]) => (k === '—' ? '—' : k));
      const stateLabels = topStates.map(([k]) => (k === '—' ? 'Unknown' : k.toUpperCase()));
      const stateValues = topStates.map(([, v]) => v);

      const catRawLabels = topCats.map(([k]) => (k === '—' ? '—' : k));
      const catLabels = topCats.map(([k]) => (k === '—' ? 'Unknown' : k));
      const catValues = topCats.map(([, v]) => v);

      const palette = [
        'rgba(59,130,246,.55)', 'rgba(99,102,241,.55)', 'rgba(16,185,129,.55)',
        'rgba(245,158,11,.55)', 'rgba(236,72,153,.55)', 'rgba(148,163,184,.45)',
        'rgba(34,197,94,.45)', 'rgba(14,165,233,.45)',
      ];

      const ctxStates = document.getElementById('chart-states');
      const ctxCats = document.getElementById('chart-categories');
      if (!ctxStates || !ctxCats) return;

      if (chartStates) chartStates.destroy();
      if (chartCategories) chartCategories.destroy();

      chartStates = new Chart(ctxStates, {
        type: 'bar',
        data: { labels: stateLabels, datasets: [{ label: 'Services', data: stateValues, backgroundColor: palette[0], borderColor: 'rgba(59,130,246,.85)', borderWidth: 1, borderRadius: 10 }] },
        options: {
          ...makeChartOptions(),
          scales: { ...makeChartOptions().scales, x: { ...makeChartOptions().scales.x, ticks: { ...makeChartOptions().scales.x.ticks, maxRotation: 0 } } },
          onClick: (_, elements) => {
            if (!elements.length) return;
            const index = elements[0].index;
            const selected = stateRawLabels[index] ?? 'all';
            // (optional click-to-filter kept as before)
            // setFilterFromChart('state', selected);
          }
        }
      });

      chartCategories = new Chart(ctxCats, {
        type: 'doughnut',
        data: { labels: catLabels, datasets: [{ label: 'Services', data: catValues, backgroundColor: catValues.map((_, i) => palette[i % palette.length]), borderColor: 'rgba(15,23,42,.9)', borderWidth: 2, hoverOffset: 6 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          animation: false,
          plugins: { legend: { position: 'right', labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } }, tooltip: makeChartOptions().plugins.tooltip },
          onClick: (_, elements) => {
            if (!elements.length) return;
            const index = elements[0].index;
            const selected = catRawLabels[index] ?? 'all';
            // setFilterFromChart('category', selected);
          }
        }
      });

      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
        syncTopScrollbar();
      });
    };

    const attachAnalyticsResizeObserver = () => {
      if (!('ResizeObserver' in window)) return;
      const ro = new ResizeObserver(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
      ro.observe(els.analyticsWrap);
    };

    // ---------------- DATA FETCH ----------------
    const refresh = async () => {
      els.status.textContent = 'Loading from Supabase…';
      const { data, error } = await supabaseClient.from(READ_TABLE).select('*');
      if (error) {
        console.error('Error fetching services:', error);
        els.status.textContent = 'Error loading data';
        return;
      }

      state.rows = (data || []).map(normalizeRow);

      updateStats();
      populateSelect(els.companyFilter, state.rows.map(r => r.company), 'All companies');
      populateSelect(els.stateFilter, state.rows.map(r => r.state), 'All states');
      populateSelect(els.categoryFilter, state.rows.map(r => r.category), 'All categories');

      state.pagination.page = 1;
      renderTable();
    };

    // ---------------- MODAL FUNCTIONS ----------------
    function setFormValues(row = {}) {
      document.getElementById('edit-id').value = row.id || '';
      document.getElementById('edit-company').value = row.company || '';
      document.getElementById('edit-authorization').value = row.authorization || '';
      document.getElementById('edit-category').value = row.category || PAGE_CATEGORY;
      document.getElementById('edit-phone').value = row.phone || '';
      document.getElementById('edit-contact').value = row.contact || '';
      document.getElementById('edit-email').value = row.email || '';
      document.getElementById('edit-address').value = row.address || '';
      document.getElementById('edit-city').value = row.city || '';
      document.getElementById('edit-state').value = row.state || '';
      document.getElementById('edit-zip').value = row.zip || '';
      document.getElementById('edit-website').value = row.website || '';
      document.getElementById('edit-availability').value = row.availability || '';
      document.getElementById('edit-lat').value = row.lat || '';
      document.getElementById('edit-long').value = row.long || '';
      document.getElementById('edit-notes').value = row.notes || '';

      // ✅ Verified select
      const vb = toBool(row.verified);
      els.editVerified.value = vb === true ? 'true' : vb === false ? 'false' : '';
    }

    function openEditModal(row) {
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can edit services.'); return; }
      document.getElementById('modal-title').textContent = 'Edit Service';
      setFormValues(row);
      els.modal.classList.remove('hidden');
      els.modal.classList.add('flex');
    }

    function openCreateModal() {
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can add services.'); return; }
      document.getElementById('modal-title').textContent = 'Add new record';
      setFormValues({ category: PAGE_CATEGORY, verified: null });
      els.modal.classList.remove('hidden');
      els.modal.classList.add('flex');
    }

    function closeEditModal() {
      els.modal.classList.add('hidden');
      els.modal.classList.remove('flex');
    }

    els.closeModal.addEventListener('click', closeEditModal);
    els.cancelEdit.addEventListener('click', closeEditModal);

    async function deleteRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can delete records.'); return; }
      const confirmed = confirm(`Delete "${row.company}"?`);
      if (!confirmed) return;
      const { error } = await supabaseClient.from(WRITE_TABLE).delete().eq('id', row.id);
      if (error) alert('Error deleting: ' + error.message);
      else refresh();
    }

    // ✅ Robust save
    const withTimeout = (promise, ms = 20000) => {
      let t;
      const timeout = new Promise((_, reject) => {
        t = setTimeout(() => reject(new Error(`Request timed out after ${ms / 1000}s`)), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    };

    els.editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (state.currentUserRole !== 'administrator') { alert('Only administrators can save changes.'); return; }

      const btn = els.editForm.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      if (btn.dataset.busy === '1') return;
      btn.dataset.busy = '1';
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const id = document.getElementById('edit-id').value;

        // ✅ Verified -> boolean/null
        const verifiedValue = els.editVerified.value === 'true' ? true : els.editVerified.value === 'false' ? false : null;

        const payload = {
          company_name: document.getElementById('edit-company').value,
          authorization: document.getElementById('edit-authorization').value,
          category: document.getElementById('edit-category').value || PAGE_CATEGORY,
          phone: document.getElementById('edit-phone').value,
          contact: document.getElementById('edit-contact').value,
          email: document.getElementById('edit-email').value,
          address: document.getElementById('edit-address').value,
          city: document.getElementById('edit-city').value,
          state: document.getElementById('edit-state').value,
          zip: document.getElementById('edit-zip').value,
          notes: document.getElementById('edit-notes').value,
          website: document.getElementById('edit-website').value,
          availability: document.getElementById('edit-availability').value,
          verified: verifiedValue, // ✅ NEW: requires a "verified" boolean column in Supabase
          lat: document.getElementById('edit-lat').value,
          long: document.getElementById('edit-long').value,
        };

        let res;
        if (id) res = await withTimeout(supabaseClient.from(WRITE_TABLE).update(payload).eq('id', id), 20000);
        else res = await withTimeout(supabaseClient.from(WRITE_TABLE).insert([payload]), 20000);

        const { error } = res || {};
        if (error) {
          console.error('Save failed:', error);
          alert('Error saving: ' + (error.message || JSON.stringify(error)));
          return;
        }

        closeEditModal();
        await refresh();
      } catch (err) {
        console.error('Unexpected save crash:', err);
        alert('Unexpected error: ' + (err?.message || err));
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
        btn.dataset.busy = '0';
      }
    });

    // ---------------- EVENTS ----------------
    els.companyFilter.addEventListener('change', (e) => { state.filters.company = e.target.value; state.pagination.page = 1; renderTable(); });
    els.stateFilter.addEventListener('change', (e) => { state.filters.state = e.target.value; state.pagination.page = 1; renderTable(); });
    els.categoryFilter.addEventListener('change', (e) => { state.filters.category = e.target.value; state.pagination.page = 1; renderTable(); });
    els.search.addEventListener('input', (e) => { state.filters.search = e.target.value; state.pagination.page = 1; renderTable(); });
    els.prevPage.addEventListener('click', () => { if (state.pagination.page > 1) { state.pagination.page -= 1; renderTable(); } });
    els.nextPage.addEventListener('click', () => {
      const total = applySort(applyFilters()).length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.pageSize));
      if (state.pagination.page < totalPages) { state.pagination.page += 1; renderTable(); }
    });

    els.refresh.addEventListener('click', refresh);
    els.addRecord?.addEventListener('click', openCreateModal);

    // ---------------- INIT ----------------
    const init = async () => {
      createConstellationBackground();
      await requireSession();
      attachResizeHandles();
      attachScrollSync();
      attachAnalyticsResizeObserver();
      await refresh();
      renderColumnsPopover();
      syncTopScrollbar();
      lucide.createIcons();
    };
    init();
  </script>
</body>
</html>
