<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module" src="../assets/scripts/supabaseClient.js"></script>
  <script type="module" src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="../assets/visuals/theme.css" />
</head>
<body class="min-h-screen bg-slate-950 text-slate-50">
  <div data-auth-loading class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
    <div class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900 px-5 py-3 shadow-xl shadow-slate-900/60">
      <span class="h-3 w-3 animate-pulse rounded-full bg-blue-400"></span>
      <p class="text-sm font-semibold text-slate-200">Validating secure session…</p>
    </div>
  </div>

  <div data-auth-protected class="hidden">
<div class="sticky top-0 z-50 space-y-px">
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
    <div class="flex items-center justify-between px-6 py-4 lg:px-10">
      <a href="../index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>
          <h1 class="text-base font-black leading-tight text-white">Secure Operations</h1>
        </div>
      </a>

      <div class="flex flex-wrap items-center justify-end gap-3">
        <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
          <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
          <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>
          <a id="nav-dashboard" href="./index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>
        </nav>
        <div class="flex items-center gap-2">
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <nav class="border-b border-slate-800 bg-slate-900/70 backdrop-blur">
      <div class="mx-auto flex max-w-7xl flex-wrap items-center gap-2 px-6 py-3 lg:px-10">
        <span class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Admin navigation</span>
        <div class="flex flex-wrap items-center gap-1">
          <a href="./index.html" class="rounded-lg border border-blue-500 bg-blue-600/90 px-4 py-2 text-xs font-semibold text-white shadow shadow-blue-500/30 transition">Dashboard</a>
          <a href="./profiles.html" data-admin-only class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Profiles</a>
          <a href="./services.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Services</a>
          <a href="./titles.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Titles</a>
          <a href="./vehicles.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Vehicles</a>
          <a href="./analytics.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Analytics</a>
        </div>
      </div>
  </nav>
</div>

    <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>

    <main class="mx-auto w-full max-w-7xl px-6 py-8 lg:px-10 space-y-8">
        <section class="space-y-6 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-xl shadow-blue-900/30">
          <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
            <div class="space-y-3">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Dashboard</p>
              <h1 class="text-3xl font-black text-white">Command center for field operations</h1>
              <p class="text-sm leading-relaxed text-slate-300">Monitor providers, fleet assets, and live data from a compact console. Quickly access key modules or review table health before loading new sources.</p>
              <div class="flex flex-wrap gap-2">
                <a href="./services.html" class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 transition hover:-translate-y-0.5 hover:border-emerald-400">
                  <i data-lucide="wrench" class="h-4 w-4"></i>
                  Open services
                </a>
                <a href="./vehicles.html" class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:-translate-y-0.5 hover:border-blue-400">
                  <i data-lucide="car" class="h-4 w-4"></i>
                  View vehicles
                </a>
                <a href="./analytics.html" class="inline-flex items-center gap-2 rounded-full border border-amber-600 bg-amber-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-amber-100 transition hover:-translate-y-0.5 hover:border-amber-400">
                  <i data-lucide="activity" class="h-4 w-4"></i>
                  Analytics panel
                </a>
              </div>
            </div>
            <div class="grid w-full max-w-md grid-cols-3 gap-3 rounded-2xl border border-blue-900/60 bg-blue-950/40 p-4 shadow-inner shadow-blue-900/40">
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p id="dataset-count" class="text-2xl font-black text-white">-</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Tables</p>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p id="records-count" class="text-2xl font-black text-amber-300">-</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Live rows</p>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                  <p id="uploaded-count" class="text-2xl font-black text-emerald-300">Active</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Status</p>
              </div>
            </div>
          </div>

          <div class="grid gap-4 lg:grid-cols-[2fr_1fr]">
            <div class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Progress</p>
                  <h3 class="text-lg font-bold text-white">Operational tracking</h3>
                </div>
                <span class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">Live data</span>
              </div>
              <div class="grid gap-3 md:grid-cols-3">
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Active providers</p>
                  <p class="text-xs text-slate-400">Synced directly from Supabase Services.</p>
                </div>
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Monitored fleet</p>
                  <p class="text-xs text-slate-400">Real-time metrics for vehicles.</p>
                </div>
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Data integrity</p>
                  <p class="text-xs text-slate-400">Analytics connected to tables and RPCs.</p>
                </div>
              </div>
            </div>
            <div class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
                <div class="flex items-center justify-between">
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Activity</p>
                <div class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-wide text-slate-500">
                  <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span>
                  Live
                </div>
              </div>
              <ul id="activity-log" class="space-y-2" aria-live="polite">
                <li class="text-slate-500 italic text-xs">Scanning tables...</li>
              </ul>
            </div>
          </div>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Data room</p>
              <h3 class="text-xl font-bold text-white">Supabase live tables</h3>
              <p class="text-sm text-slate-400">Updated statistics for every connected dataset.</p>
            </div>
            <div class="text-sm font-semibold text-slate-300">Real-time database statistics</div>
          </div>
          <div id="datasets" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
        </section>

        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-2">
            
            <section class="flex flex-col space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200">Secure upload</p>
                  <h3 class="text-lg font-bold text-white">Import Vehicles CSV</h3>
                  <p class="text-sm text-slate-400">Upsert into vehicles table using ShortVIN.</p>
                </div>
                <span class="shrink-0 rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">ShortVIN</span>
              </div>
              
              <div class="mt-auto space-y-4">
                <form id="csv-upload-form" class="grid gap-3">
                    <div class="space-y-2">
                    <label for="csv-file" class="text-xs font-semibold uppercase tracking-wide text-slate-400">CSV file</label>
                    <input id="csv-file" name="csv-file" type="file" accept=".csv" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 file:mr-3 file:rounded-md file:border-0 file:bg-blue-600 file:px-3 file:py-2 file:text-xs file:font-semibold file:uppercase file:tracking-wide file:text-white hover:border-blue-500 focus:outline-none" />
                    </div>
                    <button id="upload-button" type="button" class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-60">
                    <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                    <span>Upload &amp; upsert</span>
                    </button>
                </form>
                <p class="text-xs leading-relaxed text-slate-400">Required: ShortVIN. Updates Status, Loc, GPS, etc.</p>
              </div>
            </section>

            <section class="flex flex-col space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200">Secure upload</p>
                  <h3 class="text-lg font-bold text-white">Import Deals CSV</h3>
                  <p class="text-sm text-slate-400">Upsert into DealsJP1 (Finance Only).</p>
                </div>
                <span class="shrink-0 rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">Filter: Finance</span>
              </div>

              <div class="mt-auto space-y-4">
                <form id="deals-upload-form" class="grid gap-3">
                    <div class="space-y-2">
                    <label for="deals-file" class="text-xs font-semibold uppercase tracking-wide text-slate-400">CSV file</label>
                    <input id="deals-file" name="deals-file" type="file" accept=".csv" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 file:mr-3 file:rounded-md file:border-0 file:bg-emerald-600 file:px-3 file:py-2 file:text-xs file:font-semibold file:uppercase file:tracking-wide file:text-white hover:border-emerald-500 focus:outline-none" />
                    </div>
                    <button id="deals-upload-button" type="button" class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-500 disabled:cursor-not-allowed disabled:opacity-60">
                    <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                    <span>Upload &amp; upsert</span>
                    </button>
                </form>
                <div id="deals-progress" class="hidden space-y-2">
                  <div class="flex items-center justify-between text-[11px] font-semibold text-slate-300">
                    <span id="deals-progress-label">Initializing…</span>
                    <span id="deals-progress-count">0%</span>
                  </div>
                  <div class="h-2 rounded-full bg-slate-800 overflow-hidden">
                    <div id="deals-progress-bar" class="h-2 w-0 bg-emerald-500 transition-all duration-200"></div>
                  </div>
                </div>
                <p class="text-xs leading-relaxed text-slate-400">Requires: VIN, Current Stock No. & Sales Channel containing 'Finance'.</p>
              </div>
            </section>

            <section class="flex flex-col space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200">Secure upload</p>
                  <h3 class="text-lg font-bold text-white">Import NS Invoices &amp; Payments CSV</h3>
                  <p class="text-sm text-slate-400">Upsert into NS-Invoices&amp;pays (Document Number key).</p>
                </div>
                <span class="shrink-0 rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">Document #</span>
              </div>

              <div class="mt-auto space-y-4">
                <form id="ns-invoices-upload-form" class="grid gap-3">
                  <div class="space-y-2">
                    <label for="ns-invoices-file" class="text-xs font-semibold uppercase tracking-wide text-slate-400">CSV file</label>
                    <input id="ns-invoices-file" name="ns-invoices-file" type="file" accept=".csv" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 file:mr-3 file:rounded-md file:border-0 file:bg-amber-600 file:px-3 file:py-2 file:text-xs file:font-semibold file:uppercase file:tracking-wide file:text-white hover:border-amber-500 focus:outline-none" />
                  </div>
                  <button id="ns-invoices-upload-button" type="button" class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-amber-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-amber-500/20 transition hover:bg-amber-500 disabled:cursor-not-allowed disabled:opacity-60">
                    <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                    <span>Upload &amp; upsert</span>
                  </button>
                </form>
                <div id="ns-invoices-progress" class="hidden space-y-2">
                  <div class="flex items-center justify-between text-[11px] font-semibold text-slate-300">
                    <span id="ns-invoices-progress-label">Initializing…</span>
                    <span id="ns-invoices-progress-count">0%</span>
                  </div>
                  <div class="h-2 rounded-full bg-slate-800 overflow-hidden">
                    <div id="ns-invoices-progress-bar" class="h-2 w-0 bg-amber-500 transition-all duration-200"></div>
                  </div>
                </div>
                <p class="text-xs leading-relaxed text-slate-400">Requires: Document Number column. Amount fields are normalized to numbers when possible.</p>
              </div>
            </section>

            <section class="flex flex-col space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200">Secure upload</p>
                  <h3 class="text-lg font-bold text-white">Import PT Last Ping</h3>
                  <p class="text-sm text-slate-400">Upsert into PT-LastPing when VIN exists in Deals.</p>
                </div>
                <span class="shrink-0 rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">VIN gated</span>
              </div>

              <div class="mt-auto space-y-3">
                <form id="pt-ping-upload-form" class="grid gap-3">
                  <div class="space-y-2">
                    <label for="pt-ping-file" class="text-xs font-semibold uppercase tracking-wide text-slate-400">CSV file</label>
                    <input id="pt-ping-file" name="pt-ping-file" type="file" accept=".csv,.xlsx" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 file:mr-3 file:rounded-md file:border-0 file:bg-indigo-600 file:px-3 file:py-2 file:text-xs file:font-semibold file:uppercase file:tracking-wide file:text-white hover:border-indigo-500 focus:outline-none" />
                  </div>
                  <button id="pt-ping-upload-button" type="button" class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-500/20 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60">
                    <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                    <span>Upload &amp; upsert</span>
                  </button>
                </form>
                <p id="pt-ping-status" class="text-xs leading-relaxed text-slate-400">Requires VIN present in DealsJP1. Conflicts resolved by VIN + Serial #.</p>
              </div>
            </section>

        </div>
      </section>
    </div>
  </main>

  <template id="dataset-card-template">
    <div class="flex h-full flex-col gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/70 hover:border-slate-700 transition-colors">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wide text-blue-200" data-dataset-scope></p>
          <p class="text-lg font-bold text-white" data-dataset-title></p>
          <p class="text-xs text-slate-400" data-dataset-description></p>
        </div>
        <span class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300" data-dataset-status>Table</span>
      </div>
      <div class="grid grid-cols-2 gap-3 text-sm text-slate-200">
        <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
          <p class="text-lg font-black" data-dataset-rows>--</p>
          <p class="text-[11px] uppercase tracking-wide text-slate-500">Live Rows</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
          <p class="text-lg font-black text-emerald-200" data-dataset-columns>--</p>
          <p class="text-[11px] uppercase tracking-wide text-slate-500">Columns</p>
        </div>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 text-xs text-slate-300">
        <p class="font-semibold text-white">Database Signal</p>
        <p class="mt-1 leading-relaxed" data-dataset-signal>Fetching live stats...</p>
      </div>
    </div>
  </template>
   
  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    import { supabase as supabaseClient } from '../assets/scripts/supabaseClient.js';
    import { VEHICLES_COLUMNS } from '../assets/scripts/config.js';

    const DEALS_TABLE = 'DealsJP1';
    const NS_INVOICES_TABLE = 'NS-Invoices&pays';
    const NS_INVOICES_COLUMNS = [
      'Date',
      'Due Date/Receive By',
      'Type',
      'Document Number',
      'Amount',
      'Amount Remaining',
      'Stock No',
      'Payment Through',
      'Invoice Type',
      'Status',
      'Name',
      'Subsidiary',
      'TAM Legacy Stock #',
      'Payment Method'
    ];
    const PT_PING_COLUMNS = [
      'Name',
      'Serial #',
      'Account #',
      'address',
      'Lat',
      'Long',
      'Type',
      'Date',
      'VIN',
      'InventoryStockNumber',
      'TimeSinceLastRpt',
      'Make',
      'Model',
      'Year',
      'Color',
    ];
    
    // --- LISTA MAESTRA (Validación Local) ---
    const KNOWN_DEALS_COLUMNS = [
      'Deal Status', 'Deal Date', 'HOLD', 'Current Stock No', 'Customer', 'Brand', 'Model',
      'Model Year', 'VIN', 'Corrected VIN', 'Vehicle Status', 'Mileage', 'Driver License #',
      'Inventory Preparation Status', 'Inventory Preparation Status Changed On', 'Inventory Preparation Status Changed By',
      'Physical Location', 'Physical Location Last Changed on', 'ENTITY', 'Retail Price On Contract',
      'Cash Down', 'Total due on Deal', 'Amount', 'Reg. Contract Payment', 'Payment Schedule',
      'Total Payments in Months', 'Number OF Schedule Remaining', 'Lead Source', 'Date of Birth',
      'TAM Legacy Created Date', 'Payment Schedule Start', 'Last Payment Date', 'TAM Legacy Stock #',
      'Trade In VIN', 'Trade In Amount', 'Sales Person', 'Subsidiary', 'Location', 'Lease End Date',
      'Bucket', 'Bucket Sub Type', 'Payment Schedule_1', 'Lease Term', 'Regular Amount', 'Total Contract Scheduled Amount',
      'Inventory Valuation Value', 'Sales Channel', 'Partner Name', 'Remaining Scheduled Payments To Invoice',
      'Deposit', 'PassTime Serial No', 'PassTime Vehicle Status', 'EFT Available', 'Primary Payment Mode',
      'Secondary Payment Mode', 'Plate Number', 'Number OF Schedule Remaining_1', 'Mobile Phone', 
      'Encore Serial Number', 'Encore Serial #2', 'GPS Serial No', 'Plate Number_1', 'Current Title Number', 
      'Current Title Subsidiary', 'Current Title Physical Location', 'Title In Date', 'Title Out Date', 
      'Financing Company', 'Broker', 'Return Type', 'Actual System Return Date', 'Returned By'
    ];

    const DATASETS = [
      {
        table: 'Services',
        scope: 'Partners',
        title: 'Service Providers',
        description: 'Unified services directory filtered by category values.',
        displayName: 'Services'
      },
      {
        table: 'vehicles',
        scope: 'Fleet',
        title: 'Vehicles',
        description: 'Live vehicle and asset records.',
        displayName: 'Vehicles'
      },
      {
        table: DEALS_TABLE,
        scope: 'Sales',
        title: 'Active Deals',
        description: 'Imported deals data (VIN + Stock No).',
        displayName: 'Deals'
      },
      {
        table: 'Titles',
        scope: 'Compliance',
        title: 'Titles table',
        description: 'Lifecycle tracking for vehicle titles.',
        displayName: 'Titles'
      },
      {
        table: NS_INVOICES_TABLE,
        scope: 'Finance',
        title: 'NS Invoices & Payments',
        description: 'NetSuite feed mapped by Document Number.',
        displayName: 'NS Invoices'
      },
      {
        table: 'PT-LastPing',
        scope: 'Telematics',
        title: 'Import Last Ping',
        description: 'Latest PassTime ping uploads gated by VIN.',
        displayName: 'PT Last Ping'
      }
    ];

    const ADMIN_ROLE = 'administrator';
    const isAdminUser = () => (window.currentUserRole || '').toLowerCase() === ADMIN_ROLE;

    const toNumber = (value) => {
      if (value === undefined || value === null) return null;
      const cleaned = typeof value === 'string' ? value.replace(/,/g, '').trim() : value;
      const num = Number(cleaned);
      return Number.isFinite(num) ? num : null;
    };

    const cleanHeaderKey = (key) => {
      return (key || '')
        .toString()
        .trim()                
        .replace(/\s+/g, ' ')  
        .toLowerCase()
        .replace(/\.$/, ''); 
    };

    const normalizeRow = (row = {}) =>
      Object.entries(row).reduce((acc, [key, val]) => {
        const normalizedKey = cleanHeaderKey(key);
        if (!normalizedKey) return acc;
        acc[normalizedKey] = typeof val === 'string' ? val.trim() : val;
        return acc;
      }, {});

    const cleanValue = (value) => {
      if (value === undefined || value === null) return null;
      const stringValue = typeof value === 'string' ? value.trim() : value;
      if (`${stringValue}`.trim() === '') return null;
      return stringValue;
    };

    const buildColumnMap = (columns = []) => {
      const map = new Map();
      columns.forEach((col) => {
        const clean = cleanHeaderKey(col);
        map.set(clean, col);
      });
      return map;
    };

    const pickAllowed = (obj) =>
      Object.fromEntries(
        Object.entries(obj).filter(([k, v]) => VEHICLES_COLUMNS.has(k) && v !== undefined)
      );

    const getCsv = (row, ...possibleHeaders) => {
      for (const header of possibleHeaders) {
        const searchKey = cleanHeaderKey(header);
        const v = row[searchKey]; 
        if (v !== undefined && v !== null && `${v}`.trim() !== '') return v;
      }
      return '';
    };

    const mapVehicleRow = (row) => {
      const r = normalizeRow(row);
      const raw = {
        'deal status': cleanValue(getCsv(r, 'deal status', 'deal_status', 'dealstatus')),
        'customer id': cleanValue(getCsv(r, 'customer id', 'customer_id', 'customerid')),
        'unit type': cleanValue(getCsv(r, 'unit type', 'unit_type', 'unittype')),
        'model year': cleanValue(getCsv(r, 'model year', 'model_year', 'modelyear')),
        'model': cleanValue(getCsv(r, 'model')),
        'shortvin': cleanValue(getCsv(r, 'shortvin', 'short vin', 'short_vin')),
        'inv. prep. stat.': cleanValue(getCsv(r, 'inv. prep. stat.', 'inv prep stat', 'inv_prep_stat', 'inv prep. stat.')),
        'phys_loc': cleanValue(getCsv(r, 'phys_loc', 'phys loc', 'physloc', 'physical loc', 'physical location')),
        'deal completion': cleanValue(getCsv(r, 'deal completion', 'deal_completion', 'dealcompletion')),
        'gps fix': cleanValue(getCsv(r, 'gps fix', 'gps_fix')),
        'gps fix reason': cleanValue(getCsv(r, 'gps fix reason', 'gps_fix_reason')),
        'pt status': cleanValue(getCsv(r, 'pt status', 'pt_status')),
        'pt serial': cleanValue(getCsv(r, 'pt serial', 'pt_serial')),
        'encore serial': cleanValue(getCsv(r, 'encore serial', 'encore_serial')),
        'moving': cleanValue(getCsv(r, 'moving')),
        'pt last read': cleanValue(getCsv(r, 'pt last read', 'pt_last_read')),
        'state loc': cleanValue(getCsv(r, 'state loc', 'state_loc')),
        'pt city': cleanValue(getCsv(r, 'pt city', 'pt_city')),
        'pt zipcode': cleanValue(getCsv(r, 'pt zipcode', 'pt zip code', 'pt_zipcode')),
        'lat': toNumber(getCsv(r, 'lat', 'latitude')),
        'long': toNumber(getCsv(r, 'long', 'lng', 'longitude')),
      };
      return pickAllowed(raw);
    };

    const mapInvoiceRow = (normalizedRow = {}, columnMap) => {
      const mapped = {};
      columnMap.forEach((originalHeader, normalizedKey) => {
        if (!originalHeader) return;
        let value = normalizedRow[normalizedKey];
        if (value === undefined) return;
        if (normalizedKey === 'amount' || normalizedKey === 'amount remaining') {
          const numeric = toNumber(value);
          value = numeric !== null ? numeric : value;
        }
        const cleaned = cleanValue(value);
        if (cleaned === null) return;
        mapped[originalHeader] = cleaned;
      });
      return mapped;
    };

    const isRlsBlocked = (error) => {
      const message = (error?.message || '').toLowerCase();
      return message.includes('row-level') || message.includes('rls') || message.includes('permission');
    };

    const getTableStats = async (dataset) => {
      if (!supabaseClient) {
        return { rows: 0, columns: 0, lastUpdated: null, restricted: true, message: 'Client unavailable' };
      }
      try {
        const { count, error: countError } = await supabaseClient
          .from(dataset.table)
          .select('*', { count: 'exact', head: true });
        if (countError) {
          return { rows: 0, columns: 0, lastUpdated: null, restricted: true, message: countError.message || 'Restricted' };
        }
        const { data, error: dataError } = await supabaseClient
          .from(dataset.table)
          .select('*')
          .limit(1);
        if (dataError) {
          return { rows: count || 0, columns: 0, lastUpdated: null, restricted: true, message: dataError.message || 'Restricted' };
        }
        let columnCount = 0;
        let lastUpdated = null;
        if (data && data.length > 0) {
          columnCount = Object.keys(data[0]).length;
          lastUpdated = data[0].created_at || data[0].updated_at || null;
        }
        return { rows: count || 0, columns: columnCount, lastUpdated, restricted: false };
      } catch (err) {
        return { rows: 0, columns: 0, lastUpdated: null, restricted: true, message: err.message };
      }
    };

    const renderActivityLog = (activities) => {
      const container = document.getElementById('activity-log');
      if (!container) return;
      container.innerHTML = '';
      if (activities.length === 0) {
        container.innerHTML = '<li class="text-slate-500 italic text-xs">No recent activity detected.</li>';
        return;
      }
      activities.slice(0, 4).forEach((item) => {
        const row = document.createElement('li');
        row.className = 'flex items-center justify-between gap-3 rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2';
        row.innerHTML = `
          <div class="flex items-center gap-2">
             <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
             <span class="font-semibold text-white text-xs">${item.table} verified</span>
          </div>
          <span class="text-[10px] uppercase tracking-wide text-slate-400">${item.rows} rows</span>
        `;
        container.appendChild(row);
      });
    };

    const renderDatasetCard = async (dataset) => {
      const template = document.getElementById('dataset-card-template');
      const clone = template.content.firstElementChild.cloneNode(true);
      const els = {
        scope: clone.querySelector('[data-dataset-scope]'),
        title: clone.querySelector('[data-dataset-title]'),
        description: clone.querySelector('[data-dataset-description]'),
        status: clone.querySelector('[data-dataset-status]'),
        rows: clone.querySelector('[data-dataset-rows]'),
        columns: clone.querySelector('[data-dataset-columns]'),
        signal: clone.querySelector('[data-dataset-signal]'),
      };
      els.scope.textContent = dataset.scope;
      els.title.textContent = dataset.title;
      els.description.textContent = dataset.description;
      const stats = await getTableStats(dataset);
      els.rows.textContent = stats.rows ? stats.rows.toLocaleString() : '--';
      els.columns.textContent = stats.columns || '--';
      if (stats.restricted) {
        els.status.textContent = 'Restricted';
        els.status.className = 'rounded-full border border-amber-600 bg-amber-600/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-200';
        els.signal.textContent = stats.message ? `Access limited: ${stats.message}` : 'Access limited by security policy.';
      } else if (stats.rows > 0) {
        els.status.textContent = 'Active';
        els.status.className = 'rounded-full border border-emerald-600 bg-emerald-600/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-200';
        els.signal.textContent = `Connected to live table. ${stats.columns} fields mapped.`;
      } else {
        els.status.textContent = 'Empty';
        els.signal.textContent = 'Table exists but contains no records.';
      }
      return { card: clone, stats: { ...stats, table: dataset.displayName } };
    };

    const ensureToastContainer = () => {
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed bottom-6 right-6 z-50 flex flex-col gap-3';
        document.body.appendChild(container);
      }
      return container;
    };

    const showToast = (message, type = 'info') => {
      const container = ensureToastContainer();
      const toast = document.createElement('div');
      const variantClasses =
        type === 'success'
          ? 'border-emerald-500/60 bg-emerald-500/10 text-emerald-50 shadow-emerald-500/30'
          : 'border-red-500/60 bg-red-500/10 text-red-50 shadow-red-500/30';
      toast.className = `flex min-w-[260px] max-w-sm items-start gap-3 rounded-xl border px-4 py-3 text-sm shadow-xl backdrop-blur ${variantClasses}`;
      const icon = document.createElement('span');
      icon.className = `mt-0.5 h-2.5 w-2.5 rounded-full ${type === 'success' ? 'bg-emerald-400' : 'bg-red-400'}`;
      const text = document.createElement('p');
      text.className = 'whitespace-pre-line font-semibold leading-relaxed';
      text.textContent = message;
      toast.appendChild(icon);
      toast.appendChild(text);
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2', 'transition', 'duration-300');
        setTimeout(() => toast.remove(), 320);
      }, 4200);
    };

    // --- UPLOAD VEHICLES ---
    const uploadCsvRows = async (rows, parseErrors = 0) => {
      if (!supabaseClient) throw new Error('Supabase client unavailable.');
      if (!isAdminUser()) throw new Error('Only administrators can upload vehicle data.');
      const submitBtn = document.getElementById('upload-button');
      const mapped = rows
        .map(mapVehicleRow)
        .filter((row) => {
          const valid = !!(row.shortvin && `${row.shortvin}`.trim() !== '');
          return valid;
        });
      if (!mapped.length) {
        showToast('No valid rows detected. Each row must include a ShortVIN value.', 'error');
        return;
      }
      const BATCH_SIZE = 1000;
      let totalUpserted = 0;
      let skippedInvalid = rows.length - mapped.length;
      const totalBatches = Math.ceil(mapped.length / BATCH_SIZE);
      for (let i = 0; i < mapped.length; i += BATCH_SIZE) {
        const batch = mapped.slice(i, i + BATCH_SIZE);
        const currentBatch = Math.floor(i / BATCH_SIZE) + 1;
        if (submitBtn) {
          submitBtn.innerHTML = `<span class="animate-pulse">Uploading batch ${currentBatch}/${totalBatches}...</span>`;
        }
        const { data, error } = await supabaseClient
          .from('vehicles')
          .upsert(batch, { onConflict: 'shortvin', ignoreDuplicates: false })
          .select('shortvin');
        if (error) {
          console.error('Supabase upsert error:', error);
          if (isRlsBlocked(error)) {
            showToast('Upload blocked by security policy (RLS).', 'error');
            return;
          }
          throw error;
        }
        totalUpserted += (data ? data.length : 0);
        await new Promise((resolve) => setTimeout(resolve, 0));
      }
      const summary =
        'Completed.' +
        '\nProcessed: ' + rows.length +
        '\nUpserted: ' + totalUpserted +
        '\nSkipped (No ShortVIN): ' + skippedInvalid +
        '\nErrors: ' + parseErrors;
      showToast(summary, 'success');
    };

    // --- UPLOAD DEALS: AHORA ROBUSTO Y NORMALIZADO (CON FILTRO DE DUPLICADOS) ---
    const uploadDealsRows = async (rows, parseErrors = 0) => {
      if (!supabaseClient) throw new Error('Supabase client unavailable.');
      if (!isAdminUser()) throw new Error('Only administrators can upload deals data.');

      const submitBtn = document.getElementById('deals-upload-button');
      const progressWrap = document.getElementById('deals-progress');
      const progressBar = document.getElementById('deals-progress-bar');
      const progressLabel = document.getElementById('deals-progress-label');
      const progressCount = document.getElementById('deals-progress-count');

      const setProgress = (percent, label) => {
        if (progressWrap) progressWrap.classList.remove('hidden');
        if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
        if (progressLabel) progressLabel.textContent = label;
        if (progressCount) progressCount.textContent = `${Math.round(Math.max(0, Math.min(100, percent)))}%`;
      };
      
      const columnMap = buildColumnMap(KNOWN_DEALS_COLUMNS);
      const conflictColumn = columnMap.get('current stock no'); 

      if (!conflictColumn) {
        showToast('Local configuration error: "Current Stock No" missing from whitelist.', 'error');
        return;
      }

      setProgress(0, 'Preparing & deduplicating rows...');
      
      // 1. DEDUPLICACIÓN PARA EVITAR ERROR 'ON CONFLICT'
      const uniqueDealsMap = new Map();
      let skippedInvalid = 0;
      let duplicatesRemoved = 0;

      rows.forEach((rawRow) => {
        const normalizedRow = normalizeRow(rawRow);
        
        // Validaciones
        const salesChannel = normalizedRow['sales channel'];
        const isFinance = typeof salesChannel === 'string' && salesChannel.toLowerCase().includes('finance');
        
        const stockNumber = normalizedRow['current stock no'];
        const vin = normalizedRow['vin'];

        if (!isFinance || !stockNumber || !vin) {
          skippedInvalid += 1;
          return; 
        }

        const mapped = {};
        Object.entries(normalizedRow).forEach(([key, value]) => {
          const columnName = columnMap.get(key);
          const cleanedValue = cleanValue(value);
          if (!columnName || cleanedValue === null) return;
          mapped[columnName] = cleanedValue;
        });

        if (!mapped[conflictColumn]) {
            mapped[conflictColumn] = stockNumber;
        }

        // LLAVE UNICA: VIN + Stock
        const uniqueKey = `${vin}_${stockNumber}`;

        if (uniqueDealsMap.has(uniqueKey)) {
            duplicatesRemoved++;
        }
        // Sobrescribimos (se queda el último del CSV)
        uniqueDealsMap.set(uniqueKey, mapped);
      });

      const filteredRows = Array.from(uniqueDealsMap.values());

      if (!filteredRows.length) {
        setProgress(0, 'No finance rows detected.');
        showToast('No valid FINANCE rows detected.\nCheck "Current Stock No." and "Sales Channel".', 'error');
        return;
      }

      const BATCH_SIZE = 1000;
      let totalUpserted = 0;
      const totalBatches = Math.ceil(filteredRows.length / BATCH_SIZE);
      let processed = 0;

      for (let i = 0; i < filteredRows.length; i += BATCH_SIZE) {
        const batch = filteredRows.slice(i, i + BATCH_SIZE);
        const currentBatch = Math.floor(i / BATCH_SIZE) + 1;

        if (submitBtn) {
          submitBtn.innerHTML = `<span class="animate-pulse">Uploading batch ${currentBatch}/${totalBatches}...</span>`;
        }
        setProgress((processed / filteredRows.length) * 100, `Uploading batch ${currentBatch} of ${totalBatches}...`);

        // UPSERT
        const { data, error } = await supabaseClient
          .from(DEALS_TABLE)
          .upsert(batch, { onConflict: 'VIN,Current Stock No', ignoreDuplicates: false }) 
          .select();

        if (error) {
          console.error('Supabase upsert error:', error);
          if (isRlsBlocked(error)) {
            showToast('Upload blocked by security policy (RLS).', 'error');
            return;
          }
          throw error;
        }
        totalUpserted += (data ? data.length : 0);
        processed += batch.length;
        setProgress((processed / filteredRows.length) * 100, `Uploaded ${Math.min(processed, filteredRows.length)} of ${filteredRows.length} rows...`);
        await new Promise((resolve) => setTimeout(resolve, 0));
      }

      const summary =
        'Completed.' +
        '\nProcessed (Unique Finance): ' + filteredRows.length +
        '\nUpserted: ' + totalUpserted +
        '\nSkipped (Invalid/Not Finance): ' + skippedInvalid +
        '\nDuplicates Removed: ' + duplicatesRemoved + 
        '\nErrors: ' + parseErrors;
      
      showToast(summary, 'success');
      setProgress(100, 'Upload complete.');
    };

    const uploadInvoicesRows = async (rows, parseErrors = 0) => {
      if (!supabaseClient) throw new Error('Supabase client unavailable.');
      if (!isAdminUser()) throw new Error('Only administrators can upload invoice data.');

      const submitBtn = document.getElementById('ns-invoices-upload-button');
      const progressWrap = document.getElementById('ns-invoices-progress');
      const progressBar = document.getElementById('ns-invoices-progress-bar');
      const progressLabel = document.getElementById('ns-invoices-progress-label');
      const progressCount = document.getElementById('ns-invoices-progress-count');

      const setProgress = (percent, label) => {
        if (progressWrap) progressWrap.classList.remove('hidden');
        if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
        if (progressLabel) progressLabel.textContent = label;
        if (progressCount) progressCount.textContent = `${Math.round(Math.max(0, Math.min(100, percent)))}%`;
      };

      const columnMap = buildColumnMap(NS_INVOICES_COLUMNS);
      const conflictColumn = columnMap.get('document number');
      const conflictColumns = 'Stock No,Document Number,Date';

      if (!conflictColumn) {
        showToast('Local configuration error: "Document Number" missing from invoice columns.', 'error');
        return;
      }

      setProgress(0, 'Clearing previous invoice data...');

      const { error: truncateError } = await supabaseClient.rpc('truncate_ns_invoices');
      if (truncateError) {
        console.error('Supabase truncate error:', truncateError);
        showToast('Cannot clear previous NS invoices: ' + truncateError.message, 'error');
        return;
      }

      setProgress(5, 'Preparing invoice rows...');

      const uniqueInvoices = new Map();
      let skippedInvalid = 0;
      let duplicatesRemoved = 0;

      rows.forEach((rawRow) => {
        const normalizedRow = normalizeRow(rawRow);
        const documentNumber = normalizedRow['document number'];

        if (!documentNumber) {
          skippedInvalid++;
          return;
        }

        const mapped = mapInvoiceRow(normalizedRow, columnMap);
        if (!mapped[conflictColumn]) mapped[conflictColumn] = documentNumber;

        const stockNumber = normalizedRow['stock no'] || normalizedRow['stock number'] || normalizedRow['tam legacy stock #'];
        const uniqueKey = stockNumber ? `${documentNumber}_${stockNumber}` : `${documentNumber}`;
        if (uniqueInvoices.has(uniqueKey)) {
          duplicatesRemoved++;
        }
        uniqueInvoices.set(uniqueKey, mapped);
      });

      const filteredRows = Array.from(uniqueInvoices.values());

      if (!filteredRows.length) {
        setProgress(0, 'No valid invoice rows found.');
        showToast('No valid rows detected. Each row must include a Document Number value.', 'error');
        return;
      }

      const BATCH_SIZE = 1000;
      let totalUpserted = 0;
      const totalBatches = Math.ceil(filteredRows.length / BATCH_SIZE);
      let processed = 0;

      for (let i = 0; i < filteredRows.length; i += BATCH_SIZE) {
        const batch = filteredRows.slice(i, i + BATCH_SIZE);
        const currentBatch = Math.floor(i / BATCH_SIZE) + 1;

        if (submitBtn) {
          submitBtn.innerHTML = `<span class="animate-pulse">Uploading batch ${currentBatch}/${totalBatches}...</span>`;
        }
        setProgress((processed / filteredRows.length) * 100, `Uploading batch ${currentBatch} of ${totalBatches}...`);

        const { data, error } = await supabaseClient
          .from(NS_INVOICES_TABLE)
          .upsert(batch, { onConflict: conflictColumns, ignoreDuplicates: true })
          .select();

        if (error) {
          console.error('Supabase upsert error:', error);
          if (isRlsBlocked(error)) {
            showToast('Upload blocked by security policy (RLS).', 'error');
            return;
          }
          throw error;
        }
        totalUpserted += (data ? data.length : 0);
        processed += batch.length;
        setProgress((processed / filteredRows.length) * 100, `Uploaded ${Math.min(processed, filteredRows.length)} of ${filteredRows.length} rows...`);
      }

      const summary =
        'Completed.' +
        '\nProcessed (Unique): ' + filteredRows.length +
        '\nUpserted: ' + totalUpserted +
        '\nSkipped (Missing Document Number): ' + skippedInvalid +
        '\nDuplicates Removed: ' + duplicatesRemoved +
        '\nErrors: ' + parseErrors;

      showToast(summary, 'success');
      setProgress(100, 'Upload complete.');
    };

    const wireCsvUpload = () => {
      const form = document.getElementById('csv-upload-form');
      const fileInput = document.getElementById('csv-file');
      const submitBtn = document.getElementById('upload-button');
      const requireAdmin = () => {
        const allowed = isAdminUser();
        if (fileInput) fileInput.disabled = !allowed;
        if (submitBtn) submitBtn.disabled = !allowed;
        const titleText = allowed ? '' : 'Administrator access required';
        if (fileInput) fileInput.title = titleText;
        if (submitBtn) submitBtn.title = titleText;
        return allowed;
      };
      if (!form || !fileInput || !submitBtn) return;
      const syncAccess = () => requireAdmin();
      syncAccess();
      window.addEventListener('auth:role-updated', syncAccess);
      
      submitBtn.addEventListener('click', (event) => {
        event.preventDefault(); 
        if (!requireAdmin()) {
          showToast('Only administrators can upload vehicle data.', 'error');
          return;
        }
        const file = fileInput.files?.[0];
        if (!file) {
          showToast('Please select a CSV file to upload.', 'error');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Reading file…</span>';
        window.Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (h) => h.trim(),
          worker: false, 
          complete: async (results) => {
            try {
              const parseErrors = results.errors?.length || 0;
              submitBtn.innerHTML = '<span class="animate-pulse">Processing…</span>';
              await uploadCsvRows(results.data || [], parseErrors);
            } catch (err) {
              console.error('Upload failed:', err);
              showToast('Upload failed: ' + err.message, 'error');
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
              lucide.createIcons();
            }
          },
          error: (err) => {
            showToast('CSV parse error: ' + err.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
            lucide.createIcons();
          },
        });
      });
    };

    const wireDealsUpload = () => {
      const form = document.getElementById('deals-upload-form');
      const fileInput = document.getElementById('deals-file');
      const submitBtn = document.getElementById('deals-upload-button');
      const requireAdmin = () => {
        const allowed = isAdminUser();
        if (fileInput) fileInput.disabled = !allowed;
        if (submitBtn) submitBtn.disabled = !allowed;
        const titleText = allowed ? '' : 'Administrator access required';
        if (fileInput) fileInput.title = titleText;
        if (submitBtn) submitBtn.title = titleText;
        return allowed;
      };
      if (!form || !fileInput || !submitBtn) return;
      const syncAccess = () => requireAdmin();
      syncAccess();
      window.addEventListener('auth:role-updated', syncAccess);
      
      submitBtn.addEventListener('click', (event) => {
        event.preventDefault(); 
        if (!requireAdmin()) {
          showToast('Only administrators can upload deals data.', 'error');
          return;
        }
        const file = fileInput.files?.[0];
        if (!file) {
          showToast('Please select a CSV file to upload.', 'error');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Reading file…</span>';
        window.Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (h) => h.trim(),
          worker: false, 
          complete: async (results) => {
            try {
              const parseErrors = results.errors?.length || 0;
              submitBtn.innerHTML = '<span class="animate-pulse">Processing…</span>';
              await uploadDealsRows(results.data || [], parseErrors);
            } catch (err) {
              console.error('Upload failed:', err);
              showToast('Upload failed: ' + err.message, 'error');
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
              lucide.createIcons();
            }
          },
          error: (err) => {
            showToast('CSV parse error: ' + err.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
            lucide.createIcons();
          },
        });
      });
    };

    const wireInvoicesUpload = () => {
      const form = document.getElementById('ns-invoices-upload-form');
      const fileInput = document.getElementById('ns-invoices-file');
      const submitBtn = document.getElementById('ns-invoices-upload-button');
      const requireAdmin = () => {
        const allowed = isAdminUser();
        if (fileInput) fileInput.disabled = !allowed;
        if (submitBtn) submitBtn.disabled = !allowed;
        const titleText = allowed ? '' : 'Administrator access required';
        if (fileInput) fileInput.title = titleText;
        if (submitBtn) submitBtn.title = titleText;
        return allowed;
      };
      if (!form || !fileInput || !submitBtn) return;
      const syncAccess = () => requireAdmin();
      syncAccess();
      window.addEventListener('auth:role-updated', syncAccess);

      submitBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (!requireAdmin()) {
          showToast('Only administrators can upload invoice data.', 'error');
          return;
        }
        const file = fileInput.files?.[0];
        if (!file) {
          showToast('Please select a CSV file to upload.', 'error');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Reading file…</span>';
        window.Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (h) => h.trim(),
          worker: false,
          complete: async (results) => {
            try {
              const parseErrors = results.errors?.length || 0;
              submitBtn.innerHTML = '<span class="animate-pulse">Processing…</span>';
              await uploadInvoicesRows(results.data || [], parseErrors);
            } catch (err) {
              console.error('Upload failed:', err);
              showToast('Upload failed: ' + err.message, 'error');
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
              lucide.createIcons();
            }
          },
          error: (err) => {
            showToast('CSV parse error: ' + err.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
            lucide.createIcons();
          },
        });
      });
    };

    const wirePtPingUpload = () => {
      const form = document.getElementById('pt-ping-upload-form');
      const fileInput = document.getElementById('pt-ping-file');
      const submitBtn = document.getElementById('pt-ping-upload-button');
      const status = document.getElementById('pt-ping-status');

      const setStatus = (text) => {
        if (status) status.textContent = text;
      };

      const requireAdmin = () => {
        const allowed = isAdminUser();
        if (fileInput) fileInput.disabled = !allowed;
        if (submitBtn) submitBtn.disabled = !allowed;
        const titleText = allowed ? '' : 'Administrator access required';
        if (fileInput) fileInput.title = titleText;
        if (submitBtn) submitBtn.title = titleText;
        return allowed;
      };

      if (!form || !fileInput || !submitBtn) return;
      const syncAccess = () => requireAdmin();
      syncAccess();
      window.addEventListener('auth:role-updated', syncAccess);

      submitBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (!requireAdmin()) {
          showToast('Only administrators can upload PT ping data.', 'error');
          return;
        }
        const file = fileInput.files?.[0];
        if (!file) {
          showToast('Please select a CSV file to upload.', 'error');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Fetching VINs…</span>';
        setStatus('Parsing file...');
        parsePtPingFile(file)
          .then(async ({ rows, headers, errors }) => {
            const { valid, missing } = validatePtPingHeaders(headers);
            if (!valid) {
              setStatus('Missing headers: ' + missing.join(', '));
              showToast('Missing required headers: ' + missing.join(', '), 'error');
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
              lucide.createIcons();
              return;
            }
            try {
              submitBtn.innerHTML = '<span class="animate-pulse">Processing…</span>';
              await uploadPtPingRows(rows || [], errors?.length || 0);
            } catch (err) {
              console.error('Upload failed:', err);
              showToast('Upload failed: ' + err.message, 'error');
              setStatus('Upload failed: ' + err.message);
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
              lucide.createIcons();
            }
          })
          .catch((err) => {
            console.error('Parse error:', err);
            showToast('File parse error: ' + err.message, 'error');
            setStatus('File parse error: ' + err.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
            lucide.createIcons();
          });
      });
    };

    const mount = async () => {
      const container = document.getElementById('datasets');
      let totalRows = 0;
      let activities = [];
      for (const dataset of DATASETS) {
        const { card, stats } = await renderDatasetCard(dataset);
        container.appendChild(card);
        totalRows += stats.rows || 0;
        if ((stats.rows || 0) > 0 && !stats.restricted) activities.push(stats);
      }
      document.getElementById('dataset-count').textContent = DATASETS.length;
      document.getElementById('records-count').textContent = totalRows.toLocaleString();
      renderActivityLog(activities);
      lucide.createIcons();
    };

    const fetchDealsVinSet = async () => {
      const vinSet = new Set();
      const PAGE_SIZE = 1000;
      let from = 0;
      while (true) {
        const { data, error } = await supabaseClient
          .from(DEALS_TABLE)
          .select('VIN')
          .range(from, from + PAGE_SIZE - 1);
        if (error) throw error;
        (data || []).forEach((row) => {
          const vin = row?.VIN;
          if (vin) vinSet.add(String(vin).trim());
        });
        if (!data || data.length < PAGE_SIZE) break;
        from += PAGE_SIZE;
      }
      return vinSet;
    };

    const ensureXlsxLibrary = () => {
      if (window.XLSX) return Promise.resolve();
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load XLSX parser.'));
        document.head.appendChild(script);
      });
    };

    const parsePtPingFile = async (file) => {
      const name = file?.name || '';
      const lowerName = name.toLowerCase();
      if (lowerName.endsWith('.csv')) {
        return new Promise((resolve, reject) => {
          window.Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            worker: false,
            complete: (results) => {
              const headers = results.meta?.fields || [];
              resolve({ rows: results.data || [], headers, errors: results.errors || [] });
            },
            error: (err) => reject(err),
          });
        });
      }
      if (lowerName.endsWith('.xlsx')) {
        await ensureXlsxLibrary();
        const data = await file.arrayBuffer();
        const workbook = window.XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheet];
        const rowsMatrix = window.XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
        const headers = (rowsMatrix[0] || []).map((h) => (h === undefined || h === null ? '' : String(h)));
        const rows = rowsMatrix.slice(1).map((row) => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx];
          });
          return obj;
        });
        return { rows, headers, errors: [] };
      }
      throw new Error('Unsupported file type. Please upload CSV or XLSX.');
    };

    const validatePtPingHeaders = (headers = []) => {
      const missing = PT_PING_COLUMNS.filter((col) => !headers.includes(col));
      return { valid: missing.length === 0, missing };
    };

    const uploadPtPingRows = async (rows, parseErrors = 0) => {
      if (!supabaseClient) throw new Error('Supabase client unavailable.');
      if (!isAdminUser()) throw new Error('Only administrators can upload PT ping data.');

      const submitBtn = document.getElementById('pt-ping-upload-button');
      const status = document.getElementById('pt-ping-status');
      const rejectedRows = [];

      const downloadRejected = () => {
        if (!rejectedRows.length || !window.Papa?.unparse) return;
        const csv = window.Papa.unparse(rejectedRows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'errores_carga.csv';
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      };

      const setStatus = (text) => {
        if (status) status.textContent = text;
      };

      setStatus('Fetching active VINs from Deals...');
      const vinSet = await fetchDealsVinSet();

      if (!vinSet.size) {
        setStatus('No active VINs found in DealsJP1.');
        showToast('No active VINs found in DealsJP1.', 'error');
        return;
      }

      setStatus('Filtering rows by VIN...');
      const validRows = [];
      (rows || []).forEach((row) => {
        const vin = row?.['VIN'];
        if (!vin) {
          rejectedRows.push({ ...row, error: 'Missing VIN' });
          return;
        }
        if (!vinSet.has(String(vin).trim())) {
          rejectedRows.push({ ...row, error: 'VIN not found in DealsJP1' });
          return;
        }

        const normalizedRow = { ...row };
        if (Object.prototype.hasOwnProperty.call(normalizedRow, 'Serial #')) {
          normalizedRow['Serial'] = normalizedRow['Serial #'];
          delete normalizedRow['Serial #'];
        }
        if (Object.prototype.hasOwnProperty.call(normalizedRow, 'Account #')) {
          normalizedRow['Account'] = normalizedRow['Account #'];
          delete normalizedRow['Account #'];
        }

        validRows.push(normalizedRow);
      });

      if (!validRows.length) {
        setStatus('No rows matched VINs in DealsJP1.');
        showToast('No rows matched VINs in DealsJP1.', 'error');
        downloadRejected();
        return;
      }

      setStatus(`Uploading ${validRows.length} rows...`);
      const { error } = await supabaseClient
        .from('PT-LastPing')
        .upsert(validRows, { onConflict: 'VIN,Serial', ignoreDuplicates: false });

      if (error) {
        console.error('Supabase upsert error:', error);
        if (isRlsBlocked(error)) {
          showToast('Upload blocked by security policy (RLS).', 'error');
          setStatus('Upload blocked by security policy (RLS).');
          return;
        }
        throw error;
      }

      const summary =
        'Completed.' +
        '\nProcessed: ' + rows.length +
        '\nUpserted: ' + validRows.length +
        '\nSkipped (VIN not in Deals): ' + (rows.length - validRows.length) +
        '\nErrors: ' + parseErrors;
      setStatus('Upload complete.');
      showToast(summary, 'success');
      downloadRejected();
      if (submitBtn) submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; upsert</span>';
      lucide.createIcons();
    };

    createConstellationBackground();
    mount();
    wireCsvUpload();
    wireDealsUpload();
    wireInvoicesUpload();
    wirePtPingUpload();
  </script>
</body>
</html>
