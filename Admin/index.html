<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="../assets/scripts/supabaseClient.js"></script>
  <script src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="../assets/visuals/theme.css" />
</head>
<body class="min-h-screen bg-slate-950 text-slate-50">
  <div data-auth-loading class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
    <div class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900 px-5 py-3 shadow-xl shadow-slate-900/60">
      <span class="h-3 w-3 animate-pulse rounded-full bg-blue-400"></span>
      <p class="text-sm font-semibold text-slate-200">Validating secure session…</p>
    </div>
  </div>

  <div data-auth-protected class="hidden">
<header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
  <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-4 px-6 py-4 lg:flex-nowrap lg:gap-6 lg:px-10">

    <a href="../index.html" class="flex items-center gap-3">
      <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
        <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
      </div>
      <div>
        <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>
        <h1 class="text-base font-black leading-tight text-white">Secure Operations</h1>
      </div>
    </a>

    <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">
      <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>

      <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>

      <a id="nav-dashboard" href="./index.html" class="hidden rounded-full px-3 py-1 bg-blue-600 text-white shadow shadow-blue-500/20">Dashboard</a>

      <a id="nav-about" href="../about.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">About Us</a>
      <a id="nav-contact" href="../contact.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Contact</a>
    </nav>

    <div class="flex items-center gap-3">
      <div class="hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 md:flex">
        <span class="flex h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
        Secure Mode
      </div>

      <div class="flex items-center gap-2">
        <a id="nav-login" href="../login.html" class="hidden rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
        <div data-admin-actions class="flex items-center gap-2">
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-900/50 bg-red-950/20 px-4 py-1.5 text-xs font-semibold uppercase tracking-wide text-red-200 transition hover:bg-red-900/40 hover:text-white hover:border-red-500">
            Logout
          </button>
        </div>
      </div>

    </div>

  </div>
</header>

    <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>

    <main class="mx-auto w-full max-w-7xl px-6 py-8 lg:px-10">
    <div class="flex flex-col gap-8 lg:flex-row">
      <aside class="hidden w-64 shrink-0 space-y-4 lg:sticky lg:top-8 lg:max-h-[calc(100vh-4rem)] lg:overflow-y-auto lg:block">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Navigation</p>
          <h2 class="text-lg font-black text-white">Admin workspace</h2>
        </div>
        <nav class="flex flex-col gap-2 text-sm font-semibold">
          <a href="./index.html" class="flex items-center justify-between gap-2 rounded-xl border border-blue-500 bg-blue-600/90 px-3 py-2 text-white shadow shadow-blue-500/40">
            Dashboard <span class="text-xs font-medium text-blue-100">Overview</span>
          </a>
          <a href="./profiles.html" data-admin-only class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Profiles <span class="text-xs font-medium text-slate-400">Access levels</span>
          </a>
          <a href="./services.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Services <span class="text-xs font-medium text-slate-400">Technicians</span>
          </a>
          <a href="./vehicles.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Vehicles <span class="text-xs font-medium text-slate-400">Fleet</span>
          </a>
          <a href="./analytics.html" class="flex items-center justify-between gap-2 rounded-xl border border-slate-800/60 bg-slate-950/60 px-3 py-2 text-slate-200 transition hover:border-blue-500 hover:text-white">
            Analytics <span class="text-xs font-medium text-slate-400">Insights</span>
          </a>
        </nav>
      </aside>

      <section class="flex-1 space-y-8">
        <section class="space-y-6 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-xl shadow-blue-900/30">
          <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
            <div class="space-y-3">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Dashboard</p>
              <h1 class="text-3xl font-black text-white">Command center for field operations</h1>
              <p class="text-sm leading-relaxed text-slate-300">Monitorea proveedores, flota y datos en vivo desde un panel compacto. Accede rápido a los módulos clave o revisa la salud de las tablas antes de cargar nuevas fuentes.</p>
              <div class="flex flex-wrap gap-2">
                <a href="./services.html" class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 transition hover:-translate-y-0.5 hover:border-emerald-400">
                  <i data-lucide="wrench" class="h-4 w-4"></i>
                  Abrir services
                </a>
                <a href="./vehicles.html" class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:-translate-y-0.5 hover:border-blue-400">
                  <i data-lucide="car" class="h-4 w-4"></i>
                  Ver vehículos
                </a>
                <a href="./analytics.html" class="inline-flex items-center gap-2 rounded-full border border-amber-600 bg-amber-600/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-amber-100 transition hover:-translate-y-0.5 hover:border-amber-400">
                  <i data-lucide="activity" class="h-4 w-4"></i>
                  Panel analytics
                </a>
              </div>
            </div>
            <div class="grid w-full max-w-md grid-cols-3 gap-3 rounded-2xl border border-blue-900/60 bg-blue-950/40 p-4 shadow-inner shadow-blue-900/40">
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p id="dataset-count" class="text-2xl font-black text-white">-</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Tablas</p>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p id="records-count" class="text-2xl font-black text-amber-300">-</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Filas vivas</p>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p id="uploaded-count" class="text-2xl font-black text-emerald-300">Activo</p>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Estado</p>
              </div>
            </div>
          </div>

          <div class="grid gap-4 lg:grid-cols-[2fr_1fr]">
            <div class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Progreso</p>
                  <h3 class="text-lg font-bold text-white">Seguimiento operativo</h3>
                </div>
                <span class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">Live data</span>
              </div>
              <div class="grid gap-3 md:grid-cols-3">
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Proveedores activos</p>
                  <p class="text-xs text-slate-400">Sincronizados desde Supabase Services.</p>
                </div>
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Flota monitoreada</p>
                  <p class="text-xs text-slate-400">Metricas en tiempo real para vehículos.</p>
                </div>
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3">
                  <p class="text-sm font-semibold text-slate-200">Integridad de datos</p>
                  <p class="text-xs text-slate-400">Analítica vinculada a tablas y RPC.</p>
                </div>
              </div>
            </div>
            <div class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
              <div class="flex items-center justify-between">
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Actividad</p>
                <div class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-wide text-slate-500">
                  <span class="flex h-2 w-2 rounded-full bg-emerald-400"></span>
                  En vivo
                </div>
              </div>
              <ul id="activity-log" class="space-y-2" aria-live="polite">
                <li class="text-slate-500 italic text-xs">Scanning tables...</li>
              </ul>
            </div>
          </div>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-900 bg-slate-900/60 p-6 shadow-inner shadow-slate-900/50">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Workspaces</p>
              <h3 class="text-xl font-bold text-white">Provider &amp; fleet modules</h3>
              <p class="text-sm text-slate-400">Accesos rápidos a cada vertical de servicio.</p>
            </div>
            <span class="rounded-full border border-slate-700 bg-slate-950 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">Navigation</span>
          </div>
          <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            <a href="./services.html" class="group flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-950/80 p-4 transition hover:-translate-y-0.5 hover:border-emerald-400">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-200">People</p>
                <p class="text-lg font-bold text-white">Services</p>
                <p class="text-xs text-slate-400">Manage GPS technicians.</p>
              </div>
              <i data-lucide="building-2" class="h-8 w-8 text-emerald-200"></i>
            </a>

            <a href="./vehicles.html" class="group flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-950/80 p-4 transition hover:-translate-y-0.5 hover:border-blue-400">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-blue-200">Fleet</p>
                <p class="text-lg font-bold text-white">Vehicles</p>
                <p class="text-xs text-slate-400">Validate GPS health.</p>
              </div>
              <i data-lucide="panel-top" class="h-8 w-8 text-blue-200"></i>
            </a>

          </div>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Data room</p>
              <h3 class="text-xl font-bold text-white">Supabase live tables</h3>
              <p class="text-sm text-slate-400">Estadísticas actualizadas de cada dataset conectado.</p>
            </div>
            <div class="text-sm font-semibold text-slate-300">Real-time database statistics</div>
          </div>
          <div id="datasets" class="grid gap-4 md:grid-cols-2"></div>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-900 bg-slate-900/70 p-6 shadow-inner shadow-slate-900/60">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200">Secure upload</p>
              <h3 class="text-lg font-bold text-white">Import Services CSV</h3>
              <p class="text-sm text-slate-400">Files are parsed client-side and inserted through the deduplication RPC.</p>
            </div>
            <span class="rounded-full border border-slate-700 bg-slate-950 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300">RPC protected</span>
          </div>
          <form id="csv-upload-form" class="grid gap-3 md:grid-cols-[1fr_auto] md:items-end">
            <div class="space-y-2">
              <label for="csv-file" class="text-xs font-semibold uppercase tracking-wide text-slate-400">CSV file</label>
              <input id="csv-file" name="csv-file" type="file" accept=".csv" class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 file:mr-3 file:rounded-md file:border-0 file:bg-blue-600 file:px-3 file:py-2 file:text-xs file:font-semibold file:uppercase file:tracking-wide file:text-white hover:border-blue-500 focus:outline-none" />
            </div>
            <button id="upload-button" type="submit" class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-60">
              <i data-lucide="upload-cloud" class="h-4 w-4"></i>
              <span>Upload &amp; dedupe</span>
            </button>
          </form>
          <p class="text-xs leading-relaxed text-slate-400">Expected headers: name, category, phone, address, city, state, zip, lat, lng, website, metadata. All other columns are stored inside metadata and the RPC prevents duplicates.</p>
        </section>
      </section>
    </div>
  </main>

  <template id="dataset-card-template">
    <div class="flex h-full flex-col gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/70 hover:border-slate-700 transition-colors">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wide text-blue-200" data-dataset-scope></p>
          <p class="text-lg font-bold text-white" data-dataset-title></p>
          <p class="text-xs text-slate-400" data-dataset-description></p>
        </div>
        <span class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300" data-dataset-status>Table</span>
      </div>
      <div class="grid grid-cols-2 gap-3 text-sm text-slate-200">
        <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
          <p class="text-lg font-black" data-dataset-rows>--</p>
          <p class="text-[11px] uppercase tracking-wide text-slate-500">Live Rows</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
          <p class="text-lg font-black text-emerald-200" data-dataset-columns>--</p>
          <p class="text-[11px] uppercase tracking-wide text-slate-500">Columns</p>
        </div>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 text-xs text-slate-300">
        <p class="font-semibold text-white">Database Signal</p>
        <p class="mt-1 leading-relaxed" data-dataset-signal>Fetching live stats...</p>
      </div>
    </div>
  </template>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';

    // --- MAPPING: Frontend Keys to Actual Supabase Tables ---
    const DATASETS = [
      {
        table: 'Services',
        scope: 'Partners',
        title: 'Service Providers',
        description: 'Unified services directory filtered by category values (Towing, Tires Services, dealer/auction, Repair Shop, Locksmiths, inspector, GPS Technician, Dispatcher).',
        displayName: 'Services'
      },
      {
        table: 'vehicles',
        scope: 'Fleet',
        title: 'Vehicles',
        description: 'Live vehicle and asset records.',
        displayName: 'vehicles'
      }
    ];

    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const REQUIRED_COLUMNS = ['name', 'category'];
    const KNOWN_COLUMNS = ['name', 'category', 'phone', 'address', 'city', 'state', 'zip', 'lat', 'lng', 'website', 'metadata'];

    const formatRelativeTime = (dateString) => {
      if (!dateString) return 'Unknown';
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return 'Unknown';
      return new Intl.DateTimeFormat('en', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' }).format(date);
    };

    // --- FETCH FUNCTION: Queries Real Tables (Not Storage) ---
    const getTableStats = async (dataset) => {
      // 1. Get Count (Head only, fast)
      const { count, error: countError } = await supabaseClient
        .from(dataset.table)
        .select('*', { count: 'exact', head: true });

      if (countError) {
        console.warn(`Could not fetch stats for ${dataset.table}`, countError);
        return { rows: 0, columns: 0, lastUpdated: null };
      }

      // 2. Get 1 row to count columns and check for 'created_at'
      const { data, error: dataError } = await supabaseClient
        .from(dataset.table)
        .select('*')
        .limit(1);

      let columnCount = 0;
      let lastUpdated = null;

      if (data && data.length > 0) {
        columnCount = Object.keys(data[0]).length;
        // Try to find a date field for "Last Updated"
        lastUpdated = data[0].created_at || data[0].updated_at || null; 
      }

      return { rows: count || 0, columns: columnCount, lastUpdated };
    };

    const renderActivityLog = (activities) => {
      const container = document.getElementById('activity-log');
      if (!container) return;
      container.innerHTML = '';

      if (activities.length === 0) {
        container.innerHTML = '<li class="text-slate-500 italic text-xs">No recent activity detected.</li>';
        return;
      }

      activities.slice(0, 4).forEach((item) => {
        const row = document.createElement('li');
        row.className = 'flex items-center justify-between gap-3 rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2';
        row.innerHTML = `
          <div class="flex items-center gap-2">
             <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
             <span class="font-semibold text-white text-xs">${item.table} verified</span>
          </div>
          <span class="text-[10px] uppercase tracking-wide text-slate-400">${item.rows} rows</span>
        `;
        container.appendChild(row);
      });
    };

    const renderDatasetCard = async (dataset) => {
      const template = document.getElementById('dataset-card-template');
      const clone = template.content.firstElementChild.cloneNode(true);
      const els = {
        scope: clone.querySelector('[data-dataset-scope]'),
        title: clone.querySelector('[data-dataset-title]'),
        description: clone.querySelector('[data-dataset-description]'),
        status: clone.querySelector('[data-dataset-status]'),
        rows: clone.querySelector('[data-dataset-rows]'),
        columns: clone.querySelector('[data-dataset-columns]'),
        signal: clone.querySelector('[data-dataset-signal]'),
      };

      els.scope.textContent = dataset.scope;
      els.title.textContent = dataset.title;
      els.description.textContent = dataset.description;

      // Fetch Real Data
      const stats = await getTableStats(dataset);

      els.rows.textContent = stats.rows.toLocaleString();
      els.columns.textContent = stats.columns;
      
      if (stats.rows > 0) {
          els.status.textContent = "Active";
          els.status.className = "rounded-full border border-emerald-600 bg-emerald-600/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-200";
          els.signal.textContent = `Connected to live table. ${stats.columns} fields mapped.`;
      } else {
          els.status.textContent = "Empty";
          els.signal.textContent = "Table exists but contains no records.";
      }

      return { card: clone, stats: { ...stats, table: dataset.displayName } };
    };

    const toNumber = (value) => {
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    };

    const mapCsvRow = (row) => {
      const normalized = Object.entries(row || {}).reduce((acc, [key, val]) => {
        acc[key.trim()] = typeof val === 'string' ? val.trim() : val;
        return acc;
      }, {});

      const metadata = Object.entries(normalized).reduce((acc, [key, val]) => {
        if (!KNOWN_COLUMNS.includes(key.toLowerCase()) && val !== undefined && val !== null && `${val}`.trim() !== '') {
          acc[key] = val;
        }
        return acc;
      }, {});

      const lat = toNumber(normalized.lat ?? normalized.latitude ?? normalized.Lat ?? normalized.Latitude);
      const lng = toNumber(normalized.lng ?? normalized.longitude ?? normalized.Lng ?? normalized.Longitude);

      return {
        name: normalized.name ?? normalized.company ?? normalized.Company ?? '',
        category: (normalized.category ?? normalized.Category ?? '').trim(),
        phone: normalized.phone ?? normalized.Phone ?? '',
        address: normalized.address ?? normalized.Address ?? '',
        city: normalized.city ?? normalized.City ?? '',
        state: normalized.state ?? normalized.State ?? '',
        zip: normalized.zip ?? normalized.Zip ?? '',
        lat,
        lng,
        website: normalized.website ?? normalized.Website ?? '',
        metadata: Object.keys(metadata).length ? metadata : null,
      };
    };

    const uploadCsvRows = async (rows) => {
      const mapped = rows
        .map(mapCsvRow)
        .filter((row) => REQUIRED_COLUMNS.every((key) => row[key] && `${row[key]}`.trim() !== ''));

      if (!mapped.length) {
        alert('No valid rows detected. Please ensure at least name and category are present.');
        return;
      }

      const { data, error } = await supabaseClient.rpc('importar_partners_sin_duplicados', {
        nuevos_datos: mapped,
      });

      if (error) {
        throw error;
      }

      const result = data || {};
      alert(
        'Upload Result:\nSaved: ' + (result.insertados ?? 0) +
        '\nDuplicates Skipped: ' + (result.duplicados ?? 0) +
        '\nErrors: ' + (result.errores ?? 0)
      );
    };

    const wireCsvUpload = () => {
      const form = document.getElementById('csv-upload-form');
      const fileInput = document.getElementById('csv-file');
      const submitBtn = document.getElementById('upload-button');

      if (!form || !fileInput || !submitBtn) return;

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const file = fileInput.files?.[0];
        if (!file) {
          alert('Please select a CSV file to upload.');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Uploading…</span>';

        window.Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: async (results) => {
            try {
              if (results.errors?.length) {
                throw new Error(results.errors[0].message);
              }
              await uploadCsvRows(results.data || []);
            } catch (err) {
              alert('Upload failed: ' + err.message);
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; dedupe</span>';
              lucide.createIcons();
            }
          },
          error: (err) => {
            alert('CSV parse error: ' + err.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload &amp; dedupe</span>';
            lucide.createIcons();
          },
        });
      });
    };

    const mount = async () => {
      const container = document.getElementById('datasets');
      let totalRows = 0;
      let activities = [];

      for (const dataset of DATASETS) {
        const { card, stats } = await renderDatasetCard(dataset);
        container.appendChild(card);
        totalRows += stats.rows;
        if(stats.rows > 0) activities.push(stats);
      }

      // Update Top Summary
      document.getElementById('dataset-count').textContent = DATASETS.length;
      document.getElementById('records-count').textContent = totalRows.toLocaleString();
      
      renderActivityLog(activities);
      lucide.createIcons();
    };

    createConstellationBackground();
    mount();
    wireCsvUpload();
  </script>
</div>
</body>
</html>
