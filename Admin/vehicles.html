<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>TechLoc • Vehicles Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="module" src="../assets/scripts/supabaseClient.js"></script>

  <script type="module" src="../assets/scripts/authManager.js"></script>

  <script type="module" src="../assets/scripts/admin-auth.js"></script>

  <script src="../assets/scripts/datasets.js"></script>

  <script>

    tailwind.config = {

      theme: {

        extend: {

          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },

          colors: { slate: { 950: '#020617' } },

        },

      },

    };

  </script>

  <link rel="stylesheet" href="../assets/visuals/theme.css" />
  <style>
    .admin-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgb(148 163 184);
      position: relative;
      user-select: none;
    }
    .admin-table td {
      font-size: 12px;
      line-height: 1.35rem;
      word-break: break-word;
    }
    .admin-table .header-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: text;
    }
    .admin-table .header-label:hover {
      color: #e2e8f0;
    }
    .admin-table .header-controls {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .admin-table .header-actions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: rgb(148 163 184);
    }
    .admin-table .header-actions button {
      width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 150ms ease, color 150ms ease;
    }
    .admin-table .header-actions button:hover {
      background-color: rgba(51, 65, 85, 0.7);
      color: #e2e8f0;
    }
    .admin-table th.drag-over {
      outline: 2px dashed rgba(37, 99, 235, 0.5);
      outline-offset: -3px;
    }
    .column-resizer {
      position: absolute;
      top: 0;
      right: -4px;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
    }
    .filter-popover {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      min-width: 180px;
      border-radius: 12px;
      border: 1px solid rgba(30, 41, 59, 0.8);
      background: rgba(2, 6, 23, 0.95);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
      padding: 10px;
    }
    .filter-popover label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      color: rgb(148 163 184);
      font-weight: 700;
    }
    .filter-popover select {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(51, 65, 85, 0.9);
      color: #e2e8f0;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      font-size: 12px;
    }
  </style>

</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

  <div class="sticky top-0 z-50 space-y-px">

    <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">

    <div class="flex items-center justify-between px-6 py-4 lg:px-10">

      <a href="../index.html" class="flex items-center gap-3">

        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">

          <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>

        </div>

        <div>

          <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Admin</p>

          <h1 class="text-base font-black leading-tight text-white">Inspectors</h1>

        </div>

      </a>

      <div class="flex flex-wrap items-center justify-end gap-3">

        <nav class="hidden items-center gap-2 text-sm font-semibold text-slate-200 md:flex">

          <a id="nav-home" href="../index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>

          <a id="nav-control-view" href="../vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Control View</a>

          <a id="nav-dashboard" href="./index.html" data-dashboard-link class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Dashboard</a>

        </nav>

        <div class="flex items-center gap-2">
          <button id="nav-logout" data-admin-logout="true" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
        </div>

      </div>

    </div>

  </header>
  <nav class="border-b border-slate-800 bg-slate-900/70 backdrop-blur">
    <div class="mx-auto flex max-w-7xl flex-wrap items-center gap-2 px-6 py-3 lg:px-10">
      <span class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Admin navigation</span>
      <div class="flex flex-wrap items-center gap-1">
        <a href="./index.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Dashboard</a>
        <a href="./profiles.html" data-admin-only class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Profiles</a>
        <a href="./services.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Services</a>
        <a href="./titles.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Titles</a>
        <a href="./vehicles.html" class="rounded-lg border border-blue-500 bg-blue-600/90 px-4 py-2 text-xs font-semibold text-white shadow shadow-blue-500/30 transition">Vehicles</a>
        <a href="./analytics.html" class="rounded-lg border border-slate-800/60 px-4 py-2 text-xs font-semibold text-slate-300 transition hover:bg-slate-800 hover:text-white">Analytics</a>
      </div>
    </div>
  </nav>

  </div>



  <canvas id="constellation-canvas" class="pointer-events-none fixed inset-0 -z-10"></canvas>



    <main class="w-full px-6 py-8 lg:px-10 space-y-8">
      <section class="space-y-8">

          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">

            <div>

              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Fleet controls</p>

              <h2 class="text-2xl font-black text-white">Vehicle inventory and GPS health</h2>

              <p class="text-sm text-slate-400">Review units, spot risky statuses, and prepare data replacements.</p>

            </div>

            <div class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300">

              <i data-lucide="file-up" class="h-4 w-4"></i>

              <span id="dataset-status">Bundled asset</span>

            </div>

          </div>



          <section class="grid gap-3 sm:grid-cols-3">

            <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">

              <p class="text-sm font-semibold text-slate-300">Records</p>

              <p id="vehicle-total" class="text-3xl font-black text-white">-</p>

            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">

              <p class="text-sm font-semibold text-slate-300">GPS issues</p>

              <p id="vehicle-gps" class="text-3xl font-black text-amber-300">-</p>

            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">

              <p class="text-sm font-semibold text-slate-300">States covered</p>

              <p id="vehicle-states" class="text-3xl font-black text-emerald-300">-</p>

            </div>

          </section>



          <section class="space-y-3 rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/60">

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">

              <div>

                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Inventory</p>

                <h3 class="text-lg font-bold text-white">Vehicle list</h3>

              </div>

              <div class="flex flex-col items-stretch gap-2 sm:flex-row sm:flex-wrap sm:items-center sm:justify-end">

                <div class="flex flex-wrap gap-2">

                  <input id="search" type="search" placeholder="Search by model, VIN, or city" class="w-72 rounded-full border border-slate-700 bg-slate-950/70 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none" />

                  <a id="template-download" href="#" download class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white">

                    <i data-lucide="download" class="h-4 w-4"></i>

                    Download data

                  </a>

                  <form id="csv-upload-form" class="flex flex-col gap-2 rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 md:flex-row md:items-center md:gap-3 md:rounded-full md:py-1">
                    <label for="csv-upload-input" class="inline-flex cursor-pointer items-center gap-2 rounded-full px-2 py-1 transition hover:text-white">
                      <i data-lucide="file-up" class="h-4 w-4"></i>
                      <span id="csv-upload-label">Select CSV</span>
                      <input id="csv-upload-input" type="file" accept=".csv" class="hidden" />
                    </label>
                    <button id="csv-upload-button" type="submit" class="rounded-full bg-blue-600 px-3 py-1 text-white transition hover:bg-blue-500">Upload</button>
                    <span id="csv-upload-status" class="text-[10px] font-semibold normal-case text-slate-400">Supabase import with dedupe</span>
                    <div id="upload-progress" class="hidden w-full rounded-full border border-slate-800/60 bg-slate-950/70 px-2 py-1 text-[10px] font-semibold normal-case text-slate-200 md:w-64">
                      <div class="relative h-2 overflow-hidden rounded-full bg-slate-800/80">
                        <div id="upload-progress-bar" class="absolute inset-y-0 left-0 w-0 rounded-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-600 transition-[width]" style="transition-duration:200ms"></div>
                      </div>
                      <div id="upload-progress-label" class="mt-1 text-[10px] font-semibold text-slate-300">0% Ready to upload</div>
                    </div>
                  </form>

                </div>

              </div>

            </div>

            <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/40">

              <table class="min-w-full table-fixed divide-y divide-slate-800 text-xs leading-tight admin-table">

                <thead id="table-head" class="bg-slate-950/60 text-slate-300"></thead>

                <tbody id="table-body" class="divide-y divide-slate-800 bg-slate-950/40"></tbody>

              </table>

            </div>

            <div class="flex flex-col gap-3 rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">

              <p id="pagination-summary" class="text-sm text-slate-300">Showing 0-0 of 0</p>

              <div class="flex items-center gap-2">

                <button id="prev-page" class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 disabled:cursor-not-allowed disabled:opacity-60" disabled>

                  <i data-lucide="chevron-left" class="h-4 w-4"></i>

                  Prev

                </button>

                <span id="page-indicator" class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200">1 / 1</span>

                <button id="next-page" class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 disabled:cursor-not-allowed disabled:opacity-60" disabled>

                  Next

                  <i data-lucide="chevron-right" class="h-4 w-4"></i>

                </button>

              </div>

            </div>

          </section>

  

      </section>

  </main>



  <script type="module">

    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    import { supabase as supabaseClient } from '../assets/scripts/supabaseClient.js';



    const setupDashboardDropdown = () => {

      document.querySelectorAll('[data-dropdown]').forEach((dropdown) => {

        const trigger = dropdown.querySelector('[data-dropdown-trigger]');

        const menu = dropdown.querySelector('[data-dropdown-menu]');

        if (!trigger || !menu) return;



        let hideTimeout;



        const showMenu = () => {

          clearTimeout(hideTimeout);

          menu.classList.remove('hidden');

        };



        const scheduleHide = () => {

          hideTimeout = setTimeout(() => {

            menu.classList.add('hidden');

          }, 500);

        };



        dropdown.addEventListener('mouseenter', showMenu);

        dropdown.addEventListener('mouseleave', scheduleHide);

        trigger.addEventListener('focus', showMenu);

        trigger.addEventListener('blur', (event) => {

          if (!dropdown.contains(event.relatedTarget)) {

            scheduleHide();

          }

        });

        menu.addEventListener('focusin', showMenu);

        menu.addEventListener('focusout', (event) => {

          if (!dropdown.contains(event.relatedTarget)) {

            scheduleHide();

          }

        });

      });

    };



    const ADMIN_ROLE = 'administrator';
    const CHANGE_LOG_TABLE = 'admin_change_log';

    const actor = { id: 'anon', email: '' };

    const DATASET = { key: 'vehicles', path: getDatasetPath('vehicles') };

    const templateDownload = document.getElementById('template-download');

    if (templateDownload) templateDownload.href = DATASET.path;

    const localKey = (suffix = 'csv') => `techloc:dataset:${DATASET.key}:${suffix}`;

    const normalizeHeader = (header = '') => {
      const aliases = {
        'deal status': 'deal_status',
        'deal_status': 'deal_status',
        'dealstatus': 'deal_status',
        'customer id': 'customer_id',
        'customerid': 'customer_id',
        'unit type': 'unit_type',
        'unittype': 'unit_type',
        'model year': 'model_year',
        'modelyear': 'model_year',
        'model': 'model',
        'shortvin': 'shortvin',
        'short vin': 'shortvin',
        'short_vin': 'shortvin',
        'inv. prep. stat.': 'inv_prep_stat',
        'inv prep stat': 'inv_prep_stat',
        'inv_prep_stat': 'inv_prep_stat',
        'deal completion': 'deal_completion',
        'gps fix': 'gps_fix',
        'gps fix reason': 'gps_fix_reason',
        'pt status': 'pt_status',
        'pt_status': 'pt_status',
        'pt serial ': 'pt_serial',
        'pt serial': 'pt_serial',
        'pt_serial': 'pt_serial',
        'encore serial': 'encore_serial',
        'moving': 'moving',
        'pt last read': 'pt_last_read',
        'pt_last_read': 'pt_last_read',
        'state loc': 'state_loc',
        'state_loc': 'state_loc',
        'pt city': 'pt_city',
        'pt_city': 'pt_city',
        'pt zipcode': 'pt_zipcode',
        'pt zip code': 'pt_zipcode',
        'pt_zipcode': 'pt_zipcode',
        'lat': 'lat',
        'latitude': 'lat',
        'long': 'long',
        'lng': 'long',
        'longitude': 'long',
      };

      const trimmed = header.trim();
      const lowerTrimmed = trimmed.toLowerCase();
      if (aliases[lowerTrimmed]) return aliases[lowerTrimmed];

      return trimmed
        .replace(/([a-z0-9])([A-Z])/g, '$1_$2')
        .replace(/[^A-Za-z0-9]+/g, '_')
        .replace(/_+/g, '_')
        .toLowerCase();
    };

    const parseCsvLine = (line = '') => {

      const values = [];

      let current = '';

      let inQuotes = false;



      for (let i = 0; i < line.length; i += 1) {

        const char = line[i];

        if (char === '"') {

          if (inQuotes && line[i + 1] === '"') {

            current += '"';

            i += 1;

            continue;

          }

          inQuotes = !inQuotes;

        } else if (char === ',' && !inQuotes) {

          values.push(current);

          current = '';

        } else {

          current += char;

        }

      }



      values.push(current);

      return values.map((value) => value.replace(/^"|"$/g, '').replace(/""/g, '"'));

    };

    const parseCsvText = (text = '') => {

      const rawLines = text.split(/\r?\n/);

      const records = [];

      let buffer = '';

      let inQuotes = false;



      const flushRecord = () => {

        if (buffer.length === 0) return;

        records.push(buffer);

        buffer = '';

      };



      rawLines.forEach((line, lineIndex) => {

        const segment = buffer ? `\n${line}` : line;

        buffer += segment;



        for (let i = 0; i < line.length; i += 1) {

          if (line[i] !== '"') continue;

          const isEscaped = line[i + 1] === '"';

          if (!isEscaped) {

            inQuotes = !inQuotes;

          } else {

            i += 1; // skip escaped quote

          }

        }



        if (!inQuotes) {

          flushRecord();

        }



        if (lineIndex === rawLines.length - 1 && buffer) {

          flushRecord();

        }

      });



      let headerRecord = records.shift() || '';

      let headerValues = parseCsvLine(headerRecord);

      const valueRecords = records.map((record) => parseCsvLine(record)).filter((values) => values.length);

      const targetColumns = Math.max(headerValues.length, ...valueRecords.map((values) => values.length));

      while (headerValues.length < targetColumns && records.length) {

        const nextPiece = records.shift();

        const separator = headerRecord.endsWith(',') ? '' : ',';

        headerRecord = `${headerRecord}${separator}${nextPiece}`;

        headerValues = parseCsvLine(headerRecord);

      }



      const rows = records

        .filter(Boolean)

        .map((record) => {

          const values = parseCsvLine(record);

          return Object.fromEntries(headerValues.map((header, idx) => [header.trim(), (values[idx] || '').trim()]));

        });

      return { headers: headerValues, rows };

    };

    const normalizeRows = (rows = []) => rows.map((row) => Object.entries(row).reduce((acc, [key, value]) => {

      const normalizedKey = normalizeHeader(key);

      acc[normalizedKey] = (value || '').trim();

      return acc;

    }, {}));



    const loadDataset = async () => {

      const override = localStorage.getItem(localKey());

      if (override) {

        document.getElementById('dataset-status').textContent = 'Using uploaded data';

        return override;

      }

      const response = await fetch(DATASET.path);

      document.getElementById('dataset-status').textContent = 'Bundled asset';

      return response.text();

    };



    const renderTable = (rows) => {

      const allowEdit = isAdminUser();

      els.tableBody.innerHTML = '';

      els.tableHead.innerHTML = '';



      const headerRow = document.createElement('tr');

      if (allowEdit) {

        const editHeader = document.createElement('th');

        editHeader.className = 'px-3 py-2 text-left text-xs font-semibold whitespace-nowrap';

        editHeader.textContent = '';

        headerRow.appendChild(editHeader);

      } else {

        const readOnlyHeader = document.createElement('th');

        readOnlyHeader.className = 'px-3 py-2 text-left text-xs font-semibold whitespace-nowrap text-slate-500';

        readOnlyHeader.textContent = 'Access';

        headerRow.appendChild(readOnlyHeader);

      }

      state.headers.forEach((header) => {

        const th = document.createElement('th');

        th.className = 'px-3 py-2 text-left font-semibold whitespace-nowrap bg-slate-950/80 border-b border-slate-800';
        th.dataset.header = header;
        const storedWidth = state.columnWidths[header];
        if (storedWidth) th.style.width = storedWidth;

        const headerControls = document.createElement('div');
        headerControls.className = 'header-controls';

        const labelBtn = document.createElement('button');
        labelBtn.type = 'button';
        labelBtn.className = 'header-label text-[11px] font-semibold text-slate-300';
        labelBtn.title = 'Doble click para renombrar';
        labelBtn.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          renameHeader(header);
        });
        labelBtn.textContent = getHeaderLabel(header);
        headerControls.appendChild(labelBtn);

        const actions = document.createElement('div');
        actions.className = 'header-actions';

        const sortBtn = document.createElement('button');
        sortBtn.type = 'button';
        sortBtn.title = 'Ordenar columna';
        const sortIcon = document.createElement('span');
        const isSorted = state.filters.sortKey === header;
        sortIcon.textContent = isSorted ? (state.filters.sortDir === 'asc' ? '↑' : '↓') : '⇅';
        sortBtn.appendChild(sortIcon);
        sortBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleSortForHeader(header);
        });
        actions.appendChild(sortBtn);

        const filterableKey = getFilterableKey(header);
        if (filterableKey) {
          const filterWrapper = document.createElement('div');
          filterWrapper.className = 'relative';
          const filterBtn = document.createElement('button');
          filterBtn.type = 'button';
          filterBtn.title = 'Filtrar columna';
          const filterIcon = document.createElement('span');
          filterIcon.textContent = state.filters.columnFilters[header] ? '●' : '⧉';
          filterBtn.appendChild(filterIcon);

          const filterPopover = document.createElement('div');
          filterPopover.className = 'filter-popover hidden';
          const label = document.createElement('label');
          label.textContent = `Filtrar ${FILTERABLE_KEYS[filterableKey]}`;
          filterPopover.appendChild(label);
          const select = document.createElement('select');
          const optionAll = document.createElement('option');
          optionAll.value = 'all';
          optionAll.textContent = 'Mostrar todos';
          select.appendChild(optionAll);
          getFilterOptionsForHeader(header).forEach((value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value.toUpperCase();
            select.appendChild(option);
          });
          select.value = state.filters.columnFilters[header] || 'all';
          select.addEventListener('change', (event) => {
            setColumnFilter(header, event.target.value);
            document.removeEventListener('click', closePopover);
            filterPopover.classList.add('hidden');
          });
          filterPopover.appendChild(select);
          filterWrapper.appendChild(filterBtn);
          filterWrapper.appendChild(filterPopover);

          const closePopover = (event) => {
            if (!filterWrapper.contains(event.target)) {
              filterPopover.classList.add('hidden');
              document.removeEventListener('click', closePopover);
            }
          };

          filterBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const willOpen = filterPopover.classList.contains('hidden');
            filterPopover.classList.toggle('hidden');
            if (willOpen) {
              document.addEventListener('click', closePopover);
            } else {
              document.removeEventListener('click', closePopover);
            }
          });

          actions.appendChild(filterWrapper);
        }

        headerControls.appendChild(actions);
        th.appendChild(headerControls);

        const resizer = document.createElement('span');
        resizer.className = 'column-resizer';
        resizer.addEventListener('mousedown', (event) => {
          event.stopPropagation();
          const startX = event.clientX;
          const startWidth = th.offsetWidth;
          const columnIndex = Array.from(th.parentElement.children).indexOf(th);
          const handleMove = (moveEvent) => {
            const nextWidth = Math.max(90, startWidth + (moveEvent.clientX - startX));
            th.style.width = `${nextWidth}px`;
            state.columnWidths[header] = `${nextWidth}px`;
            els.tableBody.querySelectorAll('tr').forEach((row) => {
              const cell = row.children[columnIndex];
              if (cell) cell.style.width = `${nextWidth}px`;
            });
          };
          const handleUp = () => {
            document.removeEventListener('mousemove', handleMove);
            document.removeEventListener('mouseup', handleUp);
            saveColumnWidths();
          };
          document.addEventListener('mousemove', handleMove);
          document.addEventListener('mouseup', handleUp);
        });
        th.appendChild(resizer);

        th.draggable = true;
        th.addEventListener('dragstart', () => {
          state.draggingHeader = header;
        });
        th.addEventListener('dragover', (event) => {
          event.preventDefault();
          if (state.draggingHeader && state.draggingHeader !== header) {
            th.classList.add('drag-over');
          }
        });
        th.addEventListener('dragleave', () => th.classList.remove('drag-over'));
        th.addEventListener('drop', (event) => {
          event.preventDefault();
          th.classList.remove('drag-over');
          if (!state.draggingHeader || state.draggingHeader === header) return;
          const fromIndex = state.headers.indexOf(state.draggingHeader);
          const toIndex = state.headers.indexOf(header);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = state.headers.splice(fromIndex, 1);
          state.headers.splice(toIndex, 0, moved);
          state.draggingHeader = null;
          refreshTable();
        });
        th.addEventListener('dragend', () => {
          state.draggingHeader = null;
          th.classList.remove('drag-over');
        });

        headerRow.appendChild(th);

      });

      els.tableHead.appendChild(headerRow);



      state.pagination.pageSize = Math.max(1, rows.length);

      state.pagination.page = 1;

      const totalPages = Math.max(1, Math.ceil(rows.length / state.pagination.pageSize));

      if (state.pagination.page > totalPages) state.pagination.page = totalPages;

      const start = (state.pagination.page - 1) * state.pagination.pageSize;

      const end = Math.min(rows.length, start + state.pagination.pageSize);



      els.paginationSummary.textContent = rows.length

        ? `Showing ${start + 1}-${end} of ${rows.length}`

        : 'No entries to display';

      els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;

      els.prevPage.disabled = state.pagination.page === 1 || rows.length === 0;

      els.nextPage.disabled = state.pagination.page >= totalPages || rows.length === 0;



      rows.slice(start, end).forEach((row) => {

        const tr = document.createElement('tr');

        tr.className = 'transition hover:bg-slate-800/40';

        const actionCell = allowEdit
          ? [

              '<td class="px-2 py-2 align-top text-center">',

              '<button type="button" class="inline-flex items-center justify-center gap-1 rounded-lg border border-slate-700 bg-slate-900 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white">',

              '<i data-lucide="pencil" class="h-3 w-3"></i>',

              '<span class="sr-only">Edit row</span>',

              '</button>',

              '</td>',

            ].join('')
          : '<td class="px-2 py-2 align-top text-[10px] font-semibold uppercase tracking-wide text-slate-600">Read only</td>';

        const dataCells = state.headers.map((header, idx) => {

          const value = row[header] ?? '';

          const baseClass = 'px-2 py-2';
          const widthStyle = state.columnWidths[header] ? ` style="width:${state.columnWidths[header]}"` : '';

          if (idx === 0) {

            return `<td class="${baseClass} font-semibold text-white whitespace-normal leading-snug"${widthStyle}>${value || ''}</td>`;

          }

          return `<td class="${baseClass} text-slate-200 whitespace-normal leading-snug"${widthStyle}>${value || ''}</td>`;

        }).join('');

        tr.innerHTML = `${actionCell}${dataCells}`;

        els.tableBody.appendChild(tr);

      });

      lucide.createIcons();

    };



    const updateStats = (rows) => {

      const total = typeof state.remoteTotal === 'number' ? state.remoteTotal : rows.length;

      const gpsIssues = rows.filter((row) => String(getValue(row, 'GPS Fix', 'gps fix') || '').toLowerCase() !== 'all').length;

      const states = new Set(rows.map((r) => (getValue(r, 'State Loc', 'state loc') || '').trim()).filter(Boolean)).size;

      document.getElementById('vehicle-total').textContent = total.toLocaleString();

      document.getElementById('vehicle-gps').textContent = gpsIssues.toLocaleString();

      document.getElementById('vehicle-states').textContent = states;

    };



      const fetchVehiclesCount = async () => {

      if (!supabaseClient) return;

      try {

          const { count, error } = await supabaseClient

            .from('vehicles')

            .select('*', { count: 'exact', head: true });

        if (error) throw error;

        state.remoteTotal = typeof count === 'number' ? count : null;

        updateStats(state.rows);

      } catch (error) {

          console.error('Error fetching vehicles count:', error.message || error);

      }

    };



    const isAdminUser = () => (window.currentUserRole || '').toLowerCase() === ADMIN_ROLE;



    const mapVehicleRows = (rows = []) => {

      const normalizedRows = normalizeRows(rows);

      const deduped = new Map();

      normalizedRows.forEach((row) => {

        const key = row.short_vin || row.shortvin;

        if (!key) return;

        deduped.set(key, row);

      });

      return Array.from(deduped.values());

    };



    const hydrateActor = async () => {

      if (!supabaseClient) return;

      try {

        const { data } = await supabaseClient.auth.getSession();

        actor.id = data?.session?.user?.id || 'anon';

        actor.email = data?.session?.user?.email || '';

      } catch (error) {

        console.warn('Unable to load user session for change log', error?.message || error);

      }

    };



    const logChange = async ({ action = 'update', summary = '' } = {}) => {

      if (!supabaseClient) return;

      try {

        await supabaseClient.from(CHANGE_LOG_TABLE).insert([

          {

            table_name: 'vehicles',

            action,

            summary,

            actor: actor.email || actor.id || 'anon',

            created_at: new Date().toISOString(),

          },

        ]);

      } catch (error) {

        console.warn('Unable to record vehicle change', error?.message || error);

      }

    };



    const handleCsvUpload = async (file) => {

      if (!supabaseClient) throw new Error('Supabase client is not available.');

      if (!isAdminUser()) throw new Error('Only administrators can upload vehicle data.');

      updateUploadProgress(5, 'Reading CSV');

      const text = await file.text();

      updateUploadProgress(20, 'Parsing rows');

      const { rows } = parseCsvText(text);

      updateUploadProgress(40, 'Normalizing vehicles');

      const mapped = mapVehicleRows(rows);

      if (!mapped.length) throw new Error('No valid vehicle rows with ShortVIN found.');

      const conflictKey = 'short_vin';

      const conflictValues = mapped.map((row) => row[conflictKey]).filter(Boolean);

      if (!conflictValues.length) throw new Error('No ShortVIN column found in the CSV file.');

      updateUploadProgress(55, 'Removing duplicates');

      const { error: deleteError } = await supabaseClient

        .from('vehicles')

        .delete()

        .in(conflictKey, conflictValues);

      if (deleteError) throw deleteError;

      updateUploadProgress(75, 'Uploading to Supabase');

      const { error } = await supabaseClient

        .from('vehicles')

        .insert(mapped);

      if (error) throw error;

      updateUploadProgress(90, 'Refreshing counts');

      await fetchVehiclesCount();

      finishUploadProgress();

      logChange({
        action: 'bulk_upsert',
        summary: `Uploaded ${mapped.length} vehicle rows via CSV`,
      });

    };



    const getValue = (row = {}, ...keys) => {
      if (!row) return '';

      const lowerLookup = Object.keys(row).reduce((acc, key) => {

        acc[key.toLowerCase()] = key;

        return acc;

      }, {});

      for (const key of keys) {

        const direct = row[key];

        if (direct !== undefined) return direct;

        const matchKey = lowerLookup[key.toLowerCase()];

        if (matchKey !== undefined) return row[matchKey];

      }

      return '';

    };

    const applySearch = (rows, term) => {

      if (!term) return rows;

      const query = term.toLowerCase();

      return rows.filter((row) => [

        getValue(row, 'Model', 'model'),

        getValue(row, 'ShortVIN', 'Short VIN', 'shortvin', 'short vin'),

        getValue(row, 'PT City', 'pt city'),

        getValue(row, 'State Loc', 'state loc'),

      ]

        .some((value) => String(value || '').toLowerCase().includes(query)));

    };



    const getText = (value) => String(value || '').toLowerCase();



    const state = {

      headers: [],

      rows: [],

      columnLabels: {},

      filters: {

        search: '',

        sortKey: '',

        sortDir: 'asc',

        columnFilters: {},

      },

      columnWidths: {},

      draggingHeader: null,

      pagination: {

        page: 1,

        pageSize: 25,

      },

      remoteTotal: null,

    };

    const LABEL_STORAGE_KEY = 'techloc_vehicle_column_labels';
    const COLUMN_WIDTHS_KEY = 'techloc_vehicle_column_widths';
    const FILTERABLE_KEYS = {
      deal_status: 'Status',
      gps_fix: 'GPS Fix',
      state_loc: 'State',
    };

    const loadColumnLabels = () => {
      try { return JSON.parse(localStorage.getItem(LABEL_STORAGE_KEY)) || {}; } catch { return {}; }
    };
    const saveColumnLabels = () => {
      localStorage.setItem(LABEL_STORAGE_KEY, JSON.stringify(state.columnLabels || {}));
    };
    const loadColumnWidths = () => {
      try { return JSON.parse(localStorage.getItem(COLUMN_WIDTHS_KEY)) || {}; } catch { return {}; }
    };
    const saveColumnWidths = () => {
      localStorage.setItem(COLUMN_WIDTHS_KEY, JSON.stringify(state.columnWidths || {}));
    };
    const getHeaderLabel = (header) => state.columnLabels[header] || header;
    const renameHeader = (header) => {
      const current = getHeaderLabel(header);
      const next = prompt('Nuevo nombre de columna', current);
      if (next === null) return;
      const trimmed = next.trim();
      if (!trimmed) return;
      state.columnLabels[header] = trimmed;
      saveColumnLabels();
      refreshTable();
    };
    const getFilterableKey = (header) => {
      const normalized = normalizeHeader(header);
      return FILTERABLE_KEYS[normalized] ? normalized : null;
    };
    const getFilterOptionsForHeader = (header) => {
      const values = Array.from(
        new Set(
          state.rows
            .map((row) => getText(row[header]))
            .filter(Boolean),
        ),
      ).sort();
      return values;
    };
    const setColumnFilter = (header, value) => {
      if (!value || value === 'all') {
        delete state.filters.columnFilters[header];
      } else {
        state.filters.columnFilters[header] = value;
      }
      refreshTable();
    };
    const toggleSortForHeader = (header) => {
      if (state.filters.sortKey === header) {
        state.filters.sortDir = state.filters.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        state.filters.sortKey = header;
        state.filters.sortDir = 'asc';
      }
      refreshTable();
    };



    const els = {

      tableBody: document.getElementById('table-body'),

      tableHead: document.getElementById('table-head'),

      paginationSummary: document.getElementById('pagination-summary'),

      prevPage: document.getElementById('prev-page'),

      nextPage: document.getElementById('next-page'),

      pageIndicator: document.getElementById('page-indicator'),

      uploadForm: document.getElementById('csv-upload-form'),

      uploadInput: document.getElementById('csv-upload-input'),

      uploadLabel: document.getElementById('csv-upload-label'),

      uploadStatus: document.getElementById('csv-upload-status'),

      uploadButton: document.getElementById('csv-upload-button'),

      uploadProgress: document.getElementById('upload-progress'),

      uploadProgressBar: document.getElementById('upload-progress-bar'),

      uploadProgressLabel: document.getElementById('upload-progress-label'),

    };



    const setUploadAvailability = (allowed) => {

      const controls = [els.uploadInput, els.uploadButton];

      controls.forEach((control) => {

        if (!control) return;

        control.disabled = !allowed;

        control.classList.toggle('cursor-not-allowed', !allowed);

        control.classList.toggle('opacity-60', !allowed);

      });

      if (els.uploadStatus) {

        els.uploadStatus.textContent = allowed

          ? 'Supabase import with dedupe'

          : 'Admin role required to upload';

        els.uploadStatus.classList.toggle('text-amber-300', !allowed);

      }

    };



    const clampProgress = (value) => Math.min(100, Math.max(0, Math.round(value)));



    const resetUploadProgress = () => {

      if (els.uploadProgress) {

        els.uploadProgress.classList.add('hidden');

      }

      if (els.uploadProgressBar) {

        els.uploadProgressBar.style.width = '0%';

      }

      if (els.uploadProgressLabel) {

        els.uploadProgressLabel.textContent = '0% Ready to upload';

      }

    };



    const updateUploadProgress = (value, label = '') => {

      const clamped = clampProgress(value);

      if (els.uploadProgress) {

        els.uploadProgress.classList.remove('hidden');

      }

      if (els.uploadProgressBar) {

        els.uploadProgressBar.style.width = `${clamped}%`;

      }

      if (els.uploadProgressLabel) {

        const suffix = label ? ` ${label}` : ' Uploading';

        els.uploadProgressLabel.textContent = `${clamped}%${suffix}`;

      }

    };



    const finishUploadProgress = (label = 'Upload complete') => {

      updateUploadProgress(100, label);

      setTimeout(() => {

        resetUploadProgress();

      }, 2000);

    };



    const wireUploadForm = () => {

      if (!els.uploadForm || !els.uploadInput) return;

      setUploadAvailability(isAdminUser());

      window.addEventListener('auth:role-ready', (event) => {

        const role = (event.detail?.role || '').toLowerCase();

        setUploadAvailability(role === ADMIN_ROLE);

      });

      els.uploadInput.addEventListener('change', () => {

        const file = els.uploadInput.files?.[0];

        if (file && els.uploadLabel) {

          els.uploadLabel.textContent = file.name;

        }

      });



      els.uploadForm.addEventListener('submit', async (event) => {

        event.preventDefault();

        if (!isAdminUser()) {

          alert('You must be an administrator to upload vehicle data.');

          setUploadAvailability(false);

          return;

        }

        const file = els.uploadInput.files?.[0];

        if (!file) {

          alert('Please choose a CSV file before uploading.');

          return;

        }

        resetUploadProgress();

        updateUploadProgress(0, 'Preparing upload');

        if (els.uploadStatus) {

          els.uploadStatus.textContent = 'Uploading...';

          els.uploadStatus.classList.remove('text-emerald-300', 'text-red-300', 'text-amber-300');

        }

        try {

          await handleCsvUpload(file);

          if (els.uploadStatus) {

            els.uploadStatus.textContent = 'Upload complete (vehicles replaced).';

            els.uploadStatus.classList.add('text-emerald-300');

          }

        } catch (error) {

          console.error('Upload failed', error);

          updateUploadProgress(100, 'Upload failed');

          if (els.uploadStatus) {

            els.uploadStatus.textContent = 'Upload failed. Check console.';

            els.uploadStatus.classList.add('text-red-300');

          }

          alert(error.message || 'Failed to upload CSV.');

        }

      });

    };



    const applyFiltersAndSort = (rows) => {

      let result = [...rows];

      result = applySearch(result, state.filters.search);

      Object.entries(state.filters.columnFilters || {}).forEach(([header, value]) => {
        if (!value || value === 'all') return;
        result = result.filter((row) => getText(row[header]) === getText(value));
      });

      if (state.filters.sortKey) {
        result = result.sort((a, b) => {
          const comparison = getText(a[state.filters.sortKey]).localeCompare(getText(b[state.filters.sortKey]));
          return state.filters.sortDir === 'asc' ? comparison : -comparison;
        });
      }

      return result;

    };



    const refreshTable = () => {

      const filtered = applyFiltersAndSort(state.rows);

      renderTable(filtered);

    };



    const mount = async () => {

      wireUploadForm();

      await hydrateActor();

      const text = await loadDataset();

      const { headers, rows } = parseCsvText(text);

      state.headers = headers;
      state.columnLabels = loadColumnLabels();
      state.columnWidths = loadColumnWidths();

      state.rows = rows;

      state.pagination.page = 1;

      await fetchVehiclesCount();

      updateStats(rows);



      const handleFiltersChange = () => {

        state.pagination.page = 1;

        refreshTable();

      };



      document.getElementById('search').addEventListener('input', (event) => {

        state.filters.search = event.target.value;

        handleFiltersChange();

      });

      refreshTable();

      lucide.createIcons();

    };



    els.prevPage.addEventListener('click', () => {

      if (state.pagination.page === 1) return;

      state.pagination.page -= 1;

      refreshTable();

    });



    els.nextPage.addEventListener('click', () => {

      const filtered = applyFiltersAndSort(state.rows);

      const totalPages = Math.max(1, Math.ceil(filtered.length / state.pagination.pageSize));

      if (state.pagination.page >= totalPages) return;

      state.pagination.page += 1;

      renderTable(filtered);

    });



    createConstellationBackground();

    setupDashboardDropdown();

    mount();

  </script>

</body>

</html>
