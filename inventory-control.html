<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Inventory Control</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { slate: { 950: '#020617' } },
          boxShadow: { dashboard: '0 20px 60px rgba(15, 23, 42, 0.45)' },
        },
      },
    };
  </script>

  <style>
    :root {
      --pad-1: 0.5rem;
      --pad-2: 0.75rem;
      --gap-1: 0.5rem;
      --gap-2: 0.75rem;
      --radius: 0.75rem;
      --text-xs: 0.7rem;
      --text-sm: 0.8rem;
      --text-base: 0.9rem;
    }

    body[data-density="compact"] .p-4 { padding: var(--pad-2) !important; }
    body[data-density="compact"] .p-6 { padding: calc(var(--pad-2) + 0.25rem) !important; }
    body[data-density="compact"] .py-6 { padding-top: calc(var(--pad-2) + 0.25rem) !important; padding-bottom: calc(var(--pad-2) + 0.25rem) !important; }
    body[data-density="compact"] .py-8 { padding-top: calc(var(--pad-2) + 0.5rem) !important; padding-bottom: calc(var(--pad-2) + 0.5rem) !important; }
    body[data-density="compact"] .gap-4 { gap: var(--gap-2) !important; }
    body[data-density="compact"] .gap-6 { gap: calc(var(--gap-2) + 0.5rem) !important; }
    body[data-density="compact"] .rounded-3xl { border-radius: 1rem !important; }
    body[data-density="compact"] .rounded-2xl { border-radius: var(--radius) !important; }
    body[data-density="compact"] .h-9 { height: 2rem !important; }
    body[data-density="compact"] .h-16 { height: 3rem !important; }
    body[data-density="compact"] .text-xl { font-size: calc(var(--text-base) + 0.125rem) !important; line-height: 1.4 !important; }
    body[data-density="compact"] .text-lg { font-size: var(--text-base) !important; line-height: 1.4 !important; }
    body[data-density="compact"] .text-base { font-size: var(--text-sm) !important; }
    body[data-density="compact"] .text-sm { font-size: var(--text-xs) !important; }
  </style>

  <link rel="stylesheet" href="assets/visuals/theme.css" />
</head>

<body class="min-h-screen bg-slate-950 font-sans text-slate-50" data-density="compact">
      <div class="pointer-events-none fixed inset-0 z-10 opacity-50 mix-blend-screen">
        <canvas id="constellation-canvas" class="h-full w-full"></canvas>
      </div>

  <header class="relative z-20 border-b border-slate-800 bg-slate-950/80 backdrop-blur">
    <div class="mx-auto flex max-w-6xl flex-col gap-4 px-6 py-4 md:flex-row md:items-center md:gap-4">
      <div class="flex items-center justify-between gap-4 md:flex-none">
        <a href="index.html" class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-blue-700 shadow-lg shadow-blue-500/30">
            <span class="text-xs font-black uppercase tracking-[0.18em] text-white">TL</span>
          </div>
          <div>
            <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-blue-200">TechLoc Network</p>
            <h1 class="text-base font-black leading-tight text-white">Inventory Control</h1>
          </div>
        </a>

        <button id="mobile-menu-toggle" class="inline-flex items-center justify-center rounded-2xl border border-slate-800 bg-slate-900/70 p-2 text-slate-200 transition hover:border-blue-500 hover:text-white md:hidden" aria-label="Toggle navigation" aria-expanded="false">
          <i data-lucide="menu" class="h-5 w-5"></i>
        </button>
      </div>

      <div id="primary-nav" class="hidden flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-900/90 p-4 text-sm font-semibold text-slate-200 shadow-lg shadow-blue-900/20 md:flex md:flex-1 md:flex-row md:items-center md:gap-4 md:border-0 md:bg-transparent md:p-0 md:shadow-none">
        <nav class="flex flex-col gap-2 md:flex-row md:items-center md:justify-center md:flex-1 md:gap-2">
          <a id="nav-home" href="index.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Home</a>
          <a id="nav-control-view" href="vehicles.html" class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800 md:inline-flex">Control Map</a>
          <div class="relative group">
            <a id="nav-inventory-control" href="inventory-control.html" class="rounded-full px-3 py-1 bg-blue-600 text-white shadow shadow-blue-500/20">Inventory Control</a>
            <div class="absolute left-0 top-full z-20 mt-2 w-48 rounded-2xl border border-slate-800 bg-slate-950/95 p-2 text-xs font-semibold text-slate-200 shadow-lg shadow-blue-900/20 opacity-0 pointer-events-none transition group-hover:opacity-100 group-hover:pointer-events-auto group-focus-within:opacity-100 group-focus-within:pointer-events-auto">
              <a id="nav-services" href="services-request.html" class="block rounded-xl px-3 py-2 transition hover:bg-slate-800 hover:text-white">Service Requests</a>
            </div>
          </div>
          <a id="nav-dashboard" href="Admin/index.html" data-dashboard-link aria-hidden="true" tabindex="-1"
             class="hidden rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800 md:inline-flex">
            Dashboard
          </a>
          <a id="nav-about" href="about.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">About Us</a>
          <a id="nav-contact" href="contact.html" class="rounded-full px-3 py-1 transition-colors hover:text-white hover:bg-slate-800">Contact</a>
        </nav>

        <div class="flex flex-col gap-3 border-t border-slate-800 pt-3 md:flex-row md:items-center md:gap-3 md:border-0 md:pt-0 md:flex-none md:justify-end" data-admin-actions>
          <a id="nav-login" href="login.html" class="rounded-full border border-blue-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100 transition hover:bg-blue-600 hover:text-white">Login</a>
          <button id="nav-logout" type="button" class="hidden rounded-full border border-red-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-red-100 transition hover:border-red-400 hover:text-white">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="relative z-20 mx-auto flex w-full max-w-none flex-1 flex-col gap-4 px-6 py-6">

    <!-- Debug banner (solo aparece si hay error) -->
    <section id="debug-banner" class="hidden rounded-3xl border border-rose-800/60 bg-rose-950/40 p-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-[10px] uppercase tracking-[0.3em] text-rose-200/80">Data / Supabase Debug</p>
          <h3 class="text-lg font-bold text-white">No se pudieron cargar datos</h3>
          <p id="debug-text" class="mt-1 text-sm text-rose-100/80"></p>
        </div>
        <button id="debug-copy" type="button"
                class="rounded-full border border-rose-400/30 bg-rose-900/30 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-rose-100 transition hover:border-rose-300 hover:text-white">
          Copy error
        </button>
      </div>
      <pre id="debug-pre" class="mt-4 max-h-64 overflow-auto rounded-2xl border border-rose-400/20 bg-black/30 p-3 text-xs text-rose-100/90"></pre>
    </section>

    <section class="p-4">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-blue-300">Inventory Intelligence</p>
          <h2 class="text-xl font-black text-white md:text-2xl">Fleet Asset Visibility</h2>
          <p class="mt-2 text-sm text-slate-300">
            Power BI-style monitoring for inventory health, utilization, and recovery signals.
          </p>
        </div>
        <div class="flex flex-wrap gap-3">
          <div class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs font-semibold text-slate-200">
            <span id="connection-dot" class="h-2.5 w-2.5 rounded-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.8)]"></span>
            <span id="connection-status">Booting…</span>
          </div>
        </div>
      </div>

      <div class="mt-4 grid max-h-16 grid-cols-4 gap-2" aria-live="polite">
        <div class="flex h-12 flex-col justify-between rounded-xl border border-slate-800/70 bg-slate-950/40 px-3 py-2 shadow-none">
          <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Active Units</p>
          <p class="text-[18px] font-black leading-none text-white" data-metric="active">--</p>
          <span class="h-1 w-10 rounded-full bg-emerald-400/80"></span>
        </div>
        <div class="flex h-12 flex-col justify-between rounded-xl border border-slate-800/70 bg-slate-950/40 px-3 py-2 shadow-none">
          <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">On Hold</p>
          <p class="text-[18px] font-black leading-none text-white" data-metric="hold">--</p>
          <span class="h-1 w-10 rounded-full bg-amber-400/80"></span>
        </div>
        <div class="flex h-12 flex-col justify-between rounded-xl border border-slate-800/70 bg-slate-950/40 px-3 py-2 shadow-none">
          <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Recovery Queue</p>
          <p class="text-[18px] font-black leading-none text-white" data-metric="recovery">--</p>
          <span class="h-1 w-10 rounded-full bg-rose-400/80"></span>
        </div>
        <div class="flex h-12 flex-col justify-between rounded-xl border border-slate-800/70 bg-slate-950/40 px-3 py-2 shadow-none">
          <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Utilization</p>
          <p class="text-[18px] font-black leading-none text-white" data-metric="utilization">--</p>
          <span class="h-1 w-10 rounded-full bg-blue-400/80"></span>
        </div>
      </div>
    </section>

    <section class="z-30 p-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Filter Bar</p>
          <h3 class="text-lg font-bold text-white">Refine Inventory View</h3>
        </div>
        <button id="filter-toggle" type="button" aria-expanded="false" aria-controls="active-filters filter-builder" data-pill-control class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-200 transition hover:border-blue-500 hover:text-white">
          <i data-lucide="sliders-horizontal" class="h-4 w-4"></i>
          Filters
        </button>
      </div>

      <div class="mt-2 flex flex-wrap gap-2 text-xs font-semibold text-slate-200" id="active-filters"></div>

      <div id="filter-builder" class="mt-3 grid grid-cols-12 gap-2">
        <label class="col-span-12 flex flex-col gap-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400 sm:col-span-4">
          Search
          <input id="filter-search" type="search" placeholder="Search across all fields" class="h-9 rounded-xl border border-slate-800 bg-slate-950/70 px-3 text-sm font-semibold text-white" />
        </label>
        <div id="filter-date-range" class="col-span-12 sm:col-span-4"></div>
        <div class="col-span-12 flex flex-col gap-2 sm:col-span-4">
          <button id="reset-filters" type="button" data-pill-control class="h-8 self-end text-xs font-semibold uppercase tracking-[0.2em] text-slate-200 transition hover:border-blue-500 hover:text-white">
            Clear all
          </button>
          <div id="filter-status-block" class="w-full"></div>
        </div>
        <div id="filter-category-block" class="col-span-12 grid grid-cols-12 gap-2"></div>
      </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-[1.2fr_1fr]">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-4 shadow-dashboard">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Inventory Movement</p>
            <h3 class="text-lg font-bold text-white">Units by Status</h3>
          </div>
          <span id="status-summary" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">Loading…</span>
        </div>
        <div class="mt-4 grid grid-cols-6 gap-2" data-bar-chart aria-label="Units by status chart"></div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-4 shadow-dashboard">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Utilization Trend</p>
            <h3 class="text-lg font-bold text-white">Dynamic Load Curve</h3>
          </div>
          <span id="trend-caption" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">7-day utilization</span>
        </div>

        <div class="mt-4 rounded-2xl border border-slate-800 bg-transparent p-3">
          <div class="flex items-center justify-between text-xs text-slate-400">
            <span>Low</span>
            <span>High</span>
          </div>
          <svg viewBox="0 0 260 120" class="mt-3 h-24 w-full" id="trend-chart" aria-label="Utilization trend chart" role="img">
            <defs>
              <linearGradient id="trend-gradient" x1="0" x2="1" y1="0" y2="0">
                <stop offset="0%" stop-color="#38bdf8" />
                <stop offset="50%" stop-color="#818cf8" />
                <stop offset="100%" stop-color="#22c55e" />
              </linearGradient>
            </defs>
            <rect id="trend-brush-rect" x="0" y="10" width="0" height="100" fill="rgba(56,189,248,0.2)"></rect>
            <polyline id="trend-line" points="" fill="none" stroke="url(#trend-gradient)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"></polyline>
            <g id="trend-dots"></g>
          </svg>
          <p class="mt-3 text-xs text-slate-400">
            Hover insight: active units are trending <span class="text-emerald-300 font-semibold">upward</span> over the last cycle.
          </p>
        </div>
      </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-3">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-4 shadow-dashboard lg:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Regional Coverage</p>
            <h3 class="text-lg font-bold text-white">Top Performance Zones</h3>
          </div>
          <span class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">Realtime</span>
        </div>
        <div class="mt-4 grid gap-3 sm:grid-cols-2" id="regional-coverage" aria-label="Top performance zones"></div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-4 shadow-dashboard">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Alerts</p>
            <h3 class="text-lg font-bold text-white">Priority Actions</h3>
          </div>
          <span class="rounded-full border border-amber-500/40 bg-amber-500/10 px-3 py-1 text-[10px] font-semibold uppercase text-amber-200">live</span>
        </div>
        <ul class="mt-4 space-y-3 text-sm text-slate-200">
          <li class="rounded-2xl border border-slate-800 bg-transparent p-3">
            <p class="font-semibold text-white">GPS Offline Cluster</p>
            <p class="text-xs text-slate-400">Auto-highlights via toggle filter.</p>
          </li>
          <li class="rounded-2xl border border-slate-800 bg-transparent p-3">
            <p class="font-semibold text-white">Recovery Dispatch</p>
            <p class="text-xs text-slate-400">Click a row to open details drawer.</p>
          </li>
          <li class="rounded-2xl border border-slate-800 bg-transparent p-3">
            <p class="font-semibold text-white">Utilization Dip</p>
            <p class="text-xs text-slate-400">Brush the trend chart to filter by date.</p>
          </li>
        </ul>
      </div>
    </section>

    <section class="p-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Inventory Details</p>
          <h3 class="text-lg font-bold text-white">Filtered Asset Table</h3>
          <p class="mt-1 text-xs text-slate-400">Each row responds to the active filter set.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <button id="column-chooser-toggle" type="button" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-blue-500 hover:text-white" aria-haspopup="true" aria-expanded="false">
              Columns
            </button>
            <div id="column-chooser" class="absolute right-0 z-20 mt-2 hidden w-48 rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg">
              <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show columns</p>
              <div id="column-chooser-options" class="mt-2 grid gap-2"></div>
            </div>
          </div>
          <button id="export-csv" type="button" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-blue-500 hover:text-white" aria-label="Export filtered rows to CSV">
            Export CSV
          </button>
          <label class="inline-flex items-center gap-2 text-xs font-semibold text-slate-200">
            <span class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Per page</span>
            <select id="table-per-page" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">
              <option value="8">8</option>
              <option value="15">15</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span id="table-summary" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">0 assets</span>
          <div class="flex items-center gap-2 text-xs font-semibold text-slate-200">
            <button id="table-prev" type="button" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-blue-500 hover:text-white">Prev</button>
            <span id="table-page">Page 1</span>
            <button id="table-next" type="button" class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-blue-500 hover:text-white">Next</button>
            <label class="inline-flex items-center gap-2">
              <span class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Go to</span>
              <input id="table-go-to" type="number" min="1" class="w-16 rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200" />
            </label>
          </div>
        </div>
      </div>

      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm text-slate-200" aria-label="Filtered inventory table">
          <thead id="inventory-table-head" class="text-[10px] uppercase tracking-[0.3em] text-slate-400"></thead>
          <tbody id="inventory-table" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>
    </section>
  </main>

  <aside id="row-drawer" class="fixed right-0 top-0 z-40 flex h-full w-80 translate-x-full flex-col gap-4 border-l border-slate-800 bg-slate-950/95 p-4 shadow-2xl transition-transform">
    <div class="flex items-center justify-between">
      <h4 class="text-lg font-bold text-white">Vehicle Details</h4>
      <button id="drawer-close" type="button" class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-xs font-semibold text-slate-200">Close</button>
    </div>
    <div class="space-y-3 text-sm text-slate-200">
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">VIN</p>
        <p id="drawer-vin" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Status</p>
        <p id="drawer-status" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Location</p>
        <p id="drawer-location" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Unit</p>
        <p id="drawer-unit" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Flags</p>
        <p id="drawer-flags" class="font-semibold text-white">-</p>
      </div>
    </div>
    <div>
      <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Timeline</p>
      <ul id="drawer-timeline" class="mt-2 space-y-2 text-xs text-slate-300"></ul>
    </div>
  </aside>

  <script type="module">
    import { createConstellationBackground } from './assets/scripts/constellation.js';
    createConstellationBackground();
  </script>

  <script type="module">
    // ==========================================================
    // 1) SUPABASE CLIENT (robusto)
    // - Primero intenta importar tu supabaseClient.js
    // - Si falla, crea el cliente aquí con URL/KEY
    // ==========================================================

    lucide.createIcons();

    const PILL_CLASSES = 'rounded-xl border border-slate-700 bg-slate-950/60 px-2 py-1 text-[10px] hover:bg-slate-900/60';

    // ✅ Fallback: pega tus credenciales si tu módulo no exporta bien.
    //    (Anon key es pública, pero igual cuida RLS.)
    const SUPABASE_URL = '';       // <-- pega aquí
    const SUPABASE_ANON_KEY = '';  // <-- pega aquí

    const showDebug = (title, detail, obj) => {
      const banner = document.getElementById('debug-banner');
      const text = document.getElementById('debug-text');
      const pre = document.getElementById('debug-pre');
      banner.classList.remove('hidden');
      text.textContent = `${title} — ${detail || ''}`.trim();
      pre.textContent = obj ? JSON.stringify(obj, null, 2) : '';
      document.getElementById('debug-copy').onclick = async () => {
        const payload = `${title}\n${detail || ''}\n\n${pre.textContent}`.trim();
        try { await navigator.clipboard.writeText(payload); } catch {}
      };
    };

    const setConnectionStatus = (status) => {
      const statusEl = document.getElementById('connection-status');
      const dotEl = document.getElementById('connection-dot');
      statusEl.textContent = status;

      dotEl.className = 'h-2.5 w-2.5 rounded-full';
      if (status === 'Live') dotEl.classList.add('bg-emerald-400', 'shadow-[0_0_10px_rgba(52,211,153,0.8)]');
      else if (status.includes('Reconnect')) dotEl.classList.add('bg-amber-400', 'shadow-[0_0_10px_rgba(251,191,36,0.8)]');
      else dotEl.classList.add('bg-slate-500');
    };

    let supabaseClient = null;

    const getSupabaseClient = async () => {
      // Try import your module (best option)
      try {
        const mod = await import('./assets/scripts/supabaseClient.js');
        // common patterns: export const supabase; export default supabase;
        supabaseClient = mod.supabase || mod.default || null;
        if (supabaseClient?.from) return supabaseClient;
        throw new Error('supabaseClient.js loaded but did not export a Supabase client (expected export const supabase = createClient(...)).');
      } catch (e) {
        // Fallback: create client here
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return supabaseClient;
        }
        showDebug(
          'Supabase client not available',
          'Tu import falló y el fallback no tiene URL/KEY. Revisa supabaseClient.js export o pega credenciales aquí.',
          { error: String(e) }
        );
        return null;
      }
    };

    // ==========================================================
    // 2) DASHBOARD STATE + HELPERS (tu lógica con mejoras mínimas)
    // ==========================================================

    const DashboardState = {
      filters: {
        dateRange: { start: '', end: '' },
        search: '',
        statuses: [],
        statusKey: '',
        dateKey: '',
        categoryFilters: {},
      },
      vehiclesRaw: new Map(),
      schema: [],
      table: {
        page: 1,
        perPage: 8,
        sort: { key: '', direction: 'asc' },
        columns: {},
      },
      derived: {
        filtered: [],
        kpis: { active: 0, hold: 0, recovery: 0, utilization: 0 },
        statusBars: [],
        trendPoints: [],
        regionCoverage: [],
      },
      realtime: { channel: null },
      ui: { isLoading: true },
    };

    const STATUS_COLORS = {
      Active: 'from-emerald-400 to-blue-500',
      'On Hold': 'from-amber-400 to-orange-500',
      'In Transit': 'from-blue-400 to-indigo-500',
      Recovery: 'from-rose-400 to-red-500',
      Ready: 'from-teal-400 to-cyan-500',
      'Write-Off': 'from-slate-500 to-slate-400',
    };

    const COLUMN_STORAGE_KEY = 'inventoryControlTableColumns';

    const formatDate = (value) => {
      if (!value) return '--';
      return new Date(value).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };
    const formatNumber = (value) => new Intl.NumberFormat('en-US').format(value);

    const formatRelativeTime = (timestamp) => {
      if (!timestamp) return 'Updated --';
      const diffSeconds = Math.max(0, Math.round((Date.now() - timestamp) / 1000));
      if (diffSeconds < 60) return `Updated ${diffSeconds}s ago`;
      const minutes = Math.floor(diffSeconds / 60);
      if (minutes < 60) return `Updated ${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `Updated ${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `Updated ${days}d ago`;
    };

    const formatColumnLabel = (key) => key.replace(/_/g, ' ');

    const inferColumnType = (values) => {
      let sawString = false;
      let sawNumber = false;
      let sawBoolean = false;
      let sawDate = false;

      values.forEach((value) => {
        if (value === null || value === undefined || value === '') return;
        if (typeof value === 'boolean') {
          sawBoolean = true;
          return;
        }
        if (typeof value === 'number' && !Number.isNaN(value)) {
          sawNumber = true;
          return;
        }
        if (value instanceof Date) {
          sawDate = true;
          return;
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          const parsed = Date.parse(trimmed);
          if (!Number.isNaN(parsed) && /[-/T:]/.test(trimmed)) {
            sawDate = true;
            return;
          }
          if (trimmed && !Number.isNaN(Number(trimmed))) {
            sawNumber = true;
            return;
          }
          sawString = true;
          return;
        }
        sawString = true;
      });

      if (sawString) return 'string';
      if (sawDate && !sawNumber && !sawBoolean) return 'date';
      if (sawNumber && !sawBoolean) return 'number';
      if (sawBoolean && !sawNumber) return 'boolean';
      if (sawDate) return 'date';
      if (sawNumber) return 'number';
      if (sawBoolean) return 'boolean';
      return 'string';
    };

    const buildSchemaFromData = (rows) => {
      if (!rows?.length) return [];
      const sample = rows.slice(0, 50);
      return Object.keys(rows[0]).map((key) => {
        const values = sample.map((row) => row?.[key]);
        return {
          key,
          label: formatColumnLabel(key),
          type: inferColumnType(values),
        };
      });
    };

    const getColumnValues = (rows, key) => rows.map((row) => row?.[key]).filter((v) => v !== null && v !== undefined && v !== '');

    const getUniqueValues = (rows, key) => {
      const values = new Set();
      rows.forEach((row) => {
        const value = row?.[key];
        if (value !== null && value !== undefined && value !== '') values.add(String(value));
      });
      return Array.from(values).sort((a, b) => a.localeCompare(b));
    };

    const detectStatusKey = (schema) =>
      schema.find((col) => col.type === 'string' && /status/i.test(col.key))?.key || '';

    const detectDateKey = (schema) => {
      const preferred = schema.find((col) => col.type === 'date' && /created_at|created|updated_at|updated/i.test(col.key));
      if (preferred) return preferred.key;
      return schema.find((col) => col.type === 'date')?.key || '';
    };

    const detectCategoryKeys = (schema, rows, excludeKeys) => {
      const candidates = schema
        .filter((col) => !excludeKeys.includes(col.key))
        .filter((col) => ['string', 'number', 'boolean'].includes(col.type))
        .map((col) => ({
          key: col.key,
          label: col.label,
          values: getUniqueValues(rows, col.key),
        }))
        .filter((entry) => entry.values.length > 0 && entry.values.length <= 50)
        .sort((a, b) => b.values.length - a.values.length);

      return candidates.slice(0, 4);
    };

    const getVehicleKey = (vehicle) => vehicle.id ?? '';
    const normalizeBoolean = (value) => {
      if (typeof value === 'boolean') return value;
      if (typeof value === 'number') return value !== 0;
      if (typeof value === 'string') {
        const normalized = value.trim().toLowerCase();
        return ['true', 'yes', 'y', '1'].includes(normalized);
      }
      return Boolean(value);
    };
    const normalizeStatus = (value) => {
      const raw = String(value ?? '').trim();
      if (!raw) return 'Active';
      const normalized = raw.toLowerCase();
      if (normalized.includes('hold')) return 'On Hold';
      if (normalized.includes('transit')) return 'In Transit';
      if (normalized.includes('recover')) return 'Recovery';
      if (normalized.includes('ready')) return 'Ready';
      if (normalized.includes('write')) return 'Write-Off';
      if (normalized.includes('active')) return 'Active';
      return 'Active';
    };
    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row?.[key];
        if (value !== undefined && value !== null && value !== '') return value;
      }
      return '';
    };
    const normalizeVehicle = (vehicle) => {
      const updatedAt = getField(vehicle, 'Updated At', 'Updated', 'Last Updated');
      const createdAt = getField(vehicle, 'Created At');
      const dateValue = getField(vehicle, 'Date') || updatedAt || createdAt;
      return {
        ...vehicle,
        id: vehicle.id ?? null,
        stockNo: getField(vehicle, 'Current Stock No'),
        vin: getField(vehicle, 'VIN'),
        status: normalizeStatus(getField(vehicle, 'Vehicle Status')),
        hold: normalizeBoolean(getField(vehicle, 'HOLD')),
        brand: getField(vehicle, 'Brand'),
        model: getField(vehicle, 'Model'),
        modelYear: getField(vehicle, 'Model Year'),
        dealStatus: getField(vehicle, 'Deal Status'),
        prepStatus: getField(vehicle, 'Inventory Preparation Status'),
        createdAt: createdAt ? String(createdAt).slice(0, 10) : '',
        updatedAt: updatedAt ? String(updatedAt).slice(0, 10) : '',
        date: dateValue ? String(dateValue).slice(0, 10) : '',
        lastEventAt: vehicle.lastEventAt || (updatedAt ? new Date(updatedAt).getTime() : null),
      };
    };

    const getCurrentDataset = () => Array.from(DashboardState.vehiclesRaw.values());
    const setVehiclesFromArray = (vehicles) => {
      DashboardState.vehiclesRaw.clear();
      vehicles.forEach((vehicle) => {
        const normalized = normalizeVehicle(vehicle);
        const key = getVehicleKey(normalized);
        if (key) DashboardState.vehiclesRaw.set(key, normalized);
      });
    };

    const setupFilters = ({ preserveSelections = false } = {}) => {
      const dataset = getCurrentDataset();
      const schema = DashboardState.schema;
      if (!schema.length) return;

      const statusKey = detectStatusKey(schema);
      const dateKey = detectDateKey(schema);
      const categoryKeys = detectCategoryKeys(schema, dataset, [statusKey, dateKey].filter(Boolean));

      if (!preserveSelections) {
        DashboardState.filters.statuses = [];
        DashboardState.filters.categoryFilters = {};
      }

      DashboardState.filters.statusKey = statusKey;
      DashboardState.filters.dateKey = dateKey;

      const builder = document.getElementById('filter-builder');
      const statusBlock = document.getElementById('filter-status-block');
      const categoryBlock = document.getElementById('filter-category-block');
      const dateRangeBlock = document.getElementById('filter-date-range');

      statusBlock.innerHTML = '';
      categoryBlock.innerHTML = '';
      dateRangeBlock.innerHTML = '';

      if (statusKey) {
        const statusValues = getUniqueValues(dataset, statusKey);
        const selectedStatuses = preserveSelections ? DashboardState.filters.statuses : statusValues;
        DashboardState.filters.statuses = selectedStatuses;
        statusBlock.innerHTML = `
          <fieldset class="rounded-xl border border-slate-800/70 bg-slate-950/60 p-2">
            <legend class="px-2 text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">${formatColumnLabel(statusKey)}</legend>
            <div class="mt-2 grid gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
              ${statusValues.map((value) => `
                <label class="cursor-pointer">
                  <input type="checkbox" value="${value}" data-filter-status class="peer sr-only" ${selectedStatuses.includes(value) ? 'checked' : ''} />
                  <span class="${PILL_CLASSES} flex items-center justify-center text-slate-300 transition peer-checked:border-blue-400 peer-checked:bg-blue-500/20 peer-checked:text-blue-100">
                    ${value}
                  </span>
                </label>
              `).join('')}
            </div>
          </fieldset>
        `;
      }

      if (categoryKeys.length) {
        categoryKeys.forEach((entry) => {
          const currentValue = preserveSelections ? (DashboardState.filters.categoryFilters[entry.key] || 'all') : 'all';
          DashboardState.filters.categoryFilters[entry.key] = currentValue;
          categoryBlock.insertAdjacentHTML('beforeend', `
            <label class="col-span-12 flex flex-col gap-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400 sm:col-span-6 lg:col-span-3">
              ${entry.label}
              <select data-filter-category="${entry.key}" class="h-9 rounded-xl border border-slate-800 bg-slate-950/70 px-3 text-sm font-semibold text-white">
                <option value="all">All ${entry.label}</option>
                ${entry.values.map((value) => `<option value="${value}" ${value === currentValue ? 'selected' : ''}>${value}</option>`).join('')}
              </select>
            </label>
          `);
        });
      }

      if (dateKey) {
        const dateValues = getColumnValues(dataset, dateKey)
          .map((value) => new Date(value))
          .filter((value) => !Number.isNaN(value.getTime()))
          .map((value) => value.toISOString().slice(0, 10))
          .sort();

        if (dateValues.length && !preserveSelections) {
          const latest = new Date(dateValues[dateValues.length - 1]);
          const startDate = new Date(latest);
          startDate.setDate(startDate.getDate() - 29);
          DashboardState.filters.dateRange = { start: startDate.toISOString().slice(0, 10), end: latest.toISOString().slice(0, 10) };
        } else if (!dateValues.length) {
          DashboardState.filters.dateRange = { start: '', end: '' };
        }

        dateRangeBlock.innerHTML = `
          <div class="grid gap-2 sm:grid-cols-2">
            <label class="flex flex-col gap-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
              Start date
              <input id="filter-start-date" type="date" value="${DashboardState.filters.dateRange.start || ''}" class="h-9 rounded-xl border border-slate-800 bg-slate-950/70 px-3 text-sm font-semibold text-white" />
            </label>
            <label class="flex flex-col gap-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
              End date
              <input id="filter-end-date" type="date" value="${DashboardState.filters.dateRange.end || ''}" class="h-9 rounded-xl border border-slate-800 bg-slate-950/70 px-3 text-sm font-semibold text-white" />
            </label>
          </div>
        `;
      }

      statusBlock.classList.toggle('hidden', !statusKey);
      categoryBlock.classList.toggle('hidden', categoryKeys.length === 0);
      dateRangeBlock.classList.toggle('hidden', !dateKey);
      builder.classList.toggle('opacity-50', DashboardState.ui.isLoading);
    };

    const applyFilters = () => {
      const { filters } = DashboardState;
      const searchText = filters.search.trim().toLowerCase();

      return getCurrentDataset().filter((item) => {
        const dateValue = filters.dateKey ? item[filters.dateKey] : null;
        const parsedDate = dateValue ? new Date(dateValue) : null;
        const dateString = parsedDate && !Number.isNaN(parsedDate.getTime()) ? parsedDate.toISOString().slice(0, 10) : '';
        const inDateRange = !filters.dateKey || (
          (!filters.dateRange.start || dateString >= filters.dateRange.start) &&
          (!filters.dateRange.end || dateString <= filters.dateRange.end)
        );

        if ((filters.dateRange.start || filters.dateRange.end) && !dateString) return false;

        const searchMatch =
          !searchText ||
          DashboardState.schema.some((column) => {
            const value = item[column.key];
            if (value === null || value === undefined) return false;
            return String(value).toLowerCase().includes(searchText);
          });

        const statusMatch = !filters.statusKey || !filters.statuses.length
          || filters.statuses.includes(String(item[filters.statusKey] ?? ''));

        const categoryMatch = Object.entries(filters.categoryFilters || {}).every(([key, value]) => {
          if (value === 'all') return true;
          return String(item[key] ?? '') === value;
        });

        return inDateRange && searchMatch && statusMatch && categoryMatch;
      });
    };

    const computeTrend = (items) => {
      const filters = DashboardState.filters;
      const activeDates = [...new Set(items.map((i) => i.date))].filter(Boolean).sort();
      let dates = activeDates.slice(-7);

      if (!dates.length) {
        const endDate = filters.dateRange.end ? new Date(filters.dateRange.end) : new Date();
        dates = Array.from({ length: 7 }, (_, idx) => {
          const d = new Date(endDate);
          d.setDate(d.getDate() - (6 - idx));
          return d.toISOString().slice(0, 10);
        });
      }

      return dates.map((date, index) => {
        const dayItems = items.filter((i) => i.date === date);
        const activeCount = dayItems.filter((i) => i.status === 'Active').length;
        const value = dayItems.length ? Math.round((activeCount / dayItems.length) * 100) : 0;
        return { x: index, value, date };
      });
    };

    const computeRegionalCoverage = (items) => {
      const byState = items.reduce((acc, item) => {
        const key = item.state || '—';
        const entry = acc[key] || { state: key, total: 0, active: 0 };
        entry.total += 1;
        if (item.status === 'Active') entry.active += 1;
        acc[key] = entry;
        return acc;
      }, {});
      return Object.values(byState)
        .map((e) => ({ label: e.state, percent: e.total ? Math.round((e.active / e.total) * 100) : 0 }))
        .sort((a, b) => b.percent - a.percent)
        .slice(0, 4);
    };

    const computeDerivedState = () => {
      const filtered = applyFilters();
      const activeCount = filtered.filter((i) => i.status === 'Active').length;
      const holdCount = filtered.filter((i) => i.hold || i.status === 'On Hold').length;
      const recoveryCount = filtered.filter((i) => i.status === 'Recovery').length;
      const utilization = filtered.length ? Math.round((activeCount / filtered.length) * 100) : 0;

      const statusCounts = Object.keys(STATUS_COLORS).map((status) => ({
        status,
        count: filtered.filter((i) => i.status === status).length,
      }));
      const maxCount = Math.max(1, ...statusCounts.map((i) => i.count));
      const statusBars = statusCounts.map((i) => ({ ...i, percentage: Math.round((i.count / maxCount) * 100) }));

      DashboardState.derived = {
        filtered,
        kpis: { active: activeCount, hold: holdCount, recovery: recoveryCount, utilization },
        statusBars,
        trendPoints: computeTrend(filtered),
        regionCoverage: computeRegionalCoverage(filtered),
      };
    };

    const renderKpis = () => {
      const { kpis } = DashboardState.derived;
      const isLoading = DashboardState.ui.isLoading;
      const active = document.querySelector('[data-metric="active"]');
      const hold = document.querySelector('[data-metric="hold"]');
      const recovery = document.querySelector('[data-metric="recovery"]');
      const utilization = document.querySelector('[data-metric="utilization"]');

      [active, hold, recovery, utilization].forEach((el) => el.classList.toggle('animate-pulse', isLoading));

      if (isLoading) {
        active.textContent = hold.textContent = recovery.textContent = utilization.textContent = '...';
        return;
      }
      active.textContent = formatNumber(kpis.active);
      hold.textContent = formatNumber(kpis.hold);
      recovery.textContent = formatNumber(kpis.recovery);
      utilization.textContent = `${kpis.utilization}%`;
    };

    const renderStatusBars = () => {
      const container = document.querySelector('[data-bar-chart]');
      if (DashboardState.ui.isLoading) {
        container.innerHTML = Array.from({ length: 6 }).map(() => `
          <div class="flex flex-col items-center gap-2">
            <div class="h-20 w-8 rounded-full bg-slate-800/70 overflow-hidden">
              <div class="h-full w-full animate-pulse bg-slate-700/70"></div>
            </div>
            <span class="text-[10px] uppercase tracking-[0.2em] text-slate-500">...</span>
          </div>
        `).join('');
        return;
      }

      if (!DashboardState.derived.statusBars.length) {
        container.innerHTML = '<p class="col-span-6 text-center text-xs text-slate-400">No vehicles match current filters.</p>';
        return;
      }

      container.innerHTML = DashboardState.derived.statusBars.map((item) => `
        <button type="button" data-status="${item.status}" class="flex flex-col items-center gap-2 rounded-2xl px-1 py-1 transition hover:bg-slate-900/60">
          <div class="h-20 w-8 rounded-full bg-slate-800/70">
            <div class="bar-fill w-full rounded-full bg-gradient-to-t ${STATUS_COLORS[item.status]}" style="height: ${item.percentage}%"></div>
          </div>
          <span class="text-[10px] uppercase tracking-[0.2em] text-slate-400">${item.status}</span>
          <span class="text-[11px] font-semibold text-slate-200">${item.count}</span>
        </button>
      `).join('');
    };

    const renderTrend = () => {
      if (DashboardState.ui.isLoading) {
        document.getElementById('trend-line').setAttribute('points', '');
        document.getElementById('trend-dots').innerHTML = '';
        return;
      }
      const points = DashboardState.derived.trendPoints;
      const width = 260, height = 100;
      const step = points.length > 1 ? width / (points.length - 1) : width;

      const poly = points.map((p, idx) => {
        const x = idx * step;
        const y = height - (p.value / 100) * height + 10;
        return `${x},${y}`;
      }).join(' ');

      document.getElementById('trend-line').setAttribute('points', poly);

      document.getElementById('trend-dots').innerHTML = points.map((p, idx) => {
        const x = idx * step;
        const y = height - (p.value / 100) * height + 10;
        return `<circle cx="${x}" cy="${y}" r="4" fill="#38bdf8" />`;
      }).join('');
    };

    const renderRegionalCoverage = () => {
      const container = document.getElementById('regional-coverage');
      if (DashboardState.ui.isLoading) {
        container.innerHTML = Array.from({ length: 4 }).map(() => `
          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
            <div class="h-4 w-20 rounded-full bg-slate-800/70 animate-pulse"></div>
            <div class="mt-3 h-6 w-16 rounded-full bg-slate-800/70 animate-pulse"></div>
            <div class="mt-3 h-2 rounded-full bg-slate-800"></div>
          </div>
        `).join('');
        return;
      }

      const zones = DashboardState.derived.regionCoverage;
      if (!zones.length) {
        container.innerHTML = '<p class="text-sm text-slate-400">No regional coverage available for the selected filters.</p>';
        return;
      }

      container.innerHTML = zones.map((z, i) => `
        <button type="button" data-state="${z.label}" class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 text-left transition hover:border-blue-500 hover:bg-slate-950/80">
          <p class="text-xs text-slate-400">State ${z.label}</p>
          <p class="mt-2 text-xl font-black text-white">${z.percent}%</p>
          <div class="mt-3 h-2 rounded-full bg-slate-800">
            <div class="h-2 rounded-full bg-gradient-to-r ${i % 2 === 0 ? 'from-blue-500 to-emerald-400' : 'from-indigo-500 to-sky-400'}" style="width: ${z.percent}%"></div>
          </div>
        </button>
      `).join('');
    };

    const renderActiveFilters = () => {
      const chipsContainer = document.getElementById('active-filters');
      const { filters } = DashboardState;
      const chips = [];

      if (filters.dateRange.start || filters.dateRange.end) chips.push(`Date: ${filters.dateRange.start || 'Any'} → ${filters.dateRange.end || 'Any'}`);
      if (filters.statusKey && filters.statuses.length) chips.push(`${formatColumnLabel(filters.statusKey)}: ${filters.statuses.join(', ')}`);
      Object.entries(filters.categoryFilters || {}).forEach(([key, value]) => {
        if (value !== 'all') chips.push(`${formatColumnLabel(key)}: ${value}`);
      });
      if (filters.search) chips.push(`Search: ${filters.search}`);

      chipsContainer.innerHTML = chips.length
        ? chips.map((c) => `<span class="${PILL_CLASSES} text-slate-200">${c}</span>`).join('')
        : '<span class="text-slate-400">No active filters</span>';
    };

    const renderTableHead = () => {
      const head = document.getElementById('inventory-table-head');
      const visibleColumns = DashboardState.schema.filter((c) => DashboardState.table.columns[c.key]);
      const sortState = DashboardState.table.sort;

      if (!visibleColumns.length) {
        head.innerHTML = '<tr><th class="px-3 py-2 text-left text-[10px] uppercase tracking-[0.3em] text-slate-400">No columns</th></tr>';
        return;
      }

      head.innerHTML = `<tr>${
        visibleColumns.map((c) => {
          const isSorted = sortState.key === c.key;
          const indicator = isSorted ? (sortState.direction === 'asc' ? '▲' : '▼') : '';
          return `
            <th class="px-3 py-2">
              <button type="button" data-sort="${c.key}" class="flex items-center gap-1 text-left text-[10px] uppercase tracking-[0.3em] text-slate-400" aria-label="Sort by ${c.label}">
                <span>${c.label}</span>
                <span class="text-[10px] text-blue-300">${indicator}</span>
              </button>
            </th>
          `;
        }).join('')
      }</tr>`;
    };

    const renderTable = () => {
      const tableBody = document.getElementById('inventory-table');
      const visibleColumns = DashboardState.schema.filter((c) => DashboardState.table.columns[c.key]);
      const columnCount = Math.max(1, visibleColumns.length);

      if (DashboardState.ui.isLoading) {
        tableBody.innerHTML = Array.from({ length: DashboardState.table.perPage }).map(() => `
          <tr class="text-xs">
            <td class="px-3 py-3" colspan="${columnCount}">
              <div class="h-3 w-full rounded-full bg-slate-800/70 animate-pulse"></div>
            </td>
          </tr>
        `).join('');
        return;
      }

      if (!visibleColumns.length) {
        tableBody.innerHTML = `<tr><td class="px-3 py-6 text-center text-sm text-slate-400" colspan="${columnCount}">No columns available.</td></tr>`;
        return;
      }

      const sortedRows = [...DashboardState.derived.filtered].sort((a, b) => {
        const { key, direction } = DashboardState.table.sort;
        const column = DashboardState.schema.find((c) => c.key === key);
        if (!column) return 0;

        const getValue = (item) => item[key];

        const va = getValue(a);
        const vb = getValue(b);

        let comparison = 0;
        if (column.type === 'date') {
          const da = va ? Date.parse(va) : 0;
          const db = vb ? Date.parse(vb) : 0;
          comparison = da - db;
        } else if (column.type === 'number') {
          comparison = (Number(va) || 0) - (Number(vb) || 0);
        } else if (column.type === 'boolean') {
          comparison = (va ? 1 : 0) - (vb ? 1 : 0);
        } else {
          comparison = String(va ?? '').localeCompare(String(vb ?? ''), undefined, { sensitivity: 'base' });
        }

        if (comparison === 0) return 0;
        return direction === 'asc' ? comparison : -comparison;
      });

      const totalRows = sortedRows.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / DashboardState.table.perPage));
      const currentPage = Math.min(DashboardState.table.page, totalPages);
      DashboardState.table.page = currentPage;

      const startIndex = (currentPage - 1) * DashboardState.table.perPage;
      const pageItems = sortedRows.slice(startIndex, startIndex + DashboardState.table.perPage);
      const rangeStart = totalRows ? startIndex + 1 : 0;
      const rangeEnd = totalRows ? startIndex + pageItems.length : 0;

      const rowsHtml = pageItems.map((item) => {
        const cells = visibleColumns.map((col) => {
          let value = item[col.key];

          if (col.type === 'boolean') value = value ? 'Yes' : 'No';
          else if (col.type === 'date') value = value ? formatDate(value) : '--';

          if (value === null || value === undefined || value === '') value = '--';

          return `<td class="px-3 py-2">${value}</td>`;
        }).join('');

        return `<tr class="text-xs hover:bg-slate-900/60 cursor-pointer" data-row-key="${getVehicleKey(item)}">${cells}</tr>`;
      }).join('');

      tableBody.innerHTML = rowsHtml || `<tr><td class="px-3 py-6 text-center text-sm text-slate-400" colspan="${columnCount}">No vehicles match current filters.</td></tr>`;

      document.getElementById('table-summary').textContent = `${formatNumber(rangeStart)}–${formatNumber(rangeEnd)} of ${formatNumber(totalRows)}`;
      document.getElementById('table-page').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('table-prev').disabled = currentPage <= 1;
      document.getElementById('table-next').disabled = currentPage >= totalPages;
      const goToInput = document.getElementById('table-go-to');
      if (goToInput) {
        goToInput.max = String(totalPages);
        goToInput.value = String(currentPage);
      }
      const perPageSelect = document.getElementById('table-per-page');
      if (perPageSelect) {
        perPageSelect.value = String(DashboardState.table.perPage);
      }
    };

    const renderDashboard = () => {
      computeDerivedState();
      renderKpis();
      renderStatusBars();
      renderTrend();
      renderRegionalCoverage();
      renderTableHead();
      renderTable();
      renderActiveFilters();
      document.getElementById('status-summary').textContent = `${DashboardState.derived.filtered.length} units in view`;
    };

    const initializeTablePreferences = () => {
      const stored = localStorage.getItem(COLUMN_STORAGE_KEY);
      const saved = stored ? JSON.parse(stored) : {};
      const defaults = DashboardState.schema.reduce((acc, c) => ((acc[c.key] = true), acc), {});
      DashboardState.table.columns = DashboardState.schema.reduce((acc, column) => {
        acc[column.key] = saved[column.key] ?? defaults[column.key] ?? true;
        return acc;
      }, {});
      if (!DashboardState.schema.some((c) => c.key === DashboardState.table.sort.key)) {
        DashboardState.table.sort = { key: DashboardState.schema[0]?.key || '', direction: 'asc' };
      }
      renderColumnChooser();
    };

    const renderColumnChooser = () => {
      const container = document.getElementById('column-chooser-options');
      if (!DashboardState.schema.length) {
        container.innerHTML = '<p class="text-xs text-slate-400">No columns available.</p>';
        return;
      }
      container.innerHTML = DashboardState.schema.map((c) => `
        <label class="flex items-center gap-2 text-xs">
          <input type="checkbox" value="${c.key}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${DashboardState.table.columns[c.key] ? 'checked' : ''} />
          <span>${c.label}</span>
        </label>
      `).join('');
    };

    const openDrawer = (record) => {
      document.getElementById('drawer-vin').textContent = record.vin || '--';
      document.getElementById('drawer-status').textContent = record.status || '--';
      document.getElementById('drawer-location').textContent = `${record.yard || '--'}, ${record.state || '--'}`;
      document.getElementById('drawer-unit').textContent = `${record.brand || '--'} ${record.unitType || ''}`.trim() || '--';

      const flags = [
        record.gpsOffline ? 'GPS Offline' : null,
        record.hold ? 'Hold' : null,
        record.lien ? 'Lien' : null,
        record.recoveryPriority ? 'Recovery Priority' : null,
      ].filter(Boolean).join(' • ');

      document.getElementById('drawer-flags').textContent = flags || 'None';

      const timeline = [
        { label: 'Created', value: record.createdAt || record.date },
        { label: 'Last updated', value: record.updatedAt || record.date },
      ];

      document.getElementById('drawer-timeline').innerHTML = timeline.map((e) => `
        <li class="flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2">
          <span>${e.label}</span>
          <span class="text-slate-200">${e.value ? formatDate(e.value) : '--'}</span>
        </li>
      `).join('');

      document.getElementById('row-drawer').classList.remove('translate-x-full');
    };

    const closeDrawer = () => document.getElementById('row-drawer').classList.add('translate-x-full');

    const exportCsv = () => {
      const visibleColumns = DashboardState.schema.filter((c) => DashboardState.table.columns[c.key]);
      if (!visibleColumns.length) return;
      const rows = DashboardState.derived.filtered.map((item) =>
        visibleColumns.map((c) => {
          let value = item[c.key];
          if (c.type === 'boolean') value = value ? 'Yes' : 'No';
          if (c.type === 'date') value = value ? formatDate(value) : '';
          return `"${String(value ?? '').replace(/\"/g, '""')}"`;
        })
      );
      const header = visibleColumns.map((c) => `"${c.label}"`).join(',');
      const csv = [header, ...rows.map((r) => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'inventory-export.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    const bindFilterEvents = () => {
      const searchInput = document.getElementById('filter-search');
      const builder = document.getElementById('filter-builder');
      const perPageSelect = document.getElementById('table-per-page');
      const goToInput = document.getElementById('table-go-to');

      const resetPagination = () => (DashboardState.table.page = 1);

      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          DashboardState.filters.search = searchInput.value;
          resetPagination();
          renderDashboard();
        }, 250);
      });

      builder.addEventListener('change', (event) => {
        const target = event.target;
        if (target.matches('[data-filter-status]')) {
          const checkboxes = builder.querySelectorAll('[data-filter-status]');
          DashboardState.filters.statuses = Array.from(checkboxes)
            .filter((input) => input.checked)
            .map((input) => input.value);
          resetPagination();
          renderDashboard();
        }
        if (target.matches('[data-filter-category]')) {
          const key = target.dataset.filterCategory;
          DashboardState.filters.categoryFilters[key] = target.value;
          resetPagination();
          renderDashboard();
        }
        if (target.matches('#filter-start-date, #filter-end-date')) {
          DashboardState.filters.dateRange.start = document.getElementById('filter-start-date')?.value || '';
          DashboardState.filters.dateRange.end = document.getElementById('filter-end-date')?.value || '';
          resetPagination();
          renderDashboard();
        }
      });

      document.getElementById('reset-filters').addEventListener('click', () => {
        setupFilters();
        DashboardState.filters.search = '';
        searchInput.value = '';
        resetPagination();
        renderDashboard();
      });

      document.getElementById('table-prev').addEventListener('click', () => { DashboardState.table.page = Math.max(1, DashboardState.table.page - 1); renderDashboard(); });
      document.getElementById('table-next').addEventListener('click', () => { DashboardState.table.page += 1; renderDashboard(); });

      perPageSelect.addEventListener('change', () => {
        DashboardState.table.perPage = Number(perPageSelect.value);
        DashboardState.table.page = 1;
        renderDashboard();
      });

      goToInput.addEventListener('change', () => {
        const totalRows = DashboardState.derived.filtered.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / DashboardState.table.perPage));
        const desired = Math.min(Math.max(1, Number(goToInput.value) || 1), totalPages);
        DashboardState.table.page = desired;
        renderDashboard();
      });

      document.getElementById('inventory-table-head').addEventListener('click', (event) => {
        const button = event.target.closest('[data-sort]');
        if (!button) return;
        const key = button.dataset.sort;
        if (DashboardState.table.sort.key === key) DashboardState.table.sort.direction = DashboardState.table.sort.direction === 'asc' ? 'desc' : 'asc';
        else { DashboardState.table.sort.key = key; DashboardState.table.sort.direction = 'asc'; }
        renderDashboard();
      });

      document.getElementById('inventory-table').addEventListener('click', (event) => {
        const row = event.target.closest('[data-row-key]');
        if (!row) return;
        const record = DashboardState.vehiclesRaw.get(row.dataset.rowKey);
        if (record) openDrawer(record);
      });

      document.getElementById('drawer-close').addEventListener('click', closeDrawer);

      document.getElementById('column-chooser-toggle').addEventListener('click', () => {
        const chooser = document.getElementById('column-chooser');
        const isHidden = chooser.classList.toggle('hidden');
        document.getElementById('column-chooser-toggle').setAttribute('aria-expanded', String(!isHidden));
      });

      document.addEventListener('click', (event) => {
        const chooser = document.getElementById('column-chooser');
        const toggle = document.getElementById('column-chooser-toggle');
        if (chooser.classList.contains('hidden')) return;
        if (chooser.contains(event.target) || toggle.contains(event.target)) return;
        chooser.classList.add('hidden');
      });

      document.getElementById('column-chooser-options').addEventListener('change', (event) => {
        const input = event.target;
        if (!input.matches('input[type="checkbox"]')) return;
        DashboardState.table.columns[input.value] = input.checked;
        localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(DashboardState.table.columns));
        renderDashboard();
      });

      document.getElementById('export-csv').addEventListener('click', exportCsv);
    };

    const initializeFilterPanel = () => {
      const toggle = document.getElementById('filter-toggle');
      const activeFilters = document.getElementById('active-filters');
      const builder = document.getElementById('filter-builder');
      if (!toggle || !activeFilters || !builder) return;

      toggle.classList.add(...PILL_CLASSES.split(' '));
      document.querySelectorAll('[data-pill-control]').forEach((button) => {
        if (button === toggle) return;
        button.classList.add(...PILL_CLASSES.split(' '));
      });

      const mediaQuery = window.matchMedia('(min-width: 768px)');
      let userToggled = false;

      const setExpanded = (expanded) => {
        activeFilters.classList.toggle('hidden', !expanded);
        builder.classList.toggle('hidden', !expanded);
        toggle.setAttribute('aria-expanded', String(expanded));
      };

      setExpanded(mediaQuery.matches);

      toggle.addEventListener('click', () => {
        userToggled = true;
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      });

      const handleMediaChange = (event) => {
        if (!userToggled) setExpanded(event.matches);
      };

      if (mediaQuery.addEventListener) {
        mediaQuery.addEventListener('change', handleMediaChange);
      } else {
        mediaQuery.addListener(handleMediaChange);
      }
    };

    const bindChartInteractions = () => {
      const trendChart = document.getElementById('trend-chart');
      const brushRect = document.getElementById('trend-brush-rect');
      let brushing = false;
      let startX = 0;
      let startIndex = 0;

      const getIndexFromEvent = (event) => {
        const rect = trendChart.getBoundingClientRect();
        const x = Math.min(Math.max(event.clientX - rect.left, 0), rect.width);
        const n = DashboardState.derived.trendPoints.length;
        if (n <= 1) return 0;
        const idx = Math.round((x / rect.width) * (n - 1));
        return Math.min(Math.max(idx, 0), n - 1);
      };

      const updateBrush = (clientX) => {
        const rect = trendChart.getBoundingClientRect();
        const clampedX = Math.min(Math.max(clientX - rect.left, 0), rect.width);
        const start = Math.min(startX, clampedX);
        const width = Math.abs(clampedX - startX);
        const ratio = 260 / rect.width;
        brushRect.setAttribute('x', String(start * ratio));
        brushRect.setAttribute('width', String(width * ratio));
      };

      trendChart.addEventListener('mousedown', (event) => {
        brushing = true;
        const rect = trendChart.getBoundingClientRect();
        startX = Math.min(Math.max(event.clientX - rect.left, 0), rect.width);
        startIndex = getIndexFromEvent(event);
        updateBrush(event.clientX);
      });

      window.addEventListener('mousemove', (event) => { if (brushing) updateBrush(event.clientX); });
      window.addEventListener('mouseup', (event) => {
        if (!brushing) return;
        brushing = false;
        updateBrush(event.clientX);

        const endIndex = getIndexFromEvent(event);
        const min = Math.min(startIndex, endIndex);
        const max = Math.max(startIndex, endIndex);
        const points = DashboardState.derived.trendPoints;

        if (points.length) {
          DashboardState.filters.dateRange = { start: points[min].date, end: points[max].date };
          const startInput = document.getElementById('filter-start-date');
          const endInput = document.getElementById('filter-end-date');
          if (startInput) startInput.value = points[min].date;
          if (endInput) endInput.value = points[max].date;
          DashboardState.table.page = 1;
          renderDashboard();
        }
        brushRect.setAttribute('width', '0');
      });

      trendChart.addEventListener('mouseleave', () => { brushing = false; brushRect.setAttribute('width', '0'); });
    };

    // ==========================================================
    // 3) REALTIME + HYDRATE
    // ==========================================================

    const handleVehicleChange = (payload) => {
      const record = payload.new || payload.old;
      if (!record) return;

      if (!DashboardState.schema.length) {
        DashboardState.schema = buildSchemaFromData([record]);
        initializeTablePreferences();
      }

      const normalized = normalizeVehicle(record);
      const eventTimestamp = payload.commit_timestamp ? new Date(payload.commit_timestamp).getTime() : Date.now();
      normalized.lastEventAt = eventTimestamp;

      const key = getVehicleKey(normalized);
      if (!key) return;

      if (payload.eventType === 'DELETE') DashboardState.vehiclesRaw.delete(key);
      else DashboardState.vehiclesRaw.set(key, normalized);

      renderDashboard();
    };

    const initializeSupabaseRealtime = () => {
      if (!supabaseClient?.channel) return;

      if (DashboardState.realtime.channel) return;

      const channel = supabaseClient
        .channel('inventory-control-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'Inventory Control' }, handleVehicleChange);

      DashboardState.realtime.channel = channel;

      channel.subscribe((status) => {
        if (status === 'SUBSCRIBED') setConnectionStatus('Live');
        else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') setConnectionStatus('Reconnecting…');
        else if (status === 'CLOSED') setConnectionStatus('Offline');
      });

      window.addEventListener('beforeunload', () => {
        if (DashboardState.realtime.channel) {
          supabaseClient.removeChannel(DashboardState.realtime.channel);
          DashboardState.realtime.channel = null;
        }
      });
    };

    const hydrateVehiclesFromSupabase = async () => {
      if (!supabaseClient?.from) {
        DashboardState.ui.isLoading = false;
        setConnectionStatus('Offline');
        renderDashboard();
        return;
      }

      setConnectionStatus('Reconnecting…');

      const { data, error } = await supabaseClient
        .from('Inventory Control')
        .select('*')
        .limit(5000);

      if (error) {
        setConnectionStatus('Offline');
        DashboardState.ui.isLoading = false;
        renderDashboard();

        showDebug(
          'Supabase SELECT failed',
          'Esto suele ser RLS (no tienes SELECT permitido), credenciales, o tabla/columnas distintas.',
          { code: error.code, message: error.message, details: error.details, hint: error.hint }
        );
        return;
      }

      DashboardState.schema = buildSchemaFromData(data || []);

      setVehiclesFromArray((data || []).map((v) => {
        const updatedAt = getField(v, 'Updated At', 'Updated', 'Last Updated');
        return {
          ...v,
          lastEventAt: updatedAt ? new Date(updatedAt).getTime() : null,
        };
      }));

      DashboardState.ui.isLoading = false;
      initializeTablePreferences();
      setupFilters({ preserveSelections: true });
      renderDashboard();
      setConnectionStatus('Live');
    };

    // ==========================================================
    // 4) BOOT
    // ==========================================================

    initializeFilterPanel();
    setupFilters();
    bindFilterEvents();
    bindChartInteractions();
    renderDashboard();

    // Mobile nav
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    const primaryNav = document.getElementById('primary-nav');
    mobileToggle?.addEventListener('click', () => {
      const isOpen = primaryNav.classList.toggle('hidden');
      mobileToggle.setAttribute('aria-expanded', String(!isOpen));
    });

    // Start Supabase
    (async () => {
      setConnectionStatus('Booting…');
      supabaseClient = await getSupabaseClient();

      if (!supabaseClient) {
        setConnectionStatus('Offline');
        DashboardState.ui.isLoading = false;
        renderDashboard();
        return;
      }

      // If RLS blocks, debug banner will show exact error
      await hydrateVehiclesFromSupabase();
      initializeSupabaseRealtime();
    })();
  </script>
</body>
</html>
