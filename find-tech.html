<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Find Tech</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
    crossorigin=""
  />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      },
    };
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kG1Q9bIwF6Yw2WrwslfLv7RHF9A0w0v0r3sLs="
    crossorigin=""
  ></script>
</head>
<body class="min-h-screen bg-slate-950 font-sans text-slate-50">
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-slate-950/90 backdrop-blur">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
      <a href="index.html" class="flex items-center gap-3">
        <div class="rounded-xl bg-blue-600/90 p-2 shadow-lg shadow-blue-500/30">
          <i data-lucide="navigation" class="h-5 w-5"></i>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-300">TechLoc Network</p>
          <h1 class="text-lg font-black leading-tight">GPS Installer Hub</h1>
        </div>
      </a>
      <nav class="hidden items-center gap-8 text-sm font-semibold text-slate-200 md:flex">
        <a href="index.html" class="transition-colors hover:text-white">Home</a>
        <a href="find-tech.html" class="transition-colors hover:text-white">Find Tech</a>
        <a href="vehicles.html" class="transition-colors hover:text-white">Vehicles to Fix</a>
      </nav>
    </div>
  </header>

  <main class="space-y-12">
    <section class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 py-12">
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(59,130,246,0.12),_transparent_35%)]"></div>
      <div class="mx-auto flex max-w-7xl flex-col gap-6 px-6 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-blue-300">Find Tech</p>
          <h2 class="text-4xl font-black text-white">Locate, prioritize, and assign from one place</h2>
          <p class="text-sm text-slate-300 max-w-3xl">Enter the installation address to see the closest technicians with availability and ratings in real time. The roster loads from the CSV installer list.</p>
        </div>
        <a href="assets/installers.csv" class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-200">
          <i data-lucide="file-text" class="h-4 w-4"></i> Download installer list
        </a>
      </div>
    </section>

    <section class="mx-auto max-w-7xl space-y-6 px-6">
      <div class="grid gap-6 lg:grid-cols-[420px,1fr]">
        <aside class="rounded-3xl border border-slate-800 bg-slate-900/80 shadow-2xl shadow-blue-500/10">
          <div class="flex items-center justify-between border-b border-slate-800 px-6 py-5">
            <div class="flex items-center gap-3">
              <div class="rounded-lg bg-blue-600/20 p-2 text-blue-300">
                <i data-lucide="map-pin" class="h-4 w-4"></i>
              </div>
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Module</p>
                <p class="text-lg font-black text-white">Assign installation</p>
              </div>
            </div>
          </div>

          <div class="space-y-6 p-6">
            <form id="address-form" class="space-y-3">
              <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Installation address</label>
              <input id="address-input" type="text" placeholder="E.g., 123 Main St, Springfield, IL" class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-3 text-sm font-medium text-slate-200 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30" />
              <button type="submit" class="flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-3 text-sm font-bold uppercase tracking-wide text-white shadow-lg shadow-blue-600/30 transition hover:-translate-y-0.5 hover:bg-blue-500">
                <i data-lucide="search" class="h-4 w-4"></i> Find installers
              </button>
            </form>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-300">
              <p class="font-semibold text-white">How it works</p>
              <ol class="mt-2 space-y-1 list-decimal list-inside text-slate-400">
                <li>We read your CSV installer file.</li>
                <li>We search by ZIP first; if no match, we widen to city and then state to calculate distance.</li>
                <li>We sort by availability, rating, and current load.</li>
              </ol>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between text-xs font-semibold text-slate-300">
                <span>Active in network</span>
                <span class="rounded-full bg-slate-800 px-3 py-1 text-blue-200" id="active-count">-</span>
              </div>

              <div id="tech-cards" class="space-y-3">
                <div class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-slate-800 bg-slate-950/40 px-6 py-10 text-center text-slate-400">
                  <i data-lucide="filter" class="mb-3 h-10 w-10 text-slate-600"></i>
                  <p class="text-sm font-semibold text-white">Waiting for address</p>
                  <p class="text-xs text-slate-400">Enter a location and we will show the technician with the best ETA.</p>
                </div>
              </div>
            </div>
          </div>
        </aside>

        <div class="relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-blue-500/10">
          <div class="absolute right-4 top-4 z-20 hidden rounded-xl border border-slate-800 bg-slate-900/70 px-4 py-3 text-xs text-slate-200 lg:block">
            <h4 class="mb-2 flex items-center gap-2 text-[11px] font-bold uppercase tracking-wide text-slate-300">
              <i data-lucide="shield" class="h-3 w-3 text-blue-400"></i> Legend
            </h4>
            <div class="space-y-1 text-[11px] text-slate-400">
              <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></span> Available technician</div>
              <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-amber-500"></span> Paused / busy</div>
              <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span> Installation address</div>
            </div>
          </div>

          <div class="relative mx-auto max-w-5xl select-none">
            <div id="tech-map" class="relative aspect-[1.55] w-full overflow-hidden rounded-2xl bg-slate-950/60 ring-1 ring-slate-800/60"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-slate-900 bg-slate-950/80 py-6">
    <div class="mx-auto flex max-w-7xl flex-col gap-2 px-6 text-sm text-slate-500 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-2 text-slate-300">
        <i data-lucide="navigation" class="h-4 w-4 text-blue-400"></i>
        <span class="font-semibold text-white">TechLoc</span>
        <span class="text-slate-500">• GPS installer network across the USA</span>
      </div>
      <div class="flex items-center gap-4 text-xs uppercase tracking-wide text-slate-500">
        <span>24/7 Support</span>
        <span>Data security</span>
        <span>Reliable operations</span>
      </div>
    </div>
  </footer>

  <script type="module">
    const STATE_COORDS = {
      AL: { lat: 32.8067, lng: -86.7911 }, AK: { lat: 61.3707, lng: -152.4044 }, AZ: { lat: 33.7298, lng: -111.4312 },
      AR: { lat: 34.9697, lng: -92.3731 }, CA: { lat: 36.1162, lng: -119.6816 }, CO: { lat: 39.0598, lng: -105.3111 },
      CT: { lat: 41.5978, lng: -72.7554 }, DE: { lat: 39.3185, lng: -75.5071 }, FL: { lat: 27.7663, lng: -81.6868 },
      GA: { lat: 33.0406, lng: -83.6431 }, HI: { lat: 21.0943, lng: -157.4983 }, ID: { lat: 44.2405, lng: -114.4788 },
      IL: { lat: 40.3495, lng: -88.9861 }, IN: { lat: 39.8494, lng: -86.2583 }, IA: { lat: 42.0115, lng: -93.2105 },
      KS: { lat: 38.5266, lng: -96.7265 }, KY: { lat: 37.6681, lng: -84.6701 }, LA: { lat: 31.1695, lng: -91.8678 },
      ME: { lat: 44.6939, lng: -69.3819 }, MD: { lat: 39.0639, lng: -76.8021 }, MA: { lat: 42.2302, lng: -71.5301 },
      MI: { lat: 43.3266, lng: -84.5361 }, MN: { lat: 45.6945, lng: -93.9002 }, MS: { lat: 32.7416, lng: -89.6787 },
      MO: { lat: 38.4561, lng: -92.2884 }, MT: { lat: 46.9219, lng: -110.4544 }, NE: { lat: 41.1254, lng: -98.2681 },
      NV: { lat: 38.3135, lng: -117.0554 }, NH: { lat: 43.4525, lng: -71.5639 }, NJ: { lat: 40.2989, lng: -74.521 },
      NM: { lat: 34.8405, lng: -106.2485 }, NY: { lat: 42.1657, lng: -74.9481 }, NC: { lat: 35.6301, lng: -79.8064 },
      ND: { lat: 47.5289, lng: -99.784 }, OH: { lat: 40.3888, lng: -82.7649 }, OK: { lat: 35.5653, lng: -96.9289 },
      OR: { lat: 43.9336, lng: -120.5583 }, PA: { lat: 40.5908, lng: -77.2098 }, RI: { lat: 41.6809, lng: -71.5118 },
      SC: { lat: 33.8569, lng: -80.945 }, SD: { lat: 44.2998, lng: -99.4388 }, TN: { lat: 35.7478, lng: -86.6923 },
      TX: { lat: 31.0545, lng: -97.5635 }, UT: { lat: 40.1500, lng: -111.8624 }, VT: { lat: 44.0459, lng: -72.7107 },
      VA: { lat: 37.7693, lng: -78.1699 }, WA: { lat: 47.4009, lng: -121.4905 }, WV: { lat: 38.4912, lng: -80.9545 },
      WI: { lat: 44.2685, lng: -89.6165 }, WY: { lat: 42.7559, lng: -107.3025 }, DC: { lat: 38.9072, lng: -77.0369 },
      DEFAULT: { lat: 39.5, lng: -98.35 },
    };

    const haversineMiles = (a, b) => {
      const R = 3958.8;
      const dLat = (b.lat - a.lat) * Math.PI / 180;
      const dLon = (b.lng - a.lng) * Math.PI / 180;
      const lat1 = a.lat * Math.PI / 180;
      const lat2 = b.lat * Math.PI / 180;
      const sinDLat = Math.sin(dLat / 2);
      const sinDLon = Math.sin(dLon / 2);
      const calc = sinDLat * sinDLat + sinDLon * sinDLon * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(calc), Math.sqrt(1 - calc));
      return Math.round(R * c);
    };

    const jitterFromZip = (zip = '') => {
      const seed = parseInt(String(zip).slice(-3) || '0', 10);
      return { lat: ((seed % 7) - 3) * 0.08, lng: ((Math.floor(seed / 7) % 7) - 3) * 0.1 };
    };

    const guessLatLng = (state, zip) => {
      const base = STATE_COORDS[state] || STATE_COORDS.DEFAULT;
      const jitter = jitterFromZip(zip);
      return { lat: base.lat + jitter.lat, lng: base.lng + jitter.lng };
    };

    const parseCsvLine = (line = '') => (line.match(/(".*?"|[^",]+)(?=,|$)/g) || []).map((value) => value.replace(/^"|"$/g, ''));

    const parseCsv = async () => {
      const response = await fetch('assets/installers.csv');
      const text = await response.text();
      const lines = text.trim().split(/\r?\n/);
      const headers = parseCsvLine(lines.shift() || '').map((h) => h.trim());

      return lines
        .filter((line) => line.trim())
        .map((line, idx) => {
          const values = parseCsvLine(line);
          const row = Object.fromEntries(headers.map((h, i) => [h, (values[i] || '').trim()]));
          const state = String(row.State || row.state || '').trim().toUpperCase();
          const zip = String(row.Zipcode || row.ZIP || row.Zip || '').padStart(5, '0');
          const coords = guessLatLng(state, zip);
          return {
            id: idx + 1,
            name: row.Name || row.FullName || row.Company || 'Installer',
            company: row.Company || row.Name || 'Partner',
            email: row.Email || '',
            phone: row.Phone || '',
            state,
            city: row.City || '',
            zipcode: zip,
            notes: row.Notes || row.Note || row.Observation || '',
            lat: coords.lat,
            lng: coords.lng,
            rating: 4.4 + (idx % 6) * 0.1,
            jobsToday: idx % 5,
            status: idx % 4 === 0 ? 'Busy' : 'Available',
          };
        });
    };

    const extractAddressHint = (value) => {
      const upper = (value || '').toUpperCase();
      const stateMatch = upper.match(/,\s*([A-Z]{2})\b/) || upper.match(/\b([A-Z]{2})\b/);
      const zipMatch = upper.match(/(\d{5})/);
      return { state: stateMatch ? stateMatch[1] : '', zip: zipMatch ? zipMatch[1] : '' };
    };

    const normalize = (value = '') => value.trim().toLowerCase();

    const pickTechsByLocation = (techs, zip, city, state) => {
      const matchesByZip = zip ? techs.filter((tech) => tech.zipcode === zip) : [];
      if (matchesByZip.length) return matchesByZip;

      const matchesByCity = city
        ? techs.filter((tech) => normalize(tech.city) === normalize(city))
        : [];
      if (matchesByCity.length) return matchesByCity;

      const matchesByState = state ? techs.filter((tech) => tech.state === state) : [];
      if (matchesByState.length) return matchesByState;

      return techs;
    };

    const renderTechCards = (techs, target, selectedId) => {
      const container = document.getElementById('tech-cards');
      if (!target) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-slate-800 bg-slate-950/40 px-6 py-10 text-center text-slate-400">
          <i data-lucide="filter" class="mb-3 h-10 w-10 text-slate-600"></i>
          <p class="text-sm font-semibold text-white">Waiting for address</p>
          <p class="text-xs text-slate-400">Enter the location and we will surface the technician with the best ETA.</p>
        </div>`;
        lucide.createIcons();
        return;
      }

      const enriched = techs.map((tech) => ({
        ...tech,
        distance: haversineMiles({ lat: tech.lat, lng: tech.lng }, target),
      })).sort((a, b) => a.distance - b.distance);

      container.innerHTML = enriched.map((tech, index) => {
        const best = index === 0;
        const selected = selectedId === tech.id;
        const title = tech.company || tech.name || 'Installer';
        const statusClass = tech.status === 'Available'
          ? 'bg-green-500/10 text-green-200 ring-1 ring-green-500/30'
          : tech.status === 'Busy'
            ? 'bg-red-500/10 text-red-200 ring-1 ring-red-500/30'
            : 'bg-amber-500/10 text-amber-200 ring-1 ring-amber-500/30';
        return `<div data-tech-id="${tech.id}" class="relative cursor-pointer rounded-2xl border ${selected ? 'border-emerald-400 ring-2 ring-emerald-500/60 shadow-lg shadow-emerald-500/20' : best ? 'border-blue-500 shadow-lg shadow-blue-500/20' : 'border-slate-800'} bg-slate-950/60 p-4 transition hover:border-blue-400/60 hover:shadow-lg hover:shadow-blue-500/5" role="button" aria-label="Select ${tech.name} on map">`
          ${best ? '<div class="absolute -top-2 -right-2 flex items-center gap-1 rounded-full bg-emerald-500 px-3 py-1 text-[10px] font-bold uppercase tracking-wide text-white shadow-lg shadow-emerald-500/30"><i data-lucide="star" class="h-3 w-3"></i> Best option</div>' : ''}
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-3">
              <div class="flex h-12 w-12 items-center justify-center rounded-full ${best ? 'bg-blue-500/20 text-blue-100' : 'bg-slate-800 text-slate-200'} text-lg font-black">${title.charAt(0)}</div>
              <div>
                <p class="text-sm font-bold text-white">${title}</p>
                <div class="flex flex-col text-[11px] text-slate-400">
                  <span class="flex items-center gap-1 font-medium"><i data-lucide="user" class="h-3 w-3 text-slate-500"></i> ${tech.name || 'Technician'}</span>
                  <span class="flex items-center gap-1 font-medium"><i data-lucide="map-pin" class="h-3 w-3 text-slate-500"></i> ${tech.city || tech.state}</span>
                  <span class="flex items-center gap-2">
                    <span class="flex items-center gap-1 text-amber-300"><i data-lucide="star" class="h-3 w-3"></i> ${tech.rating?.toFixed ? tech.rating.toFixed(1) : tech.rating}</span>
                    <span class="text-slate-500">${tech.jobsToday} jobs today</span>
                  </span>
                </div>
              </div>
            </div>
            <div class="text-right">
              <p class="text-lg font-black ${best ? 'text-emerald-300' : 'text-slate-200'}">${tech.distance}<span class="ml-1 text-xs font-semibold text-slate-400">miles</span></p>
              <span class="mt-2 inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide ${statusClass}">${tech.status}</span>
            </div>
          </div>
          <div class="mt-3 grid gap-2 text-[11px] text-slate-400 sm:grid-cols-2">
            <span class="flex items-center gap-2"><i data-lucide="phone" class="h-3 w-3"></i>${tech.phone || 'N/A'}</span>
            <span class="flex items-center gap-2"><i data-lucide="shield" class="h-3 w-3"></i>${tech.company || 'Tech partner'}</span>
          </div>
          ${tech.notes ? `<div class="mt-2 flex items-start gap-2 rounded-lg border border-slate-800 bg-slate-900/70 p-2 text-[11px] text-slate-200"><i data-lucide="info" class="h-3 w-3 text-amber-300"></i><span class="text-left leading-tight">${tech.notes}</span></div>` : ''}
        </div>`;
      }).join('');
      lucide.createIcons();
    };

    let map;
    let techLayer;
    let routeLayer;
    let targetLayer;

    const initMap = () => {
      map = L.map('tech-map', { zoomControl: false, worldCopyJump: true }).setView([STATE_COORDS.DEFAULT.lat, STATE_COORDS.DEFAULT.lng], 4.2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map);
      techLayer = L.layerGroup().addTo(map);
      routeLayer = L.layerGroup().addTo(map);
      targetLayer = L.layerGroup().addTo(map);
    };

    const renderTechMap = (techs, target, highlightedId) => {
      if (!map) initMap();
      techLayer.clearLayers();
      routeLayer.clearLayers();
      targetLayer.clearLayers();

      const bounds = [];

      if (target) {
        const targetMarker = L.marker([target.lat, target.lng], {
          title: 'Installation address',
          icon: L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconAnchor: [12, 41],
          }),
        }).addTo(targetLayer);
        bounds.push([target.lat, target.lng]);

        const nearest = highlightedId
          ? techs.find((t) => t.id === highlightedId)
          : techs
            .map((tech) => ({ ...tech, distance: haversineMiles({ lat: tech.lat, lng: tech.lng }, target) }))
            .sort((a, b) => a.distance - b.distance)[0];

        if (nearest) {
          routeLayer.addLayer(L.polyline([[target.lat, target.lng], [nearest.lat, nearest.lng]], {
            color: '#22c55e',
            weight: 4,
            opacity: 0.8,
            dashArray: '6 4',
          }));
        }
      }

      techs.forEach((tech) => {
        const highlighted = highlightedId === tech.id;
        const available = tech.status === 'Available';
        const marker = L.circleMarker([tech.lat, tech.lng], {
          radius: highlighted ? 9 : 7,
          color: highlighted ? '#34d399' : '#60a5fa',
          weight: highlighted ? 3 : 1.5,
          fillColor: available ? '#3b82f6' : '#f59e0b',
          fillOpacity: 0.9,
          className: 'cursor-pointer',
        }).addTo(techLayer);

        marker.bindTooltip(`${tech.company || tech.name} (${available ? 'Available' : tech.status})`, { permanent: false, direction: 'top', offset: [0, -2] });

        marker.on('click', () => {
          highlightedTechId = tech.id;
          renderTechCards(currentTechs, currentTarget, highlightedTechId);
          renderTechMap(currentTechs, currentTarget, highlightedTechId);
        });

        bounds.push([tech.lat, tech.lng]);
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [30, 30] });
      } else if (bounds.length === 1) {
        map.setView(bounds[0], 6);
      }

      lucide.createIcons();
    };

    let currentTechs = [];
    let currentTarget = null;
    let highlightedTechId = null;

    const init = async () => {
      const techs = await parseCsv();
      currentTechs = techs;
      document.getElementById('active-count').textContent = techs.length;
      renderTechCards(techs, null, highlightedTechId);
      renderTechMap(techs, null, highlightedTechId);

      document.getElementById('address-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const value = document.getElementById('address-input').value;
        const { state, zip } = extractAddressHint(value);
        const cityGuess = value
          .split(',')
          .map((part) => part.trim())
          .find((part) => part && !/\d{5}/.test(part) && !/\d/.test(part) && part.length > 2 && !/^[A-Z]{2}$/.test(part.toUpperCase())) || '';
        const target = guessLatLng(state || 'DEFAULT', zip);
        const scopedTechs = pickTechsByLocation(techs, zip, cityGuess, state);
        currentTechs = scopedTechs;
        currentTarget = target;
        highlightedTechId = scopedTechs.length ? scopedTechs[0].id : null;
        renderTechCards(scopedTechs, target, highlightedTechId);
        renderTechMap(scopedTechs, target, highlightedTechId);
      });

      document.getElementById('tech-cards').addEventListener('click', (event) => {
        const card = event.target.closest('[data-tech-id]');
        if (!card || !currentTarget) return;
        highlightedTechId = Number(card.getAttribute('data-tech-id'));
        renderTechCards(currentTechs, currentTarget, highlightedTechId);
        renderTechMap(currentTechs, currentTarget, highlightedTechId);
      });
    };

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      init();
    });
  </script>
</body>
</html>
