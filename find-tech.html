<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc ‚Ä¢ Red de Instaladores</title>
  
  <!-- Fuentes e Iconos -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  
  <!-- Leaflet CSS (Mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            slate: { 850: '#1a2233' } 
          }
        },
      },
    };
  </script>
  
  <!-- Iconos Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    /* Mapa oscuro y responsivo */
    #tech-map {
      height: 100%;
      min-height: 500px;
      width: 100%;
      background-color: #0f172a; 
      z-index: 1;
    }
    /* Filtro para modo oscuro profundo */
    .leaflet-tile {
      filter: grayscale(100%) invert(100%) contrast(85%);
    }
    /* Scrollbars personalizadas */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="h-screen bg-slate-950 font-sans text-slate-50 overflow-hidden flex flex-col">

  <!-- Header -->
  <header class="flex-none border-b border-slate-800 bg-slate-900 z-50">
    <div class="mx-auto flex w-full items-center justify-between px-6 py-4">
      <a href="#" class="flex items-center gap-3">
        <div class="rounded-lg bg-blue-600 p-2 shadow-lg shadow-blue-500/20">
          <i data-lucide="satellite" class="h-5 w-5 text-white"></i>
        </div>
        <div>
          <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-blue-400">Sistema GPS</p>
          <h1 class="text-lg font-black leading-tight">TechLoc Manager</h1>
        </div>
      </a>
      <div class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        <span class="text-xs font-medium text-slate-300">Sistema Online</span>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <main class="flex-1 flex overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-[420px] flex-none border-r border-slate-800 bg-slate-900 flex flex-col shadow-2xl z-20">
      
      <!-- Panel de B√∫squeda -->
      <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
        <div class="mb-4">
          <label class="text-[11px] font-bold uppercase tracking-wider text-slate-400 mb-2 block">Direcci√≥n de Instalaci√≥n</label>
          <form id="search-form" class="relative">
            <input 
              id="address-input" 
              type="text" 
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3.5 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-all font-medium" 
              placeholder="Ej: 33101, Miami o FL..."
              autocomplete="off"
            >
            <button type="submit" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors shadow-lg shadow-blue-900/20">
              BUSCAR
            </button>
          </form>
        </div>

        <!-- Stats -->
        <div class="flex items-center justify-between text-xs bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
          <span class="text-slate-500">Total T√©cnicos en Flota</span>
          <strong id="total-count" class="text-lg text-white font-black">0</strong>
        </div>
        
        <!-- Error Alert -->
        <div id="csv-error" class="hidden mt-3 p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg animate-fade-in">
          <p class="text-[11px] text-amber-300 flex gap-2">
            <i data-lucide="info" class="h-4 w-4 shrink-0"></i>
            <span>No se encontr√≥ el archivo de datos. Verifique que "assets/installers.csv" exista.</span>
          </p>
        </div>
      </div>

      <!-- Lista Scrollable -->
      <div id="tech-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900 scroll-smooth">
        <!-- Loader -->
        <div class="py-12 text-center opacity-50">
          <i data-lucide="loader-2" class="h-8 w-8 text-blue-500 animate-spin mx-auto mb-3"></i>
          <p class="text-xs text-slate-400">Esperando datos...</p>
        </div>
      </div>
    </aside>

    <!-- Mapa -->
    <div class="flex-1 relative bg-slate-950">
      <div class="absolute top-6 right-6 z-[400] bg-slate-900/95 backdrop-blur border border-slate-700 p-4 rounded-xl shadow-2xl min-w-[180px]">
        <h4 class="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-3 pb-2 border-b border-slate-800">Leyenda</h4>
        <div class="space-y-2 text-xs font-medium text-slate-300">
          <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow-[0_0_8px_#3b82f6]"></span> Disponible</div>
          <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-amber-500"></span> Ocupado</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border-2 border-white bg-red-600 animate-pulse"></span> B√∫squeda</div>
        </div>
      </div>
      <div id="tech-map"></div>
    </div>
  </main>

  <script>
    // --- Configuraci√≥n Geogr√°fica ---
    const DEFAULT_CENTER = [39.8283, -98.5795]; // Centro USA
    // Coordenadas base de los estados para ubicar t√©cnicos si no hay lat/lng espec√≠fico
    const STATE_COORDS = {
      'AL': [32.8067, -86.7911], 'AK': [61.3707, -152.4044], 'AZ': [33.7298, -111.4312], 'AR': [34.9697, -92.3731],
      'CA': [36.1162, -119.6816], 'CO': [39.0598, -105.3111], 'CT': [41.5978, -72.7554], 'DE': [39.3185, -75.5071],
      'FL': [27.7663, -81.6868], 'GA': [33.0406, -83.6431], 'HI': [21.0943, -157.4983], 'ID': [44.2405, -114.4788],
      'IL': [40.3495, -88.9861], 'IN': [39.8494, -86.2583], 'IA': [42.0115, -93.2105], 'KS': [38.5266, -96.7265],
      'KY': [37.6681, -84.6701], 'LA': [31.1695, -91.8678], 'ME': [44.6939, -69.3819], 'MD': [39.0639, -76.8021],
      'MA': [42.2302, -71.5301], 'MI': [43.3266, -84.5361], 'MN': [45.6945, -93.9002], 'MS': [32.7416, -89.6787],
      'MO': [38.4561, -92.2884], 'MT': [46.9219, -110.4544], 'NE': [41.1254, -98.2681], 'NV': [38.3135, -117.0554],
      'NH': [43.4525, -71.5639], 'NJ': [40.2989, -74.5210], 'NM': [34.8405, -106.2485], 'NY': [42.1657, -74.9481],
      'NC': [35.6301, -79.8064], 'ND': [47.5289, -99.7840], 'OH': [40.3888, -82.7649], 'OK': [35.5653, -96.9289],
      'OR': [43.9336, -120.5583], 'PA': [40.5908, -77.2098], 'RI': [41.6809, -71.5118], 'SC': [33.8569, -80.9450],
      'SD': [44.2998, -99.4388], 'TN': [35.7478, -86.6923], 'TX': [31.0545, -97.5635], 'UT': [40.1500, -111.8624],
      'VT': [44.0459, -72.7107], 'VA': [37.7693, -78.1699], 'WA': [47.4009, -121.4905], 'WV': [38.4912, -80.9545],
      'WI': [44.2685, -89.6165], 'WY': [42.7559, -107.3025], 'DC': [38.9072, -77.0369]
    };

    let map, techLayer, routeLayer, targetLayer;
    let allTechs = [];

    // --- Inicializar Mapa ---
    function initMap() {
      map = L.map('tech-map', { zoomControl: false, attributionControl: false }).setView(DEFAULT_CENTER, 4);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      techLayer = L.layerGroup().addTo(map);
      routeLayer = L.layerGroup().addTo(map);
      targetLayer = L.layerGroup().addTo(map);
    }

    // --- Generaci√≥n de Coordenadas "A prueba de fallos" ---
    // Si el estado no existe en la lista, usamos un hash del nombre para ponerlo en un lugar fijo (aunque sea arbitrario en el mapa)
    // para que el t√©cnico NO desaparezca de la lista.
    function getCoords(state, zip, id) {
      const stateKey = (state || '').trim().toUpperCase();
      let base = STATE_COORDS[stateKey];
      
      // FALLBACK: Si el estado no est√° en mi lista, generamos una lat/lng pseudo-aleatoria dentro de USA
      // para asegurar que el t√©cnico aparezca en el mapa y en la lista.
      if (!base) {
        // Generar coordenadas basades en el c√≥digo ASCII del estado para que sean consistentes
        const hash = stateKey.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        base = [35 + (hash % 15), -100 + (hash % 20)]; 
      }
      
      // Dispersi√≥n "Nube" (Circular)
      const seed = parseInt((zip || '0').replace(/\D/g, '')) + (id * 47); 
      const angle = (seed % 360) * (Math.PI / 180);
      const radius = 0.1 + ((seed % 70) / 100); 

      const latOffset = radius * Math.cos(angle);
      const lngOffset = radius * Math.sin(angle) * 1.3; 

      return {
        lat: base[0] + latOffset,
        lng: base[1] + lngOffset
      };
    }

    // --- Procesamiento de Datos ---
    function processCSV(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
      if (lines.length < 2) return;

      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
      
      allTechs = lines.slice(1).map((line, index) => {
        // Regex para respetar comas dentro de comillas
        const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
        const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
        
        const row = {};
        headers.forEach((h, i) => row[h] = cleanValues[i] || '');

        // Extraer estado (ej: "Alabama (AL)" -> "AL")
        let stateRaw = row['state'] || '';
        let stateMatch = stateRaw.match(/\(([A-Z]{2})\)/); 
        let stateCode = stateMatch ? stateMatch[1] : (stateRaw.length === 2 ? stateRaw : 'UNKNOWN');
        
        const zip = row['zip'] || row['zipcode'] || '';
        const coords = getCoords(stateCode, zip, index);

        return {
          id: index,
          name: row['installation company'] || row['company'] || row['name'] || 'Instalador ' + index,
          city: row['city'] || 'Ubicaci√≥n Desconocida',
          state: stateCode,
          zip: zip,
          phone: row['phone'] || 'No disponible',
          email: row['email'] || 'No disponible',
          lat: coords.lat,
          lng: coords.lng,
          status: (index % 4 === 0) ? 'Busy' : 'Available',
          rating: (4 + Math.random()).toFixed(1)
        };
      });

      document.getElementById('total-count').textContent = allTechs.length;
      document.getElementById('csv-error').classList.add('hidden'); // Ocultar error si hubo √©xito
      renderTechs(allTechs); 
      renderMapMarkers(allTechs);
    }

    // --- Carga Autom√°tica (Intento) ---
    async function loadInitialData() {
      try {
        const response = await fetch('assets/installers.csv');
        if (!response.ok) throw new Error("CSV local no encontrado o bloqueado por CORS");
        const text = await response.text();
        processCSV(text);
      } catch (e) {
        console.warn("No se pudo cargar assets/installers.csv autom√°ticamente.", e);
        document.getElementById('csv-error').classList.remove('hidden');
        renderTechs([]); // Lista vac√≠a hasta que carguen archivo
      }
    }

    // --- Renderizado de Lista (CON DISTANCIA) ---
    function renderTechs(techs, targetCoords = null) {
      const container = document.getElementById('tech-list');
      container.innerHTML = '';

      if (techs.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-slate-500 text-sm border border-dashed border-slate-800 rounded-xl">No hay t√©cnicos cargados.</div>';
        return;
      }

      // IMPORTANTE: Calcular y ordenar por distancia
      let displayTechs = [...techs];
      if (targetCoords) {
        displayTechs = displayTechs.map(t => ({
          ...t, 
          distance: getDistance(targetCoords.lat, targetCoords.lng, t.lat, t.lng)
        })).sort((a, b) => a.distance - b.distance);
      }
      
      // Mostrar solo los primeros 100 para rendimiento
      displayTechs.slice(0, 100).forEach((tech, idx) => {
        const isBest = idx === 0 && targetCoords;
        const el = document.createElement('div');
        
        el.className = `group relative p-4 rounded-xl border transition-all cursor-pointer bg-slate-900 animate-fade-in
          ${isBest ? 'border-blue-500 bg-slate-800 shadow-lg shadow-blue-500/10 z-10 ring-1 ring-blue-500/50' : 'border-slate-800 hover:border-slate-600'}`;
        
        el.innerHTML = `
          ${isBest ? '<div class="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-md z-20">MEJOR OPCI√ìN</div>' : ''}
          
          <div class="flex justify-between items-start mb-2">
            <div class="pr-2 w-2/3">
              <h3 class="font-bold text-slate-100 text-sm group-hover:text-blue-400 transition-colors truncate">${tech.name}</h3>
              <div class="text-xs text-slate-400 flex items-center gap-1 mt-0.5">
                <i data-lucide="map-pin" class="h-3 w-3 text-slate-500"></i> ${tech.city}, ${tech.state} ${tech.zip}
              </div>
            </div>
            ${targetCoords ? `
              <div class="text-right flex-shrink-0 w-1/3">
                <span class="block text-xl font-black ${isBest ? 'text-blue-400' : 'text-slate-500'} tracking-tight leading-none">${Math.round(tech.distance)}</span>
                <span class="text-[9px] font-bold text-slate-600 uppercase">millas</span>
              </div>` : ''}
          </div>

          <div class="grid grid-cols-1 gap-1.5 my-3 pb-3 border-b border-slate-800/80">
            <div class="flex items-center gap-2 text-xs text-slate-300 bg-slate-950/50 p-1.5 rounded border border-slate-800/50 hover:border-blue-500/30 transition-colors">
              <i data-lucide="phone" class="h-3 w-3 text-blue-500 shrink-0"></i>
              <span class="truncate select-all cursor-text">${tech.phone}</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-300 bg-slate-950/50 p-1.5 rounded border border-slate-800/50 hover:border-blue-500/30 transition-colors">
              <i data-lucide="mail" class="h-3 w-3 text-blue-500 shrink-0"></i>
              <span class="truncate select-all cursor-text" title="${tech.email}">${tech.email}</span>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <span class="flex items-center gap-1.5 text-[10px] uppercase font-bold px-2 py-1 rounded-md border ${tech.status === 'Available' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-amber-500/10 text-amber-400 border-amber-500/20'}">
              <span class="w-1.5 h-1.5 rounded-full ${tech.status === 'Available' ? 'bg-blue-400' : 'bg-amber-400'}"></span>
              ${tech.status === 'Available' ? 'Disponible' : 'Ocupado'}
            </span>
            <div class="flex items-center text-xs text-slate-300 font-bold bg-slate-950 px-2 py-1 rounded-md">
              <i data-lucide="star" class="h-3 w-3 mr-1 text-yellow-500 fill-current"></i> ${tech.rating}
            </div>
          </div>
        `;
        
        el.addEventListener('click', () => {
          flyToTech(tech);
          document.querySelectorAll('#tech-list > div').forEach(d => d.classList.remove('ring-2', 'ring-blue-500'));
          el.classList.add('ring-2', 'ring-blue-500');
        });

        container.appendChild(el);
      });
      
      lucide.createIcons();
    }

    // --- Renderizado de Mapa ---
    function renderMapMarkers(techs) {
      techLayer.clearLayers();
      
      techs.forEach(tech => {
        const color = tech.status === 'Available' ? '#3b82f6' : '#f59e0b';
        const marker = L.circleMarker([tech.lat, tech.lng], {
          radius: 5,
          fillColor: color,
          color: '#0f172a',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        }).addTo(techLayer);

        marker.bindPopup(`
          <div class="text-slate-800 p-1 min-w-[200px]">
            <strong class="block text-sm mb-1 font-bold text-slate-900 border-b pb-1">${tech.name}</strong>
            <span class="text-xs block text-slate-500 mb-2 mt-1 flex items-center gap-1"><i style="width:12px" data-lucide="map-pin"></i> ${tech.city}, ${tech.state}</span>
            <div class="grid gap-1.5">
               <a href="tel:${tech.phone}" class="flex items-center gap-2 text-xs bg-blue-50 text-blue-700 px-2 py-1.5 rounded font-semibold border border-blue-100 hover:bg-blue-100 transition">üìû ${tech.phone}</a>
               <a href="mailto:${tech.email}" class="flex items-center gap-2 text-xs bg-slate-50 text-slate-700 px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-100 transition truncate">‚úâÔ∏è ${tech.email}</a>
            </div>
          </div>
        `);
      });
    }

    // --- L√≥gica de B√∫squeda ---
    function handleSearch(e) {
      e.preventDefault();
      const query = document.getElementById('address-input').value.trim().toLowerCase();
      if (!query) return;

      if (allTechs.length === 0) {
        alert("Primero carga un archivo CSV con tus t√©cnicos.");
        return;
      }

      let targetLat, targetLng;
      let foundMatch = false;

      // 1. ZIP
      const zipMatch = allTechs.find(t => t.zip && t.zip.includes(query) && query.length >= 3);
      // 2. Ciudad
      const cityMatch = allTechs.find(t => t.city && t.city.toLowerCase().includes(query));
      // 3. Estado
      const stateQuery = query.toUpperCase().substring(0, 2);
      const stateCoords = STATE_COORDS[stateQuery];

      if (zipMatch) {
        targetLat = zipMatch.lat; targetLng = zipMatch.lng; foundMatch = true;
      } else if (cityMatch) {
        targetLat = cityMatch.lat; targetLng = cityMatch.lng; foundMatch = true;
      } else if (stateCoords) {
        targetLat = stateCoords[0]; targetLng = stateCoords[1]; foundMatch = true;
      } else {
        targetLat = 38.0; targetLng = -97.0; // Fallback
        alert("No encontramos t√©cnicos exactos en esa ubicaci√≥n. Mostrando vista general.");
      }

      // Marcador de B√∫squeda
      targetLayer.clearLayers();
      const targetIcon = L.divIcon({
        className: 'bg-transparent',
        html: `<div class="relative flex items-center justify-center">
                <span class="animate-ping absolute inline-flex h-8 w-8 rounded-full bg-red-500 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-4 w-4 bg-red-600 border-2 border-white shadow-xl"></span>
              </div>`
      });
      L.marker([targetLat, targetLng], { icon: targetIcon }).addTo(targetLayer);

      // Ruta visual
      const nearest = allTechs.map(t => ({...t, dist: getDistance(targetLat, targetLng, t.lat, t.lng)}))
                              .sort((a,b) => a.dist - b.dist)[0];
      
      routeLayer.clearLayers();
      if (nearest && foundMatch) {
        L.polyline([[targetLat, targetLng], [nearest.lat, nearest.lng]], {
          color: '#3b82f6',
          weight: 2,
          dashArray: '5, 5',
          opacity: 0.8
        }).addTo(routeLayer);
        map.fitBounds(L.latLngBounds([[targetLat, targetLng], [nearest.lat, nearest.lng]]), { padding: [100, 100], maxZoom: 10 });
      } else {
        map.setView([targetLat, targetLng], 7);
      }

      // REORDENAR LA LISTA VISUAL
      renderTechs(allTechs, { lat: targetLat, lng: targetLng });
    }

    // --- Utilidades ---
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8; 
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function flyToTech(tech) {
      map.flyTo([tech.lat, tech.lng], 11, { duration: 1.5 });
    }

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      initMap();
      loadInitialData(); // Intenta cargar autom√°tico
      document.getElementById('search-form').addEventListener('submit', handleSearch);
    });

  </script>
</body>
</html>
